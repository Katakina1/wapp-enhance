<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.certification.dao.ManualCertificationDao">
	<select id="queryTotal" resultType="Integer" >
		/**mycat:schema=${schemaLabel}*/
		select
		count(1)
 		from t_dx_record_invoice t
 		where 1=1
		AND gf_tax_no in (SELECT taxno FROM t_ac_org where orgid in(SELECT orgid FROM t_ac_user_taxno where userid=#{map.userId}))
		<if test="map.invoiceNo != null and map.invoiceNo != ''">
			and invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
		</if>
		<if test="map.qsStatus !=null and map.qsStatus != '-1'">
			and qs_status = #{map.qsStatus}
		</if>
		<if test="map.qsType !=null and map.qsType != '-1'">
			and qs_type = #{map.qsType}
		</if>
		<if test="map.qsDate1 != null and map.qsDate1 != ''">
			<![CDATA[ AND date_format(qs_date,'%Y-%m-%d') >= #{map.qsDate1} ]]>
		</if>
		<if test="map.qsDate2 != null and map.qsDate2 != ''">
			<![CDATA[ AND date_format(qs_date,'%Y-%m-%d')  <= #{map.qsDate2} ]]>
		</if>
		<if test="map.invoiceType !=null and map.invoiceType != '-1'">
			and invoice_type = #{map.invoiceType}
		</if>
		<if test="map.gfName != null and map.gfName != '-1'and  map.gfName != ''">
			and gf_tax_no = #{map.gfName}
		</if>
		<if test="map.xfName != null and map.xfName != ''">
			and xf_name like concat('%',concat(#{map.xfName},'%'))
		</if>
		<if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
			<![CDATA[ AND date_format(invoice_date,'%Y-%m-%d') >= #{map.invoiceDate1} ]]>
		</if>
		<if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
			<![CDATA[ AND date_format(invoice_date,'%Y-%m-%d')  <= #{map.invoiceDate2} ]]>
		</if>
		and invoice_type IN (1, 3, 14)
		and rzh_yesorno=0
		and invoice_status=0
		and invoice_amount>0
		AND (SELECT c.current_tax_period FROM t_dx_tax_current c WHERE c.taxno=t.gf_tax_no)>=date_format(invoice_date,'%Y%m')
		and IF (
		invoice_date >= '2017-07-01 00:00:00',

		DATE_ADD(invoice_date,INTERVAL 359 DAY) >= getdate(),

		DATE_ADD(invoice_date,INTERVAL 179 DAY) >= getdate()
		)
		and tax_amount>=0
		and auth_status in (0,5)

	</select>

	<select id="queryList" resultType="com.xforceplus.wapp.modules.certification.entity.InvoiceCertificationEntity" >
		/**mycat:schema=${schemaLabel}*/
		select
		id 				 ,
		invoice_type      invoiceType,
    	invoice_code 	 invoiceCode,
    	invoice_no 		 invoiceNo,
    	invoice_date	 invoiceDate,
    	gf_name 		 gfName,
    	xf_name 		 xfName,
		invoice_amount   invoiceAmount,
    	tax_amount 		 taxAmount,
		(select  n.dictname  from t_ac_dictdeta n  where n.dicttype=1569 and n.dictcode=t.qs_status) qsStatus,
		qs_date 		 qsDate,
		(select  m.dictname  from t_ac_dictdeta m  where m.dicttype=1130 and m.dictcode=t.qs_type) qsType
		from t_dx_record_invoice t
 		where 1=1
		AND (SELECT c.current_tax_period FROM t_dx_tax_current c WHERE c.taxno=t.gf_tax_no)>=date_format(invoice_date,'%Y%m')
		and invoice_type IN (1, 3, 14)
		AND gf_tax_no in (SELECT taxno FROM t_ac_org where orgid in(SELECT orgid FROM t_ac_user_taxno where userid=#{map.userId}))
		<if test="map.invoiceNo != null and map.invoiceNo != ''">
			and invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
		</if>
		<if test="map.qsStatus !=null and map.qsStatus != '-1'">
			and qs_status = #{map.qsStatus}
		</if>
		<if test="map.qsType !=null and map.qsType != '-1'">
			and qs_type = #{map.qsType}
		</if>
		<if test="map.qsDate1 != null and map.qsDate1 != ''">
			<![CDATA[ AND date_format(qs_date,'%Y-%m-%d') >= #{map.qsDate1} ]]>
		</if>
		<if test="map.qsDate2 != null and map.qsDate2 != ''">
			<![CDATA[ AND date_format(qs_date,'%Y-%m-%d')  <= #{map.qsDate2} ]]>
		</if>
		<if test="map.invoiceType !=null and map.invoiceType != '-1'">
			and invoice_type = #{map.invoiceType}
		</if>
		<if test="map.gfName != null and map.gfName != '-1'and  map.gfName != ''">
			and gf_tax_no = #{map.gfName}
		</if>
		<if test="map.xfName != null and map.xfName != ''">
			and xf_name like concat('%',concat(#{map.xfName},'%'))
		</if>
		<if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
			<![CDATA[ AND date_format(invoice_date,'%Y-%m-%d') >= #{map.invoiceDate1} ]]>
		</if>
		<if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
			<![CDATA[ AND date_format(invoice_date,'%Y-%m-%d')  <= #{map.invoiceDate2} ]]>
		</if>
		and rzh_yesorno=0
		and invoice_status=0
		and invoice_amount>0
		and IF (
		invoice_date >= '2017-07-01 00:00:00',

		DATE_ADD(invoice_date,INTERVAL 359 DAY) >= getdate(),

		DATE_ADD(invoice_date,INTERVAL 179 DAY) >= getdate()
		)
		and tax_amount>=0
		and auth_status in (0,5)
		order by invoice_date desc, id
		<if test="map.offset != null and map.limit != null">
			limit #{map.offset}, #{map.limit}
		</if>
	</select>
	<update id="manualCertification">
		/**mycat:schema=${schemaLabel}*/
		update t_dx_record_invoice WITH(ROWLOCK) set
		gx_type=4,
		auth_status=2,
		confirm_date=getdate(),
		rzh_belong_date=#{rzhBelongDate},
		confirm_user=#{loginName}
		where ID = #{id}
	</update>
	<select id="getRzhBelongDate" resultType="String">
		/**mycat:schema=${schemaLabel}*/
		select
		(SELECT c.current_tax_period FROM t_dx_tax_current c WHERE c.taxno=t.gf_tax_no) rzhBelongDate
		from t_dx_record_invoice t
		where t.id= #{id}
	</select>

	<select id="getCurrentTaxPeriod" resultType="String">
		/**mycat:schema=${schemaLabel}*/
				select
		(select current_tax_period FROM t_dx_tax_current where taxno=t.gf_tax_no or old_tax_no=t.gf_tax_no ORDER BY taxno DESC LIMIT 1) rzhBelongDate
		from t_dx_record_invoice t
		where t.id= #{id}
	</select>


</mapper>