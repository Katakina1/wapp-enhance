<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.redTicket.dao.SapInvoiceDao">
    <insert id="saveSapInvoice" parameterType="com.xforceplus.wapp.modules.redTicket.entity.SapInvoiceEntity">
        insert into t_dx_dsign
        (document_header_text, subject, company_code, document_type, certificate_no,
         clearance_voucher, clearing_date, refer_to, show_currency_amount,
        voucher_currency, currency, currency_amount, posting_date, payment_date,
        invoice_text, creation_date,venderid,cost_center,profit_center,usercode,invoice_date)
        values
        (#{documentHeaderText}, #{subject}, #{companyCode}, #{documentType}, #{certificateNo},
         #{clearanceVoucher}, #{clearingDate}, #{reference}, #{showCurrencyAmount},
        #{voucherCurrency}, #{currency}, #{currencyAmount}, #{postingDate}, #{paymentDate},
        #{invoiceText}, GETDATE(),#{venderId},#{costCenter},#{profitCenter},#{usercode},#{invoiceDate})
    </insert>

    <update id="updateSapInvoiceToRecord" parameterType="com.xforceplus.wapp.modules.redTicket.entity.SapInvoiceEntity">
        update t_dx_record_invoice WITH(ROWLOCK) set
        document_header_text = CASE WHEN document_header_text is null or document_header_text='' THEN #{documentHeaderText} ELSE document_header_text END,
        subject = CASE WHEN subject is null or subject='' THEN #{subject} ELSE subject END,
        company_code = CASE WHEN company_code is null or company_code='' THEN #{companyCode} ELSE company_code END,
        document_type = CASE WHEN document_type is null or document_type='' THEN #{documentType} ELSE document_type END,
        certificate_no = CASE WHEN certificate_no is null or certificate_no='' THEN #{certificateNo} ELSE certificate_no END,
        write_off = CASE WHEN write_off is null or write_off='' THEN #{writeOff} ELSE write_off END,
        clearance_voucher = CASE WHEN clearance_voucher is null or clearance_voucher='' THEN #{clearanceVoucher} ELSE clearance_voucher END,
        clearing_date = CASE WHEN clearing_date is null THEN #{clearingDate} ELSE clearing_date END,
        show_currency_amount = CASE WHEN show_currency_amount is null THEN #{showCurrencyAmount} ELSE show_currency_amount END,
        voucher_currency = CASE WHEN voucher_currency is null or voucher_currency='' THEN #{voucherCurrency} ELSE voucher_currency END,
        currency = CASE WHEN currency is null or currency='' THEN #{currency} ELSE currency END,
        posting_date = CASE WHEN posting_date is null THEN #{postingDate} ELSE posting_date END,
        payment_date = CASE WHEN payment_date is null THEN #{paymentDate} ELSE payment_date END,
        invoice_text = CASE WHEN invoice_text is null or invoice_text='' THEN #{invoiceText} ELSE invoice_text END
        where invoice_no=RIGHT(#{reference}, 8) and invoice_amount=#{currencyAmount}
    </update>

    <update id="associateInvoice" parameterType="com.xforceplus.wapp.modules.redTicket.entity.SapInvoiceEntity">
        update t_dx_record_invoice WITH(ROWLOCK) set
        certificate_no = #{certificateNo},
        payment_date = #{paymentDate},
        shop_no=#{shopNo}
        where venderid = #{venderId} and invoice_no=#{reference} and invoice_date=#{invoiceDate}
    </update>

    <update id="associateProtocol" parameterType="com.xforceplus.wapp.modules.redTicket.entity.SapInvoiceEntity">
        update t_dx_protocol set
        pay_date = #{paymentDate}
        where protocol_no=RIGHT(#{reference}, 10)
        <![CDATA[ AND SUBSTRING( convert(varchar(100),case_date,20),0,11) = #{invoiceDate} ]]>
        and  amount = #{currencyAmount}
    </update>

    <update id="updateTenUserCode" parameterType="com.xforceplus.wapp.modules.base.entity.UserEntity">
        update t_ac_user set
        ten_usercode = #{tenUserCode}
        where usercode = #{usercode}
    </update>

    <select id="getUserCode" resultType="java.lang.String">
        select usercode from t_ac_user where ten_usercode=#{subject}
    </select>

    <select id="getDictNameByType" resultType="java.lang.String">
        SELECT tad.dictname dictname
        FROM t_ac_dictdeta tad
        LEFT JOIN t_ac_dicttype tadt ON tadt.dicttypeid = tad.dicttype
        WHERE tadt.dicttypecode = #{type}
    </select>
    <select id="delZp">
        delete from t_dx_dsign WITH (ROWLOCK) where document_type = 'ZP'
    </select>

    <select id="selectDsign" resultType="java.lang.Integer">
        select count(1) from t_dx_dsign where payment_date=#{paymentDate} and refer_to=#{referTo} and currency_amount=#{currencyAmount} and venderid=#{venderid}
    </select>
</mapper>