<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xforceplus.wapp.modules.cost.dao.CostApplicationDao">
    <select id="getUserInfo" resultType="com.xforceplus.wapp.modules.cost.entity.SettlementEntity">
        SELECT
        case when b.orgtype=3 then '' else a.usercode end venderId,
        a.username venderName,
        a.bank_name bankName,
        a.bank_account bankAccount
        from t_ac_user a join t_ac_org b on a.orgid=b.orgid
        where a.userid=#{id}
    </select>

    <select id="getUserInfoByCode" resultType="com.xforceplus.wapp.modules.cost.entity.SettlementEntity">
        SELECT
        usercode venderId,
        username venderName,
        bank_name bankName,
        bank_account bankAccount
        from t_ac_user where usercode=#{venderid}
    </select>

    <select id="getCostType" resultType="com.xforceplus.wapp.modules.cost.entity.SelectionOptionEntity">
        select cost_type optionKey,
        cost_type_name optionName
        from t_dx_cost_type where vender_id=#{venderId} and is_contract=#{businessType}
    </select>

    <select id="searchInvoice" resultType="com.xforceplus.wapp.modules.cost.entity.RecordInvoiceEntity">
        SELECT  invoice_code,
        invoice_no,
        source_system,
        invoice_type,
        invoice_date,
        invoice_amount,
        tax_amount,
        total_amount,
        tax_rate,
        gf_tax_no gfTaxNo,
        jvname gfName,
        check_code,
        dxhy_match_status,
        cost_no,
        covered_amount,
        total_amount-isnull(covered_amount,0) uncoveredAmount
        from t_dx_record_invoice WITH(NOLOCK) where invoice_code=#{invoiceCode} and invoice_no=#{invoiceNo}
    </select>

    <select id="checkInvoice" resultType="int">
        select count(1) from t_dx_settlement_invoice where invoice_code=#{invoiceCode} and invoice_no=#{invoiceNo}
    </select>

    <select id="getGfInfo" resultType="com.xforceplus.wapp.modules.cost.entity.SelectionOptionEntity">
        select orgcode optionKey,
        orgcode+'('+orgname+')' optionName
        from t_ac_org where orgtype='5' and taxno!='0'
    </select>

    <select id="getGfInfoByStaff" resultType="com.xforceplus.wapp.modules.cost.entity.SelectionOptionEntity">
        select b.orgcode optionKey,
        b.orgcode+'('+b.orgname+')' optionName
        from t_ac_staff_org a join t_ac_org b on a.orgid=b.orgid where b.orgtype='5' and b.taxno!='0'
        and a.staff=#{staff}
    </select>

    <select id="getGf" resultType="com.xforceplus.wapp.modules.cost.entity.RecordInvoiceEntity">
        select taxno jvcode,
        taxname jvname,
        company_code companyCode
        from t_ac_org where orgcode=#{orgcode}
    </select>

    <select id="getRateOptions" resultType="com.xforceplus.wapp.modules.cost.entity.SelectionOptionEntity">
        select dictcode optionKey,
        dictname optionName
        from t_ac_dictdeta where dicttype=(select dicttypeid from t_ac_dicttype where dicttypecode='WALMART_RATE')
        order by sortno asc
    </select>

    <select id="getDeptInfo" resultType="com.xforceplus.wapp.modules.cost.entity.SelectionOptionEntity">
        select a.cost_center optionKey,
        a.cost_center_name optionName
        from t_ac_org_dev a join t_ac_org b on a.orgid=b.orgid where b.orgcode=#{staffNo}
    </select>

    <select id="getEmail" resultType="com.xforceplus.wapp.modules.cost.entity.SelectionOptionEntity">
        select b.staff_no optionKey,
        b.email optionName
        from t_ac_staff_vendor a left join t_ac_staff_info b on a.staff=b.staff_no
        where a.vendor_no=#{vendorNo}
    </select>

    <insert id="saveFile" useGeneratedKeys="true" keyColumn="id" keyProperty="id" parameterType="com.xforceplus.wapp.modules.cost.entity.SettlementFileEntity">
        insert into t_dx_settlement_file (file_name, file_type, file_path)
        values (#{fileName}, #{fileType}, #{filePath})
    </insert>

    <select id="getFileInfo" resultType="com.xforceplus.wapp.modules.cost.entity.SettlementFileEntity">
        select file_path, file_name from t_dx_settlement_file where id=#{id}
    </select>

    <insert id="saveSettlement">
        insert into t_dx_settlement WITH(ROWLOCK) (vender_id, vender_name, bank_name, bank_account, approver_email,
        settlement_amount, walmart_status, cost_no, create_date, remark, pay_model,
        belongs_to, service_type, payment_mode, pay_day, contract, has_invoice, urgency,
        eps_no, eps_id, old_bind_id, old_total_amount, surplus_amount)
        values (#{venderId}, #{venderName}, #{bankName}, #{bankAccount}, #{approverEmail},
        #{settlementAmount}, #{walmartStatus}, #{costNo}, getdate(), #{remark}, #{payModel},
        #{belongsTo}, #{serviceType}, #{paymentMode}, #{payDay}, #{contract}, #{hasInvoice},
        #{urgency}, #{epsNo} , #{epsId}, #{oldBindId}, #{oldTotalAmount}, #{surplusAmount})
    </insert>

    <insert id="saveSettlementInvoice">
        insert into t_dx_record_invoice WITH(ROWLOCK)(invoice_type, invoice_code, invoice_no, invoice_date,
        invoice_amount, tax_amount, total_amount, jvcode, jvname, check_code, cost_no,
        detail_yesorno, uuid, covered_amount, flow_type,
        gf_tax_no, gf_name, company_code, invoice_status)
        values (#{invoice.invoiceType}, #{invoice.invoiceCode}, #{invoice.invoiceNo}, #{invoice.invoiceDate},
        #{invoice.invoiceAmount}, #{invoice.taxAmount}, #{invoice.totalAmount},
        #{invoice.gfTaxNo}, #{invoice.gfName}, #{invoice.checkCode}, #{costNo},
        '0', #{invoice.invoiceCode}+#{invoice.invoiceNo}, #{invoice.coverAmount}, '2',
        #{invoice.jvcode}, #{invoice.jvname}, #{invoice.companyCode}, '0')
    </insert>

    <insert id="saveSettlementInvoice2">
        insert into t_dx_settlement_invoice (invoice_type, invoice_code, invoice_no, invoice_date,
        invoice_amount, tax_amount, total_amount, gf_tax_no, gf_name, check_code, cost_no,
        covered_amount, venderid)
        values (#{invoice.invoiceType}, #{invoice.invoiceCode}, #{invoice.invoiceNo}, #{invoice.invoiceDate},
        #{invoice.invoiceAmount}, #{invoice.taxAmount}, #{invoice.totalAmount},
        #{invoice.gfTaxNo}, #{invoice.gfName}, #{invoice.checkCode}, #{costNo},
        #{invoice.coverAmount}, #{invoice.venderid})
    </insert>

    <update id="updateSettlementInvoice">
        update t_dx_record_invoice WITH(ROWLOCK) set
        cost_no=#{costNo}, covered_amount=isnull(covered_amount,0.00)+#{coverAmount},
        flow_type='2'
        where invoice_code=#{invoiceCode} and invoice_no=#{invoiceNo}
    </update>

    <update id="updateRecordInvoice">
        update t_dx_record_invoice WITH(ROWLOCK) set
        cost_no=#{costNo},
        covered_amount=isnull(covered_amount,0.00)+#{invoice.coverAmount},
        flow_type='2',
        invoice_date=#{invoice.invoiceDate},
        invoice_amount=#{invoice.invoiceAmount},
        tax_amount=#{invoice.taxAmount},
        total_amount=#{invoice.totalAmount},
        jvcode=#{invoice.gfTaxNo},
        jvname=#{invoice.gfName},
        check_code=#{invoice.checkCode},
        gf_tax_no=#{invoice.jvcode},
        gf_name=#{invoice.jvname},
        company_code=#{invoice.companyCode}
        where invoice_code=#{invoice.invoiceCode} and invoice_no=#{invoice.invoiceNo}
    </update>

    <insert id="saveSettlementInvoiceMatch">
        insert into t_dx_match_settlement_invoice (cost_no, invoice_code, invoice_no)
        values (#{costNo}, #{invoiceCode}, #{invoiceNo})
    </insert>

    <select id="getRateCount" resultType="int">
        select count(1) from t_dx_settlement_rate where invoice_no like #{invoiceNo}+'%'
    </select>

    <insert id="saveRate" useGeneratedKeys="true" keyColumn="id" keyProperty="rate.id" parameterType="com.xforceplus.wapp.modules.cost.entity.RateEntity">
        insert into t_dx_settlement_rate (cost_no, invoice_code, invoice_no,
        invoice_amount, tax_rate, tax_amount)
        values (#{costNo}, #{invoiceCode}, #{invoiceNo},
        #{rate.invoiceAmount}, #{rate.taxRate}, #{rate.taxAmount})
    </insert>

    <insert id="saveCost">
        insert into t_dx_settlement_cost (rate_id, cost_type, cost_type_name, cost_time, cost_amount, cost_use,
        cost_dept, cost_dept_id, instance_id, bpms_id, project_code)
        values (#{rateId}, #{cost.costType}, #{cost.costTypeName}, #{cost.costTime}, #{cost.costAmount}, #{cost.costUse},
        #{cost.costDept}, #{cost.costDeptId}, #{cost.instanceId}, #{cost.bpmsId}, #{cost.projectCode})
    </insert>

    <update id="updateFile">
        update t_dx_settlement_file set file_path=#{path}, cost_no=#{costNo}
        where id=#{id}
    </update>

    <select id="getGfTaxNoByDept" resultType="java.lang.String">
        select taxno from t_ac_org where orgid=(select orgid from t_ac_org_dev where cost_center=#{dept})
    </select>

    <select id="getGfTaxNoByStaffNo" resultType="java.lang.String">
        select gf_tax_no from t_ac_staff_info where staff_no=#{staffNo}
    </select>
</mapper>