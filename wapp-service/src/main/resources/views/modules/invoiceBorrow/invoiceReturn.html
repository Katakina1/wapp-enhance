
<!DOCTYPE html>
<!--suppress ALL -->
<html lang="ZH">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" href="../../libs/customer/index.css">
    <style type="text/css">

        #file {
            outline: 0.01rem;
            background-color: transparent;
            filter: alpha(opacity=0);
            -moz-opacity: 0;
            -khtml-opacity: 0;
            opacity: 0;
            height: 0.4rem;
            width: 100%;
        }
        #upload {
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            line-height: 0.4rem;
            border: 0.01rem solid #dedede;
            height: 0.4rem;
        }


        [v-cloak] {
            display: none;
        }

        .el-form--inline .el-form-item {
            width: 35%;
        }
        .el-dialog__header{
            background: #333333;
            color: white;
        }
        .el-dialog__header span,.el-dialog__header i{
            color: white !important;
        }
        .el-form-item__error{
            transform: translateY(-5px);;
        }
    </style>
</head>
<body>
<script type="text/javascript" charset="utf-8" src="../../js/customer/resource.js"></script>
<iframe id="ifile" style="display:none"></iframe>
<div id="vm" v-cloak>
    <div>
        <el-form :model="formInline" label-width="1.0rem">
            <el-row>
                <el-col :span="12">
                    <el-form-item label="JV:">
                        <el-select id="gf-select" v-model="formInline.gfTaxNo" filterable @focus="gfNameFocus" @blur="gfNameBlur">
                            <el-option
                                    v-for="item in gfs"
                                    :key="item.value"
                                    :label="item.label"
                                    :value="item.value">
                            </el-option>
                        </el-select>
                    </el-form-item>
                </el-col>
                <el-col :span="12">
                    <el-form-item label="供应商号:">
                        <el-input v-model="formInline.venderId"  maxlength="6"    @keyup.native="numberOnKeyVenderId($event)"
                                  @change="numberChangeVenderId"
                                  placeholder="请输入供应商号"></el-input>
                    </el-form-item>
                </el-col>
                <el-col :span="12">
                    <el-form-item label="发票号码:">
                        <el-input v-model="formInline.invoiceNo" placeholder="请输入发票号码"  maxlength="8"
                                  @keyup.native="numberOnKey($event)"
                                  @change="numberChange"></el-input>
                    </el-form-item>
                </el-col>

                <el-col :span="14">
                    <el-form-item label="借阅日期:" prop="createDate" id="requireMsg2">
                        <el-row>
                            <el-col :span="13">
                                <el-date-picker @blur="blurpickerchange(1)" @focus="focuspickerchange(1)" type="date" id="datevalue1"
                                                placeholder="选择日期" v-model="formInline.createStartDate"
                                                :picker-options="createDateOptions"
                                                :clearable="false" :editable="false" value-format="yyyy-MM-dd"></el-date-picker>
                            </el-col>
                            <el-col class="line" :span="2">—</el-col>
                            <el-col :span="13">
                                <el-date-picker type="date" placeholder="选择日期" v-model="formInline.createEndDate" id="datevalue2"
                                                @blur="blurpickerchange(2)" @focus="focuspickerchange(2)"
                                                :picker-options="createEndDateOptions"
                                                :clearable="false" :editable="false" value-format="yyyy-MM-dd"></el-date-picker>
                            </el-col>
                        </el-row>
                    </el-form-item>
                </el-col>

            </el-row>
            <el-row>
                <el-col :span="12">
                    <el-form-item label="装订册号:">
                        <el-input v-model="formInline.bindingNo" placeholder="请输入装订册号"  maxlength="9"
                                  @keyup.native="numberOnKeyBingding($event)"
                                  @change="numberChangeBinding"></el-input>
                    </el-form-item>
                </el-col>
                <el-col :span="12">
                    <el-form-item label="装箱号:">
                        <el-input v-model="formInline.packingNo" maxlength="255" @keyup.native="packNoOnKey($event)"
                                  @change="packNoChange"
                                  placeholder="请输入装箱号"></el-input>
                    </el-form-item>
                </el-col>
                <el-col :span="6">
                    <el-form-item label="公司代码:" prop="extf0" label-width="1.4rem">
                        <el-input v-model="formInline.companyCode" maxlength="255"  @keyup.native="companyCodeOnKey($event)"
                                  @change="companyCodeChange"    placeholder="请输入公司代码"></el-input>
                    </el-form-item>
                </el-col>
                <el-col :span="12">
                    <el-form-item label="凭证号:">
                        <el-input v-model="formInline.certificateNo" maxlength="255" @keyup.native="certificateOnKey($event)"
                                  @change="certificateChange"
                                  placeholder="请输入凭证号"></el-input>
                    </el-form-item>
                </el-col>
                <el-col :span="12">
                    <el-form-item label="EPS号:" prop="epsNo">
                        <el-input v-model="formInline.epsNo" maxlength="20" placeholder="请输入EPS号"></el-input>
                    </el-form-item>
                </el-col>
            </el-row>
            <el-row>
                <el-col :span="1" :offset="1">
                    <el-button class="btnexport" @click="onSubmit">查询</el-button>
                </el-col>
<!--                <el-col :span="1" :offset="1">-->
<!--                    <el-button class="btnexport" @click="borrow" :disabled="total == 0">归还</el-button>-->
<!--                </el-col>-->
                <el-col :span="1" :offset="1">
                    <el-button  id="export_btn" class="btnexport" @click="exportData()" disabled>导出</el-button>
                </el-col>
            </el-row>
            <form id="upload_form" target="frm" method="post" enctype="multipart/form-data">
                <div class="row" style="border-top: 0;">
                    <div class="col-xs-4" >
                        <div class="form-group">
                            <label class="col-xs-4 control-label">选择上传文件:</label>
                            <div class="col-xs-8" id="upload">
                                <span v-html="selectFileFlag"></span>
                                <input type="file" @change="onChangeFile($event)" id="file" name="file" class="text-input"
                                       hidden>
                            </div>
                        </div>
                    </div>
                    <el-col :span="1" :offset="1">
                        <el-button  class="btnexport" @click="showSelectFileWin()">浏览</el-button>
                    </el-col>
                    <el-col :span="1" :offset="1" class="btn-row2">
                        <el-button  class="btnexport" @click="batchImport($event)">导入归还</el-button>
                    </el-col>
                </div>
            </form>
        </el-form>
    </div>
    <hr>
        <div class="total">
            <span>合计数量: {{total}}条, 合计金额: {{summationTotalAmount}}元, 合计税额: {{summationTaxAmount}}元</span>
        </div>
        <el-table height="4rem" border fit :data="tableData" class="tableData" highlight-current-row
                  style="width: 100%;font-size: 0.12rem;"  @selection-change="changeFun">
            <el-table-column :show-overflow-tooltip="true"  type="index" width="70" :index="mainIndex" label="序号" align="center"></el-table-column>
            <el-table-column :show-overflow-tooltip="true"  type="selection" width="55" class="selection" align="center" prop='id' @selection-change="changeFun"></el-table-column>
            <el-table-column :show-overflow-tooltip="true"  prop="jvCode" label="JV" align="left" header-align="center" width="120" ></el-table-column>
            <el-table-column :show-overflow-tooltip="true"  prop="companyCode" label="公司代码" align="left" header-align="center" width="120" ></el-table-column>
            <el-table-column :show-overflow-tooltip="true"  prop="invoiceCode" label="发票代码" align="left" header-align="center" width="120"></el-table-column>
            <el-table-column :show-overflow-tooltip="true"  prop="invoiceNo" label="发票号码" align="left" header-align="center" width="120">
                <template scope="scope">
                    <span>{{ scope.row.invoiceNo }}</span>
                    <el-tooltip class="item" effect="dark" placement="top-start">
                        <div slot="content">{{ scope.row.invoiceTypeName }}</div>
                        <img v-if="scope.row.invoiceType== '01'" style="height:0.2rem;" src="../../img/special-invoice.png"/>
                        <img v-if="scope.row.invoiceType== '03' " style="height:0.2rem;" src="../../img/motor-vehicles.png"/>
                        <img   v-if="scope.row.invoiceType=== '04' "
                             style="height:0.2rem;" src="../../img/plain-invoice.png"/>
                        <img v-if="scope.row.invoiceType== '10' " style="height:0.2rem;" src="../../img/einvoice.png"/>
                        <img   v-if="scope.row.invoiceType=== '11' "
                             style="height:0.2rem;" src="../../img/roll-invoice.png"/>
                        <img v-if="scope.row.invoiceType== '14' " style="height:0.2rem;" src="../../img/general-invoice.png"/>
                    </el-tooltip>
                </template>
            </el-table-column>
            <el-table-column :show-overflow-tooltip="true"  prop="epsNo" label="EPS_NO" align="left" header-align="center" width="100"></el-table-column>
            <el-table-column :show-overflow-tooltip="true"  prop="invoiceDate" label="开票日期" align="center" :formatter="formatInvoiceDate" width="140"></el-table-column>
            <el-table-column :show-overflow-tooltip="true"  prop="gfName" label="购方名称" :show-overflow-tooltip="true" align="left" header-align="center" :formatter="formatterNull" width="150"></el-table-column>
            <el-table-column :show-overflow-tooltip="true"  prop="xfName" label="销方名称" :show-overflow-tooltip="true" align="left" header-align="center" :formatter="formatterNull" width="150"></el-table-column>
            <el-table-column :show-overflow-tooltip="true"  prop="venderId" label="供应商号" align="left" header-align="center" width="120" ></el-table-column>
            <el-table-column :show-overflow-tooltip="true"  prop="invoiceAmount" label="金额" align="right" header-align="center" :formatter="numberFormat" width="110"></el-table-column>
            <el-table-column :show-overflow-tooltip="true"  prop="taxAmount" label="税额" align="right" header-align="center" :formatter="numberFormat" width="110"></el-table-column>
            <el-table-column :show-overflow-tooltip="true"  prop="taxRate" label="税率" align="right"  header-align="center" width="110" :formatter="numberFormat"></el-table-column>
            <el-table-column :show-overflow-tooltip="true"  prop="totalAmount" label="价税合计" align="right"  header-align="center" width="110" :formatter="numberFormat"></el-table-column>
            <el-table-column :show-overflow-tooltip="true"  prop="certificateNo" label="凭证号" align="left" header-align="center" width="120" ></el-table-column>
            <el-table-column :show-overflow-tooltip="true"  prop="scanningSeriano" label="扫描流水号" align="left" header-align="center" width="150" :show-overflow-tooltip="true">
                <template scope="scope">
                    <span v-if="scope.row.scanningSeriano=== null" >—— ——</span>
                    <span v-else>{{scope.row.scanningSeriano}}</span>
                </template>
            </el-table-column>
            <el-table-column :show-overflow-tooltip="true"  prop="bbindingno" label="装订册号" align="center" header-align="center" width="120" :show-overflow-tooltip="true"></el-table-column>
            <el-table-column :show-overflow-tooltip="true"  prop="packingno" label="装箱号" align="left" header-align="center" width="120" ></el-table-column>
        </el-table>
        <el-col class="toolbar" style="padding:0.1rem;">
            <el-pagination background @current-change="currentChange" @size-change="handleSizeChange"
                           :current-page="currentPage"
                           :page-size="pageSize" :page-sizes="pageList" :pager-count="pagerCount"
                           layout="slot, sizes, prev, pager, next" :total="total" style="float:right">
                <span>共{{total}}条记录，第{{currentPage}}页，共{{totalPage}}页</span>
            </el-pagination>
        </el-col>

        <el-dialog title="发票归还信息" :visible.sync="borrowWin" :before-close="closeBorrowWin" width="45%">
            <div style="width: 100%;">
                <el-form ref="saveBorrowForm" :model="saveBorrowForm" label-width="1.2rem">
                    <el-row>
                        <el-col :span="12" style="width: 65%">
                            <el-form-item label="归还人:" prop="borrowUser" :rules="[{ required: true, message: '归还人不能为空'}]">
                                <el-input v-model.trim="saveBorrowForm.borrowUser" maxlength="50"
                                          placeholder="请输入归还人"></el-input>
                            </el-form-item>
                        </el-col>
                    </el-row>
                    <el-row>
                        <el-col :span="13" style="width: 65%">
                            <el-form-item label="归还时间:" prop="borrowDate" id="requireMsg3" :rules="[{ required: true, message: '借阅日期不能为空'}]">
                                <el-date-picker @blur="blurpickerchange(3)" @focus="focuspickerchange(3)" type="date" id="datevalue3"
                                                placeholder="选择日期" v-model="saveBorrowForm.borrowDate"
                                                :picker-options="createDateOptions"
                                                :clearable="false" :editable="false" value-format="yyyy-MM-dd"></el-date-picker>
                            </el-form-item>
                        </el-col>
                    </el-row>
                </el-form>
            </div>


            <span slot="footer" class="dialog-footer">
            <div align="right">
                <el-button class="btnexport"  @click="submit">保存</el-button>
                <el-button class="queryBtn" @click="closeBorrowWin">取消</el-button>
            </div>
        </span>
        </el-dialog>

</div>
</body>
<script type="text/babel">
    Vue.http.options.emulateJSON = true;
    Vue.http.options.emulateHTTP = true;
    var vm = new Vue({
        el: '#vm',
        i18n,
        data: {
            selectFileFlag: '',
            fileList: [],
            tableShow: true,
            tableData: [],
            currentPage: 1,
            total: 0,
            borrowWin: false,
            multipleSelection: [],
            summationTotalAmount: '0.00',
            summationTaxAmount: '0.00',
            totalPage: 1,
            pagerCount: PAGE_PARENT.PAGER_COUNT,
            pageSize: PAGE_PARENT.PAGE_SIZE,
            pageList: PAGE_PARENT.PAGE_LIST,
            filterInvoiceTypeList: ['01', '03', '14'],
            options: [],
            gfs: [{
                value: "-1",
                label: "全部"
            }],
            invoiceTypeList: [],
            createDateOptions:{},
            createEndDateOptions: {},
            saveBorrowForm: {
                ids:[],
                operateType:'1',
                borrowUser: '',
                borrowDate:null,
                borrowReason:''
            },
            formInline: {
                gfTaxNo:'-1',
                certificateNo:'',
                bindingNo:'',
                packingNo:'',
                jvCode:'',
                companyCode:'',
                venderId:'',
                gfName: '',
                epsNo:'',
                createDate: new Date(),
                createStartDate: new Date().getFullYear() + "-" + format2(new Date().getMonth()+1) + "-01",
                createEndDate: new Date().getFullYear()+"-"+format2(new Date().getMonth()+1)+"-"+format2(new Date().getDate()),
                invoiceType: '',
                invoiceNo: ''
            },
            exportParam: {}
        },
        mounted: function () {
            this.createDateOptions = {
                disabledDate: function(time)  {
                    return time.getTime() >= Date.now();
                }
            };
            this.createEndDateOptions = {
                disabledDate: function(time) {
                    return time.getTime() >= Date.now();
                }
            };
            this.getGfName();

            $("#gf-select").attr("maxlength","50");
        },
        methods: {
            gfNameFocus: function (event) {
                $(".el-select input").removeAttr('readonly');
            },
            gfNameBlur: function (event) {
                $(".el-select input").attr('readonly','readonly');
            },
            currentChange: function(val) {
                if(this.total > 0) {
                    this.findAll(val);
                }
            },
            handleSizeChange: function (val) {
                this.pageSize = val;
                if(this.total > 0) {
                    this.findAll(1);
                }
            },
            findAll: function (currentPage) {
                var qsStartDate = new Date(this.formInline.createStartDate);
                var qsEndDate = new Date(this.formInline.createEndDate);
                qsStartDate.setMonth(qsStartDate.getMonth() + 12);
                $(".checkMsg").remove();
                if ( (qsEndDate.getTime() + 1000*60*60*24) > qsStartDate.getTime()) {
                    $("#requireMsg2 .el-form-item__content div.el-date-editor:first-child").append('<div class="checkMsg">日期选择跨度不可超过1年</div>');
                    return ;
                }else if(qsEndDate.getTime()<new Date(this.formInline.createStartDate)){
                    $("#requireMsg2 .el-form-item__content div.el-date-editor:first-child").append('<div class="checkMsg">结束时间不可小于开始时间</div>');
                    return;
                }
                if ( (qsEndDate.getTime() + 1000*60*60*24) > qsStartDate.getTime()) {
                    $("#requireMsg3 .el-form-item__content div.el-date-editor:first-child").append('<div class="checkMsg">日期选择跨度不可超过1年</div>');
                    return ;
                }else if(qsEndDate.getTime()<new Date(this.formInline.createStartDate)){
                    $("#requireMsg3 .el-form-item__content div.el-date-editor:first-child").append('<div class="checkMsg">结束时间不可小于开始时间</div>');
                    return;
                }
                var loadingInstance = this.$loading({
                    text: '正在拼命加载中',
                    target: document.querySelector('.tableData')
                });
                if (!isNaN(currentPage)) {
                    this.currentPage = currentPage;
                }
                var params_ = {
                    page: this.currentPage,
                    limit: this.pageSize,
                    sidx: '',
                    order: 'desc',
                    borrowYesOrNo:'1',
                    jvCode: this.formInline.jvCode,
                    companyCode: this.formInline.companyCode,
                    certificateNo:this.formInline.certificateNo,
                    gfName: this.formInline.gfTaxNo,
                    venderId:this.formInline.venderId,
                    bindingNo:this.formInline.bindingNo,
                    packingNo:this.formInline.packingNo,
                    epsNo:this.formInline.epsNo,
                    createDate: this.formInline.createDate === '' ? '' : this.formatDate(this.formInline.createDate, true),
                    invoiceNo: this.trimStr(this.formInline.invoiceNo),
                    invoiceType: this.formInline.invoiceType,
                    borrowStartDate: this.formatDateTime(this.formInline.createStartDate),
                    borrowEndDate: this.formatDateTime(this.formInline.createEndDate)
                };

                this.exportParam = params_;
                var flag = false;
                var hh;
                this.$http.post(baseURL + "invoice/borrow/list",
                    params_, {
                        'headers': {
                            "token": token
                        }
                    }).then(function (response) {
                    flag = true;
                    loadingInstance.close();
                    if (response.data.code != 0 && response.data.code != 401) {
                        alert(response.data.msg);
                        return;
                    }
                    this.total = response.data.page.totalCount;
                    this.totalPage = response.data.page.totalPage;
                    if (response.data.page.totalCount > 0) {
                        this.summationTotalAmount = this.numberFormat('','',response.data.page.summationTotalAmount);
                        this.summationTaxAmount = this.numberFormat('','',response.data.page.summationTaxAmount);
                    } else {
                        this.summationTotalAmount = '0.00';
                        this.summationTaxAmount = '0.00';
                    }
                    this.tableData = [];
                    for (var key in response.data.page.list) {
                        this.$set(this.tableData, key, response.data.page.list[key]);
                    }
                    if(this.tableData.length>0){
                        $("#export_btn").removeAttr("disabled").removeClass("is-disabled");
                    }
                },(err)=>{
                    loadingInstance.close();
                    if(err.status == 408) {
                        alert(err.statusText);
                    }
                }).catch(function (response) {
                    loadingInstance.close();
                    alert(response.data.msg);
                });
                var intervelId = setInterval(function () {
                    if (flag) {
                        hh=$(document).height();
                        $("body",parent.document).find("#myiframe").css('height',hh+'px');
                        clearInterval(intervelId);
                        return;
                    }
                },50);
            },
            borrow:function () {
                var rows = vm.multipleSelection;
                if (!rows.length > 0) {
                    alert("请勾选需要借阅的发票！");
                    return;
                } else {
                    vm.borrowWin = true;
                }
            },
            submit:function () {
                //表单校验
                this.$refs['saveBorrowForm'].validate(function (valid) {
                    if (valid) {
                        vm.save();
                    } else {
                        return false
                    }
                })
            },
            save: function () {
                var ids = [];
                var rows = vm.multipleSelection;
                for (var i = 0; i < rows.length; i++) {
                    ids.push(rows[i].uuid);
                }
                vm.saveBorrowForm.ids=ids;
                var data = vm.saveBorrowForm;
                $.ajax({
                    type: "POST",
                    url: baseURL + "invoice/borrow/save",
                    contentType: "application/json",
                    data: JSON.stringify(data),
                    success: function (r) {
                        if (r.code === 0) {
                            vm.borrowWin = false;
                            vm.findAll(1);
                            vm.$refs["saveBorrowForm"].resetFields();
                            alert('保存成功');

                        }else if (r.code == 401) {
                            alert("登录超时，请重新登录", function () {
                                var hostHref = parent.location.href;
                                if(hostHref.indexOf("int")!=-1){
                                    parent.location.href ="http://rl.wal-mart.com";
                                }else if(hostHref.indexOf("ext")!=-1){
                                    parent.location.href ="https://retaillink.wal-mart.com";
                                }else if(hostHref.indexOf("https://cnwapp.wal-mart.com")!=-1){
                                    parent.location.href ="https://retaillink.wal-mart.com";
                                }else{
                                    parent.location.href = baseURL + 'login.html';
                                }
                            });
                        } else {
                            vm.$refs["saveBorrowForm"].resetFields();
                            alert(r.msg);
                        }
                    }
                });
            },
            closeBorrowWin: function () {
                vm.$refs["saveBorrowForm"].resetFields();
                vm.borrowWin = false;
            },
            getGfName: function () {
                $.get(baseURL + 'report/invoiceProcessingStatusReport/searchGf',function(r){
                    var gfs = [];
                    gfs.push({
                        value: "-1",
                        label: "全部"
                    });
                    for(var i=0;i<r.optionList.length;i++){
                        var gf = {};
                        gf.value = r.optionList[i].value;
                        gf.label = r.optionList[i].value+"("+r.optionList[i].label+")";
                        gfs.push(gf);
                    }
                    vm.gfs = gfs;
                });
            },
            getInvoiceType: function () {
                //param/getParamMap
                this.$http.post(baseURL + sysUrl.getParamMap,
                    {type: 'INV_TYPE'}, {
                        'headers': {
                            "token": token
                        }
                    }).then(function (response) {
                    response.data.splice(0, 0, {typeName: "全部", typeCode: ''});
                    for (var i in response.data) {
                        this.$set(this.invoiceTypeList, i, response.data[i]);
                    }
                    this.invoiceTypeList = this.invoiceTypeList.filter(function (item) {
                        var myTypeCode = item.typeCode;
                        return myTypeCode == '' || myTypeCode == '01' || myTypeCode == '03' || myTypeCode == '14';
                    });
                }).catch(function (response) {
                });
            },
            blurpickerchange: function (val) {
                if (val == 1) {
                    $('#datevalue1').siblings('span.el-input__suffix').css('background', 'white');
                    $('#datevalue1').siblings('span.el-input__prefix').children('i').css('color', '#ffaa00');
                } else if (val == 2) {
                    $('#datevalue2').siblings('span.el-input__suffix').css('background', 'white');
                    $('#datevalue2').siblings('span.el-input__prefix').children('i').css('color', '#ffaa00');
                }else if(val==3){
                    $('#datevalue3').siblings('span.el-input__suffix').css('background', 'white');
                    $('#datevalue3').siblings('span.el-input__prefix').children('i').css('color', '#ffaa00');
                }
            },
            focuspickerchange: function (val) {
                if (val == 1) {
                    $('#datevalue1').siblings('span.el-input__suffix').css('background', '#ffaa00');
                    $('#datevalue1').siblings('span.el-input__prefix').children('i').css('color', '#333333');
                } else if (val == 2) {
                    $('#datevalue2').siblings('span.el-input__suffix').css('background', '#ffaa00');
                    $('#datevalue2').siblings('span.el-input__prefix').children('i').css('color', '#333333');
                }else if(val==3){
                    $('#datevalue3').siblings('span.el-input__suffix').css('background', '#ffaa00');
                    $('#datevalue3').siblings('span.el-input__prefix').children('i').css('color', '#333333');
                }
            },
            formatDateTime: function (time) {
                var date = new Date(time.toString().replace(/-/g, "/"));
                var seperator1 = "-";
                var seperator2 = ":";
                var month = date.getMonth() + 1;
                var strDate = date.getDate();
                if (month >= 1 && month <= 9) {
                    month = "0" + month;
                }
                if (strDate >= 0 && strDate <= 9) {
                    strDate = "0" + strDate;
                }
                return date.getFullYear() + seperator1 + month + seperator1 + strDate;
            },
            formatDate: function (time, flag) {
                var date = new Date(time.toString().replace(/-/g,"/"));
                var seperator1 = "";
                if (flag) {
                    seperator1 = "-";
                }
                var seperator2 = ":";
                var month = date.getMonth() + 1;
                var strDate = date.getDate();
                if (month >= 1 && month <= 9) {
                    month = "0" + month;
                }
                if (strDate >= 0 && strDate <= 9) {
                    strDate = "0" + strDate;
                }
                return date.getFullYear() + seperator1 + month + seperator1 + strDate;
            },
            formatterNull: function (row, column, cellValue) {
                if (cellValue == null || cellValue == "" || cellValue == undefined) {
                    return "一 一";
                } else {
                    return cellValue;
                }
            },formatCreateDate: function (row, column) {
                if (row.createDate != null) {
                    return this.formatDate(row.createDate, true);
                } else {
                    return '';
                }
            },
            formatInvoiceDate: function (row) {
                if (row.invoiceDate != null) {
                    return this.formatDate(row.invoiceDate, true);
                } else {
                    return '';
                }
            },
            exportData() {
                var params_ = {
                    sidx: '',
                    order: 'desc',
                    borrowYesOrNo:'1',
                    jvCode: this.formInline.jvCode,
                    companyCode: this.formInline.companyCode,
                    certificateNo:this.formInline.certificateNo,
                    gfName: this.formInline.gfTaxNo,
                    venderId:this.formInline.venderId,
                    bindingNo:this.formInline.bindingNo,
                    packingNo:this.formInline.packingNo,
                    epsNo:this.formInline.epsNo,
                    createDate: this.formInline.createDate === '' ? '' : this.formatDate(this.formInline.createDate, true),
                    invoiceNo: this.trimStr(this.formInline.invoiceNo),
                    invoiceType: this.formInline.invoiceType,
                    borrowStartDate: this.formatDateTime(this.formInline.createStartDate),
                    borrowEndDate: this.formatDateTime(this.formInline.createEndDate)
                };
                $.ajax({
                    url:baseURL + 'excel/apply',
                    type:"POST",
                    data:{'serviceType':19,'condition':JSON.stringify(params_)},
                    success:function (r) {
                        flag = true;
                        if(r.code==0){
                            alert(r.data);
                            // $('#totalStatistics').html("合计数量: "+vm.total+"条, 合计金额: "+
                            //     formatMoney(r.page.summationTotalAmount)+"元, 合计税额: "+formatMoney(r.page.summationTaxAmount)+"元");
                        }

                    }
                });
                $("#export_btn").attr("disabled","true").addClass("is-disabled");
            },
            onSubmit() {
                this.tableShow = true;
                this.findAll(1);
            },
            onChangeFile: function (event) {
                var str = $("#file").val();
                var index = str.lastIndexOf('.');
                var photoExt = str.substr(index, 4);
                photoExt = photoExt.toLowerCase();
                if (photoExt != '' && !(photoExt == '.xls' || photoExt == '.xlsx')) {
                    alert("请上传excel文件格式!");
                    this.isNeedFileExtension = false;
                    return false;
                } else {
                    this.selectFileFlag = '';
                    this.file = '';
                    var meFile = event.target.files[0];
                    if (event != undefined && meFile != null && meFile != '') {
                        this.file = event.target.files[0];
                        this.isNeedFileExtension = true;
                        //截取名称最后18位
                        this.selectFileFlag = event.target.files[0].name;
                    }
                }
            },
            showSelectFileWin:function() {
                this.selectFileFlag = '';
                this.file = '';
                $("#upload_form")[0].reset();
                $("#file").click();
            },
            batchImport: function (event) {
                if (!this.isNeedFileExtension) {
                    alert("请上传excel文件格式!");
                } else {
                    event.preventDefault();
                    if (this.file == '' || this.file == undefined) {
                        alert("请选择excel文件!");
                        return;
                    }
                    //allDataList=[];
                    var formData = new FormData();
                    formData.append('file', this.file);
                    formData.append('token', this.token);
                    var config = {
                        headers: {
                            'Content-Type': 'multipart/form-data'
                        }
                    };
                    this.tempTableData = this.tableData;
                    this.tableData = [];
                    this.listLoading = true;
                    var flag = false
                    var hh;
                    var url = baseURL + "invoice/borrow/importGh";
                    this.$http.post(url, formData, config).then(function (response) {
                        this.listLoading = false;
                        flag = true;
                        if(response.data.code !=undefined && response.data.code == 401) {
                            return;
                        }
                        this.selectFileFlag = '';
                        this.file = '';
                        // if(response.data.errorCount>0){
                        //     alert("请检查数据是否完整！");
                        //     return;
                        // }
                        if (response.data.success) {
                            alert("共计导入" + (response.data.reason + response.data.errorCount) + "条，成功" + response.data.reason + "条，未填归还人"+response.data.errorCount+"条"
                            );
                            vm.onSubmit();
                            this.selectFileFlag = '';
                            this.file = '';
                            $("#upload_form")[0].reset();
                            // alert('批量导入成功');

                        }
                        else {
                            alert(response.data.reason);
                        }
                    })
                    var intervelId = setInterval(function () {
                        if (flag) {
                            hh=$(document).height();
                            $("body",parent.document).find("#myiframe").css('height',hh+'px');
                            clearInterval(intervelId);
                            return;
                        }
                    },50);
                }
            },
            changeFun: function (row) {
                this.multipleSelection = row;
            },
            handleClick(row) {
                var loadingInstance = this.$loading({
                    text: '正在拼命加载中',
                    target: document.querySelector('.tableData')
                });
                var reqParam = {
                    buyerTaxNo: row.gfTaxNo,
                    invoiceType: row.invoiceType,
                    invoiceCode: row.invoiceCode,
                    invoiceNo: row.invoiceNo,
                    invoiceDate: row.invoiceDate == null ? "" : this.formatDate(row.invoiceDate, false),
                    checkCode: row.checkCode,
                    invoiceAmount: row.invoiceAmount
                };
                this.$http.post(baseURL + sysUrl.detailedInvoiceHandle,
                    reqParam, {
                        'headers': {
                            "token": token
                        }
                    }).then(function (response) {
                    loadingInstance.close();
                    alert(response.data.resultTip);
                    this.findAll(1);
                },(err)=>{
                    loadingInstance.close();
                    if(err.status == 408) {
                        alert(err.statusText);
                    }
                }).catch(function (response) {
                    loadingInstance.close();
                    alert(response.data.msg);
                });
            },
            numberChange(val) {
                var reg = /[^\d]/g;
                this.formInline.invoiceNo = val.replace(reg, '');
            },
            numberChangeBinding(val) {
                var reg = /[^\d]/g;
                this.formInline.bindingNo = val.replace(reg, '');
            },
            numberOnKey(event) {
                this.numberChange(event.target._value);
            },
            numberOnKeyBingding(event) {
                this.numberChangeBinding(event.target._value);
            },
            numberOnKeyVenderId(event) {
                this.numberChangeVenderId(event.target._value);
            },
            numberChangeVenderId(val) {
                var reg = /[^\d]/g;
                this.formInline.venderId = val.replace(reg, '');
            },
            companyCodeChange(val) {
                var reg =/[\W]/g;
                this.formInline.companyCode = val.replace(reg, '');
            },
            companyCodeOnKey(event) {
                this.companyCodeChange(event.target._value);
            },
            packNoChange(val) {
                var reg =/[\W]/g;
                this.formInline.packingNo = val.replace(reg, '');
            },
            packNoOnKey(event) {
                this.packNoChange(event.target._value);
            },
            certificateChange(val) {
                var reg =/[\W]/g;
                this.formInline.certificateNo = val.replace(reg, '');
            },
            certificateOnKey(event) {
                this.certificateChange(event.target._value);
            },
            /**
             * 行号 - 发票采集注列表
             */
            mainIndex: function (index) {
                return index + (this.currentPage - 1) * this.pageSize + 1;
            }
        }
    });
    function format2(value) {
        if (value < 10) {
            return "0" + value;
        } else {
            return value;
        }
    }
</script>
</html>