
<!DOCTYPE html>
<!--suppress ALL -->
<html lang="ZH">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" href="../../libs/customer/index.css">
    <style type="text/css">


        [v-cloak] {
            display: none;
        }

        #appForm > form > div.el-form-item:first-child input {
            padding-right: 0.4rem !important;
            cursor: text;
        }
    </style>
</head>
<body>
<iframe id="ifile" style="display:none"></iframe>
<div id="vm" v-cloak>
    <div id="appForm">
        <el-form ref="formInline" name="formInline"  :model="formInline" :rules="rules" class="demo-form-inline" label-width="1.0rem">
            <el-row>
                <el-col :span="12">
            <el-form-item label="购方名称:">
                <el-select v-model="formInline.gfName" id="gf-select"
                           filterable @focus="gfNameFocus" @blur="gfNameBlur">
                    <el-option
                            v-for="item in options"
                            :key="item.orgName"
                            :label="item.orgName"
                            :value="item.orgTaxNo">
                    </el-option>
                </el-select>
            </el-form-item>
                </el-col>
                <el-col :span="14">
            <el-form-item label="采集日期:" prop="createDate" id="requireMsg2">
                <el-row>
                <el-col :span="13">
                    <el-date-picker @blur="blurpickerchange(1)" @focus="focuspickerchange(1)" type="date" id="datevalue1"
                                    placeholder="选择日期" v-model="formInline.createStartDate"
                                    :picker-options="createDateOptions"
                                    :clearable="false" :editable="false" value-format="yyyy-MM-dd"></el-date-picker>
                </el-col>
                <el-col class="line" :span="2" style="margin-top:0.1rem;">—</el-col>
                <el-col :span="13">
                    <el-date-picker type="date" placeholder="选择日期" v-model="formInline.createEndDate" id="datevalue2"
                                    @blur="blurpickerchange(2)" @focus="focuspickerchange(2)"
                                    :picker-options="createEndDateOptions"
                                    :clearable="false" :editable="false" value-format="yyyy-MM-dd"></el-date-picker>
                </el-col>
                </el-row>
            </el-form-item>
                </el-col>
            <el-col :span="1" :offset="1">
                <el-button class="btnexport" @click="onSubmit">查询</el-button>
            </el-col>
                <el-col :span="1" :offset="1">
                <el-button class="btnexport" @click="exportData()"  :disabled="total == 0">导出</el-button>
                </el-col>
            </el-row>
        </el-form>
    </div>
    <hr>
    <div v-show="tableShow">
        <div class="total">
            <span>合计数量: {{total}}条, 合计金额: {{summationTotalAmount}}元, 合计税额: {{summationTaxAmount}}元</span>

        </div>
        <el-table height="4rem" border fit :data="tableData" class="tableData" highlight-current-row
                  style="width: 100%;font-size: 0.12rem;">
            <el-table-column :show-overflow-tooltip="true"  type="index" width="70" :index="invoiceCollectIndex" label="序号" align="center"></el-table-column>
            <el-table-column :show-overflow-tooltip="true"  prop="createDate" label="采集日期" :formatter="formatCreateDate"
                             align="center"></el-table-column>
            <el-table-column :show-overflow-tooltip="true"  prop="gfTaxNo" label="购方税号" align="left" header-align="center">
                <template scope="scope">
                    <a href="javascript:void(0);" @click="clickTaxNo(scope.row)"><span
                            class="column-span">{{ scope.row.gfTaxNo }}</span></a>
                </template>
            </el-table-column>
            <el-table-column :show-overflow-tooltip="true"  prop="gfName" label="购方名称" :show-overflow-tooltip="true" align="left"
                             header-align="center" :formatter="formatterNull"></el-table-column>
            <el-table-column :show-overflow-tooltip="true"  prop="collectCount" label="采集数量合计" align="right" header-align="center"></el-table-column>
            <el-table-column :show-overflow-tooltip="true"  prop="sumTotalAmount" label="金额合计" align="right" header-align="center"
                             :formatter="numberFormat"></el-table-column>
            <el-table-column :show-overflow-tooltip="true"  prop="sumTaxAmount" label="税额合计" align="right" header-align="center"
                             :formatter="numberFormat"></el-table-column>
        </el-table>
        <el-col class="toolbar" style="padding:0.1rem;">
            <el-pagination background @current-change="currentChange" @size-change="handleSizeChange"
                           :current-page="currentPage"
                           :page-size="pageSize" :page-sizes="pageList" :pager-count="pagerCount"
                           layout="slot, sizes, prev, pager, next" :total="total" style="float:right">
                <span>共{{total}}条记录，第{{currentPage}}页，共{{totalPage}}页</span>
            </el-pagination>
        </el-col>
    </div>

    <el-dialog title="发票信息" :visible.sync="dialogTableVisible" width="80%" :before-close="beforeCloseUpdateWin" :close-on-click-modal="false">
        <el-table height="4rem" border fit :data="gridData" highlight-current-row
                  style="width: 100%;font-size: 0.12rem;"
                  v-loading="gridDataLoading"
                  element-loading-text="正在拼命加载中"
        >
            <el-table-column :show-overflow-tooltip="true"  type="index" width="70" :index="gridDataIndex" label="序号" align="center"></el-table-column>
            <el-table-column :show-overflow-tooltip="true"  property="invoiceCode" label="发票代码" align="left" header-align="center"></el-table-column>
            <el-table-column :show-overflow-tooltip="true"  property="invoiceNo" label="发票号码" width="120" align="left"
                             header-align="center">
                <template scope="scope">
                    <span>{{ scope.row.invoiceNo }}</span>
                    <el-tooltip class="item" effect="dark" placement="top-start">
                        <div slot="content" v-if="scope.row.invoiceType== '01' ">增值税专用发票</div>
                        <img v-if="scope.row.invoiceType== '01'" style="height:0.2rem;" src="../../img/special-invoice.png" />
                        <div slot="content" v-if="scope.row.invoiceType== '03' ">机动车销售统一发票</div>
                        <img v-if="scope.row.invoiceType== '03' " style="height:0.2rem;" src="../../img/motor-vehicles.png" />
                        <div slot="content" v-if="scope.row.invoiceType== '04' ">增值税普通发票</div>
                        <img v-if="scope.row.invoiceType=== '04' "
                             style="height:0.2rem;" src="../../img/plain-invoice.png"  />
                        <div slot="content" v-if="scope.row.invoiceType== '10' ">增值税电子普通发票</div>
                        <img v-if="scope.row.invoiceType== '10' " style="height:0.2rem;" src="../../img/einvoice.png"/>
                        <div slot="content" v-if="scope.row.invoiceType== '11' ">增值税普通发票（卷票）</div>
                        <img v-if="scope.row.invoiceType=== '11' "
                             style="height:0.2rem;" src="../../img/roll-invoice.png" />
                        <div slot="content" v-if="scope.row.invoiceType== '14' ">增值税电子普通发票（通行费）</div>
                        <img v-if="scope.row.invoiceType== '14' " style="height:0.2rem;" src="../../img/general-invoice.png"/>
                    </el-tooltip>
                </template>
            </el-table-column>
            <el-table-column :show-overflow-tooltip="true"  property="openInvoiceDate" label="开票日期" width="120" align="center"></el-table-column>
            <el-table-column :show-overflow-tooltip="true"  property="gfName" label="购方名称" :show-overflow-tooltip="true" align="left"
                             header-align="center" :formatter="formatterNull"></el-table-column>
            <el-table-column :show-overflow-tooltip="true"  property="xfName" label="销方名称" :show-overflow-tooltip="true" align="left"
                             header-align="center" :formatter="formatterNull"></el-table-column>
            <el-table-column :show-overflow-tooltip="true"  property="invoiceAmount" label="金额" align="right"
                             header-align="center" :formatter="numberFormat"></el-table-column>
            <el-table-column :show-overflow-tooltip="true"  property="taxAmount" label="税额"  align="right"
                             header-align="center" :formatter="numberFormat"></el-table-column>
        </el-table>
        <el-col class="toolbar" style="padding:0.1rem;">
            <el-pagination background @current-change="findGridDataAll" @size-change="handleGridDataSizeChange"
                           :current-page="gridDataCurrentPage" :page-size="gridDataPageSize" :page-sizes="pageList"
                           :pager-count="pagerCount"
                           layout="slot, sizes, prev, pager, next" :total="gridDataTotal" style="float:right">
                <span>共{{gridDataTotal}}条记录，第{{gridDataCurrentPage}}页，共{{gridDataTotalPage}}页</span>
            </el-pagination>
        </el-col>
        <span slot="footer" class="dialog-footer">

        </span>
    </el-dialog>
</div>
</body>
<script type="text/javascript" charset="utf-8" src="../../js/customer/resource.js"></script>
<script type="text/babel">
    Vue.http.options.emulateJSON = true;
    Vue.http.options.emulateHTTP = true;
    new Vue({
        el: '#vm',
        i18n,
        data: {
            tableShow: true,
            tableData: [],
            gridData: [],
            currentPage: 1,
            pagerCount: PAGE_PARENT.PAGER_COUNT,
            pageSize: PAGE_PARENT.PAGE_SIZE,
            pageList: PAGE_PARENT.PAGE_LIST,
            totalPage: 1,
            total: 0,
            summationTotalAmount: '0.00',
            summationTaxAmount: '0.00',
            gridDataTotal: 0,
            gridDataCurrentPage: 1,
            gridDataTotalPage: 1,
            gridDataPageSize: PAGE_PARENT.PAGE_SIZE,
            dialogTableVisible: false,
            options: [],
            createDateOptions: {},
            createEndDateOptions: {},
            formInline: {
                gfName: '',
                createStartDate: new Date().getFullYear() + "-" + format2(new Date().getMonth()+1) + "-01",
                createEndDate: new Date().getFullYear()+"-"+format2(new Date().getMonth()+1)+"-"+format2(new Date().getDate())
            },
            exportParam: {},
            gridDataLoading: false,
            rules:{}
        },
        mounted: function () {
            this.createDateOptions = {
                disabledDate: (time) => {
                    return time.getTime() >= Date.now();
                }
            };
            this.createEndDateOptions = {
                disabledDate: (time) => {
                    return time.getTime() >= Date.now();
                }
            };

            this.rules = {
                createDate: [
                    {
                        /*validator: (rule, value, callback) => {
                            setTimeout(() => {
                                const createEndTime = new Date(this.formatDateTime(this.formInline.createEndDate));
                                const createStartTime = new Date(this.formatDateTime(this.formInline.createStartDate));
                                const sixMonthSub = createEndTime.setMonth(createEndTime.getMonth() - 6);
                                createEndTime.setMonth(createEndTime.getMonth() + 6);
                                if(sixMonthSub > createStartTime) {
                                    callback(new Error('日期选择跨度不可超过半年'));
                                }
                                if(createStartTime > createEndTime) {
                                    callback(new Error('结束时间不可小于开始时间'));
                                }
                            }, 200);
                        }, trigger: 'blur'*/
                    }
                ]
            };

            this.getGfName();

            $("#gf-select").attr("maxlength","50");
        },
        methods: {
            gfNameFocus: function (event) {
                $(".el-select input").removeAttr('readonly');
            },
            gfNameBlur: function (event) {
                $(".el-select input").attr('readonly','readonly');
            },
            focuspickerchange: function (val) {
                if (val == 1) {
                    $('#datevalue1').siblings('span.el-input__suffix').css('background', '#ffaa00');
                    $('#datevalue1').siblings('span.el-input__prefix').children('i').css('color', '#333333');
                } else if (val == 2) {
                    $('#datevalue2').siblings('span.el-input__suffix').css('background', '#ffaa00');
                    $('#datevalue2').siblings('span.el-input__prefix').children('i').css('color', '#333333');
                }else if(val==3){
                    $('#datevalue3').siblings('span.el-input__suffix').css('background', '#ffaa00');
                    $('#datevalue3').siblings('span.el-input__prefix').children('i').css('color', '#333333');
                }
            },
            blurpickerchange: function (val) {
                if (val == 1) {
                    $('#datevalue1').siblings('span.el-input__suffix').css('background', 'white');
                    $('#datevalue1').siblings('span.el-input__prefix').children('i').css('color', '#ffaa00');
                } else if (val == 2) {
                    $('#datevalue2').siblings('span.el-input__suffix').css('background', 'white');
                    $('#datevalue2').siblings('span.el-input__prefix').children('i').css('color', '#ffaa00');
                }else if(val==3){
                    $('#datevalue3').siblings('span.el-input__suffix').css('background', 'white');
                    $('#datevalue3').siblings('span.el-input__prefix').children('i').css('color', '#ffaa00');
                }
            },
            currentChange: function(val) {
                if(this.total > 0) {
                    this.findAll(val);
                }
            },
            handleGridDataSizeChange: function(val) {
                this.gridDataPageSize = val;
                this.findGridDataAll(1);
            },
            handleSizeChange: function (val) {
                this.pageSize = val;
                if(this.total > 0) {
                    this.findAll(1);
                }
            },
            findAll: function (currentPage) {
                var qsStartDate = new Date(this.formInline.createStartDate);
                var qsEndDate = new Date(this.formInline.createEndDate);
                qsStartDate.setMonth(qsStartDate.getMonth() + 12);
                $(".checkMsg").remove();
                if ( (qsEndDate.getTime() + 1000*60*60*24) > qsStartDate.getTime()) {
                    $("#requireMsg2 .el-form-item__content div.el-date-editor:first-child").append('<div class="checkMsg">日期选择跨度不可超过1年</div>');
                    return ;
                }else if(qsEndDate.getTime()<new Date(this.formInline.createStartDate)){
                    $("#requireMsg2 .el-form-item__content div.el-date-editor:first-child").append('<div class="checkMsg">结束时间不可小于开始时间</div>');
                    return;
                }
                var loadingInstance = this.$loading({
                    text: '正在拼命加载中',
                    target: document.querySelector('.tableData')
                });
                if (!isNaN(currentPage)) {
                    this.currentPage = currentPage;
                }
                const params_ = {
                    page: this.currentPage,
                    limit: this.pageSize,
                    sidx: '',
                    order: 'desc',
                    gfTaxNo: this.formInline.gfName,
                    createStartDate: this.formatDateTime(this.formInline.createStartDate),
                    createEndDate: this.formatDateTime(this.formInline.createEndDate)
                };
                this.exportParam = params_;
                this.$http.post(baseURL + sysUrl.collectListQueryPaged,
                    params_, {
                        'headers': {
                            "token": token
                        }
                    }).then(function (response) {
                    loadingInstance.close();
                    if (response.data.code != 0 && response.data.code != 401) {
                        alert(response.data.msg);
                        return;
                    }
                    this.total = response.data.page.totalCount;
                    this.totalPage = response.data.page.totalPage;
                    if (response.data.page.totalCount > 0) {
                        this.summationTotalAmount = this.numberFormat('','',response.data.page.summationTotalAmount);
                        this.summationTaxAmount = this.numberFormat('','',response.data.page.summationTaxAmount);
                    } else {
                        this.summationTotalAmount = '0.00';
                        this.summationTaxAmount = '0.00';
                    }
                    this.tableData = [];
                    for (const key in response.data.page.list) {
                        this.$set(this.tableData, key, response.data.page.list[key]);
                    }

                },(err)=>{
                    loadingInstance.close();
                    if(err.status == 408) {
                        alert(err.statusText);
                    }
                }).catch(function (response) {
                    loadingInstance.close();
                    alert(response.data.msg);
                });
            },
            getGfName: function () {
                this.$http.post(baseURL + sysUrl.collectionTaxName,
                    {}, {
                        'headers': {
                            "token": token
                        }
                    }).then(function (response) {
                    response.data.splice(0, 0, {orgName: "全部", orgTaxNo: ''});
                    for (const i in response.data) {
                        this.$set(this.options, i, response.data[i]);
                    }
                }).catch(function (response) {
                    alert(response.data.msg);
                });
            },
            formatDateTime: function (time) {
                const date = new Date(time.toString().replace(/-/g, "/"));
                const seperator1 = "-";
                const seperator2 = ":";
                var month = date.getMonth() + 1;
                let strDate = date.getDate();
                if (month >= 1 && month <= 9) {
                    month = "0" + month;
                }
                if (strDate >= 0 && strDate <= 9) {
                    strDate = "0" + strDate;
                }
                return date.getFullYear() + seperator1 + month + seperator1 + strDate;
            },
            formatDate: function (time) {
                const date = new Date(time.toString().replace(/-/g, "/"));
                const seperator1 = "-";
                const seperator2 = ":";
                var month = date.getMonth() + 1;
                let strDate = date.getDate();
                if (month >= 1 && month <= 9) {
                    month = "0" + month;
                }
                if (strDate >= 0 && strDate <= 9) {
                    strDate = "0" + strDate;
                }
                return date.getFullYear() + seperator1 + month + seperator1 + strDate + " " + date.getHours() + seperator2 + date.getMinutes() + seperator2 + date.getSeconds();
            }, formatCreateDate: function (row, column) {
                if (row.createDate != null) {
                    return this.formatDateTime(row.createDate);
                } else {
                    return "一 一";
                }
            },
            beforeCloseUpdateWin() {
                this.dialogTableVisible = false;
                this.gridData = [];
            },
            exportData() {
                const me = this;
                const params_ = {
                    gfTaxNo: me.exportParam.gfTaxNo,
                    createStartDate: me.formatDateTime(me.exportParam.createStartDate),
                    createEndDate: me.formatDateTime(me.exportParam.createEndDate)
                };
                $.ajax({
                    url:baseURL + 'excel/apply',
                    type:"POST",
                    data:{'serviceType':54,'condition':JSON.stringify(params_)},
                    success:function (r) {
                        flag = true;
                        if(r.code==0){
                            alert(r.data);
                            // $('#totalStatistics').html("合计数量: "+vm.total+"条, 合计金额: "+
                            //     formatMoney(r.page.summationTotalAmount)+"元, 合计税额: "+formatMoney(r.page.summationTaxAmount)+"元");

                        }

                    }
                });
                //document.getElementById("ifile").src = baseURL + sysUrl.collectListExport + '?gfTaxNo=' + params_.gfTaxNo + '&createStartDate=' + params_.createStartDate + '&createEndDate=' + params_.createEndDate;
            },
            onSubmit() {
                this.tableShow = true;
                this.findAll(1);
            },
            clickTaxNo(row) {
                this.dialogTableVisible = true;
                this.gridDataLoading = true;
                this.rowData = row;
                this.findGridDataAll(1);
            },
            findGridDataAll(gridDataCurrentPage) {
                if (!isNaN(gridDataCurrentPage)) {
                    this.gridDataCurrentPage = gridDataCurrentPage;
                }
                const params_ = {
                    page: this.gridDataCurrentPage,
                    limit: this.gridDataPageSize,
                    sidx: '',
                    order: 'desc',
                    gfTaxNo: this.rowData.gfTaxNo,
                    createDate: this.rowData.createDate
                };
                this.$http.post(baseURL + sysUrl.collectListByTaxNo,
                    params_, {
                        'headers': {
                            "token": token
                        }
                    }).then(function (response) {
                    this.gridDataLoading = false;
                    this.gridDataTotal = response.data.page.totalCount;
                    this.gridDataTotalPage = response.data.page.totalPage;
                    this.gridData = [];
                    for (const key in response.data.page.list) {
                        this.$set(this.gridData, key, response.data.page.list[key]);
                    }
                }, (err) => {
                    this.gridDataLoading = false;
                    if(err.status == 408) {
                        alert(err.statusText);
                    }
                }).catch(function (response) {
                    this.gridDataLoading = false;
                    alert(response.data.msg);
                });
            },
            /**
             * 行号 - 发票采集注列表
             */
            invoiceCollectIndex: function (index) {
                return index + (this.currentPage - 1) * this.pageSize + 1;
            },
            /**
             * 行号 - 发票信息
             */
            gridDataIndex: function (index) {
                return index + (this.gridDataCurrentPage - 1) * this.gridDataPageSize + 1;
            }
        }
    });
    function format2(value) {
        if (value < 10) {
            return "0" + value;
        } else {
            return value;
        }
    }
</script>
</html>