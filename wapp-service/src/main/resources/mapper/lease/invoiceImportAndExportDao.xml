<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.lease.dao.InvoiceImportAndExportDao">


    <select id="invoiceImportAndExportlist" resultType="com.xforceplus.wapp.modules.lease.entity.InvoiceImportAndExportEntity">
        SELECT
        <if test=" map.limit != null">
            TOP (#{map.limit})
        </if>
        A.*
        FROM
        (
        SELECT
        row_number () OVER (ORDER BY o.id DESC) AS rownumber ,o.*
        FROM
        (
        select
        id,
        company_code     companyCode,
        invoice_code     invoiceCode,
        invoice_type     invoiceType,
        invoice_no       invoiceNo,
        venderid         venderId,
        vendername       venderName,
        tax_amount       taxAmount,
        tax_rate         taxRate,
        invoice_amount   invoiceAmount,
        total_amount     totalAmount,
        invoice_date     invoiceDate,
        remark           reMark,
        jvcode           jvCode,
        shop_no          shopNo,
        period           peRiod,
        fixed_matching         matChing,
        fixed_matching_date    matChingDate,
        sap,
        sap_date sapDate,
        fixed_tax_code    taxCode
        from t_dx_record_invoice WITH(NOLOCK)
        where
        1=1
        and flow_type=6
        <if test="map.jvCode != null and map.jvCode != '' and map.jvCode != '-1'">
            and jvcode like concat('%',concat(#{map.jvCode},'%'))
        </if>
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
        </if>
        <if test="map.matching != null and map.matching != '' and map.matching !='-1'">
            and fixed_matching= #{map.matching}
        </if>
        <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23) >= #{map.invoiceDate1} ]]>
        </if>
        <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23)  <= #{map.invoiceDate2} ]]>
        </if>
        <if test="map.invoiceDate3 != null and map.invoiceDate3 != ''">
            <![CDATA[ AND convert(varchar(100),qs_date,23) >= #{map.invoiceDate3} ]]>
        </if>
        <if test="map.invoiceDate4 != null and map.invoiceDate4 != ''">
            <![CDATA[ AND convert(varchar(100),qs_date,23)  <= #{map.invoiceDate4} ]]>
        </if>
        <!--<if test="map.invoiceStatus !=null and map.invoiceStatus != '-1'">-->
            <!--and m.invoice_status = #{map.invoiceStatus}-->
        <!--</if>-->
        <!--<if test="map.invoiceType !=null and map.invoiceType != '-1'">-->
            <!--and m.invoice_type = #{map.invoiceType}-->
        <!--</if>-->
        <!--<if test="map.qsStatus !=null and map.qsStatus != '-1'">-->
            <!--and m.qs_status = #{map.qsStatus}-->
        <!--</if>-->
        <if test="map.companyCode != null and map.companyCode != ''">
            and company_code = #{map.companyCode}
       </if>
       <!--<if test="map.invoiceType !=null and map.invoiceType != '-1' and map.invoiceType != '-2'">-->
            <!--and m.invoice_type = #{map.invoiceType}-->
       <!--</if>-->
         <!--<if test="map.invoiceType == '-2'">-->
            <!--and m.invoice_type in ('01','04')-->
       <!--</if>-->
       <if test="map.venderId != null and map.venderId != ''">
             and venderid = #{map.venderId}
        </if>

        ) AS o
        ) A
        WHERE 1=1

        <if test="map.offset != null ">
            and   rownumber > #{map.offset}
        </if>

    </select>

    <!--查询发票信息条数-->
    <select id="invoiceImportAndExportlistCount" resultType="Integer">
        select count(1)
        from t_dx_record_invoice m WITH(NOLOCK)
        where
        1=1
        and flow_type=6
        <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
            <![CDATA[ AND convert(varchar(100),m.invoice_date,23) >= #{map.invoiceDate1} ]]>
        </if>
        <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
            <![CDATA[ AND convert(varchar(100),m.invoice_date,23)  <= #{map.invoiceDate2} ]]>
        </if>
        <if test="map.invoiceDate3 != null and map.invoiceDate3 != ''">
            <![CDATA[ AND convert(varchar(100),qs_date,23) >= #{map.invoiceDate3} ]]>
        </if>
        <if test="map.invoiceDate4 != null and map.invoiceDate4 != ''">
            <![CDATA[ AND convert(varchar(100),qs_date,23)  <= #{map.invoiceDate4} ]]>
        </if>
            <if test="map.jvCode != null and map.jvCode != ''and map.jvCode != '-1'">
                and m.jvcode like concat('%',concat(#{map.jvCode},'%'))
            </if>
            <if test="map.invoiceNo != null and map.invoiceNo != ''">
                and m.invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
            </if>
            <if test="map.companyCode != null and map.companyCode != ''">
                and m.company_code = #{map.companyCode}
            </if>
            <if test="map.venderId != null and map.venderId != ''">
                and m.venderid = #{map.venderId}
            </if>
            <if test="map.matching != null and map.matching != '' and map.matching !='-1'">
                and fixed_matching= #{map.matching}
            </if>

    </select>

    <select id="invoiceImportAndExportlistAll" resultType="com.xforceplus.wapp.modules.lease.entity.InvoiceImportAndExportEntity">
        select
        id,
        company_code     companyCode,
        invoice_code     invoiceCode,
        invoice_type     invoiceType,
        invoice_no       invoiceNo,
        venderid         venderId,
        vendername       venderName,
        tax_amount       taxAmount,
        tax_rate         taxRate,
        invoice_amount   invoiceAmount,
        invoice_date     invoiceDate,
        total_amount     totalAmount,
        remark           reMark,
        jvcode           jvCode,
        shop_no          shopNo,
        period           peRiod,
        fixed_matching         matChing,
        fixed_matching_date    matChingDate,
        fixed_tax_code    taxCode
        from t_dx_record_invoice m WITH(NOLOCK)
        where 1=1
        and flow_type=6
        <if test="map.jvCode != null and map.jvCode != ''and map.jvCode != '-1'">
            and m.jvcode like concat('%',concat(#{map.jvCode},'%'))
        </if>
        <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
            <![CDATA[ AND convert(varchar(100),m.invoice_date,23) >= #{map.invoiceDate1} ]]>
        </if>
        <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
            <![CDATA[ AND convert(varchar(100),m.invoice_date,23)  <= #{map.invoiceDate2} ]]>
        </if>
        <if test="map.invoiceDate3 != null and map.invoiceDate3 != ''">
            <![CDATA[ AND convert(varchar(100),qs_date,23) >= #{map.invoiceDate3} ]]>
        </if>
        <if test="map.invoiceDate4 != null and map.invoiceDate4 != ''">
            <![CDATA[ AND convert(varchar(100),qs_date,23)  <= #{map.invoiceDate4} ]]>
        </if>
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and m.invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
        </if>
        <if test="map.companyCode != null and map.companyCode != ''">
            and m.company_code = #{map.companyCode}
        </if>
        <if test="map.venderId != null and map.venderId != ''">
            and m.venderid = #{map.venderId}
        </if>
        <if test="map.matching != null and map.matching != '' and map.matching !='-1'">
            and fixed_matching= #{map.matching}
        </if>
        ORDER BY m.id DESC
    </select>

    <update id="invoiceImportAndExportUpdate">
        update t_dx_record_invoice with(rowlock)
        set
         shop_no =     #{map.shopNo},
        period =       #{map.peRiod},
        fixed_matching  =    #{map.matChing},
        fixed_matching_date = #{map.matChingDate},
        fixed_tax_code=#{map.taxCode}
        where id = #{map.id}
    </update>
</mapper>