<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xforceplus.wapp.modules.businessData.dao.ReturngoodsDao">

    <resultMap id="returnGoodsMap" type="com.xforceplus.wapp.modules.businessData.entity.ReturngoodsEntity">
        <id column="id" property="id"/>
        <result column="return_goods_code" property="returnGoodsCode"/>
        <result column="supplier_association" property="supplierAssociation"/>
        <result column="return_goods_date" property="returnGoodsDate"/>
        <result column="return_goods_amount" property="returnGoodsAmount"/>
        <result column="return_cost_amount" property="returncostAmount"/>
        <result column="return_goods_status" property="returnGoodsStatus"/>
        <result column="redticket_data_serial_number" property="redticketDataSerialNumber"/>

    </resultMap>

    <select id="getReturnGoodsList" resultMap="returnGoodsMap">
        <if test="map.offset != null and map.limit != null">
            SELECT
            TOP (#{map.limit}) A.*
            FROM
            (
            SELECT
            row_number () OVER (ORDER BY id desc) AS rownumber, o.*
            FROM
            (
        </if>
        select
        id,return_goods_code,supplier_association,
        return_goods_date,return_goods_amount,
        return_cost_amount,return_goods_status,
        redticket_data_serial_number

        from t_dx_return_goods r WITH(NOLOCK)
        LEFT JOIN t_ac_user u WITH(NOLOCK) ON r.supplier_association = u.usercode
        <where>
            <if test="map.userCode != null and map.userCode != ''">
              and  r.supplier_association = #{map.userCode}
            </if>
            <if test="map.returnGoodsCode != null and map.returnGoodsCode != ''">
                and r.return_goods_code  = #{map.returnGoodsCode}
            </if>
            <if test="map.returnGoodsStatus != null and map.returnGoodsStatus != '' and map.returnGoodsStatus != '-1'">
                and r.return_goods_status  = #{map.returnGoodsStatus}
            </if>
        </where>
        <if test="map.offset != null and map.limit != null">
            )
            AS o
            )A
            WHERE
            rownumber >#{map.offset}
        </if>
    </select>

    <select id="returnGoodsQueryCount" resultType="Integer">
        SELECT count(1) FROM t_dx_return_goods r WITH(NOLOCK)
        LEFT JOIN t_ac_user u WITH(NOLOCK) ON r.supplier_association = u.usercode
        <where>
            <if test="map.userCode != null and map.userCode != ''">
                and  r.supplier_association = #{map.userCode}
            </if>
            <if test="map.returnGoodsCode != null and map.returnGoodsCode != ''">
                and r.return_goods_code  = #{map.returnGoodsCode}
            </if>
            <if test="map.returnGoodsStatus != null and map.returnGoodsStatus != '' and map.returnGoodsStatus != '-1'">
                and r.return_goods_status  = #{map.returnGoodsStatus}
            </if>
        </where>
    </select>

    <select id="returnGoodsQueryRedCount" resultType="Integer">
        SELECT count(1) FROM t_dx_return_goods r WITH(NOLOCK)
        LEFT JOIN t_ac_user u WITH(NOLOCK) ON r.supplier_association = u.usercode
        <where>
            and r.redticket_data_serial_number IS null
            <if test="map.userCode != null and map.userCode != ''">
                and  r.supplier_association = #{map.userCode}
            </if>
            <if test="map.returnGoodsCode != null and map.returnGoodsCode != ''">
                and r.return_goods_code  = #{map.returnGoodsCode}
            </if>
            <if test="map.returnGoodsStatus != null and map.returnGoodsStatus != '' and map.returnGoodsStatus != '-1'">
                and r.return_goods_status  = #{map.returnGoodsStatus}
            </if>
        </where>
    </select>

    <update id="redRushreturnGoods">
        UPDATE t_dx_all_record_invoice_detail
        SET
        return_goods_status='1',
        redticket_data_serial_number=#{redTicketNumber}
        <where>
            <if test="userCode != null and userCode != ''">
                and  supplier_association = #{userCode}
            </if>
            <if test="map.returnGoodsCode != null and map.returnGoodsCode != ''">
                and return_goods_code  = #{map.returnGoodsCode}
            </if>
        </where>
    </update>

</mapper>