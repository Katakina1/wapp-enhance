<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.businessData.dao.AgreementDao">

    <select id="getAgreementList" resultType="com.xforceplus.wapp.modules.businessData.entity.AgreementEntity" >
        <if test="map.offset != null and map.limit != null">
            SELECT
            TOP (#{map.limit}) A.*
            FROM
            (
            SELECT
            row_number () OVER (ORDER BY id desc) AS rownumber, o.*
            FROM
            (
        </if>
        select
         id                              id,
         agreement_code                  agreementCode,
         supplier_association            supplierAssociation,
         agreement_date                  agreementDate,
         agreement_amount                agreementAmount,
         agreement_cost_amount           agreementCostAmount,
         agreement_status                agreementStatus,
         redticket_data_serial_number    redticketDataSerialNumber,
         description
		from t_dx_agreement_table a
        LEFT JOIN t_ac_user u WITH(NOLOCK) ON a.supplier_association = u.usercode
		<where>
            <if test="map.userCode != null and map.userCode != ''">
                and a.supplier_association = #{map.userCode}
            </if>
            <if test="map.agreementCode != null and map.agreementCode != ''">
                and a.agreement_code  = #{map.agreementCode}
            </if>
            <if test="map.agreementStatus != null and map.agreementStatus != '' and map.agreementStatus != '-1'">
                and a.agreement_status  = #{map.agreementStatus}
            </if>
            <if test="map.orgname != null and map.orgname != ''">
                and a.gfname  = #{map.orgname}
            </if>
            <if test="map.invoiceDate3 != null and map.invoiceDate3 != ''">
                <![CDATA[ AND convert(varchar(100),a.agreement_date,23) >= #{map.invoiceDate3} ]]>
            </if>
            <if test="map.invoiceDate4 != null and map.invoiceDate4 != ''">
                <![CDATA[ AND convert(varchar(10),a.agreement_date,23)  <= #{map.invoiceDate4} ]]>
                and a.redticket_data_serial_number IS null
            </if>
        </where>
        <if test="map.offset != null and map.limit != null">
            )
            AS o
            )A
            WHERE
            rownumber >#{map.offset}
        </if>
	</select>

    <select id="agreementQueryCount" resultType="Integer">
        SELECT count(1) FROM t_dx_agreement_table a
        LEFT JOIN t_ac_user u WITH(NOLOCK) ON a.supplier_association = u.usercode
        <where>
            <if test="map.userCode != null and map.userCode != ''">
                and a.supplier_association = #{map.userCode}
            </if>
            <if test="map.agreementCode != null and map.agreementCode != ''">
                and a.agreement_code  = #{map.agreementCode}
            </if>
            <if test="map.agreementStatus != null and map.agreementStatus != '' and map.agreementStatus != '-1'">
                and a.agreement_status  = #{map.agreementStatus}
            </if>
        </where>
    </select>

    <select id="agreementQueryRedCount" resultType="Integer">
        SELECT count(1) FROM t_dx_agreement_table a
        LEFT JOIN t_ac_user u WITH(NOLOCK) ON a.supplier_association = u.usercode
        <where>
            and a.redticket_data_serial_number IS null
            <if test="map.userCode != null and map.userCode != ''">
                and a.supplier_association = #{map.userCode}
            </if>
            <if test="map.agreementCode != null and map.agreementCode != ''">
                and a.agreement_code  = #{map.agreementCode}
            </if>
            <if test="map.agreementStatus != null and map.agreementStatus != '' and map.agreementStatus != '-1'">
                and a.agreement_status  = #{map.agreementStatus}
            </if>
        </where>
    </select>

    <update id="redRushAgreement">
        UPDATE t_dx_agreement_table
        SET
        agreement_status='1',
        redticket_data_serial_number=#{redTicketNumber}
        <where>
            <if test="userCode != null and userCode != ''">
                and  supplier_association = #{userCode}
            </if>
            <if test="map.agreementCode != null and map.agreementCode != ''">
                and agreement_code = #{map.agreementCode}
            </if>
        </where>
    </update>

</mapper>