<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.redTicket.dao.AgreementRedTicketInformationDao">

    <select id="protocollist" resultType="com.xforceplus.wapp.modules.redTicket.entity.ProtocolEntity">
        <if test="map.offset != null and map.limit != null">
            SELECT
            TOP (#{map.limit}) A.*
            FROM
            (
            SELECT
            row_number () OVER (ORDER BY id desc) AS rownumber, o.*
            FROM
            (
        </if>
        select
        id,
        protocol_no                   protocolNo,
        vender_id                     venderId,
        dept_no                       deptNo,
        pay_item                      payItem,
        pay_company_code              payCompanyCode,
        amount,
        protocol_status               protocolStatus,
        case_date                     caseDate,
        seq,
        pay_date                      payDate,
        redticket_data_serial_number  redticketDataSerialNumber
        from t_dx_protocol WITH(NOLOCK)
        <where>
            and redticket_data_serial_number is NULL
            and pay_item in
            <foreach item="payItem" collection="map.payItem"  open="(" separator="," close=")">
                #{payItem}
            </foreach>
            <if test="map.payCompanyCode != null and map.payCompanyCode != ''">
                and pay_company_code like concat('%',concat(#{map.payCompanyCode},'%'))
            </if>
            <if test="map.agreementCode != null and map.agreementCode != ''">
                and protocol_no like concat('%',concat(#{map.agreementCode},'%'))
            </if>
            <if test="map.userCode != null and map.userCode != ''">
                and vender_id like concat('%',concat(#{map.userCode},'%'))
            </if>
            <if test="map.invoiceDate3 != null and map.invoiceDate3 != ''">
                <![CDATA[ AND convert(varchar(100),case_date,23) >= #{map.invoiceDate3} ]]>
            </if>
            <if test="map.invoiceDate4 != null and map.invoiceDate4 != ''">
                <![CDATA[ AND convert(varchar(10),case_date,23)  <= #{map.invoiceDate4} ]]>
            </if>
        </where>
        <if test="map.offset != null and map.limit != null">
            )
            AS o
            )A
            WHERE
            rownumber >#{map.offset}
        </if>
    </select>

    <select id="protocolCount" resultType="Integer">
        select count(1)
        from t_dx_protocol WITH(NOLOCK)
        <where>
            and redticket_data_serial_number is NULL
            and pay_item in
            <foreach item="payItem" collection="map.payItem"  open="(" separator="," close=")">
                #{payItem}
            </foreach>
            <if test="map.payCompanyCode != null and map.payCompanyCode != ''">
                and pay_company_code like concat('%',concat(#{map.payCompanyCode},'%'))
            </if>
            <if test="map.agreementCode != null and map.agreementCode != ''">
                and protocol_no like concat('%',concat(#{map.agreementCode},'%'))
            </if>
            <if test="map.userCode != null and map.userCode != ''">
                and vender_id like concat('%',concat(#{map.userCode},'%'))
            </if>
            <if test="map.invoiceDate3 != null and map.invoiceDate3 != ''">
                <![CDATA[ AND convert(varchar(100),case_date,23) >= #{map.invoiceDate3} ]]>
            </if>
            <if test="map.invoiceDate4 != null and map.invoiceDate4 != ''">
                <![CDATA[ AND convert(varchar(10),case_date,23)  <= #{map.invoiceDate4} ]]>
            </if>
        </where>
    </select>

    <select id="protocoldetaillist" resultType="com.xforceplus.wapp.modules.redTicket.entity.ProtocolDetailEntity">
        <if test="map.offset != null and map.limit != null">
            SELECT
            TOP (#{map.limit}) A.*
            FROM
            (
            SELECT
            row_number () OVER (ORDER BY id desc) AS rownumber, o.*
            FROM
            (
        </if>
        select
        id,
        protocol_no     protocolNo,
        vender_id       venderId,
        reason,
        number,
        number_desc     numberDesc,
        detail_amount   detailAmount,
        store
        from t_dx_protocol_detail WITH(NOLOCK)
        <where>
            <if test="map.protocolNo != null and map.protocolNo != ''">
                and protocol_no like concat('%',concat(#{map.protocolNo},'%'))
            </if>
        </where>
        <if test="map.offset != null and map.limit != null">
            )
            AS o
            )A
            WHERE
            rownumber >#{map.offset}
        </if>
    </select>

    <update id="redRushAgreement">
        UPDATE t_dx_protocol
        SET
        redticket_data_serial_number=#{redTicketNumber}
        <where>
            <if test="userCode != null and userCode != ''">
                and  vender_id = #{userCode}
            </if>
            <if test="map.protocolNo != null and map.protocolNo != ''">
                and protocol_no = #{map.protocolNo}
            </if>
        </where>
    </update>

    <select id="getInvoicelist" resultType="com.xforceplus.wapp.modules.redTicket.entity.InvoiceEntity">
        select
        r.id,r.red_money_amount,r.valid,r.settlementAmount,r.invoice_amount,r.matchno
        from t_dx_record_invoice r WITH(NOLOCK),
        (SELECT d.invoice_code,d.invoice_no FROM t_dx_record_invoice_detail d WITH(NOLOCK) WHERE d.redticket_data_serial_number IS NULL
        and CONVERT(DECIMAL(18,4),d.detail_amount)>0  GROUP BY d.invoice_code,d.invoice_no) d
        where r.invoice_code = d.invoice_code
        AND r.invoice_no=d.invoice_no
        and r.rzh_yesorno='1'
        and r.invoice_status in('0','3')
        and r.red_money_amount>0
        and r.invoice_amount>0
        and r.flow_type='1'
        and r.invoice_type='01'
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and r.invoice_no like '%'+#{map.invoiceNo}+'%'
        </if>
        <if test="map.invoiceCode != null and map.invoiceCode != ''">
            and r.invoice_code like '%'+#{map.invoiceCode}+'%'
        </if>
        <if test="map.uuid != null and map.uuid != ''">
            and r.uuid like '%'+#{map.uuid}+'%'
        </if>
        <if test="map.orgcode != null and map.orgcode != ''">
            and r.jvcode like '%'+#{map.orgcode}+'%'
        </if>
        <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
            <![CDATA[ AND convert(varchar(100),r.invoice_date,23) >= #{map.invoiceDate1} ]]>
        </if>
        <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
            <![CDATA[ AND convert(varchar(10),r.invoice_date,23)  <= #{map.invoiceDate2} ]]>
        </if>
        and r.xf_tax_no in (select taxno from t_ac_org WITH(NOLOCK) where orgid in (select orgid from t_ac_user WITH(NOLOCK) where userid=#{map.userID}))
    </select>

    <select id="getPayItemlist" resultType="String">
        select
        t.dictname
        from t_ac_dictdeta t WITH(NOLOCK)
        left join t_ac_dicttype d on t.dicttype=d.dicttypeid
        where d.dicttypecode='PAY_ITEM_PROTOCOL'
    </select>

    <select id="selectPurchaseInvoiceNo" resultType="String">
        select purchase_invoice_no from t_dx_all_record_invoice_detail where purchase_invoice_no=#{PurchaseInvoiceNo}
    </select>
    <select id="queryInvoiceDetailList" resultType="com.xforceplus.wapp.modules.protocol.entity.ProtocolInvoiceDetailEntity">
        select * from t_dx_protocol_invoice_detail where  protocol_no=#{protocolNo}
        <![CDATA[ AND convert(varchar(100),case_date,23)  = #{caseDate} ]]>
    </select>
    <select id="selectRoleCode" resultType="com.xforceplus.wapp.modules.redTicket.entity.RoleEntity">
        select r.rolecode from t_ac_role r join t_ac_user_role ur on r.roleid=ur.roleid join t_ac_user au on ur.userid=au.userid where au.userid=#{userId}
    </select>
</mapper>