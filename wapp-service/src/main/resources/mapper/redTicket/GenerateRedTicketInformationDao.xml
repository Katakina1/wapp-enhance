<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.redTicket.dao.GenerateRedTicketInformationDao">

    <resultMap id="invoiceMap" type="com.xforceplus.wapp.modules.redTicket.entity.InvoiceEntity">
        <result column="invoice_type" property="invoiceType"/>
        <result column="invoice_code" property="invoiceCode"/>
        <result column="invoice_no" property="invoiceNo"/>
        <result column="invoice_date" property="invoiceDate"/>
        <result column="gf_tax_no" property="gfTaxNo"/>
        <result column="gf_name" property="gfName"/>
        <result column="xf_tax_no" property="xfTaxNo"/>
        <result column="xf_name" property="xfName"/>
        <result column="invoice_amount" property="invoiceAmount"/>
        <result column="tax_amount" property="taxAmount"/>
        <result column="tax_rate" property="taxRate"/>
        <result column="total_amount" property="totalAmount"/>
        <result column="payment_amount" property="paymentAmount"/>
        <result column="red_money_amount" property="redMoneyAmount"/>
        <result column="source_system" property="systemSource"/>
        <result column="detail_yesorno" property="detailYesorno"/>
        <result column="invoice_status" property="invoiceStatus"/>
        <result column="status_update_date" property="statusUpdateDate"/>
        <result column="rzh_yesorno" property="rzhYesorno"/>
        <result column="valid" property="valid"/>
        <result column="venderid" property="venderid"/>
    </resultMap>

    <select id="queryGfCode" resultType="com.xforceplus.wapp.modules.base.entity.OrganizationEntity">
      select orgcode,orgname,
      company_code companyCode,taxno from t_ac_org WITH(NOLOCK) where orgtype=5
      and orgcode=#{gfName}
    </select>

    <select id="getInvoicelist" resultMap="invoiceMap">
        <if test="map.offset != null and map.limit != null">
            SELECT
            TOP (#{map.limit}) A.*
            FROM
            (
            SELECT
            row_number () OVER (ORDER BY id desc) AS rownumber, o.*
            FROM
            (
        </if>
        select
        r.id,r.uuid,r.gf_tax_no,r.invoice_code,r.invoice_no,
        r.invoice_type,r.invoice_amount,r.tax_amount,
        r.tax_rate,r.total_amount,r.payment_amount,r.xf_tax_no,
        r.red_money_amount,r.rzh_yesorno,r.valid,r.settlementAmount,
        r.venderid,r.invoice_date,r.invoice_status,r.matchno

        from t_dx_record_invoice r WITH(NOLOCK),
        (SELECT d.invoice_code,d.invoice_no FROM t_dx_record_invoice_detail d WITH(NOLOCK) WHERE d.redticket_data_serial_number IS NULL
        and CONVERT(DECIMAL(18,4),d.detail_amount)>0  GROUP BY d.invoice_code,d.invoice_no) d
        where r.invoice_code = d.invoice_code
        AND r.invoice_no=d.invoice_no
        and r.rzh_yesorno='1'
        and r.invoice_status in('0','3')
        and r.red_money_amount>0
        and r.invoice_amount>0
        and r.flow_type='1'
        and r.invoice_type='01'
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and r.invoice_no like '%'+#{map.invoiceNo}+'%'
        </if>
        <if test="map.invoiceCode != null and map.invoiceCode != ''">
            and r.invoice_code like '%'+#{map.invoiceCode}+'%'
        </if>
        <if test="map.uuid != null and map.uuid != ''">
            and r.uuid like '%'+#{map.uuid}+'%'
        </if>
        <if test="map.orgcode != null and map.orgcode != ''">
            and r.jvcode like '%'+#{map.orgcode}+'%'
        </if>
        <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
            <![CDATA[ AND convert(varchar(100),r.invoice_date,23) >= #{map.invoiceDate1} ]]>
        </if>
        <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
            <![CDATA[ AND convert(varchar(10),r.invoice_date,23)  <= #{map.invoiceDate2} ]]>
        </if>
        and r.xf_tax_no in (select taxno from t_ac_org WITH(NOLOCK) where orgid in (select orgid from t_ac_user WITH(NOLOCK) where userid=#{map.userID}))
        <if test="map.offset != null and map.limit != null">
            )
            AS o
            )A
            WHERE
            rownumber >#{map.offset}
        </if>
    </select>

    <select id="invoiceCount" resultType="Integer">
        SELECT count(1) FROM t_dx_record_invoice r WITH(NOLOCK),
        (SELECT d.invoice_code,d.invoice_no FROM t_dx_record_invoice_detail d WITH(NOLOCK) WHERE d.redticket_data_serial_number IS NULL
        and CONVERT(DECIMAL(18,4),d.detail_amount)>0  GROUP BY d.invoice_code,d.invoice_no) d
        where r.invoice_code = d.invoice_code
        AND r.invoice_no=d.invoice_no
        and r.rzh_yesorno='1'
        and r.invoice_status in('0','3')
        and r.red_money_amount>0
        and r.invoice_amount>0
        and r.flow_type='1'
        and r.invoice_type='01'
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
                and r.invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
            </if>
            <if test="map.invoiceCode != null and map.invoiceCode != ''">
                and r.invoice_code like concat('%',concat(#{map.invoiceCode},'%'))
            </if>
            <if test="map.orgcode != null and map.orgcode != ''">
            and r.jvcode like concat('%',concat(#{map.orgcode},'%'))
            </if>
            <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
                <![CDATA[ AND convert(varchar(100),r.invoice_date,23) >= #{map.invoiceDate1} ]]>
            </if>
            <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
                <![CDATA[ AND convert(varchar(10),r.invoice_date,23)  <= #{map.invoiceDate2} ]]>
            </if>
        <if test="map.uuid != null and map.uuid != ''">
            and r.uuid like '%'+#{map.uuid}+'%'
        </if>
        and r.xf_tax_no in (select taxno from t_ac_org WITH(NOLOCK) where orgid in (select orgid from t_ac_user WITH(NOLOCK) where userid=#{map.userID}))
    </select>

    <update id="invoiceRedRush">
        UPDATE t_dx_record_invoice WITH(ROWLOCK)
        SET
        red_money_amount=red_money_amount-#{redRushAmountDet}
        <where>
            and uuid =#{uuid}
        </where>
    </update>

    <select id="invoicelist" resultMap="invoiceMap">
        select
        r.id,r.uuid,r.gf_tax_no,r.invoice_code,r.invoice_no,
        r.invoice_type,r.invoice_amount,r.tax_amount,
        r.tax_rate,r.total_amount,r.payment_amount,
        r.red_money_amount,r.rzh_yesorno,r.valid,r.settlementAmount,
        r.venderid,r.invoice_date,r.invoice_status

        from t_dx_record_invoice r WITH(NOLOCK)
        <where>
        <if test="map.uuid != null and map.uuid != ''">
            and r.uuid like '%'+#{map.uuid}+'%'
        </if>
        </where>
        and r.xf_tax_no in (select taxno from t_ac_org WITH(NOLOCK) where orgid in (select orgid from t_ac_user WITH(NOLOCK) where userid=#{map.userID}))
    </select>

    <select id="getReturnGoodsList" resultType="com.xforceplus.wapp.modules.businessData.entity.ReturngoodsEntity">
        <if test="map.offset != null and map.limit != null">
            SELECT
            TOP (#{map.limit}) A.*
            FROM
            (
            SELECT
            row_number () OVER (ORDER BY id desc) AS rownumber, o.*
            FROM
            (
        </if>
        select
        id,
        return_goods_code                returnGoodsCode,
        supplier_association             supplierAssociation,
        return_goods_date                returnGoodsDate,
        return_cost_amount               returncostAmount,
        return_goods_status              returnGoodsStatus,
        redticket_data_serial_number     redticketDataSerialNumber

        from t_dx_all_record_invoice_detail r
        LEFT JOIN t_ac_user u WITH(NOLOCK) ON r.supplier_association = u.usercode
        <where>
            <if test="map.userCode != null and map.userCode != ''">
                and  r.supplier_association = #{map.userCode}
            </if>
            <if test="map.returnGoodsCode != null and map.returnGoodsCode != ''">
                and r.return_goods_code  = #{map.returnGoodsCode}
            </if>
            <if test="map.orgname != null and map.orgname != ''">
                and r.jvcode  = #{map.orgname}
            </if>
            <if test="map.invoiceDate3 != null and map.invoiceDate3 != ''">
                <![CDATA[ AND convert(varchar(100),r.return_goods_date,23) >= #{map.invoiceDate3} ]]>
            </if>
            <if test="map.invoiceDate4 != null and map.invoiceDate4 != ''">
                <![CDATA[ AND convert(varchar(10),r.return_goods_date,23)  <= #{map.invoiceDate4} ]]>
            </if>
            and r.redticket_data_serial_number IS null
            <if test="map.offset == null or map.limit == null">
                ORDER BY return_goods_date desc
            </if>
        </where>
        <if test="map.offset != null and map.limit != null">
            )
            AS o
            )A
            WHERE
            rownumber >#{map.offset}
        </if>
    </select>


    <select id="getReturnGoodsCount" resultType="Integer">
        select count(1)
        from t_dx_all_record_invoice_detail r
        LEFT JOIN t_ac_user u WITH(NOLOCK) ON r.supplier_association = u.usercode
        <where>
            <if test="map.userCode != null and map.userCode != ''">
                and  r.supplier_association = #{map.userCode}
            </if>
            <if test="map.returnGoodsCode != null and map.returnGoodsCode != ''">
                and r.return_goods_code  = #{map.returnGoodsCode}
            </if>
            <if test="map.orgname != null and map.orgname != ''">
                and r.jvcode  = #{map.orgname}
            </if>
            <if test="map.invoiceDate3 != null and map.invoiceDate3 != ''">
                <![CDATA[ AND convert(varchar(100),r.return_goods_date,23) >= #{map.invoiceDate3} ]]>
            </if>
            <if test="map.invoiceDate4 != null and map.invoiceDate4 != ''">
                <![CDATA[ AND convert(varchar(10),r.return_goods_date,23)  <= #{map.invoiceDate4} ]]>
            </if>
            and r.redticket_data_serial_number IS null
        </where>
    </select>

    <select id="getGfTaxNo" resultType="String">
        select gf_tax_no from t_dx_record_invoice WITH(NOLOCK)
        <where>
            uuid=#{map.uuid}
        </where>
    </select>

    <select id="getCompanycode" resultType="String">
        select company_code from t_ac_org WITH(NOLOCK)
        <where>
            orgcode=#{orgcode}
        </where>
    </select>
</mapper>