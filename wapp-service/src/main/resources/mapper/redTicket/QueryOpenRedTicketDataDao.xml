<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.redTicket.dao.QueryOpenRedTicketDataDao">

    <select id="getRedTicketMatchList" resultType="com.xforceplus.wapp.modules.redTicket.entity.RedTicketMatch" >

        SELECT
        <if test=" map.limit != null">
            TOP (#{map.limit})
        </if>
        A.*
        FROM
        (
        SELECT
        row_number () OVER (ORDER BY o.id ) AS rownumber ,o.*
        FROM
        (
        select
        distinct   m.id ,
        m.redticket_data_serial_number  redTicketDataSerialNumber,
        m.business_type                 businessType,
        m.red_total_amount              redTotalAmount,
        m.whether_upload_data           dataStatus,
        m.whether_upload_rednotice       noticeStatus,
        m.red_notice_number              redNoticeNumber,
        m.audit_results                  examineResult,
        m.audit_remarks                  examineRemarks,
        m.data_association               dataAssociation,
        m.venderid               venderid,
        m.tax_rate               taxRate,
        m.rednotice_association           redNoticeAssociation,
        m.invoice_code invoiceCode,
        m.invoice_no invoiceNo,
        m.invoice_amount invoiceAmount,
        m.tax_amount taxAmount,
        m.total_amount totalAmount,
        m.scan_match_status scanMatchStatus,
        m.red_ticket_examine_time examineDate,
        m.redticket_creation_time redTicketCreationTime,
        m.upload_rednotice_time uploadRednoticeTime,
        m.open_redticket_time openRedticketTime,
        m.two_examine_time twoExamineTime,
        m.two_audit_remarks twoAuditRemarks
        from t_dx_red_ticket_matching m
        <if test='map.businessType == "1"'>
            left join t_dx_return_agreement_middle  tam  WITH(NOLOCK)  on m.id=tam.red_ticket_matching_association
            LEFT JOIN  t_dx_all_record_invoice_detail  tg WITH(NOLOCK)  on  tg.id = tam.return_agreement_association

        </if>

        <if test='map.businessType == "2"'>
            left join t_dx_return_agreement_middle  tam  WITH(NOLOCK)  on m.id=tam.red_ticket_matching_association
            LEFT JOIN  t_dx_protocol  ta  WITH(NOLOCK) on  ta.id = tam.return_agreement_association

        </if>
        <where>
            and m.redticket_status='0'
            <choose>
                <when test=' map.businessType == "1"'>
                    <if test="map.serviceNo != null and map.serviceNo != ''">
                        and tg.return_goods_code like concat('%',concat(#{map.serviceNo},'%'))
                    </if>

                </when>
                <when test=' map.businessType == "2"'>
                    <if test="map.serviceNo != null and map.serviceNo != ''">
                         and ta.protocol_no like concat('%',concat(#{map.serviceNo},'%'))
                    </if>
                </when>

            </choose>
            <if test="map.userCode != null and map.userCode != ''">
                and  m.venderid   like concat('%',concat(#{map.userCode},'%'))
            </if>
            <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
                <![CDATA[ AND convert(varchar(100),m.redticket_creation_time,23) >= #{map.invoiceDate1} ]]>
            </if>
            <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
                <![CDATA[ AND convert(varchar(10),m.redticket_creation_time,23)  <= #{map.invoiceDate2} ]]>
            </if>

            <if test="map.businessType != null and map.businessType != '' and map.businessType != '-1'">
                and m.business_type = #{map.businessType}
            </if>

        </where>  ) AS o
        ) A
        WHERE 1=1
        <if test="map.offset != null ">
            and   rownumber > #{map.offset}
        </if>

	</select>

    <select id="getRedTicketMatchListCount" resultType="java.lang.Integer" >
        select
        count(1)
        from (
        select
        distinct m.id
        from t_dx_red_ticket_matching m WITH(NOLOCK)
        <if test='map.businessType == "1"'>
            left join t_dx_return_agreement_middle  tam  WITH(NOLOCK)  on m.id=tam.red_ticket_matching_association
            LEFT JOIN  t_dx_all_record_invoice_detail  tg WITH(NOLOCK)  on  tg.id = tam.return_agreement_association

        </if>

        <if test='map.businessType == "2"'>
            left join t_dx_return_agreement_middle  tam  WITH(NOLOCK)  on m.id=tam.red_ticket_matching_association
            LEFT JOIN  t_dx_protocol  ta  WITH(NOLOCK) on  ta.id = tam.return_agreement_association

        </if>
        <where>
            and m.redticket_status='0'
            <choose>
                <when test=' map.businessType == "1"'>
                    <if test="map.serviceNo != null and map.serviceNo != ''">
                        and tg.return_goods_code like concat('%',concat(#{map.serviceNo},'%'))
                    </if>

                </when>
                <when test=' map.businessType == "2"'>
                    <if test="map.serviceNo != null and map.serviceNo != ''">
                        and ta.protocol_no like concat('%',concat(#{map.serviceNo},'%'))
                    </if>

                </when>

            </choose>

            <if test="map.userCode != null and map.userCode != ''">
                and  m.venderid   like concat('%',concat(#{map.userCode},'%'))
            </if>
            <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
                <![CDATA[ AND convert(varchar(100),m.redticket_creation_time,23) >= #{map.invoiceDate1} ]]>
            </if>
            <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
                <![CDATA[ AND convert(varchar(10),m.redticket_creation_time,23)  <= #{map.invoiceDate2} ]]>
            </if>

            <if test="map.businessType != null and map.businessType != '' and map.businessType != '-1'">
                and m.business_type = #{map.businessType}
            </if>

        </where>
        ) a
    </select>


    <!--查询退货表信息-->
    <select id="getReturnGoodsList" resultType="com.xforceplus.wapp.modules.redTicket.entity.ReturnGoodsEntity">
        SELECT
        <if test=" map.limit != null">
            TOP (#{map.limit})
        </if>
        A.*
        FROM
        (
        SELECT
        row_number () OVER (ORDER BY o.id ) AS rownumber ,o.*
        FROM
        (
        select
        tg.id       ,
        return_goods_code    returnGoodsCode ,
        return_goods_date    returnGoodsDate,
        return_goods_status  returnGoodsStatus,
        return_cost_amount   returnCostAmount,
        supplier_association supplierAssociation,
        redticket_data_serial_number  redTicketDataSerialNumber
        from
        t_dx_all_record_invoice_detail tg WITH(NOLOCK)
        LEFT JOIN t_dx_return_agreement_middle tam WITH(NOLOCK)  on tg.id =tam.return_agreement_association
        where  tam.red_ticket_matching_association=  #{map.id}
        ) AS o
        ) A
        WHERE 1=1
        <if test="map.offset != null ">
            and   rownumber > #{map.offset}
        </if>
    </select>
    <!--查询退货条数-->
    <select id="getReturnGoodsListCount" resultType="java.lang.Integer">
        select
         count(1)
        from
        t_dx_all_record_invoice_detail tg WITH(NOLOCK)
         LEFT JOIN t_dx_return_agreement_middle tam WITH(NOLOCK)  on tg.id =tam.return_agreement_association
        where  tam.red_ticket_matching_association=  #{map.id}
    </select>

    <!--查询抵账表信息(蓝票)-->
    <select id="getRecordInvoiceList" resultType="com.xforceplus.wapp.modules.redTicket.entity.InvoiceEntity">
        <if test=" map.limit != null">
        SELECT
            TOP (#{map.limit})
        A.*
        FROM
        (
        SELECT
        row_number () OVER (ORDER BY o.id ) AS rownumber ,o.*
        FROM
        (
        </if>
        select
        id,
        gf_tax_no      gfTaxNo,
        invoice_code   invoiceCode,
        invoice_no     invoiceNo,
        invoice_type   invoiceType,
        invoice_date   invoiceDate,
        tax_rate       taxRate,
        tax_amount     taxAmount,
        red_rush_amount redRushAmount,
        total_amount    totalAmount
        from
        t_dx_red_ticket_matching_middle
        where  red_ticket_matching_association = #{map.id}
        <if test="map.offset != null ">
        ) AS o
        ) A
        WHERE 1=1
            and   rownumber > #{map.offset}
        </if>

    </select>
    <!--查询蓝票条数-->
    <select id="getRecordInvoiceListCount" resultType="java.lang.Integer">
       select
        count(1)
        from
        t_dx_red_ticket_matching_middle
        where  red_ticket_matching_association = #{map.id}


    </select>


    <!--查看蓝票明细信息列表-->
    <select id="getRecordInvoiceDetailList" resultType="com.xforceplus.wapp.modules.redTicket.entity.InvoiceDetail">
        <if test=" map.limit != null">
        SELECT
            TOP (#{map.limit})
        </if>
        A.*
        FROM
        (
        SELECT
        row_number () OVER (ORDER BY o.id ) AS rownumber ,o.*
        FROM
        (
        select
        id,
        goods_name goodsName ,
        model  ,
        unit_price  unitPrice,
        unit   ,
        tax_rate    taxRate ,
        detail_amount    detailAmount ,
        tax_amount    taxAmount ,
        red_rush_number   redRushNumber,
        red_rush_amount   redRushAmount,
        red_rush_price    redRushPrice,
        redticket_data_serial_number redTicketDataSerialNumber,
        invoice_code  invoiceCode ,
        invoice_no  invoiceNo
        from
        t_dx_record_invoice_detail WITH(NOLOCK)
        where   redticket_data_serial_number =#{map.redTicketDataSerialNumber}
        ) AS o
        ) A
        WHERE 1=1
        <if test="map.offset != null ">
            and   rownumber > #{map.offset}
        </if>
    </select>
    <!--查看明细条数-->
    <select id="getRecordInvoiceDetailListCount" resultType="java.lang.Integer">
        select
         count(1)
        from
        t_dx_record_invoice_detail WITH(NOLOCK)

        where   redticket_data_serial_number =#{map.redTicketDataSerialNumber}
    </select>

<!--查询业务类型-->
    <select id="selectBusinessType" resultType="String">
        select business_type from t_dx_red_ticket_matching where redticket_data_serial_number=#{redTicketDataSerialNumber}
    </select>
    <!--查看红票明细列表-->
    <select id="getMergeInvoiceDetailList" resultType="com.xforceplus.wapp.modules.redTicket.entity.RedTicketMatchDetail">
        <if test=" map.limit != null">
            SELECT
            TOP (#{map.limit})
        A.*
        FROM
        (
        SELECT
        row_number () OVER (ORDER BY o.id ) AS rownumber ,o.*
        FROM
        (
        </if>
        select
        id   ,
        goods_number     goodsNumber,
        goods_price      goodsPrice,
        goods_amount     goodsAmount,
        redticket_data_serial_number  redTicketDataSerialNumber,
        goods_name  goodsName,
        goods_unit  goodsUnit,
        goods_model  goodsModel,
        tax_amount  taxAmount,
        tax_rate  taxRate,
        red_rush_number  redRushNumber,
        red_rush_amount  redRushAmount,
        red_rush_price  redRushPrice
        from t_dx_Invoice_details WITH(NOLOCK)
        where redticket_data_serial_number  = #{map.redTicketDataSerialNumber}
        <if test="map.offset != null ">
        ) AS o
        ) A
        WHERE 1=1
            and   rownumber > #{map.offset}
        </if>
    </select>
    <!--查看红票信息条数-->
    <select id="getMergeInvoiceDetailListCount" resultType="java.lang.Integer">
        select
        count(1)
        from t_dx_Invoice_details WITH(NOLOCK)
        where redticket_data_serial_number  = #{map.redTicketDataSerialNumber}
    </select>


    <!--查询协议表信息-->
    <select id="getAgreementList" resultType="com.xforceplus.wapp.modules.redTicket.entity.ProtocolEntity">
        SELECT
        <if test=" map.limit != null">
            TOP (#{map.limit})
        </if>
        A.*
        FROM
        (
        SELECT
        row_number () OVER (ORDER BY o.id ) AS rownumber ,o.*
        FROM
        (
        select
        ta.id,
        ta.protocol_no                   protocolNo,
        ta.vender_id                     venderId,
        ta.dept_no                       deptNo,
        ta.pay_item                      payItem,
        ta.pay_company_code              payCompanyCode,
        ta.amount,
        ta.protocol_status               protocolStatus,
        ta.case_date                     caseDate,
        ta.seq,
        ta.pay_date                      payDate,
        ta.redticket_data_serial_number  redticketDataSerialNumber
        from t_dx_protocol ta
        LEFT JOIN t_dx_return_agreement_middle tam on ta.id =tam.return_agreement_association
        where tam.red_ticket_matching_association = #{map.id}
        ) AS o
        ) A
        WHERE 1=1
        <if test="map.offset != null ">
            and   rownumber > #{map.offset}
        </if>
    </select>

    <select id="getAgreementListCount" resultType="java.lang.Integer">
       select
        count(1)
        from t_dx_protocol ta
        LEFT JOIN t_dx_return_agreement_middle tam on ta.id =tam.return_agreement_association
        where tam.red_ticket_matching_association = #{map.id}
    </select>
    <!--查询上传资料集合-->
    <select id="getQueryImg" resultType="com.xforceplus.wapp.modules.redTicket.entity.FileEntity">
        select
        id       ,
        file_path    filePath ,
        file_type  fileType,
        file_description    fileDescription,
        file_name    fileName,
        file_number  fileNumber
        from
        t_dx_file_table
        where  file_number = #{map.id}
    </select>
    <!--查找fileEntity  by id-->
    <select id="getFielImage" resultType="com.xforceplus.wapp.modules.redTicket.entity.FileEntity">
        select
        id       ,
        file_path    filePath ,
        file_type  fileType,
        file_description    fileDescription,
        file_Name    fileName,
        file_number  fileNumber
        from
        t_dx_file_table
        where  id = #{id}
    </select>


    <!--保存路径，和文件类型-->
    <insert id="saveFilePath">
        INSERT INTO t_dx_file_table (file_path, file_type, file_number,file_name) VALUES (#{filePath}, #{fileType}, #{fileNumber},#{fileName})

    </insert>
    <!--修改上传资料状态-->
    <update id="updateStatus">
           UPDATE t_dx_red_ticket_matching SET whether_upload_data = '1'
          WHERE id = #{id}
     </update>

    <!--修改上传资料状态-->
    <update id="updateExamineStatus">
           UPDATE t_dx_red_ticket_matching SET audit_results = '1',red_ticket_examine_time=null,audit_remarks=''
          WHERE id = #{id}
     </update>

    <select id="queryXL" resultType="com.xforceplus.wapp.modules.report.entity.OptionEntity">
        select
        t_ac_dictdeta.dictname label,
        t_ac_dictdeta.dictcode  value
        from  t_ac_dictdeta
        LEFT JOIN t_ac_dicttype on  t_ac_dicttype.dicttypeid = t_ac_dictdeta.dicttype
        where t_ac_dicttype.dicttypecode ='VATRATE' ORDER BY sortno
    </select>
    <select id="queryRedTicketType" resultType="com.xforceplus.wapp.modules.report.entity.OptionEntity">
        select
        t_ac_dictdeta.dictname label,
        t_ac_dictdeta.dictcode  value
        from  t_ac_dictdeta
        LEFT JOIN t_ac_dicttype on  t_ac_dicttype.dicttypeid = t_ac_dictdeta.dicttype
        where t_ac_dicttype.dicttypecode ='OPENREDTICKETDATATYPE'
    </select>

</mapper>