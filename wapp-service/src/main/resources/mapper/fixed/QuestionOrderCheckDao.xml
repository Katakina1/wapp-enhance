<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xforceplus.wapp.modules.fixed.dao.QuestionOrderCheckDao">
  <resultMap id="BaseResultMap" type="com.xforceplus.wapp.modules.fixed.entity.QuestionOrderEntity">
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="jvcode" jdbcType="NVARCHAR" property="jvcode" />
    <result column="jvname" jdbcType="NVARCHAR" property="jvname" />
    <result column="gf_tax_no" jdbcType="NVARCHAR" property="gfTaxNo" />
    <result column="gf_name" jdbcType="NVARCHAR" property="gfName" />
    <result column="venderid" jdbcType="NVARCHAR" property="venderid" />
    <result column="vender_name" jdbcType="NVARCHAR" property="venderName" />
    <result column="invoice_amount" jdbcType="DECIMAL" property="invoiceAmount" />
    <result column="invoice_count" jdbcType="INTEGER" property="invoiceCount" />
    <result column="order_amount" jdbcType="DECIMAL" property="orderAmount" />
    <result column="order_count" jdbcType="INTEGER" property="orderCount" />
    <result column="match_date" jdbcType="TIMESTAMP" property="matchDate" />
    <result column="settlement_method" jdbcType="CHAR" property="settlementMethod" />
    <result column="match_status" jdbcType="CHAR" property="matchStatus" />
    
    
  
    <result column="path" jdbcType="NVARCHAR" property="path" />
    
  </resultMap>
   <resultMap id="invoiceResultMaps" type="com.xforceplus.wapp.modules.posuopei.entity.DetailEntity">
        <id column="id" property="id"/>
        <result column="uuid" property="uuid"/>
        <result column="invoice_code" property="invoiceCode"/>
        <result column="invoice_no" property="invoiceNo"/>
        <result column="detail_no" property="detailNo"/>
        <result column="goods_name" property="goodsName"/>
        <result column="model" property="model"/>
        <result column="unit" property="unit"/>
        <result column="num" property="num"/>
        <result column="unit_price" property="unitPrice"/>
        <result column="detail_amount" property="detailAmount"/>
        <result column="tax_rate" property="taxRate"/>
        <result column="tax_amount" property="taxAmount"/>
        <result column="cph" property="cph"/>
        <result column="lx" property="lx"/>
        <result column="txrqq" property="txrqq"/>
        <result column="txrqz" property="txrqz"/>
        <result column="goods_num" property="goodsNum"/>
    </resultMap>
  <!--分页查询问题单审核-->
  <select id="queryCheckOrderList" resultMap="BaseResultMap">
   /**mycat:schema=${schemaLabel}*/
    <if test="map.offset != null and map.limit != null">
      SELECT
      TOP (#{map.limit}) A.*
      FROM
      (
      SELECT
      row_number () OVER (ORDER BY o.venderid desc) AS rownumber, o.*
      FROM
      (
    </if>
    select
      distinct
     mac.id ,  
    mac.jvcode,
    mac.jvname,
    mac.gf_tax_no,
    mac.gf_name,
    mac.venderid,
    mac.vender_name,
    mac.invoice_amount,
    mac.invoice_count,
    mac.order_amount,
    mac.order_count,
   	mac.match_date,
    mac.settlement_method,
    mac.match_status
   <!--  <if test="map.orderNo != null and map.orderNo != ''">
    	,tol.id
    </if>
     <if test="map.invoiceNo != null and map.invoiceNo != ''">
     ,trl.id
     </if> -->
    from t_dx_fixed_assets_match mac  WITH(NOLOCK)
      <if test="map.orderNo != null and map.orderNo != ''">
			, (select tlk.match_id  from t_dx_fixed_assets_order tor inner join t_dx_fixed_assets_link tlk on
			 tor.order_no = #{map.orderNo} and tor.id=tlk.doc_id ) tol 
      </if>
      <!-- 发票号码 -->
      <if test="map.invoiceNo != null and map.invoiceNo != ''">
         ,(select tlnk.match_id from t_dx_record_invoice tri inner join t_dx_fixed_assets_link tlnk on
			 tri.invoice_no=#{map.invoiceNo} and tri.id=tlnk.doc_id) trl
      </if>
      ,t_dx_fixed_assets_file dxfile WITH ( NOLOCK )
      where  1=1  and mac.check_status is null  <![CDATA[ and mac.settlement_method <>'0']]>
      AND mac.id= dxfile.match_id
      AND dxfile.id is not null

      <if test="map.orderNo != null and map.orderNo != ''">
       and tol.match_id=mac.id
      </if>
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
      	and mac.id=trl.match_id
      </if>
	  <if test="map.venderid != null and map.venderid != ''">
 		and mac.venderid=#{map.venderid}
	  </if>
 	  <if test="map.matchDate1 != null and map.matchDate1 != ''">
        <![CDATA[ AND convert(varchar(100),mac.match_date,23) >= #{map.matchDate1} ]]>
      </if>
      <if test="map.matchDate2 != null and map.matchDate2 != ''">
        <![CDATA[ AND convert(varchar(100),mac.match_date,23) <= #{map.matchDate2} ]]>
      </if>
    
    <if test="map.offset != null and map.limit != null">
      )
      AS o
      )A
      WHERE
      rownumber > #{map.offset}
    </if>
  </select >

  <select id="countOrders" resultType="java.lang.Integer">
   /**mycat:schema=${schemaLabel}*/
      SELECT
      count(1)
      FROM
      (
      SELECT
      distinct
      mac.id
      from t_dx_fixed_assets_match mac  WITH(NOLOCK)
      <if test="map.orderNo != null and map.orderNo != ''">
          , (select tlk.match_id  from t_dx_fixed_assets_order tor inner join t_dx_fixed_assets_link tlk on
          tor.order_no = #{map.orderNo} and tor.id=tlk.doc_id ) tol
      </if>
      <!-- 发票号码 -->
      <if test="map.invoiceNo != null and map.invoiceNo != ''">
          ,(select tlnk.match_id from t_dx_record_invoice tri inner join t_dx_fixed_assets_link tlnk on
          tri.invoice_no=#{map.invoiceNo} and tri.id=tlnk.doc_id) trl
      </if>
      ,t_dx_fixed_assets_file dxfile WITH ( NOLOCK )
      where  1=1  and mac.check_status is null  <![CDATA[ and mac.settlement_method <>'0']]>
      AND mac.id= dxfile.match_id
      AND dxfile.id is not null
      <if test="map.orderNo != null and map.orderNo != ''">
          and tol.match_id=mac.id
      </if>
      <if test="map.invoiceNo != null and map.invoiceNo != ''">
          and mac.id=trl.match_id
      </if>
      <if test="map.venderid != null and map.venderid != ''">
          and mac.venderid=#{map.venderid}
      </if>
      <if test="map.matchDate1 != null and map.matchDate1 != ''">
          <![CDATA[ AND convert(varchar(100),mac.match_date,23) >= #{map.matchDate1} ]]>
      </if>
      <if test="map.matchDate2 != null and map.matchDate2 != ''">
          <![CDATA[ AND convert(varchar(100),mac.match_date,23) <= #{map.matchDate2} ]]>
      </if>
      ) AS o
  </select>
  
  <!-- 查询发票信息 -->
  <select id="queryInvoice" resultType="com.xforceplus.wapp.modules.fixed.entity.InvoiceEntity">
   /**mycat:schema=${schemaLabel}*/
  select 
  	tdi.invoice_type as invoiceType,
  	tdi.invoice_code as invoiceCode,
  	tdi.invoice_no as invoiceNo ,
  	tdi.invoice_amount as invoiceAmount,
  	tdi.tax_amount as taxAmount,
	tdi.invoice_date as invoiceDate,
	tdi.tax_rate as taxRate,
	tdi.venderid,
	tdi.vendername as venderName ,
	tdi.detail_yesorno as detailYesorno,
	tdi.id
  from t_dx_record_invoice tdi WITH(NOLOCK) , t_dx_fixed_assets_link lin WITH(NOLOCK) ,t_dx_fixed_assets_match mac  WITH(NOLOCK)
  where mac.id=lin.match_id and lin.doc_id=tdi.id and mac.id=#{map.id} and lin.doc_type= '2'
  
  </select>
  <!-- 查询订单 -->
    <select id="queryOrder" resultType="com.xforceplus.wapp.modules.fixed.entity.OrderEntity">
   /**mycat:schema=${schemaLabel}*/
	select 
	tor.order_no orderNo,
	tor.amount,
	tor.order_date orderDate,
	tor.venderid,
	tor.shamount
	from t_dx_fixed_assets_order tor  WITH(NOLOCK) ,t_dx_fixed_assets_link lin WITH(NOLOCK) ,t_dx_fixed_assets_match mac  WITH(NOLOCK)
	where mac.id=lin.match_id and lin.doc_id=tor.id and mac.id=#{map.id} and lin.doc_type= '1'
  </select>
  <update id="check" >
  	
        UPDATE t_dx_fixed_assets_match
        SET check_status=#{result},
      <if test="reason != null and reason != ''">
          check_fail_reason=#{reason},
      </if>
        check_date=getdate()
        WHERE id=#{id}

    </update>
  
   <select id="getVehicleDetail" resultType="com.xforceplus.wapp.modules.posuopei.entity.DetailVehicleEntity">
        /**mycat:schema=${schemaLabel}*/
        SELECT
        *
        FROM t_dx_vehicle_sale_invoice WITH(NOLOCK)
        WHERE uuid IN (SELECT uuid FROM t_dx_record_invoice WHERE id=#{id})
    </select>


 <select id="getInvoiceDetail" resultMap="invoiceResultMaps">
/**mycat:schema=${schemaLabel}*/
        SELECT
        *
        FROM
        t_dx_record_invoice_detail WITH(NOLOCK)
        WHERE
        uuid in (SELECT uuid FROM t_dx_record_invoice where id=#{id})
    </select>


<select id="getOutInfo" resultType="com.xforceplus.wapp.modules.posuopei.entity.InvoicesEntity">
        /**mycat:schema=${schemaLabel}*/
        SELECT
        out_date outDate,
        out_by outBy,
        out_reason outReason,
        out_invoice_amout outInvoiceAmout,
        out_tax_amount outTaxAmount
        from t_dx_record_invoice_out WITH(NOLOCK)
        where uuid=#{uuid} and is_cancel='0'
        order by out_date asc
    </select>

 <select id="getDetailInfo" resultType="com.xforceplus.wapp.modules.posuopei.entity.InvoicesEntity">
        /**mycat:schema=${schemaLabel}*/
        select
        a.*,
        a.dxhy_match_status matchStatus,
        b.user_name qsBy
        FROM t_dx_record_invoice a WITH(NOLOCK)
        LEFT JOIN t_dx_invoice b ON a.uuid=b.uuid
        WHERE a.id=#{id}
    </select>
    
    <!--查询文件  -->
  <select id="queryFileName" resultType="com.xforceplus.wapp.modules.fixed.entity.FileEntity">
   /**mycat:schema=${schemaLabel}*/
  select 
	  tfile.id,
	  tfile.file_name as fileName,
	  tfile.path as filePath
  from t_dx_fixed_assets_file tfile  WITH(NOLOCK) where tfile.match_id=#{map.id}
  
  
  </select>
  
   <select id="getFileImage" resultType="com.xforceplus.wapp.modules.fixed.entity.FileEntity">
        select
        id       ,
        path    filePath ,
       	match_id  matchId,
        file_Name    fileName
        from
        t_dx_fixed_assets_file WITH(NOLOCK)
        where  id = #{id}
    </select>
  
  
  <select id="getFileInfo" resultType="com.xforceplus.wapp.modules.fixed.entity.FileEntity">
        select 
	  tfile.id,
	  tfile.file_name as fileName,
	  tfile.path as filePath
 		 from t_dx_fixed_assets_file tfile WITH(NOLOCK)  where tfile.id=#{id}
    </select>
    
</mapper>