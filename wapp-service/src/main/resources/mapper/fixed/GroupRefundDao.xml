<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.fixed.dao.IndexGroupRefundDao">

    <resultMap id="reportStatisticsMap" type="com.xforceplus.wapp.modules.report.entity.ReportStatisticsEntity">
        <result column="totalCount" property="totalCount" />
        <result column="totalAmount" property="totalAmount" />
        <result column="totalTax" property="totalTax" />
    </resultMap>

    <select id="queryList" resultType="com.xforceplus.wapp.modules.fixed.entity.IndexGroupRefundEntity">
        <if test="map.offset != null and map.limit != null">
            SELECT
            TOP (#{map.limit}) A.*
            FROM
            (
            SELECT
            row_number () OVER (ORDER BY matchDate desc, id desc) AS rownumber, o.*
            FROM
            (
        </if>
        select

        DISTINCT(b.id),
        b.gf_name gfName,
        b.venderid venderId,
        b.invoice_amount settlementAmount,
        b.invoice_count invoiceNum,
        b.order_amount poAmonut,
        b.order_count poNum,
        convert(varchar(100),b.match_date,23) matchDate,
        b.vender_name venderName,
        b.scan_fail_reason  reasonForCancel
        from t_dx_fixed_assets_match b WITH(NOLOCK)
        where
        EXISTS
        (select 1 from t_dx_fixed_assets_link ff
        where ff.match_id =  b.id and doc_type = '2'
        and EXISTS
        (select 1 from t_dx_record_invoice rr where
        ff.doc_id = rr.id
        and EXISTS
        (select 1 from t_dx_invoice ii
        where rr.uuid = ii.uuid
        and (rebateyesorno != '1' or rebateyesorno is null) and (rebateno is null or rebateno = '')
        and (isdel = '0'or isdel is null)
        )
        )
        )
        and b.scan_match_status = '2'

        <if test="map.poCode != null and map.poCode != ''">
            and b.id in
            (select match_id from t_dx_fixed_assets_link
            where doc_type = '1' and doc_id in(select id from t_dx_fixed_assets_order  where order_no = #{map.poCode}))
        </if>
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and b.id in
            (select match_id from t_dx_fixed_assets_link
            where doc_type = '2' and doc_id in(select id from t_dx_record_invoice  where invoice_no = #{map.invoiceNo}))
        </if>
        <if test="map.matchDate1 != null and map.matchDate1 != ''">
            <![CDATA[ AND convert(varchar(100),b.match_date,23) >= #{map.matchDate1} ]]>
        </if>
        <if test="map.matchDate2 != null and map.matchDate2 != ''">
            <![CDATA[ AND convert(varchar(100),b.match_date,23)  <= #{map.matchDate2} ]]>
        </if>
        <if test="map.offset == null and map.limit == null">
            ORDER BY b.match_date desc, id desc
        </if>
        <if test="map.offset != null and map.limit != null">
            )
            AS o
            )A
            WHERE
            rownumber >#{map.offset}

        </if>
    </select>

    <select id="queryTotalResult" resultMap="reportStatisticsMap">
        select COUNT(DISTINCT b.id) totalCount, ISNULL(sum(a.invoice_amount),0) totalAmount, ISNULL(sum(a.tax_amount),0) totalTax
        from t_dx_record_invoice a WITH(NOLOCK) , t_dx_match b WITH(NOLOCK)
        where
        EXISTS
        (select 1 from t_dx_fixed_assets_link ff
        where ff.match_id =  b.id and doc_type = '2'
        and EXISTS
        (select 1 from t_dx_record_invoice rr where
        ff.doc_id = rr.id
        and EXISTS
        (select 1 from t_dx_invoice ii
        where rr.uuid = ii.uuid
        and (rebateyesorno != '1' or rebateyesorno is null) and (rebateno is null or rebateno = '')
        and (isdel = '0'or isdel is null)
        )
        )
        )
        and b.scan_match_status = '2'
        <if test="map.poCode != null and map.poCode != ''">
            and b.id in
            (select match_id from t_dx_fixed_assets_link
            where doc_type = '1' and doc_id in(select id from t_dx_fixed_assets_order  where order_no = #{map.poCode}))
        </if>
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and b.id in
            (select match_id from t_dx_fixed_assets_link
            where doc_type = '2' and doc_id in(select id from t_dx_record_invoice  where invoice_no = #{map.invoiceNo}))
        </if>
        <if test="map.matchDate1 != null and map.matchDate1 != ''">
            <![CDATA[ AND convert(varchar(100),b.match_date,23) >= #{map.matchDate1} ]]>
        </if>
        <if test="map.matchDate2 != null and map.matchDate2 != ''">
            <![CDATA[ AND convert(varchar(100),b.match_date,23)  <= #{map.matchDate2} ]]>
        </if>
    </select>
    <!--查询抵账表信息-->
    <select id="getRecordInvoiceList" resultType="com.xforceplus.wapp.modules.fixed.entity.IndexGenerateBindNumberEntity">
        SELECT
        <if test=" map.limit != null">
            TOP (#{map.limit})
        </if>
        A.*
        FROM
        (
        SELECT
        row_number () OVER (ORDER BY o.id ) AS rownumber ,o.*
        FROM
        (
        select
        id,
        invoice_code   invoiceCode,
        invoice_no     invoiceNo,
        invoice_type   invoiceType,
        convert(varchar(100),invoice_date,23)   invoiceDate,
        invoice_amount invoiceAmount,
        tax_amount     taxAmount,
        venderid       venderId,
        vendername     venderName
        from
        t_dx_record_invoice WITH(NOLOCK)
        where  id in (
        select  doc_id  from t_dx_fixed_assets_link
        where doc_type = '2' and match_id in(
        select id from  t_dx_fixed_assets_match
        where id =  #{map.id}
        )
        )
        ) AS o
        ) A
        WHERE 1=1
        <if test="map.offset != null ">
            and   rownumber > #{map.offset}
        </if>

    </select>
    <!--查询发票明细条数-->
    <select id="getRecordInvoiceListCount" resultType="java.lang.Integer">
        select
        count(1)
        from
        t_dx_record_invoice WITH(NOLOCK)
        where  id in (
        select  doc_id  from t_dx_fixed_assets_link
        where doc_type = '2' and match_id in(
        select id from  t_dx_fixed_assets_match
        where id =  #{map.id}
        )
        )
    </select>

    <!--查看PO信息列表-->
    <select id="getPOList" resultType="com.xforceplus.wapp.modules.fixed.entity.IndexGenerateBindNumberEntity">
        SELECT
        <if test=" map.limit != null">
            TOP (#{map.limit})
        </if>
        A.*
        FROM
        (
        SELECT
        row_number () OVER (ORDER BY o.id ) AS rownumber ,o.*
        FROM
        (
        select
        id,
        order_no   poCode,
        amount  amountUnpaid,
        order_detail_no   orderDetailNo,
        venderid  venderId,
        convert(varchar(100),order_date,23) receiptDate
        from
        t_dx_fixed_assets_order WITH(NOLOCK)
        where  id in (
        select  doc_id  from t_dx_fixed_assets_link
        where doc_type = '1' and match_id in(
        select id from  t_dx_fixed_assets_match
        where id =  #{map.id}
        )
        )
        ) AS o
        ) A
        WHERE 1=1
        <if test="map.offset != null ">
            and   rownumber > #{map.offset}
        </if>
    </select>
    <!--查看PO明细条数-->
    <select id="getPOListCount" resultType="java.lang.Integer">
        select
        count(1)
        from
        t_dx_fixed_assets_order WITH(NOLOCK)
        where  id in (
        select  doc_id  from t_dx_fixed_assets_link
        where doc_type = '1' and match_id in(
        select id from  t_dx_fixed_assets_match
        where id =  #{map.id}
        )
        )
    </select>

    <update id="inputrefundyesno">

        update t_dx_invoice
        set
        isdel = '1',
        del_date = GETDATE(),
        refund_reason = #{refundReason}
        where uuid = #{uuid}
    </update>

    <!--查询失败原因-->
    <select id="queryReason" resultType="com.xforceplus.wapp.modules.fixed.entity.IndexGroupRefundEntity">
        select scan_fail_reason refundReason
        from  t_dx_fixed_assets_match WITH(NOLOCK)
        where id =  #{id}
    </select>

    <!--查询uuid-->
    <select id="queryuuid" resultType="com.xforceplus.wapp.modules.fixed.entity.IndexGroupRefundEntity">
        select uuid from t_dx_record_invoice  WITH(NOLOCK)
        where id in (
        select  doc_id  from t_dx_fixed_assets_link
        where doc_type = '2' and match_id in(
        select id from  t_dx_fixed_assets_match
        where id =  #{id}
        )
        )
    </select>

    <!--整组退修改扫描表-->
    <update id="inputrefundnotes">

        update t_dx_invoice
        set
        refund_notes = #{refundNotes},
        rebateyesorno = '1',
        rebate_date = getdate(),
        rebateno =#{rebateNo}
        where uuid = #{uuid} and (rebateno is null or rebateno = '')
    </update>

    <!--查询最大退单号-->
    <select id="querymaxrebateno" resultType="com.xforceplus.wapp.modules.fixed.entity.IndexGroupRefundEntity">
        select MAX(rebateno)  rebateNo
        from t_dx_invoice WITH(NOLOCK)
    </select>


</mapper>