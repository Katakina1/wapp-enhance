<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.fixed.dao.InvoiceImportExportDao">


    <select id="invoiceImportAndExportlist" resultType="com.xforceplus.wapp.modules.lease.entity.InvoiceImportAndExportEntity">
        <if test=" map.limit != null">
        SELECT

            TOP (#{map.limit})

        A.*
        FROM
        (
        SELECT
        row_number () OVER (ORDER BY o.invoiceDate DESC) AS rownumber ,o.*
        FROM
        (
        </if>
        select
        id,
        company_code     companyCode,
        invoice_code     invoiceCode,
        invoice_type     invoiceType,
        invoice_no       invoiceNo,
        venderid         venderId,
        vendername       venderName,
        tax_amount       taxAmount,
        tax_rate         taxRate,
        invoice_amount   invoiceAmount,
        total_amount     totalAmount,
        invoice_date     invoiceDate,
        remark           reMark,
        jvcode           jvCode,
        shop_no          shopNo,
        period           peRiod,
        fixed_matching         matChing,
        fixed_matching_date    matChingDate,
        sap,
        sap_date sapDate
        from t_dx_record_invoice WITH(NOLOCK)
        where
        1=1
        and scan_match_status=1
        and (sap is null or sap='0' or sap=''or sap='2')
        and flow_type=5
        <if test="map.jvCode != null and map.jvCode != '' and map.jvCode != '-1'">
            and jvcode like concat('%',concat(#{map.jvCode},'%'))
        </if>
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
        </if>
        <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23) >= #{map.invoiceDate1} ]]>
        </if>
        <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23)  <= #{map.invoiceDate2} ]]>
        </if>
        <!--<if test="map.invoiceStatus !=null and map.invoiceStatus != '-1'">-->
            <!--and m.invoice_status = #{map.invoiceStatus}-->
        <!--</if>-->
        <!--<if test="map.invoiceType !=null and map.invoiceType != '-1'">-->
            <!--and m.invoice_type = #{map.invoiceType}-->
        <!--</if>-->
        <!--<if test="map.qsStatus !=null and map.qsStatus != '-1'">-->
            <!--and m.qs_status = #{map.qsStatus}-->
        <!--</if>-->
        <if test="map.companyCode != null and map.companyCode != ''">
            and company_code = #{map.companyCode}
       </if>
       <!--<if test="map.invoiceType !=null and map.invoiceType != '-1' and map.invoiceType != '-2'">-->
            <!--and m.invoice_type = #{map.invoiceType}-->
       <!--</if>-->
         <!--<if test="map.invoiceType == '-2'">-->
            <!--and m.invoice_type in ('01','04')-->
       <!--</if>-->
       <if test="map.venderId != null and map.venderId != ''">
             and venderid = #{map.venderId}
        </if>
        <if test="map.offset != null ">
        ) AS o
        ) A
        WHERE 1=1
          and   rownumber > #{map.offset}
        </if>

    </select>

    <!--查询发票信息条数-->
    <select id="invoiceImportAndExportlistCount" resultType="Integer">
        select count(1)
        from t_dx_record_invoice m WITH(NOLOCK)
        where
        1=1
        and scan_match_status=1
        and (sap is null or sap='0' or sap=''or sap='2')
        and flow_type=5
        <if test="map.jvCode != null and map.jvCode != '' and map.jvCode != '-1'">
            and jvcode like concat('%',concat(#{map.jvCode},'%'))
        </if>
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
        </if>
        <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23) >= #{map.invoiceDate1} ]]>
        </if>
        <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23)  <= #{map.invoiceDate2} ]]>
        </if>
        <!--<if test="map.invoiceStatus !=null and map.invoiceStatus != '-1'">-->
        <!--and m.invoice_status = #{map.invoiceStatus}-->
        <!--</if>-->
        <!--<if test="map.invoiceType !=null and map.invoiceType != '-1'">-->
        <!--and m.invoice_type = #{map.invoiceType}-->
        <!--</if>-->
        <!--<if test="map.qsStatus !=null and map.qsStatus != '-1'">-->
        <!--and m.qs_status = #{map.qsStatus}-->
        <!--</if>-->
        <if test="map.companyCode != null and map.companyCode != ''">
            and company_code = #{map.companyCode}
        </if>
        <!--<if test="map.invoiceType !=null and map.invoiceType != '-1' and map.invoiceType != '-2'">-->
        <!--and m.invoice_type = #{map.invoiceType}-->
        <!--</if>-->
        <!--<if test="map.invoiceType == '-2'">-->
        <!--and m.invoice_type in ('01','04')-->
        <!--</if>-->
        <if test="map.venderId != null and map.venderId != ''">
            and venderid = #{map.venderId}
        </if>


    </select>

    <select id="invoiceImportAndExportlistAll" resultType="com.xforceplus.wapp.modules.lease.entity.InvoiceImportAndExportEntity">
        select
        id,
        company_code     companyCode,
        invoice_code     invoiceCode,
        invoice_no       invoiceNo,
        venderid         venderId,
        vendername       venderName,
        tax_amount       taxAmount,
        invoice_amount   invoiceAmount,
        invoice_date     invoiceDate,
        total_amount     totalAmount,
        jvcode           jvCode,
        tax_rate           taxRate,
        sap
        from t_dx_record_invoice m WITH(NOLOCK)
        where 1=1
        and scan_match_status=1
        and flow_type=5
        and (sap is null or sap='0' or sap=''or sap='2')
        <if test="map.jvCode != null and map.jvCode != '' and map.jvCode != '-1'">
            and jvcode like concat('%',concat(#{map.jvCode},'%'))
        </if>
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
        </if>
        <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23) >= #{map.invoiceDate1} ]]>
        </if>
        <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23)  <= #{map.invoiceDate2} ]]>
        </if>

        <if test="map.companyCode != null and map.companyCode != ''">
            and company_code = #{map.companyCode}
        </if>

        <if test="map.venderId != null and map.venderId != ''">
            and venderid = #{map.venderId}
        </if>



    </select>

    <update id="invoiceImportAndExportUpdate">
        <if test="map.sap != null and map.sap != ''">
        update t_dx_record_invoice with(rowlock)
        set
        sap  =    #{map.sap},
        sap_date = getdate()
        where uuid = #{map.uuid}
        </if>
    </update>

    <!--获取发票id的订单号 -->
    <select id="selectOrdersById" resultType="String">
        SELECT
	concat (
		t3.order_no,'-',
		t3.order_detail_no
	) orders
FROM
	t_dx_fixed_assets_order t3
WHERE
	t3.id IN (
		SELECT
			t2.doc_id
		FROM
			t_dx_fixed_assets_link t2
		WHERE
			t2.match_id IN (
				SELECT
					match_id
				FROM
					t_dx_fixed_assets_link t1
				WHERE
					t1.doc_type = '2'
				AND t1.doc_id = #{id}
			)
		AND t2.doc_type = '1'
	)
    </select>
</mapper>