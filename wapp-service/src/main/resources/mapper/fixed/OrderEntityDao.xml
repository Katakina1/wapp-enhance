<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xforceplus.wapp.modules.fixed.dao.OrderEntityDao">
  <resultMap id="BaseResultMap" type="com.xforceplus.wapp.modules.fixed.entity.OrderEntity">
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="venderid" jdbcType="NVARCHAR" property="venderid" />
    <result column="jvcode" jdbcType="NVARCHAR" property="jvcode" />
    <result column="jvname" jdbcType="NVARCHAR" property="jvname" />
    <result column="order_no" jdbcType="NVARCHAR" property="orderNo" />
    <result column="order_detail_no" jdbcType="NVARCHAR" property="orderDetailNo" />
    <result column="company_code" jdbcType="NVARCHAR" property="companyCode" />
    <result column="amount" jdbcType="DECIMAL" property="amount" />
    <result column="match_status" jdbcType="CHAR" property="matchStatus" />
    <result column="sap_status" jdbcType="CHAR" property="sapStatus" />
    <result column="create_date" jdbcType="TIMESTAMP" property="createDate" />
    <result column="update_date" jdbcType="TIMESTAMP" property="updateDate" />
    <result column="order_date" jdbcType="TIMESTAMP" property="orderDate" />
    <result column="orgType" jdbcType="NVARCHAR" property="orgType" />
  </resultMap>


  <!--分页查询订单-->
  <select id="findOrderList" resultMap="BaseResultMap">
    <if test="map.offset != null and map.limit != null">
      SELECT
      TOP (#{map.limit}) A.*
      FROM
      (
      SELECT
      row_number () OVER (ORDER BY o.venderid desc,o.order_no) AS rownumber, o.*
      FROM
      (
    </if>
    select
    dfao.id,
    dfao.venderid,
    dfao.jvcode,
    dfao.jvname,
    dfao.order_no,
    dfao.order_detail_no,
    dfao.company_code,
    dfao.amount,
    dfao.match_status,
    dfao.create_date,
    dfao.update_date,
    dfao.order_date,
    dfao.sap_status,
    (select org.orgtype from t_ac_org org where au.orgid = org.orgid) as orgType
    from t_dx_fixed_assets_order dfao WITH(NOLOCK)
    left join t_ac_user au  WITH(NOLOCK) on dfao.venderid = au.usercode
    <where>
      <if test="map.venderid != null and map.venderid != ''">
        and dfao.venderid like concat('%',concat(#{map.venderid},'%'))
      </if>
      <if test="map.orderNo != null and map.orderNo != ''">
        and dfao.order_no = #{map.orderNo}
      </if>
      <if test="map.matchStatus != null and map.matchStatus != ''">
        and dfao.match_status = #{map.matchStatus}
      </if>
      <if test="map.orderDate1 != null and map.orderDate1 != ''">
        <![CDATA[ AND convert(varchar(100),dfao.order_date,23) >= #{map.orderDate1} ]]>
      </if>
      <if test="map.orderDate2 != null and map.orderDate2 != ''">
        <![CDATA[ AND convert(varchar(10),dfao.order_date,23)  <= #{map.orderDate2} ]]>
      </if>
    </where>
    <if test="map.offset != null and map.limit != null">
      )
      AS o
      )A
      WHERE
      rownumber > #{map.offset}
    </if>
  </select>
  <select id="countOrders" resultType="java.lang.Integer">
    select count(1)
    from t_dx_fixed_assets_order dfao WITH(NOLOCK)
    <where>
      <if test="map.venderid != null and map.venderid != ''">
        and dfao.venderid like concat('%',concat(#{map.venderid},'%'))
      </if>
      <if test="map.orderNo != null and map.orderNo != ''">
        and dfao.order_no = #{map.orderNo}
      </if>
      <if test="map.matchStatus != null and map.matchStatus != ''">
        and dfao.match_status = #{map.matchStatus}
      </if>
      <if test="map.orderDate1 != null and map.orderDate1 != ''">
        <![CDATA[ AND convert(varchar(100),dfao.order_date,23) >= #{map.orderDate1} ]]>
      </if>
      <if test="map.orderDate2 != null and map.orderDate2 != ''">
        <![CDATA[ AND convert(varchar(10),dfao.order_date,23)  <= #{map.orderDate2} ]]>
      </if>
    </where>
  </select>

</mapper>