<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xforceplus.wapp.modules.fixed.dao.FixedMatchDao">
    <select id="queryOrderList" resultType="com.xforceplus.wapp.modules.fixed.entity.OrderEntity">
        select id, venderid, jvcode, order_no, order_detail_no, order_date, amount  ,company_code
        from t_dx_fixed_assets_order WITH(NOLOCK)  where match_status='0' and venderid=#{venderid} and jvcode=#{jvcode}
        <if test="orderNo != null and orderNo != ''">
            and order_no like '%'+#{orderNo}+'%'
        </if>
        <if test="orderDate1 != null and orderDate1 != ''">
            <![CDATA[ AND convert(varchar(10),order_date,23) >= #{orderDate1} ]]>
        </if>
        <if test="orderDate2 != null and orderDate2 != ''">
            <![CDATA[ AND convert(varchar(10),order_date,23)  <= #{orderDate2} ]]>
        </if>
    </select>

    <select id="getRate" resultType="com.xforceplus.wapp.modules.cost.entity.SelectionOptionEntity">
        select dictcode optionKey,
        dictname optionName
        from t_ac_dictdeta WITH(NOLOCK)
        where dicttype=(select dicttypeid from t_ac_dicttype where dicttypecode='TAX_RATE_FIXED')
        order by sortno asc
    </select>

    <select id="searchInvoice" resultType="com.xforceplus.wapp.modules.fixed.entity.InvoiceEntity">
        select invoice_code, invoice_no, invoice_type, invoice_date, invoice_amount,
        tax_amount, total_amount, tax_rate, gf_tax_no, gf_name,
        jvcode, jvname, check_code, flow_type, venderid,
        detail_yesorno, id,source_system,xf_name , xf_tax_no, invoice_status,sap
        from t_dx_record_invoice WITH(NOLOCK)
        where invoice_code=#{invoiceCode} and invoice_no=#{invoiceNo}


    </select>

    <select id="searchInvoiceQuery" resultType="com.xforceplus.wapp.modules.fixed.entity.InvoiceEntity">
        select
        ri.invoice_code,
        ri.invoice_no,
        ri.invoice_type,
        ri.invoice_date,
        ri.invoice_amount,
        ri.tax_amount,
        ri.total_amount,
        ri.tax_rate,
        ri.gf_tax_no,
        ri.gf_name,
        ri.jvcode,
        ri.jvname,
        ri.check_code,
        ri.flow_type,
        ri.venderid,
        ri.detail_yesorno,
        ri.id,
        ri.source_system,
        ri.xf_name
        from t_dx_record_invoice ri WITH(NOLOCK)
        inner join t_ac_org u WITH ( NOLOCK ) on u.orgid=#{orgid} and  u.orgtype=8 and u.taxno=ri.xf_tax_no
        where 1=1
        <if test="invoiceNo != null and invoiceNo != ''">
          and ri.invoice_no=#{invoiceNo}
        </if>
        <if test="invoiceQueryDate1 != null and invoiceQueryDate1 != ''">
            <![CDATA[ AND convert(varchar(10),ri.invoice_date,23) >= #{invoiceQueryDate1} ]]>
        </if>
        <if test="invoiceQueryDate2 != null and invoiceQueryDate2 != ''">
            <![CDATA[ AND convert(varchar(10),ri.invoice_date,23)  <= #{invoiceQueryDate2} ]]>
        </if>
        AND (ri.flow_type is null or ri.flow_type='')
        AND ri.gf_tax_no=#{gfTaxNo}
        AND ri.tax_rate is not null
        AND ri.invoice_type='01' and ri.source_system='0'  and  ri.invoice_status='0'  and  ri.detail_yesorno='1'
        AND (ri.sap='0'or ri.sap=''or ri.sap is NULL  OR ri.sap = '3')

    </select>

    <select id="getJVInfo" resultType="com.xforceplus.wapp.modules.fixed.entity.MatchQueryEntity">
        select orgcode jvcode,
        orgname jvname,
        taxno gfTaxNo,
        taxname gfName from t_ac_org  WITH(NOLOCK) where orgcode=#{jvcode}
    </select>

    <insert id="saveMatch" useGeneratedKeys="true" keyProperty="id" parameterType="com.xforceplus.wapp.modules.fixed.entity.MatchQueryEntity">
        insert into t_dx_fixed_assets_match
        (jvcode, jvname, gf_tax_no, gf_name, venderid,
        vender_name, invoice_amount, invoice_count, order_amount, order_count,
        match_date, settlement_method, match_status, scan_match_status)
        values
        (#{jvcode}, #{jvname}, #{gfTaxNo}, #{gfName}, #{venderid},
        #{venderName}, #{invoiceAmount},#{invoiceCount}, #{orderAmount},#{orderCount},
        GETDATE(), #{settlementMethod},'0', '0')
    </insert>

    <update id="updateInvoice" parameterType="com.xforceplus.wapp.modules.fixed.entity.InvoiceEntity">
        update t_dx_record_invoice set
        venderid=#{venderid},
        vendername=#{venderName},
        jvcode=#{jvcode},
        jvname=#{jvname},
        flow_type='5',
        fixed_matching=#{matching},
        fixed_matching_date = getdate(),
        company_code=#{companyCode}
        where id=#{id}
    </update>

    <update id="updateInvoiceByEntering" parameterType="com.xforceplus.wapp.modules.fixed.entity.InvoiceEntity">
        update t_dx_record_invoice set
        venderid=#{venderid},
        vendername=#{venderName},
        jvcode=#{jvcode},
        jvname=#{jvname},
        flow_type='5',
        fixed_matching=#{matching},
        fixed_matching_date = getdate(),
        company_code=#{companyCode},
        invoice_code=#{invoiceCode},
        invoice_no=#{invoiceNo},
        invoice_date=#{invoiceDate},
         invoice_amount=#{invoiceAmount},
         tax_amount=#{taxAmount},
          total_amount=#{totalAmount},
          tax_rate=#{taxRate},
        check_code=#{checkCode}
        where id=#{id}
    </update>



    <select id="getXf" resultType="com.xforceplus.wapp.modules.base.entity.OrganizationEntity">
        select org.taxname,org.taxno from t_ac_org org  JOIN t_ac_user tau on tau.orgid=org.orgid where tau.userid=#{userId}
    </select>



    <update id="saveInvoice" useGeneratedKeys="true" keyProperty="id" parameterType="com.xforceplus.wapp.modules.fixed.entity.InvoiceEntity">
        insert into t_dx_record_invoice
        (invoice_type, invoice_code, invoice_no, invoice_date, invoice_amount,
         tax_amount, total_amount, tax_rate, jvcode, jvname,
         check_code, gf_tax_no, gf_name, venderid,
            flow_type,
         detail_yesorno, uuid, invoice_status, source_system, create_date,
         vendername,fixed_matching,valid,xf_tax_no, xf_name,company_code,fixed_matching_date,sap)
        values
        (#{invoiceType}, #{invoiceCode}, #{invoiceNo}, #{invoiceDate}, #{invoiceAmount},
        #{taxAmount}, #{totalAmount}, #{taxRate}, #{jvcode}, #{jvname},
        #{checkCode}, #{gfTaxNo}, #{gfName}, #{venderid},
            '5',
       '0', #{invoiceCode}+#{invoiceNo}, '0', '2', GETDATE(),
       #{venderName},#{matching},'1', #{xfTaxNo}, #{xfName},#{companyCode},getdate(),'0')
    </update>
    
    <update id="updateOrder">
        update t_dx_fixed_assets_order set
        match_status='1'
        where id=#{id}
    </update>

    <insert id="saveLink">
        insert into t_dx_fixed_assets_link
        (match_id, doc_type, doc_id)
        values
        <foreach collection ="list" item="link" separator =",">
            (#{link.matchId}, #{link.docType}, #{link.docId})
        </foreach >
    </insert>

    <insert id="saveFile" useGeneratedKeys="true" keyColumn="id" keyProperty="id" parameterType="com.xforceplus.wapp.modules.fixed.entity.FileEntity">
        insert into t_dx_fixed_assets_file (file_name, path, file_type)
        values (#{fileName}, #{filePath}, #{fileType})
    </insert>

    <update id="updateFile">
        update t_dx_fixed_assets_file set path=#{path}, match_id=#{matchId}
        where id=#{id}
    </update>


</mapper>