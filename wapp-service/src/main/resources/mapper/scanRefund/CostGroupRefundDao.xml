<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.scanRefund.dao.CostGroupRefundDao">

    <resultMap id="reportStatisticsMap" type="com.xforceplus.wapp.modules.report.entity.ReportStatisticsEntity">
        <result column="totalCount" property="totalCount" />
        <result column="totalAmount" property="totalAmount" />
        <result column="totalTax" property="totalTax" />
    </resultMap>

    <select id="queryList" resultType="com.xforceplus.wapp.modules.scanRefund.entity.CostGroupRefundEntity">
        <if test="map.offset != null and map.limit != null">
            SELECT
            TOP (#{map.limit}) A.*
            FROM
            (
            SELECT
            row_number () OVER (ORDER BY id desc) AS rownumber, o.*
            FROM
            (
        </if>
        select

        DISTINCT(b.id),
        b.cost_no costNo,
        <!-- b.cost_type costType,-->
        b.staff_email approverEmail,
        b.vender_id venderId,
        b.vender_name venderName,
        b.bank_name bankName,
        b.bank_account bankAccount,
        b.settlement_amount settlementAmount,
        b.create_date createDate,
        b.walmart_status walmartStatus,
        b.scan_fail_reason  reasonForCancel
        from t_dx_settlement b WITH(NOLOCK)
        where b.scan_status = '2' and b.walmart_status = '1'
        and EXISTS
        (select 1 from t_dx_settlement_invoice ss
        where ss.cost_no = b.cost_no and
        EXISTS
        (select 1 from t_dx_invoice dd WITH(NOLOCK)
        where dd.uuid = concat(ss.invoice_code,ss.invoice_no)
        and (rebateyesorno != '1' or rebateyesorno is null) and (rebateno is null or rebateno = '')
        and (isdel = '0'or isdel is null)
        )
        )
        <if test="map.costNo != null and map.costNo != ''">
            and b.cost_no = #{map.costNo}
        </if>
        <if test="map.createDate1 != null and map.createDate1 != ''">
            <![CDATA[ AND convert(varchar(100),b.create_date,23) >= #{map.createDate1} ]]>
        </if>
        <if test="map.createDate2 != null and map.createDate2 != ''">
            <![CDATA[ AND convert(varchar(100),b.create_date,23)  <= #{map.createDate2} ]]>
        </if>
        <if test="map.offset == null and map.limit == null">
            ORDER BY b.id desc
        </if>
        <if test="map.offset != null and map.limit != null">
            )
            AS o
            )A
            WHERE
            rownumber >#{map.offset}

        </if>
        <!--limit #{map.offset}, #{map.limit}-->
    </select>

    <select id="queryTotalResult" resultMap="reportStatisticsMap">

        select COUNT(DISTINCT b.id) totalCount, ISNULL(sum(a.invoice_amount),0) totalAmount, ISNULL(sum(a.tax_amount),0) totalTax
        from t_dx_record_invoice a WITH(NOLOCK), t_dx_settlement b WITH(NOLOCK)
        where  b.scan_status = '2' and b.walmart_status = '1'
        and EXISTS
        (select 1 from t_dx_settlement_invoice ss
        where ss.cost_no = b.cost_no and
        EXISTS
        (select 1 from t_dx_invoice dd WITH(NOLOCK)
        where dd.uuid = concat(ss.invoice_code,ss.invoice_no)
        and (rebateyesorno != '1' or rebateyesorno is null) and (rebateno is null or rebateno = '')
        and (isdel = '0'or isdel is null)
        )
        )
        <if test="map.costNo != null and map.costNo != ''">
            and b.cost_no = #{map.costNo}
        </if>
        <if test="map.createDate1 != null and map.createDate1 != ''">
            <![CDATA[ AND convert(varchar(100),b.create_date,23) >= #{map.createDate1} ]]>
        </if>
        <if test="map.createDate2 != null and map.createDate2 != ''">
            <![CDATA[ AND convert(varchar(100),b.create_date,23)  <= #{map.createDate2} ]]>
        </if>

    </select>
    <!--查询抵账表信息-->
    <select id="getRecordInvoiceList" resultType="com.xforceplus.wapp.modules.pack.entity.GenerateBindNumberEntity">
        SELECT
        <if test=" map.limit != null">
            TOP (#{map.limit})
        </if>
        A.*
        FROM
        (
        SELECT
        row_number () OVER (ORDER BY o.id ) AS rownumber ,o.*
        FROM
        (
        select
        id,
        invoice_code   invoiceCode,
        invoice_no     invoiceNo,
        invoice_type   invoiceType,
        convert(varchar(100),invoice_date,23)   invoiceDate,
        invoice_amount invoiceAmount,
        tax_amount     taxAmount,
        venderid       venderId,
        tax_rate       taxRate,
        vendername     venderName,
        gf_name gfName,
        total_amount totalAmount
        from
        t_dx_record_invoice WITH(NOLOCK)
        where  uuid in (
        select concat(invoice_code,invoice_no) uuid from t_dx_settlement_invoice WITH(NOLOCK)
        where cost_no in(
        select cost_no from  t_dx_settlement WITH(NOLOCK)
        where id =  #{map.id}
        )
        )
        ) AS o
        ) A
        WHERE 1=1
        <if test="map.offset != null ">
            and   rownumber > #{map.offset}
        </if>

    </select>
    <!--查询发票明细条数-->
    <select id="getRecordInvoiceListCount" resultType="java.lang.Integer">
        select
        count(1)
        from
        t_dx_record_invoice WITH(NOLOCK)
        where  uuid in (
        select concat(invoice_code,invoice_no) uuid from t_dx_settlement_invoice WITH(NOLOCK)
        where cost_no in(
        select cost_no from  t_dx_settlement WITH(NOLOCK)
        where id =  #{map.id}
        )
        )
    </select>

    <!--查看税率信息列表-->
    <select id="getRateList" resultType="com.xforceplus.wapp.modules.scanRefund.entity.CostGroupRefundEntity">
        SELECT
        <if test=" map.limit != null">
            TOP (#{map.limit})
        </if>
        A.*
        FROM
        (
        SELECT
        row_number () OVER (ORDER BY o.id ) AS rownumber ,o.*
        FROM
        (
        select
        id,
        invoice_amount   invoiceAmount,
        tax_rate  taxRate,
        tax_amount  taxAmount
        from
        t_dx_settlement_rate
        where cost_no in (
        select cost_no from t_dx_settlement
        where id = #{map.id}
        )
        ) AS o
        ) A
        WHERE 1=1
        <if test="map.offset != null ">
            and   rownumber > #{map.offset}
        </if>
    </select>
    <!--查看税率明细条数-->
    <select id="getRateListCount" resultType="java.lang.Integer">
        select
        count(1)
        from
        t_dx_settlement_rate
        where cost_no in (
        select cost_no from t_dx_settlement
        where id = #{map.id}
        )
    </select>

    <!--查看税率明细总额-->
    <select id="getRateListTotal" resultType="com.xforceplus.wapp.modules.scanRefund.entity.CostGroupRefundEntity">
        select
        sum(invoice_amount) summationTotalAmount,
        sum(tax_amount) summationTaxAmount
        from
        t_dx_settlement_rate
        where cost_no in (
        select cost_no from t_dx_settlement
        where id = #{map.id}
        )
    </select>
    <!--查看费用信息列表-->
    <select id="getCostList" resultType="com.xforceplus.wapp.modules.scanRefund.entity.CostGroupRefundEntity">
        SELECT
        <if test=" map.limit != null">
            TOP (#{map.limit})
        </if>
        A.*
        FROM
        (
        SELECT
        row_number () OVER (ORDER BY o.id ) AS rownumber ,o.*
        FROM
        (
        select
        a.id,
        a.cost_type   costType,
        a.cost_time  costTime,
        a.cost_amount  costAmount,
        a.cost_use   costUse,
        b.remark  remark
        from
        t_dx_settlement_cost a WITH(NOLOCK)
        LEFT JOIN t_dx_settlement_rate ratec WITH(NOLOCK) on ratec.id = a.rate_id
        LEFT JOIN t_dx_settlement b WITH(NOLOCK) on b.cost_no = ratec.cost_no
        where  a.rate_id in (
        select id from t_dx_settlement_rate
        where cost_no in (
        select cost_no from t_dx_settlement WITH(NOLOCK)
        where id = #{map.id}
        )
        )
        ) AS o
        ) A
        WHERE 1=1
        <if test="map.offset != null ">
            and   rownumber > #{map.offset}
        </if>
    </select>
    <!--查看费用明细条数-->
    <select id="getCostListCount" resultType="java.lang.Integer">
        select
        count(1)
        from
        t_dx_settlement_cost a
        LEFT JOIN t_dx_settlement_rate ratec WITH(NOLOCK) on ratec.id = a.rate_id
        LEFT JOIN t_dx_settlement b WITH(NOLOCK) on b.cost_no = ratec.cost_no
          where  a.rate_id in (
        select id from t_dx_settlement_rate WITH(NOLOCK)
        where cost_no in (
        select cost_no from t_dx_settlement WITH(NOLOCK)
        where id = #{map.id}
        )
        )
    </select>

    <!--整组退修改扫描表-->
    <update id="inputrefundnotes">

        update t_dx_invoice WITH(ROWLOCK)
        set
            refund_notes = #{refundNotes},
            refundyesorno = '1',
            rebate_date = getdate(),
            rebateno =#{rebateNo}
        where uuid = #{uuid}  and (rebateno is null or rebateno = '')
    </update>

    <update id="inputrefundyesno">

        update t_dx_invoice WITH(ROWLOCK)
        set
        isdel = '1',
        del_date = GETDATE(),
        refund_reason = #{refundReason}
        where uuid = #{uuid}
    </update>

    <!--查询失败原因-->
    <select id="queryReason" resultType="com.xforceplus.wapp.modules.scanRefund.entity.CostGroupRefundEntity">
        select scan_fail_reason refundReason
        from  t_dx_settlement
        where id =  #{id}
    </select>

    <!--查询uuid-->
    <select id="queryuuid" resultType="com.xforceplus.wapp.modules.scanRefund.entity.CostGroupRefundEntity">
        select uuid from t_dx_record_invoice WITH(NOLOCK)
        where uuid in (
        select concat(invoice_code,invoice_no) uuid from t_dx_settlement_invoice WITH(NOLOCK)
        where cost_no in(
        select cost_no from  t_dx_settlement WITH(NOLOCK)
        where id =  #{id}
        )
        )
    </select>

    <!--查询最大退单号-->
    <select id="querymaxrebateno" resultType="com.xforceplus.wapp.modules.scanRefund.entity.CostGroupRefundEntity">
        select MAX(rebateno)  rebateNo
        from t_dx_invoice WITH(NOLOCK)
    </select>


    <!--<select id="queryrebateno" resultType="com.xforceplus.wapp.modules.pack.entity.GenerateBindNumberEntity">-->
    <!--select bbindingno-->
    <!--from t_dx_record_invoice WITH(NOLOCK)-->
    <!--where id =#{id}-->
    <!--</select>-->


</mapper>