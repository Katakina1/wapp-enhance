<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.scanRefund.dao.RebatenoForQueryXiaoDao">


    <select id="queryList" resultType="com.xforceplus.wapp.modules.scanRefund.entity.RebatenoForQueryXiaoEntity">
        SELECT
        <if test=" map.limit != null">
            TOP (#{map.limit})
        </if>
        A.*
        FROM
        (
        SELECT
        row_number () OVER (ORDER BY o.qsDate DESC) AS rownumber ,o.*
        FROM
        (
        select
        m.id               Id,
        m.qs_status        qsStatus,--签收状态
        m.qs_date          qsDate,--签收日期
        m.invoice_code     invoiceCode,--发票代码
        m.invoice_no       invoiceNo,--发票号码
        m.invoice_date      createDate,--开票日期
        m.gf_name          gfName,--购方名
        m.xf_name          xfName,--销方名
        m.invoice_amount   invoiceAmount,--金额
        m.tax_amount       taxAmount,--税额
        m.jv_code           jvCode,
        m.company_code     companyCode,
        m.invoice_type     invoiceType,
        m.venderid         venderid,
        m.refund_reason            notes,
        m.rebateno         rebateNo,
        m.rebate_expressno rebateExpressno,
        m.rebate_date      rebateDate,
        m.flow_type flowType,
        m.mail_company    mailCompany,
        m.mail_date    mailDate
        from t_dx_invoice m WITH(NOLOCK)
        <where>
        m.rebateyesorno = '1'
        and m.venderid = #{map.usercode}
         <if test="map.flowType != null and map.flowType != '' and map.flowType != '-1'">
                and m.flow_type = #{map.flowType}
         </if>
        <if test="map.jvCode != null and map.jvCode != ''and map.jvCode != '-1'">
            and m.jv_code like concat('%',concat(#{map.jvCode},'%'))
        </if>
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and m.invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
        </if>
        <if test="map.rebateDate1 != null and map.rebateDate1 != ''">
            <![CDATA[ AND convert(varchar(100),m.rebate_date,23) >= #{map.rebateDate1} ]]>
        </if>
        <if test="map.rebateDate2 != null and map.rebateDate2 != ''">
            <![CDATA[ AND convert(varchar(100),m.rebate_date,23)  <= #{map.rebateDate2} ]]>
        </if>
        <!--<if test="map.invoiceStatus !=null and map.invoiceStatus != '-1'">-->
            <!--and m.invoice_status = #{map.invoiceStatus}-->
        <!--</if>-->
        <if test="map.invoiceType !=null and map.invoiceType != '-1'">
            and m.invoice_type = #{map.invoiceType}
        </if>
        <if test="map.qsStatus !=null and map.qsStatus != '-1'">
            and m.qs_status = #{map.qsStatus}
        </if>
        <if test="map.companyCode != null and map.companyCode != ''">
            and m.company_code = #{map.companyCode}
       </if>
       <if test="map.invoiceType !=null and map.invoiceType != '-1' and map.invoiceType != '-2'">
            and m.invoice_type = #{map.invoiceType}
       </if>
         <if test="map.invoiceType == '-2'">
            and m.invoice_type in ('01','04')
       </if>
       <if test="map.venderid != null and map.venderid != ''">
             and m.venderid = #{map.venderid}
        </if>
            <if test="map.rebateNo != null and map.rebateNo != ''">
                and m.rebateno  LIKE '%'+#{map.rebateNo}+'%'
            </if>
            <if test="map.rebateExpressno != null and map.rebateExpressno != ''">
                and m.rebate_expressno  LIKE '%'+ #{map.rebateExpressno}+'%'
            </if>
    </where>
        ) AS o
        ) A
        WHERE 1=1

        <if test="map.offset != null ">
            and   rownumber > #{map.offset}
        </if>

    </select>

    <!--查询发票信息条数-->
    <select id="invoiceMatchCount" resultType="Integer">
        select count(1)
        from t_dx_invoice m WITH(NOLOCK)
        <where>
            m.rebateyesorno = '1'
            and m.venderid = #{map.usercode}
            <if test="map.flowType != null and map.flowType != '' and map.flowType != '-1'">
                and m.flow_type = #{map.flowType}
            </if>
            <if test="map.jvCode != null and map.jvCode != ''and map.jvCode != '-1'">
                and m.jv_code like concat('%',concat(#{map.jvCode},'%'))
            </if>
            <if test="map.invoiceNo != null and map.invoiceNo != ''">
                and m.invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
            </if>
            <if test="map.rebateDate1 != null and map.rebateDate1 != ''">
                <![CDATA[ AND convert(varchar(100),m.rebate_date,23) >= #{map.rebateDate1} ]]>
            </if>
            <if test="map.rebateDate2 != null and map.rebateDate2 != ''">
                <![CDATA[ AND convert(varchar(100),m.rebate_date,23)  <= #{map.rebateDate2} ]]>
            </if>
            <!--<if test="map.invoiceStatus !=null and map.invoiceStatus != '-1'">-->
                <!--and m.invoice_status = #{map.invoiceStatus}-->
            <!--</if>-->
            <if test="map.invoiceType !=null and map.invoiceType != '-1'">
                and m.invoice_type = #{map.invoiceType}
            </if>
            <if test="map.qsStatus !=null and map.qsStatus != '-1'">
                and m.qs_status = #{map.qsStatus}
            </if>
            <if test="map.companyCode != null and map.companyCode != ''">
                and m.company_code = #{map.companyCode}
            </if>
            <if test="map.invoiceType !=null and map.invoiceType != '-1' and map.invoiceType != '-2'">
                and m.invoice_type = #{map.invoiceType}
            </if>
            <if test="map.invoiceType == '-2'">
                and m.invoice_type in ('01','04')
            </if>
            <if test="map.venderid != null and map.venderid != ''">
                and m.venderid = #{map.venderid}
            </if>
            <if test="map.rebateNo != null and map.rebateNo != ''">
                and m.rebateno  LIKE '%'+#{map.rebateNo}+'%'
            </if>
            <if test="map.rebateExpressno != null and map.rebateExpressno != ''">
                and m.rebate_expressno  LIKE '%' +  #{map.rebateExpressno} + '%'
            </if>
        </where>
    </select>

    <select id="queryListAll" resultType="com.xforceplus.wapp.modules.scanRefund.entity.RebatenoForQueryXiaoEntity">
        select
        m.id               Id,
        m.qs_status        qsStatus,--签收状态
        m.qs_date          qsDate,--签收日期
        m.invoice_code     invoiceCode,--发票代码
        m.invoice_no       invoiceNo,--发票号码
        m.invoice_date      createDate,--开票日期
        m.gf_name          gfName,--购方名
        m.xf_name          xfName,--销方名
        m.invoice_amount   invoiceAmount,--金额
        m.tax_amount       taxAmount,--税额
        m.jv_code           jvCode,
        m.company_code     companyCode,
        m.invoice_type     invoiceType,
        m.venderid         venderid,
        m.refund_reason            notes,
        m.rebateno         rebateNo,
        m.rebate_expressno rebateExpressno,
        m.mail_company    mailCompany,
        m.mail_date    mailDate,
        m.flow_type    flowType,
        m.rebate_date      rebateDate
        from t_dx_invoice m WITH(NOLOCK)
        where
        m.rebateyesorno = '1'
        and m.venderid = #{map.usercode}
            <if test="map.jvCode != null and map.jvCode != '' and map.jvCode != '-1'">
                and m.jv_code like concat('%',concat(#{map.jvCode},'%'))
            </if>
            <if test="map.invoiceNo != null and map.invoiceNo != ''">
                and m.invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
            </if>
        <if test="map.rebateDate1 != null and map.rebateDate1 != ''">
            <![CDATA[ AND convert(varchar(100),m.rebate_date,23) >= #{map.rebateDate1} ]]>
        </if>
        <if test="map.rebateDate2 != null and map.rebateDate2 != ''">
            <![CDATA[ AND convert(varchar(100),m.rebate_date,23)  <= #{map.rebateDate2} ]]>
        </if>
            <!--<if test="map.invoiceStatus !=null and map.invoiceStatus != '-1'">-->
                <!--and m.invoice_status = #{map.invoiceStatus}-->
            <!--</if>-->
            <if test="map.invoiceType !=null and map.invoiceType != '-1'">
                and m.invoice_type = #{map.invoiceType}
            </if>
            <if test="map.qsStatus !=null and map.qsStatus != '-1'">
                and m.qs_status = #{map.qsStatus}
            </if>
            <if test="map.companyCode != null and map.companyCode != ''">
                and m.company_code = #{map.companyCode}
            </if>
            <if test="map.invoiceType !=null and map.invoiceType != '-1' and map.invoiceType != '-2'">
                and m.invoice_type = #{map.invoiceType}
            </if>
            <if test="map.invoiceType == '-2'">
                and m.invoice_type in ('01','04')
            </if>
            <if test="map.venderid != null and map.venderid != ''">
                and m.venderid = #{map.venderid}
            </if>
        <if test="map.rebateNo != null and map.rebateNo != ''">
            and m.rebateno  LIKE '%' + #{map.rebateNo} + '%'
        </if>
        <if test="map.rebateExpressno != null and map.rebateExpressno != ''">
            and m.rebate_expressno  LIKE '%' +  #{map.rebateExpressno} + '%'
        </if>
    </select>


</mapper>