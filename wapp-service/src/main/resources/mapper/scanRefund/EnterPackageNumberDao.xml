<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.scanRefund.dao.EnterPackageNumberDao">

    <resultMap id="reportStatisticsMap" type="com.xforceplus.wapp.modules.report.entity.ReportStatisticsEntity">
        <result column="totalCount" property="totalCount" />
        <result column="totalAmount" property="totalAmount" />
        <result column="totalTax" property="totalTax" />
    </resultMap>

    <resultMap id="optionMap" type="com.xforceplus.wapp.modules.report.entity.OptionEntity">
        <result column="taxno" property="value" />
        <result column="taxname" property="label" />
    </resultMap>

    <select id="queryList" resultType="com.xforceplus.wapp.modules.scanRefund.entity.EnterPackageNumberEntity">
        /**mycat:schema=${schemaLabel}*/
        <if test="map.offset != null and map.limit != null">
            SELECT
            TOP (#{map.limit}) A.*
            FROM
            (
            SELECT
            row_number () OVER (ORDER BY rebateDate desc) AS rownumber, o.*  <!--, id desc-->
            FROM
            (
        </if>
        select

        convert(varchar(100),rebate_date,23) rebateDate,
        rebateno rebateNo,
        id,
        venderid venderId,
        invoice_type invoiceType,
        invoice_code invoiceCode,
        invoice_no invoiceNo,
        invoice_date invoiceDate,
        invoice_amount invoiceAmount,
        tax_amount taxAmount
        from t_dx_invoice WITH(NOLOCK)
        where rebateyesorno = '1'
        and (expressnoyesorno != '1' or expressnoyesorno is null)
        <if test="map.rebateNo != null and map.rebateNo != ''">
            and rebateno = #{map.rebateNo}
        </if>
        <if test="map.rebateDate1 != null and map.rebateDate1 != ''">
            <![CDATA[ AND convert(varchar(100),rebate_date,23) >= #{map.rebateDate1} ]]>
        </if>
        <if test="map.rebateDate2 != null and map.rebateDate2 != ''">
            <![CDATA[ AND convert(varchar(100),rebate_date,23)  <= #{map.rebateDate2} ]]>
        </if>
        <if test="map.offset == null and map.limit == null">
            ORDER BY rebate_date desc<!--, id desc-->
        </if>
        <if test="map.offset != null and map.limit != null">
            )
            AS o
            )A
            WHERE
            rownumber >#{map.offset}

        </if>
        <!--limit #{map.offset}, #{map.limit}-->
    </select>

    <select id="queryTotalResult" resultMap="reportStatisticsMap">
        /**mycat:schema=${schemaLabel}*/
        select count(1) totalCount, ISNULL(sum(invoice_amount),0) totalAmount, ISNULL(sum(tax_amount),0) totalTax
        from t_dx_invoice WITH(NOLOCK)
        where rebateyesorno = '1'
        and (expressnoyesorno != '1' or expressnoyesorno is null)
        <if test="map.rebateNo != null and map.rebateNo != ''">
            and rebateno = #{map.rebateNo}
        </if>
        <if test="map.rebateDate1 != null and map.rebateDate1 != ''">
            <![CDATA[ AND convert(varchar(100),rebate_date,23) >= #{map.rebateDate1} ]]>
        </if>
        <if test="map.rebateDate2 != null and map.rebateDate2 != ''">
            <![CDATA[ AND convert(varchar(100),rebate_date,23)  <= #{map.rebateDate2} ]]>
        </if>

    </select>



    <select id="queryListAll" resultType="com.xforceplus.wapp.modules.report.entity.ComprehensiveInvoiceQueryEntity">
        /**mycat:schema=${schemaLabel}*/select
        id,
        uuid,
        invoice_type invoiceType,
        invoice_code invoiceCode,
        invoice_no invoiceNo,
        invoice_date invoiceDate,
        gf_tax_no gfTaxNo,
        gf_name gfName,
        xf_tax_no xfTaxNo,
        xf_name xfName,
        invoice_amount invoiceAmount,
        tax_amount taxAmount,
        total_amount totalAmount,
        remark,
        invoice_status invoiceStatus,
        rzh_date rzhDate,
        qs_date qsDate,
        rzh_belong_date rzhBelongDate,
        rzh_yesorno rzhYesorno,
        auth_status authStatus,
        qs_type  qsType,
        qs_status qsStatus
        from t_dx_record_invoice WITH(NOLOCK)
        where 1=1
        <if test="map.gfName != null and map.gfName != '-1'">
            and gf_tax_no = #{map.gfName}
        </if>
        <if test="map.xfName != null and map.xfName != ''">
            and xf_name like concat('%',concat(#{map.xfName},'%'))
        </if>
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
        </if>
        <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23) >= #{map.invoiceDate1} ]]>
        </if>
        <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
            <![CDATA[ AND convert(varchar(10),invoice_date,23)  <= #{map.invoiceDate2} ]]>
        </if>
        <if test="map.invoiceStatus !=null and map.invoiceStatus != '-1'">
            and invoice_status = #{map.invoiceStatus}
        </if>
        <if test="map.invoiceType !=null and map.invoiceType != '-1'">
            and invoice_type = #{map.invoiceType}
        </if>
        <if test="map.qsStatus !=null and map.qsStatus != '-1'">
            and qs_status = #{map.qsStatus}
        </if>
        <if test="map.rzhYesorno !=null and map.rzhYesorno != '-1'">
            and rzh_yesorno = #{map.rzhYesorno}
        </if>
        <if test="map.qsType !=null and map.qsType != '-1'">
            and qs_type = #{map.qsType}
        </if>
        <if test="map.qsDate1 != null and map.qsDate1 != ''">
            <![CDATA[ AND convert(varchar(100),qs_date,23) >= #{map.qsDate1} ]]>
        </if>
        <if test="map.qsDate2 != null and map.qsDate2 != ''">
            <![CDATA[ AND convert(varchar(100),qs_date,23)  <= #{map.qsDate2} ]]>
        </if>
        <if test="map.rzhBelongDate !=null and map.rzhBelongDate != ''">
            and rzh_belong_date = #{map.rzhBelongDate}
        </if>
        <if test="map.rzhDate1 != null and map.rzhDate1 != ''">
            <![CDATA[ AND convert(varchar(100),rzh_date,23) >= #{map.rzhDate1} ]]>
        </if>
        <if test="map.rzhDate2 != null and map.rzhDate2 != ''">
            <![CDATA[ AND convert(varchar(100),rzh_date,23)  <= #{map.rzhDate2} ]]>
        </if>
        and gf_tax_no in (select taxno from t_ac_org WITH(NOLOCK) where orgid in (select orgid from t_ac_user_taxno where userid=#{map.userID}))
        order by invoice_date desc, id desc
    </select>

    <update id="inputrebateExpressno">
        update t_dx_invoice WITH(ROWLOCK)
        <set>
            rebate_expressno = #{rebateExpressno},
            expressnoyesorno = '1',
            mail_date = #{mailDate},
            mail_company = #{mailCompany},
        </set>
        where rebateyesorno ='1' and
        rebateno in
        <foreach item="rebateNo" collection="rebateNos" open="(" separator="," close=")">
            #{rebateNo}
        </foreach>

    </update>

    <select id="queryrebateexpressno" resultType="java.lang.Integer">
        select count(1)
        from t_dx_invoice WITH(NOLOCK)
        where rebate_expressno =#{rebateExpressno}
    </select>

    <select id="queryrebateNo" resultType="java.lang.Integer">
        select count(1)
        from t_dx_invoice WITH(NOLOCK)
        where rebateno =#{rebateNo} and rebateyesorno = '1'
        and (expressnoyesorno != '1' or expressnoyesorno is null)
    </select>

    <update id="inputrebateExpressnoBatch">
        update t_dx_invoice WITH(ROWLOCK)
        <set>
            rebate_expressno = #{rebateExpressno},
            expressnoyesorno = '1',
            mail_company = #{mailCompany},
            mail_date = #{mailDate},
        </set>
        where rebateyesorno ='1' and
        rebateno = #{rebateNo}
    </update>

</mapper>