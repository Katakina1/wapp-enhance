<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.scanRefund.dao.HostRefundDao">

    <resultMap id="reportStatisticsMap" type="com.xforceplus.wapp.modules.report.entity.ReportStatisticsEntity">
        <result column="totalCount" property="totalCount" />
        <result column="totalAmount" property="totalAmount" />
        <result column="totalTax" property="totalTax" />
    </resultMap>

    <resultMap id="optionMap" type="com.xforceplus.wapp.modules.report.entity.OptionEntity">
        <result column="taxno" property="value" />
        <result column="taxname" property="label" />
    </resultMap>

    <select id="queryList" resultType="com.xforceplus.wapp.modules.pack.entity.GenerateBindNumberEntity">
        <if test="map.offset != null and map.limit != null">
            SELECT
            TOP (#{map.limit}) A.*
            FROM
            (
            SELECT
            row_number () OVER (ORDER BY invoiceDate desc, id desc) AS rownumber, o.*
            FROM
            (
        </if>
        select
        id,
        invoice_code   invoiceCode,
        invoice_no     invoiceNo,
        invoice_type   invoiceType,
        convert(varchar(100),invoice_date,23)   invoiceDate,
        invoice_amount invoiceAmount,
        tax_amount     taxAmount,
        venderid       venderId,
        vendername     venderName,
        tax_rate       taxRate
        from
        t_dx_record_invoice WITH(NOLOCK)
        where
        host_status in ('0','1','10','13')
        and uuid in (select uuid from t_dx_invoice WITH(NOLOCK)
        where (rebateyesorno != '1' or rebateyesorno is null) and (rebateno is null or rebateno = '')
        and (isdel = '0'or isdel is null)
        )
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and invoice_no = #{map.invoiceNo}
        </if>
        <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23) >= #{map.invoiceDate1} ]]>
        </if>
        <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23)  <= #{map.invoiceDate2} ]]>
        </if>
        <if test="map.offset == null and map.limit == null">
            ORDER BY invoice_date desc, id desc
        </if>
        <if test="map.offset != null and map.limit != null">
            )
            AS o
            )A
            WHERE
            rownumber >#{map.offset}

        </if>
        <!--limit #{map.offset}, #{map.limit}-->
    </select>

    <select id="queryRzhList" resultType="com.xforceplus.wapp.modules.scanRefund.entity.GroupRefundEntity">
        <if test="map.offset != null and map.limit != null">
            SELECT
            TOP (#{map.limit}) A.*
            FROM
            (
            SELECT
            row_number () OVER (ORDER BY invoiceDate desc, id desc) AS rownumber, o.*
            FROM
            (
        </if>
        select
        b.id,
        b.invoice_code   invoiceCode,
        b.invoice_no     invoiceNo,
        b.invoice_type   invoiceType,
        convert(varchar(100),b.invoice_date,23)   invoiceDate,
        b.invoice_amount invoiceAmount,
        b.tax_amount     taxAmount,
        b.venderid       venderId,
        b.xf_name     venderName,
        b.tax_rate       taxRate,
        b.rzh_belong_date rzhBelongDate,
        b.invoice_status  invoiceStatus,
        convert(varchar(100),b.rzh_date,23)      rzhDate,
        b.company_code    companyCode,
        b.jvcode   jvcode
        from
        t_dx_record_invoice b WITH(NOLOCK)
        INNER JOIN t_dx_invoice a WITH(NOLOCK) on a.uuid = b.uuid
        where
        b.auth_status = '4'  and b.invoice_status in('2','4','1')
        and (a.rebateyesorno != '1' or a.rebateyesorno is null) and (a.rebateno is null or a.rebateno = '')
        and (a.isdel = '0'or a.isdel is null)
        <if test="map.orgcode != null and map.orgcode != ''">
            and b.gf_tax_no in(select taxno from t_ac_org WITH(NOLOCK) where orgcode = #{map.orgcode})
        </if>
        <if test="map.companyCode != null and map.companyCode != ''">
            and b.xf_tax_no in(select taxno from t_ac_org WITH(NOLOCK) where company_code = #{map.companyCode})
        </if>
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and b.invoice_no = #{map.invoiceNo}
        </if>
        <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
            <![CDATA[ AND convert(varchar(100),b.invoice_date,23) >= #{map.invoiceDate1} ]]>
        </if>
        <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
            <![CDATA[ AND convert(varchar(100),b.invoice_date,23)  <= #{map.invoiceDate2} ]]>
        </if>
        <if test="map.offset == null and map.limit == null">
            ORDER BY b.invoice_date desc, b.id desc
        </if>
        <if test="map.offset != null and map.limit != null">
            )
            AS o
            )A
            WHERE
            rownumber >#{map.offset}

        </if>
        <!--limit #{map.offset}, #{map.limit}-->
    </select>

    <select id="queryTotalResult" resultMap="reportStatisticsMap">
        select COUNT(DISTINCT b.id) totalCount
        from
        t_dx_record_invoice b WITH(NOLOCK)
        INNER JOIN t_dx_invoice a WITH(NOLOCK) on a.uuid = b.uuid
        where
        b.auth_status = '4'  and b.invoice_status in('2','4','1')
        and (a.rebateyesorno != '1' or a.rebateyesorno is null) and (a.rebateno is null or a.rebateno = '')
        and (a.isdel = '0'or a.isdel is null)
        <if test="map.orgcode != null and map.orgcode != ''">
            and b.gf_tax_no in(select taxno from t_ac_org WITH(NOLOCK) where orgcode = #{map.orgcode})
        </if>
        <if test="map.companyCode != null and map.companyCode != ''">
            and b.xf_tax_no in(select taxno from t_ac_org WITH(NOLOCK) where company_code = #{map.companyCode})
        </if>
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and b.invoice_no = #{map.invoiceNo}
        </if>
        <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
            <![CDATA[ AND convert(varchar(100),b.invoice_date,23) >= #{map.invoiceDate1} ]]>
        </if>
        <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
            <![CDATA[ AND convert(varchar(100),b.invoice_date,23)  <= #{map.invoiceDate2} ]]>
        </if>

    </select>

    <select id="queryRzhTotalResult" resultMap="reportStatisticsMap">
        select COUNT(DISTINCT b.id) totalCount
        from 
        t_dx_record_invoice b WITH(NOLOCK)
        INNER JOIN t_dx_invoice a WITH(NOLOCK) on a.uuid = b.uuid
        where
        b.auth_status = '4'  and b.invoice_status in('2','4','1')
        and (a.rebateyesorno != '1' or a.rebateyesorno is null) and (a.rebateno is null or a.rebateno = '')
        and (a.isdel = '0'or a.isdel is null)
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and b.invoice_no = #{map.invoiceNo}
        </if>
        <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
            <![CDATA[ AND convert(varchar(100),b.invoice_date,23) >= #{map.invoiceDate1} ]]>
        </if>
        <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
            <![CDATA[ AND convert(varchar(100),b.invoice_date,23)  <= #{map.invoiceDate2} ]]>
        </if>

    </select>

    <update id="inputrefundyesno">

        update t_dx_invoice WITH(ROWLOCK)
        set
        isdel = '1',
        del_date = GETDATE(),
        refund_reason = #{refundReason}
        where uuid = #{uuid} and isdel = '0'
    </update>

    <select id="queryisdel" resultType="com.xforceplus.wapp.modules.scanRefund.entity.GroupRefundEntity">
        select isdel
        from t_dx_invoice WITH(NOLOCK)
        where uuid = #{uuid}
    </select>

    <!--查询uuid-->
    <select id="queryuuid" resultType="com.xforceplus.wapp.modules.scanRefund.entity.GroupRefundEntity">
        select uuid from t_dx_record_invoice WITH(NOLOCK)
        where id  = #{id}
    </select>

    <!--查看条数-->
    <select id="getuuidCount" resultType="java.lang.Integer">
        select
        count(1)
        from
        t_dx_invoice WITH(NOLOCK)
        where  uuid = #{uuid}

    </select>

    <insert id="saveInvoice" parameterType="com.xforceplus.wapp.modules.pack.entity.GenerateBindNumberEntity">
        INSERT INTO t_dx_invoice WITH(ROWLOCK) (
        invoice_code,
        invoice_no,
        invoice_amount,
        invoice_date,
        tax_amount,
        uuid,
        invoice_type,
        gf_tax_no,
        venderid,
        total_amount,
        isdel,
        create_date,
        refund_reason
        ) VALUES (
        #{entity.invoiceCode},
        #{entity.invoiceNo},
        #{entity.invoiceAmount},
        #{entity.invoiceDate},
        #{entity.taxAmount},
        #{entity.uuid},
        #{entity.invoiceType},
        #{entity.gfTaxNo},
        #{entity.venderId},
        #{entity.totalAmount},
        '1',
        GETDATE(),
         #{entity.refundReason}
        )
    </insert>


    <select id="queryListUuid" resultType="com.xforceplus.wapp.modules.pack.entity.GenerateBindNumberEntity">
        select
        invoice_code  invoiceCode,
        invoice_no invoiceNo,
        invoice_amount invoiceAmount,
        invoice_date invoiceDate,
        tax_amount taxAmount,
        tax_rate taxRate,
        source_system sourceSystem,
        uuid uuid,
        invoice_type invoiceType,
        gf_tax_no gfTaxNo,
        venderid  venderId,
        detail_yesorno detailYesorno,
        total_amount totalAmount,
        flow_type flowType,
        invoice_status  invoiceStatus
        from
        t_dx_record_invoice WITH(NOLOCK)
        where  uuid = #{uuid}

    </select>

</mapper>