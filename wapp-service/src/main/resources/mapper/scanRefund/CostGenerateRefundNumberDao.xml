<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.scanRefund.dao.CostGenerateRefundNumberDao">

    <resultMap id="reportStatisticsMap" type="com.xforceplus.wapp.modules.report.entity.ReportStatisticsEntity">
        <result column="totalCount" property="totalCount" />
        <result column="totalAmount" property="totalAmount" />
        <result column="totalTax" property="totalTax" />
    </resultMap>

    <resultMap id="optionMap" type="com.xforceplus.wapp.modules.report.entity.OptionEntity">
        <result column="taxno" property="value" />
        <result column="taxname" property="label" />
    </resultMap>

    <select id="queryList" resultType="com.xforceplus.wapp.modules.scanRefund.entity.GenerateRefundNumberEntity">
        /**mycat:schema=${schemaLabel}*/
        <if test="map.offset != null and map.limit != null">
        SELECT
        TOP (#{map.limit}) A.*
        FROM
        (
        SELECT
        row_number () OVER (ORDER BY epsNo desc, id desc) AS rownumber, o.*
        FROM
        (
        </if>
        select
        DISTINCT(a.id),
        convert(varchar(100),a.create_date,23) createDate,
        a.invoice_serial_no invoiceSerialNo,
        a.venderid venderId,
        a.invoice_type invoiceType,
        a.invoice_code invoiceCode,
        a.invoice_no invoiceNo,
        a.invoice_date invoiceDate,
        a.invoice_amount invoiceAmount,
        a.tax_amount taxAmount,
        a.refund_reason refundReason,
        a.refund_code refundCode,
        a.rebateno rebateNo,
        a.eps_no epsNo,
        a.belongs_to belongsTo,
        a.scan_id scanId
        from t_dx_invoice a WITH(NOLOCK)
        where (a.rebateyesorno != '1' or a.rebateyesorno is null)
        and a.isdel = '1' and
        a.valid = 1 and
        a.rebateyesorno = 0 and
        a.flow_type = '2'
        <if test="map.epsNo != null and map.epsNo != '' and map.epsNo != '-1'">
            and a.eps_no = #{map.epsNo}
        </if>
        <if test="map.belongsTo == 0">
            and a.belongs_to = 'WAPP'
        </if>
        <if test="map.belongsTo == 1">
            and a.belongs_to = 'bpms'
        </if>
        <if test="map.venderId != null and map.venderId != ''">
            and a.venderid = #{map.venderId}
        </if>
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and a.invoice_no = #{map.invoiceNo}
        </if>

        <if test="map.scanId != null and map.scanId != '' and map.scanId != '-1'">
            and a.scan_id = #{map.scanId}
        </if>
        <if test="map.createDate1 != null and map.createDate1 != ''">
            <![CDATA[ AND convert(varchar(100),a.del_date,23) >= #{map.createDate1} ]]>
        </if>
        <if test="map.createDate2 != null and map.createDate2 != ''">
            <![CDATA[ AND convert(varchar(100),a.del_date,23)  <= #{map.createDate2} ]]>
        </if>
        <if test="map.offset == null and map.limit == null">
            ORDER BY a.create_date desc, id desc
        </if>
        <if test="map.offset != null and map.limit != null">
            )
            AS o
            )A
            WHERE
            rownumber >#{map.offset}

        </if>
        <!--limit #{map.offset}, #{map.limit}-->
    </select>




    <select id="queryListAlls" resultType="com.xforceplus.wapp.modules.scanRefund.entity.GenerateRefundNumberEntity">
        select
        DISTINCT(a.id),
        convert(varchar(100),a.create_date,23) createDate,
        a.invoice_serial_no invoiceSerialNo,
        a.venderid venderId,
        a.invoice_type invoiceType,
        a.invoice_code invoiceCode,
        a.invoice_no invoiceNo,
        a.invoice_date invoiceDate,
        a.invoice_amount invoiceAmount,
        a.tax_amount taxAmount,
        a.refund_reason refundReason,
        a.refund_code refundCode,
        a.rebateno rebateNo,
        a.eps_no epsNo,
        a.belongs_to belongsTo,
        a.scan_id scanId
        from t_dx_invoice a WITH(NOLOCK)
        where (a.rebateyesorno != '1' or a.rebateyesorno is null)
        and a.isdel = '1' and
        a.valid = 1 and
        a.rebateyesorno = 0 and
        a.flow_type = '2'
        <if test="map.epsNo != 'null' and map.epsNo != '' and map.epsNo != '-1'">
            and a.eps_no = #{map.epsNo}
        </if>
        <if test="map.belongsTo == 0">
            and a.belongs_to = 'WAPP'
        </if>
        <if test="map.belongsTo == 1">
            and a.belongs_to = 'bpms'
        </if>
        <if test="map.venderId != 'null' and map.venderId != ''">
            and a.venderid = #{map.venderId}
        </if>
        <if test="map.invoiceNo != 'null' and map.invoiceNo != ''">
            and a.invoice_no = #{map.invoiceNo}
        </if>

        <if test="map.scanId != null and map.scanId != '' and map.scanId != '-1'">
            and a.scan_id = #{map.scanId}
        </if>
        <if test="map.createDate1 != 'null' and map.createDate1 != ''">
            <![CDATA[ AND convert(varchar(100),a.del_date,23) >= #{map.createDate1} ]]>
        </if>
        <if test="map.createDate2 != 'null' and map.createDate2 != ''">
            <![CDATA[ AND convert(varchar(100),a.del_date,23)  <= #{map.createDate2} ]]>
        </if>
    </select>


    <select id="epsDetaList" resultType="com.xforceplus.wapp.modules.scanRefund.entity.GenerateRefundNumberEntity">
        select a.eps_no from t_dx_invoice a WITH(NOLOCK) where a.eps_no is not null
        and (a.rebateyesorno != '1' or a.rebateyesorno is null)
        and a.isdel = '1' and
        a.valid = 1 and
        a.rebateyesorno = 0 and

        a.flow_type = '2'
        <if test="map.epsNo != null and map.epsNo != '' and map.epsNo != '-1'">
            and a.eps_no = #{map.epsNo}
        </if>
        <if test="map.venderId != null and map.venderId != ''">
            and a.venderid = #{map.venderId}
        </if>
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and a.invoice_no = #{map.invoiceNo}
        </if>

        <if test="map.scanId != null and map.scanId != '' and map.scanId != '-1'">
            and a.scan_id = #{map.scanId}
        </if>
        <if test="map.createDate1 != null and map.createDate1 != ''">
            <![CDATA[ AND convert(varchar(100),a.del_date,23) >= #{map.createDate1} ]]>
        </if>
        <if test="map.createDate2 != null and map.createDate2 != ''">
            <![CDATA[ AND convert(varchar(100),a.del_date,23)  <= #{map.createDate2} ]]>
        </if>
        <if test="map.offset == null and map.limit == null">
            ORDER BY a.eps_no desc
        </if>
        group by a.eps_no
    </select>




    <select id="queryTotalResult" resultMap="reportStatisticsMap">
        /**mycat:schema=${schemaLabel}*/
        select count(DISTINCT(a.id)) totalCount, ISNULL(sum(a.invoice_amount),0) totalAmount, ISNULL(sum(a.tax_amount),0) totalTax
        from t_dx_invoice a WITH(NOLOCK)
        where (a.rebateyesorno != '1' or a.rebateyesorno is null)
        and a.isdel = '1' and
        a.valid = 1 and
        a.rebateyesorno = 0 and

        a.flow_type = '2'
        <if test="map.epsNo != null and map.epsNo != '' and map.epsNo != '-1'">
            and a.eps_no = #{map.epsNo}
        </if>
        <if test="map.belongsTo == 0">
            and a.belongs_to = 'WAPP'
        </if>
        <if test="map.belongsTo == 1">
            and a.belongs_to = 'bpms'
        </if>
        <if test="map.venderId != null and map.venderId != ''">
            and a.venderid = #{map.venderId}
        </if>
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and a.invoice_no = #{map.invoiceNo}
        </if>
        <if test="map.scanId != null and map.scanId != '' and map.scanId != '-1'">
            and a.scan_id = #{map.scanId}
        </if>
        <if test="map.createDate1 != null and map.createDate1 != ''">
            <![CDATA[ AND convert(varchar(100),a.del_date,23) >= #{map.createDate1} ]]>
        </if>
        <if test="map.createDate2 != null and map.createDate2 != ''">
            <![CDATA[ AND convert(varchar(100),a.del_date,23)  <= #{map.createDate2} ]]>
        </if>
       <!-- <if test="map.qssDate1 != null and map.qssDate1 != ''">
            <![CDATA[ AND convert(varchar(100),a.qs_date,23) >= #{map.qssDate1} ]]>
        </if>
        <if test="map.qssDate2 != null and map.qssDate2 != ''">
            <![CDATA[ AND convert(varchar(100),a.qs_date,23)  <= #{map.qssDate2} ]]>
        </if>-->
    </select>

    <update id="rebatenobyId">
        update t_dx_invoice WITH(ROWLOCK)
        <set>
            rebateno =#{rebateNo},
            rebateyesorno = '1',
            rebate_date = getdate()
        </set>
        where id = #{id}

    </update>

    <update id="rebatenobyuuid">
        update t_dx_record_invoice WITH(ROWLOCK)
        <set>
            qs_status='0',
            scan_match_status='0',
            qs_date=null,
            scan_match_date=null,
            tp_status = '2'
        </set>
        where uuid = #{uuid}
    </update>

    <!--查询uuid-->
    <select id="queryuuid1" resultType="com.xforceplus.wapp.modules.scanRefund.entity.GenerateRefundNumberEntity">
        select uuid
        from t_dx_invoice WITH(NOLOCK)
        where id =
        #{id}
    </select>

    <!--查询退单号-->
    <select id="queryrebateno" resultType="com.xforceplus.wapp.modules.scanRefund.entity.GenerateRefundNumberEntity">
        select rebateno rebateNo
        from t_dx_invoice WITH(NOLOCK)
        where id =
            #{id}
    </select>
    <!--查询最大退单号-->
    <select id="querymaxrebateno" resultType="com.xforceplus.wapp.modules.scanRefund.entity.GenerateRefundNumberEntity">
        select MAX(rebateno)  rebateNo
        from t_dx_invoice WITH(NOLOCK)
    </select>

    <!--<select id="queryrebatenoListCount" resultType="java.lang.Integer">-->
        <!--select COUNT (1)-->
        <!--from t_dx_record_invoice WITH(NOLOCK)-->
        <!--where id in-->
        <!--<foreach item="id" collection="ids" open="(" separator="," close=")">-->
            <!--#{id}-->
        <!--</foreach>-->
    <!--</select>-->
    <select id="queryepsno" resultType="com.xforceplus.wapp.modules.scanRefund.entity.GenerateRefundNumberEntity">
        select id
        from t_dx_invoice WITH(NOLOCK) where eps_no = #{epsNo}
    </select>

</mapper>