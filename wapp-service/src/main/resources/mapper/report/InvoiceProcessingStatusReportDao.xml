<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xforceplus.wapp.modules.report.dao.InvoiceProcessingStatusReportDao">

    <resultMap id="gfoptionMap" type="com.xforceplus.wapp.modules.report.entity.GfOptionEntity">
        <result column="orgcode" property="value" />
        <result column="taxname" property="label"/>
    </resultMap>

    <!--查询发票匹配处理状态报告信息-->
    <select id="matchlist" resultType="com.xforceplus.wapp.modules.report.entity.MatchEntity">
        SELECT
        <if test=" map.limit != null">
            TOP (#{map.limit})
        </if>
        A.*
        FROM
        (
        SELECT
        row_number () OVER (ORDER BY o.id ) AS rownumber ,o.*
        FROM
        (
        select
        m.id,
        m.venderid         venderId,
        u.username         vendername,
        r.invoice_no       invoiceNo,
        r.invoice_type     invoiceType,
        r.jvcode           orgcode,
        r.company_code     companyCode,
        m.settlementamount settlementAmount,
        m.po_amount        poAmount,
        m.claim_amount     claimAmount,
        m.match_date       matchDate,
        m.gf_name          gfName,
        m.po_num           poNum,
        m.claim_num        claimNum,
        m.invoice_num      invoiceNum,
        m.invoice_amount   invoiceAmount,
        r.host_status      hostStatus
        from t_dx_match m WITH(NOLOCK)
        left join t_dx_record_invoice r WITH(NOLOCK) on m.matchno=r.matchno
        left join t_ac_user u WITH(NOLOCK) on m.venderid=u.usercode
        <where>
            <if test="map.companyCode != null and map.companyCode != ''">
                AND m.matchno in (SELECT matchno FROM t_dx_record_invoice WITH(NOLOCK) where company_code = #{map.companyCode})
            </if>
            <if test="map.gfName != null and map.gfName != ''and map.gfName != '-1'">
                and r.jvcode like concat('%',concat(#{map.gfName},'%'))
            </if>
            <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
                <![CDATA[ AND convert(varchar(100),m.match_date,23) >= #{map.invoiceDate1} ]]>
            </if>
            <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
                <![CDATA[ AND convert(varchar(10),m.match_date,23)  <= #{map.invoiceDate2} ]]>
            </if>
            <if test="map.venderId != null and map.venderId != ''">
                and m.venderid like concat('%',concat(#{map.venderId},'%'))
            </if>
        </where>
        ) AS o
        ) A
        WHERE 1=1
        <if test="map.offset != null ">
            and   rownumber > #{map.offset}
        </if>
    </select>

    <!--查询发票匹配处理状态报告信息条数-->
    <select id="matchlistCount" resultType="Integer">
        select count(1)
        from t_dx_match m WITH(NOLOCK)
        left join t_dx_record_invoice r WITH(NOLOCK) on m.matchno=r.matchno
        left join t_ac_user u WITH(NOLOCK) on m.venderid=u.usercode
        <where>
            <if test="map.companyCode != null and map.companyCode != ''">
                AND m.matchno in (SELECT matchno FROM t_dx_record_invoice WITH(NOLOCK) where company_code = #{map.companyCode})
            </if>
            <if test="map.gfName != null and map.gfName != ''and map.gfName != '-1'">
                and r.jvcode like concat('%',concat(#{map.gfName},'%'))
            </if>
            <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
                <![CDATA[ AND convert(varchar(100),m.match_date,23) >= #{map.invoiceDate1} ]]>
            </if>
            <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
                <![CDATA[ AND convert(varchar(10),m.match_date,23)  <= #{map.invoiceDate2} ]]>
            </if>
            <if test="map.venderId != null and map.venderId != ''">
                and m.venderid like concat('%',concat(#{map.venderId},'%'))
            </if>
        </where>
    </select>

    <select id="searchGf" resultMap="gfoptionMap">
        select orgname taxname,orgcode from t_ac_org WITH(NOLOCK) where orgtype=5
    </select>

</mapper>