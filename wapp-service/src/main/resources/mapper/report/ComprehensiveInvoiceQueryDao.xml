<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.report.dao.ComprehensiveInvoiceQueryDao">

    <resultMap id="reportStatisticsMap" type="com.xforceplus.wapp.modules.report.entity.ReportStatisticsEntity">
        <result column="totalCount" property="totalCount" />
        <result column="totalAmount" property="totalAmount" />
        <result column="totalTax" property="totalTax" />
        <result column="taxAmount" property="taxAmount" />
    </resultMap>

    <resultMap id="optionMap" type="com.xforceplus.wapp.modules.report.entity.OptionEntity">
        <result column="taxno" property="value" />
        <result column="taxname" property="label" />
    </resultMap>

    <resultMap id="flowTypeMap" type="com.xforceplus.wapp.modules.report.entity.OptionEntity">
        <result column="billtypecode" property="value" />
        <result column="billtypename" property="label" />
    </resultMap>

    <select id="queryList" resultType="com.xforceplus.wapp.modules.report.entity.ComprehensiveInvoiceQueryEntity">
        /**mycat:schema=${schemaLabel}*/
        <if test="map.offset != null and map.limit != null">
            SELECT
            TOP (#{map.limit}) A.*
            FROM
            (
            SELECT
            row_number () OVER (ORDER BY id desc) AS rownumber, o.*
            FROM
            (
        </if>
        select
        id,
        invoice_type invoiceType,
        invoice_code invoiceCode,
        invoice_no invoiceNo,
        invoice_date invoiceDate,
        gf_tax_no gfTaxNo,
        gf_name gfName,
        xf_tax_no xfTaxNo,
        xf_name xfName,
        invoice_amount invoiceAmount,
        tax_amount taxAmount,
        total_amount totalAmount,
        remark,
        invoice_status invoiceStatus,
        rzh_date rzhDate,
        qs_date qsDate,
        rzh_belong_date rzhBelongDate,
        rzh_yesorno rzhYesorno,
        auth_status authStatus,
        qs_type qsType,
        qs_status qsStatus,
        certificate_no certificateNo,
        dxhy_match_status dxhyMatchStatus,
        match_date matchDate,
        host_status hostStatus,
        scanning_seriano scanningSeriano,
        bbindingno,
        packingno,
        tax_rate taxRate,
        venderid venderId,
        tp_status tpStatus,
        scan_match_status scanMatchStatus,
        scan_match_date scanMatchDate,
        host_date hostDate,
        jvcode jvCode,
        payment_date paymentDate,
        company_code  companyCode,
        flow_type     flowType,
        check_code,
        packing_address packingAddress,
        borrow_date borrowDate,
        borrow_user borrowUser,
        borrow_reason borrowReason,
        borrow_dept borrowDept,
        borrow_return_date borrowReturnDate,
        borrow_return_user borrowReturnUser
        from t_dx_record_invoice WITH(NOLOCK)
        where 1=1
        <if test="map.checkCode != null and map.checkCode != '-1'">
            and (check_code =#{map.checkCode}  or  right(check_code,6)=#{map.checkCode} )
        </if>
        <if test="map.invoiceDateQuery != null and map.invoiceDateQuery != '-1'">
            <![CDATA[ AND convert(varchar(100),invoice_date,23) = #{map.invoiceDateQuery} ]]>
        </if>
        <if test="map.gfName != null and map.gfName != '-1'">
            and jvcode like concat('%',concat(#{map.gfName},'%'))
        </if>
        <if test="map.xfName != null and map.xfName != ''">
            and venderid like concat('%',concat(#{map.xfName},'%'))
        </if>
        <if test="map.invoiceCode != null and map.invoiceCode != ''">
            and invoice_code like concat('%',concat(#{map.invoiceCode},'%'))
        </if>
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
        </if>
        <if test="map.flowType != null and map.flowType != ''and map.flowType != '-1'">
            and flow_type like concat('%',concat(#{map.flowType},'%'))
        </if>
        <if test="map.invoiceDate1 != null and map.invoiceDate1 != '' and map.bbindingno == '' and map.packingno == ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23) >= #{map.invoiceDate1} ]]>
        </if>
        <if test="map.invoiceDate2 != null and map.invoiceDate2 != '' and map.bbindingno == '' and map.packingno == ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23)  <= #{map.invoiceDate2} ]]>
        </if>
        <if test="map.invoiceStatus !=null and map.invoiceStatus != '-1'">
            and invoice_status = #{map.invoiceStatus}
        </if>
        <if test="map.invoiceType !=null and map.invoiceType != '-1' and map.invoiceType != '-2'">
            and invoice_type = #{map.invoiceType}
        </if>
        <if test="map.invoiceType == '-2'">
            and invoice_type in ('01','04')
        </if>
        <if test="map.dxhyMatchStatus !=null and map.dxhyMatchStatus != '-1'">
            and dxhy_match_status = #{map.dxhyMatchStatus}
        </if>
        <if test="map.qsStatus !=null and map.qsStatus != '-1'">
            and qs_status = #{map.qsStatus}
        </if>
        <if test="map.rzhYesorno==0">
            and (rzh_yesorno= #{map.rzhYesorno} or rzh_yesorno is null)
        </if>
        <if test="map.rzhYesorno==1">
            and (rzh_yesorno= #{map.rzhYesorno})
        </if>
        <if test="map.bbindingno !=null and map.bbindingno != ''">
            and bbindingno like concat('%',concat(#{map.bbindingno},'%'))
        </if>
        <if test="map.packingno !=null and map.packingno != ''">
            and packingno like concat('%',concat(#{map.packingno},'%'))
        </if>
        <if test="map.qsType !=null and map.qsType != '-1'">
            and qs_type = #{map.qsType}
        </if>
        <if test="map.qsDate1 != null and map.qsDate1 != ''">
            <![CDATA[ AND convert(varchar(100),qs_date,23) >= #{map.qsDate1} ]]>
        </if>
        <if test="map.qsDate2 != null and map.qsDate2 != ''">
            <![CDATA[ AND convert(varchar(100),qs_date,23)  <= #{map.qsDate2}) ]]>
        </if>
        <if test="map.rzhBelongDate !=null and map.rzhBelongDate != ''">
            and rzh_belong_date = #{map.rzhBelongDate}
        </if>
        <if test="map.rzhDate1 != null and map.rzhDate1 != ''">
            <![CDATA[ AND convert(varchar(100),rzh_date,23) >= #{map.rzhDate1} ]]>
        </if>
        <if test="map.rzhDate2 != null and map.rzhDate2 != ''">
            <![CDATA[ AND convert(varchar(100),rzh_date,23)  <= #{map.rzhDate2} ]]>
        </if>
        <if test="map.matchDateStart != null and map.matchDateStart != ''">
            <![CDATA[ AND convert(varchar(100),match_date,23) >= #{map.matchDateStart} ]]>
        </if>
        <if test="map.matchDateEnd != null and map.matchDateEnd != ''">
            <![CDATA[ AND convert(varchar(100),match_date,23)  <= #{map.matchDateEnd} ]]>
        </if>
        <if test="map.venderno !=null  and map.venderno !=''">
            and venderid =#{map.venderno}
        </if>
        <choose>
            <when test="map.hoststatus ==0">
                AND (host_status in ('0','1','10') or host_status is null)
            </when>
            <when test="map.hoststatus ==1">
                AND host_status in ('5','11','12')
            </when>
            <when test="map.hoststatus ==2">
                AND host_status in ('9','14')
            </when>
            <when test="map.hoststatus ==3">
                AND host_status in ('15','19','99','999')
            </when>
            <when test="map.hoststatus ==8">
                AND host_status in ('8')
            </when>
            <when test="map.hoststatus ==9">
                AND tp_status='2'
            </when>
            <otherwise></otherwise>
        </choose>

        <!--<if test="map.userID !=null or map.userID !=''">
            and xf_tax_no in (select taxno from t_ac_org WITH(NOLOCK) where orgid in (select orgid from t_ac_user WITH(NOLOCK) where userid=#{map.userID}))
        </if>-->
        <if test="map.offset != null and map.limit != null">
            )
            AS o
            )A
            WHERE
            rownumber >#{map.offset} order by id desc

        </if>
        <!--limit #{map.offset}, #{map.limit}-->
    </select>

    <select id="queryTotalResult" resultMap="reportStatisticsMap">
        /**mycat:schema=${schemaLabel}*/select count(1) totalCount, ISNULL(sum(invoice_amount),0) totalAmount, ISNULL(sum(tax_amount),0) totalTax,
        ISNULL(sum(total_amount),0) taxAmount
        from t_dx_record_invoice WITH(NOLOCK)
        where 1=1
        <if test="map.gfName != null and map.gfName != '-1'">
            and jvcode like concat('%',concat(#{map.gfName},'%'))
        </if>
        <if test="map.xfName != null and map.xfName != ''">
            and venderid like concat('%',concat(#{map.xfName},'%'))
        </if>
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
        </if>
        <if test="map.flowType != null and map.flowType != ''and map.flowType != '-1'">
            and flow_type like concat('%',concat(#{map.flowType},'%'))
        </if>
        <if test="map.invoiceDate1 != null and map.invoiceDate1 != '' and map.bbindingno == '' and map.packingno == ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23) >= #{map.invoiceDate1} ]]>
        </if>
        <if test="map.invoiceDate2 != null and map.invoiceDate2 != '' and map.bbindingno == '' and map.packingno == ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23)  <= #{map.invoiceDate2} ]]>
        </if>
        <if test="map.invoiceStatus !=null and map.invoiceStatus != '-1'">
            and invoice_status = #{map.invoiceStatus}
        </if>
        <if test="map.invoiceType !=null and map.invoiceType != '-1' and map.invoiceType != '-2'">
            and invoice_type = #{map.invoiceType}
        </if>
        <if test="map.invoiceType == '-2'">
            and invoice_type in ('01','04')
        </if>
        <if test="map.qsStatus !=null and map.qsStatus != '-1'">
            and qs_status = #{map.qsStatus}
        </if>
        <if test="map.dxhyMatchStatus !=null and map.dxhyMatchStatus != '-1'">
            and dxhy_match_status = #{map.dxhyMatchStatus}
        </if>
        <if test="map.rzhYesorno==0">
            and (rzh_yesorno= #{map.rzhYesorno} or rzh_yesorno is null)
        </if>
        <if test="map.rzhYesorno==1">
            and (rzh_yesorno= #{map.rzhYesorno})
        </if>
        <if test="map.bbindingno !=null and map.bbindingno != ''">
            and bbindingno like concat('%',concat(#{map.bbindingno},'%'))
        </if>
        <if test="map.packingno !=null and map.packingno != ''">
            and packingno like concat('%',concat(#{map.packingno},'%'))
        </if>
        <if test="map.qsType !=null and map.qsType != '-1'">
            and qs_type = #{map.qsType}
        </if>
        <if test="map.qsDate1 != null and map.qsDate1 != ''">
            <![CDATA[ AND convert(varchar(100),qs_date,23) >= #{map.qsDate1} ]]>
        </if>
        <if test="map.qsDate2 != null and map.qsDate2 != ''">
            <![CDATA[ AND convert(varchar(100),qs_date,23)  <= #{map.qsDate2} ]]>
        </if>
        <if test="map.rzhBelongDate !=null and map.rzhBelongDate != ''">
            and rzh_belong_date = #{map.rzhBelongDate}
        </if>
        <if test="map.matchDateStart != null and map.matchDateStart != ''">
            <![CDATA[ AND convert(varchar(100),match_date,23) >= #{map.matchDateStart} ]]>
        </if>
        <if test="map.matchDateEnd != null and map.matchDateEnd != ''">
            <![CDATA[ AND convert(varchar(100),match_date,23)  <= #{map.matchDateEnd} ]]>
        </if>
        <if test="map.rzhDate1 != null and map.rzhDate1 != ''">
            <![CDATA[ AND convert(varchar(10),rzh_date,23) >= #{map.rzhDate1} ]]>
        </if>
        <if test="map.rzhDate2 != null and map.rzhDate2 != ''">
            <![CDATA[ AND convert(varchar(10),rzh_date,23)  <= #{map.rzhDate2} ]]>
        </if>
        <if test="map.venderno !=null  and map.venderno !=''">
            and venderid =#{map.venderno}
        </if>
        <choose>
            <when test="map.hoststatus ==0">
                AND (host_status in ('0','1','10') or host_status is null)
            </when>
            <when test="map.hoststatus ==1">
                AND host_status in ('5','11','12')
            </when>
            <when test="map.hoststatus ==2">
                AND host_status in ('9','14')
            </when>
            <when test="map.hoststatus ==3">
                AND host_status in ('15','19','99','999')
            </when>
            <when test="map.hoststatus ==8">
                AND host_status in ('8')
            </when>
            <when test="map.hoststatus ==9">
                AND tp_status='2'
            </when>
            <otherwise></otherwise>
        </choose>

        <!--<if test="map.venderid !=null or map.venderid !=''">
            and xf_tax_no in (select taxno from t_ac_org WITH(NOLOCK) where orgid in (select orgid from t_ac_user WITH(NOLOCK) where userid=#{map.userID}))
        </if>-->
    </select>



    <select id="queryListAll" resultType="com.xforceplus.wapp.modules.report.entity.ComprehensiveInvoiceQueryEntity">
        /**mycat:schema=${schemaLabel}*/select
        id,
        uuid,
        invoice_type invoiceType,
        invoice_code invoiceCode,
        invoice_no invoiceNo,
        invoice_date invoiceDate,
        gf_tax_no gfTaxNo,
        gf_name gfName,
        xf_tax_no xfTaxNo,
        xf_name xfName,
        invoice_amount invoiceAmount,
        tax_amount taxAmount,
        total_amount totalAmount,
        remark,
        invoice_status invoiceStatus,
        rzh_date rzhDate,
        qs_date qsDate,
        rzh_belong_date rzhBelongDate,
        rzh_yesorno rzhYesorno,
        auth_status authStatus,
        qs_type  qsType,
        qs_status qsStatus,
        tp_status tpStatus,
        dxhy_match_status dxhyMatchStatus,
        match_date matchDate,
        host_status hostStatus,
        scanning_seriano scanningSeriano,
        bbindingno,
        packingno,
        venderid venderId,
        jvcode jvCode,
        company_code  companyCode,
        flow_type     flowType,
        payment_date paymentDate
        from t_dx_record_invoice WITH(NOLOCK)
        where 1=1
        <if test="map.gfName != null and map.gfName != '-1'">
            and jvcode like concat('%',concat(#{map.gfName},'%'))
        </if>
        <if test="map.xfName != null and map.xfName != ''">
            and venderid like concat('%',concat(#{map.xfName},'%'))
        </if>
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
        </if>
        <if test="map.flowType != null and map.flowType != ''and map.flowType != '-1'">
            and flow_type like concat('%',concat(#{map.flowType},'%'))
        </if>
        <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23) >= #{map.invoiceDate1} ]]>
        </if>
        <if test="map.matchDateStart != null and map.matchDateStart != ''">
            <![CDATA[ AND convert(varchar(100),match_date,23) >= #{map.matchDateStart} ]]>
        </if>
        <if test="map.matchDateEnd != null and map.matchDateEnd != ''">
            <![CDATA[ AND convert(varchar(100),match_date,23)  <= #{map.matchDateEnd} ]]>
        </if>
        <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
            <![CDATA[ AND convert(varchar(10),invoice_date,23)  <= #{map.invoiceDate2} ]]>
        </if>
        <if test="map.invoiceStatus !=null and map.invoiceStatus != '-1'">
            and invoice_status = #{map.invoiceStatus}
        </if>
        <if test="map.invoiceType !=null and map.invoiceType != '-1' and map.invoiceType != '-2'">
            and invoice_type = #{map.invoiceType}
        </if>
        <if test="map.invoiceType == '-2'">
            and invoice_type in ('01','04')
        </if>
        <if test="map.qsStatus !=null and map.qsStatus != '-1'">
            and qs_status = #{map.qsStatus}
        </if>
        <if test="map.rzhYesorno !=null and map.rzhYesorno != '-1'">
            and rzh_yesorno = #{map.rzhYesorno}
        </if>
        <if test="map.bbindingno !=null and map.bbindingno != ''">
            and bbindingno like concat('%',concat(#{map.bbindingno},'%'))
        </if>
        <if test="map.packingno !=null and map.packingno != ''">
            and packingno like concat('%',concat(#{map.packingno},'%'))
        </if>
        <if test="map.qsType !=null and map.qsType != '-1'">
            and qs_type = #{map.qsType}
        </if>
        <if test="map.qsDate1 != null and map.qsDate1 != ''">
            <![CDATA[ AND convert(varchar(100),qs_date,23) >= #{map.qsDate1} ]]>
        </if>
        <if test="map.qsDate2 != null and map.qsDate2 != ''">
            <![CDATA[ AND convert(varchar(100),qs_date,23)  <= #{map.qsDate2} ]]>
        </if>
        <if test="map.rzhBelongDate !=null and map.rzhBelongDate != ''">
            and rzh_belong_date = #{map.rzhBelongDate}
        </if>
        <if test="map.rzhDate1 != null and map.rzhDate1 != ''">
            <![CDATA[ AND convert(varchar(100),rzh_date,23) >= #{map.rzhDate1} ]]>
        </if>
        <if test="map.rzhDate2 != null and map.rzhDate2 != ''">
            <![CDATA[ AND convert(varchar(100),rzh_date,23)  <= #{map.rzhDate2} ]]>
        </if>
        <if test="map.venderno !=null  and map.venderno !=''">
            and venderid =#{map.venderno}
        </if>
        <choose>
            <when test="map.hoststatus ==0">
                AND (host_status in ('0','1','10') or host_status is null)
            </when>
            <when test="map.hoststatus ==1">
                AND host_status in ('5','11','12')
            </when>
            <when test="map.hoststatus ==2">
                AND host_status in ('9','14')
            </when>
            <when test="map.hoststatus ==3">
                AND host_status in ('15','19','99','999')
            </when>
            <when test="map.hoststatus ==8">
                AND host_status in ('8')
            </when>
            <when test="map.hoststatus ==9">
                AND tp_status='2'
            </when>
            <otherwise></otherwise>
        </choose>
        <!--&lt;!&ndash;&lt;!&ndash;<if test="map.venderid ==null and map.venderid ==''">-->
        <!--and gf_tax_no in (select taxno from t_ac_org WITH(NOLOCK) where orgid in (select orgid from t_ac_user_taxno where userid=#{map.userID}))-->
        <!--</if>&ndash;&gt;-->
        <!--<if test="map.venderid !=null or map.venderid !=''">
            and xf_tax_no in (select taxno from t_ac_org WITH(NOLOCK) where orgid in (select orgid from t_ac_user WITH(NOLOCK) where userid=#{map.userID}))
        </if>&ndash;&gt;-->
        order by invoice_date desc, id desc
    </select>

    <select id="queryListSL" resultType="com.xforceplus.wapp.modules.report.entity.ComprehensiveInvoiceQueryEntity">
        /**mycat:schema=${schemaLabel}*/select
        tdi.id,
        tdi.invoice_code invoiceCode,
        tdi.invoice_no invoiceNo,
        case when tdis.detail_amount is null then tdi.invoice_amount else tdis.detail_amount end as invoiceAmount,
        case when tdis.tax_amount is null then tdi.tax_amount else tdis.tax_amount end as taxAmount,
        tdis.tax_rate taxRate
        from t_dx_record_invoice tdi WITH(NOLOCK)
        left join t_dx_record_invoice_statistics  tdis WITH(NOLOCK)
        on tdi.uuid = concat(tdis.invoice_code, tdis.invoice_no)
        where valid='1'
        <if test="map.gfName != null and map.gfName != '-1'">
            and tdi.gf_tax_no = #{map.gfName}
        </if>
        <if test="map.xfName != null and map.xfName != ''">
            and tdi.venderid like concat('%',concat(#{map.xfName},'%'))
        </if>
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and tdi.invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
        </if>
        <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
            <![CDATA[ AND convert(varchar(100),tdi.invoice_date,23) >= #{map.invoiceDate1} ]]>
        </if>
        <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
            <![CDATA[ AND convert(varchar(100),tdi.invoice_date,23)  <= #{map.invoiceDate2} ]]>
        </if>
        <if test="map.invoiceStatus !=null and map.invoiceStatus != '-1'">
            and tdi.invoice_status = #{map.invoiceStatus}
        </if>
        <if test="map.invoiceType !=null and map.invoiceType != '-1'">
            and tdi.invoice_type = #{map.invoiceType}
        </if>
        <if test="map.qsStatus !=null and map.qsStatus != '-1'">
            and tdi.qs_status = #{map.qsStatus}
        </if>
        <if test="map.rzhYesorno !=null and map.rzhYesorno != '-1'">
            and tdi.rzh_yesorno = #{map.rzhYesorno}
        </if>
        <if test="map.qsType !=null and map.qsType != '-1'">
            and tdi.qs_type = #{map.qsType}
        </if>
        <if test="map.qsDate1 != null and map.qsDate1 != ''">
            <![CDATA[ AND convert(varchar(100),tdi.qs_date,23) >= #{map.qsDate1} ]]>
        </if>
        <if test="map.qsDate2 != null and map.qsDate2 != ''">
            <![CDATA[ AND convert(varchar(100),tdi.qs_date,23)  <= #{map.qsDate2}]]>
        </if>
        <if test="map.rzhBelongDate !=null and map.rzhBelongDate != ''">
            and tdi.rzh_belong_date = #{map.rzhBelongDate}
        </if>
        <if test="map.rzhDate1 != null and map.rzhDate1 != ''">
            <![CDATA[ AND convert(varchar(100),tdi.rzh_date,23) >= #{map.rzhDate1} ]]>
        </if>
        <if test="map.rzhDate2 != null and map.rzhDate2 != ''">
            <![CDATA[ AND convert(varchar(100),tdi.rzh_date,23)  <= #{map.rzhDate2} ]]>
        </if>
        /*and tdi.gf_tax_no in (select taxno from t_ac_org WITH(NOLOCK) where orgid in (select orgid from t_ac_user WITH(NOLOCK) where userid=#{map.userID}))*/
        order by tdi.invoice_date desc, tdi.id desc
    </select>


    <select id="searchGf" resultMap="optionMap">
        /**mycat:schema=${schemaLabel}*/select taxno, orgname taxname from t_ac_org WITH(NOLOCK) where orgtype=5
    </select>

    <select id="searchXf" resultType="String">
        /**mycat:schema=${schemaLabel}*/select DISTINCT xf_name from t_dx_record_invoice WITH(NOLOCK) where xf_name like concat('%',concat(#{map.queryString},'%'))
        /*and gf_tax_no in (select taxno from t_ac_org WITH(NOLOCK) where orgid in (select orgid from t_ac_user WITH(NOLOCK) where userid=#{map.userID}))*/
    </select>

    <select id="searchflowType" resultMap="flowTypeMap">
        select billtypecode,billtypename from t_ac_billtype WITH(NOLOCK)
    </select>
</mapper>