<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xforceplus.wapp.modules.report.dao.SupplierIssueInvoiceQuantityandRatioDao">

    <!--查询问题发票数量及比率-->
    <select id="problemInvoice" resultType="com.xforceplus.wapp.modules.report.entity.QuestionInvoiceQuantityAndRatioEntity">
        SELECT
        <if test=" map.limit != null">
            TOP (#{map.limit})
        </if>
        A.*
        FROM
        (
        SELECT
        row_number () OVER (ORDER BY o.venderId ) AS rownumber ,o.*
        FROM
        (
        SELECT
        u.usercode   venderId,
        u.username   vendername,
        SUM(CASE WHEN r.invoice_status='0' then 1 ELSE 0 END) normalInvoice,
        SUM(CASE WHEN r.invoice_status!='0' then 1 ELSE 0 END) problemInvoice,
        SUBSTRING (convert(varchar (20),(SUM(CASE WHEN r.invoice_status!='0' then 1 ELSE 0 END)* 100 / count(1)) ),1,3)+'%' problemInvoiceRatio
        from t_ac_user u WITH(NOLOCK)
        LEFT JOIN t_ac_org o WITH(NOLOCK) on o.orgid=u.orgid
        LEFT JOIN t_dx_record_invoice r WITH(NOLOCK) on r.xf_tax_no=o.taxno
        <where>
             and o.orgtype='8'
            <if test="map.venderId != null and map.venderId != ''">
                and u.usercode like concat('%',concat(#{map.venderId},'%'))
            </if>
            <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
                <![CDATA[ AND convert(varchar(100),r.invoice_date,23) >= #{map.invoiceDate1} ]]>
            </if>
            <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
                <![CDATA[ AND convert(varchar(10),r.invoice_date,23)  <= #{map.invoiceDate2} ]]>
            </if>
        </where>
        GROUP BY u.usercode,u.username
        ) AS o
        ) A
        WHERE 1=1
        <if test="map.offset != null ">
            and   rownumber > #{map.offset}
        </if>
    </select>
</mapper>