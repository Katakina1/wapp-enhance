<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.report.dao.SignedUncertifiedDao">

    <!--数据库表表明对应实体类的属性-->
    <sql id="t_dx_record_invoice_Column">
    tdri.id id,
    DATE_FORMAT(tdri.qs_date,'%Y-%m-%d') qsDate,
    tdri.invoice_code invoiceCode,
    tdri.invoice_no invoiceNo,
    DATE_FORMAT(tdri.invoice_date,'%Y-%m-%d') invoiceDate,
    tdri.gf_tax_no gfTaxNo,
    tdri.gf_name gfName,
    tdri.xf_tax_no xfTaxNo,
    tdri.xf_name xfName,
    tdri.invoice_amount invoiceAmount,
    tdri.tax_amount taxAmount,
    tdri.qs_type qsType,
    tdri.invoice_type invoiceType
</sql>

    <!--已签收未认证发票-->
    <select id="queryList" resultType="com.xforceplus.wapp.modules.report.entity.ComprehensiveInvoiceQueryEntity">
        /**mycat:schema=${schemaLabel}*/ select
        <include refid="t_dx_record_invoice_Column"/>
        FROM t_dx_record_invoice tdri WITH(NOLOCK)
        INNER JOIN t_ac_org tao WITH(NOLOCK) ON tao. taxno= tdri.gf_tax_no
        INNER JOIN t_ac_user_taxno taut ON taut.orgid=tao.orgid
        WHERE tdri.valid='1'
        AND tdri.qs_status='1'
        AND tdri.rzh_yesorno='0'
        AND tdri.invoice_status='0'
        AND taut.userid=#{map.userId}
        AND tdri.invoice_type IN ('01','03','14')
        <if test="map.gfName !=null and map.gfName!=''">
            AND tdri.gf_tax_no =#{map.gfName}
        </if>
        <if test="map.xfName !=null and map.xfName!=''">
            AND tdri.xf_name LIKE '%${map.xfName}%'
        </if>
        <if test="map.invoiceNo !=null and map.invoiceNo!=''">
            AND tdri.invoice_no LIKE '%${map.invoiceNo}%'
        </if>

        <if test="map.qsStartDate !=null and map.qsStartDate!=''">
            <![CDATA[ AND date_format(tdri.qs_date, '%Y-%m-%d') >=#{map.qsStartDate}  ]]>
        </if>
        <if test="map.qsEndDate !=null and map.qsEndDate!=''">
            <![CDATA[ AND date_format(tdri.qs_date, '%Y-%m-%d')<=#{map.qsEndDate}]]>
        </if>

        <if test="map.qsType !=null and map.qsType!=''">
            AND tdri.qs_type =#{map.qsType}
        </if>

        ORDER BY tdri.qs_date desc,tdri.id desc
        <if test="map.offset !=null and map.limit!=null">
            limit #{map.offset}, #{map.limit}
        </if>

    </select>

    <!--已签收未认证发票count-->
    <select id="queryTotal" resultType="Integer">
        /**mycat:schema=${schemaLabel}*/ SELECT count(0)
        FROM t_dx_record_invoice tdri WITH(NOLOCK)
        INNER JOIN t_ac_org tao WITH(NOLOCK) ON tao. taxno= tdri.gf_tax_no
        INNER JOIN t_ac_user_taxno taut ON taut.orgid=tao.orgid
        WHERE tdri.valid='1'
        AND tdri.qs_status='1'
        AND tdri.rzh_yesorno='0'
        AND tdri.invoice_status='0'
        AND taut.userid=#{map.userId}
        AND tdri.invoice_type IN ('01','03','14')
        <if test="map.gfName !=null and map.gfName!=''">
            AND tdri.gf_tax_no =#{map.gfName}
        </if>
        <if test="map.xfName !=null and map.xfName!=''">
            AND tdri.xf_name LIKE '%${map.xfName}%'
        </if>
        <if test="map.invoiceNo !=null and map.invoiceNo!=''">
            AND tdri.invoice_no LIKE '%${map.invoiceNo}%'
        </if>

        <if test="map.qsStartDate !=null and map.qsStartDate!=''">
            <![CDATA[ AND date_format(tdri.qs_date, '%Y-%m-%d') >=#{map.qsStartDate}  ]]>
        </if>
        <if test="map.qsEndDate !=null and map.qsEndDate!=''">
            <![CDATA[ AND date_format(tdri.qs_date, '%Y-%m-%d')<=#{map.qsEndDate}]]>
        </if>

        <if test="map.qsType !=null and map.qsType!=''">
            AND tdri.qs_type =#{map.qsType}
        </if>

    </select>


    <!--合计iqGrid金额，税额-->
    <select id="queryTotalResult" resultType="com.xforceplus.wapp.modules.report.entity.ReportStatisticsEntity">
        /**mycat:schema=${schemaLabel}*/ SELECT
        count(1) totalCount,
        sum(tdri.invoice_amount) totalAmount,
        sum(tdri.tax_amount) totalTax
        from t_dx_record_invoice tdri WITH(NOLOCK)
        INNER JOIN t_ac_org tao WITH(NOLOCK) ON tao. taxno= tdri.gf_tax_no
        INNER JOIN t_ac_user_taxno taut ON taut.orgid=tao.orgid
        WHERE tdri.valid='1'
        AND tdri.qs_status='1'
        AND tdri.rzh_yesorno='0'
        AND tdri.invoice_status='0'
        AND taut.userid=#{condition.userId}
        AND tdri.invoice_type IN ('01','03','14')
        <if test="condition.gfName !=null and condition.gfName!=''">
            AND tdri.gf_tax_no =#{condition.gfName}
        </if>
        <if test="condition.xfName !=null and condition.xfName!=''">
            AND tdri.xf_name LIKE '%${condition.xfName}%'
        </if>
        <if test="condition.invoiceNo !=null and condition.invoiceNo!=''">
            AND tdri.invoice_no LIKE '%${condition.invoiceNo}%'
        </if>

        <if test="condition.qsStartDate !=null and condition.qsStartDate!=''">
            <![CDATA[ AND date_format(tdri.qs_date, '%Y-%m-%d') >=#{condition.qsStartDate}  ]]>
        </if>
        <if test="condition.qsEndDate !=null and condition.qsEndDate!=''">
            <![CDATA[ AND date_format(tdri.qs_date, '%Y-%m-%d')<=#{condition.qsEndDate}]]>
        </if>
        <if test="condition.qsType !=null and condition.qsType!=''">
            AND tdri.qs_type =#{condition.qsType}
        </if>
    </select>

    <select id="searchGf" resultType="com.xforceplus.wapp.modules.report.entity.OptionEntity">
       /**mycat:schema=${schemaLabel}*/   SELECT
        taxno  value,
        orgname label
        FROM t_ac_org WITH(NOLOCK)
        WHERE  orgid IN
        (SELECT orgid FROM t_ac_user_taxno WHERE userid=#{userId})
    </select>


    <select id="searchXf" resultType="String">
       /**mycat:schema=${schemaLabel}*/   select DISTINCT xf_name from t_dx_record_invoice WITH(NOLOCK) where xf_name like  '%${condition.queryString}%'
        and gf_tax_no in (select taxno from t_ac_org WITH(NOLOCK) where orgid in (select orgid from t_ac_user_taxno where userid=#{condition.userId}))
    </select>

</mapper>