<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.report.dao.TimeoutInvoiceReportDao">

    <resultMap id="reportStatisticsMap" type="com.xforceplus.wapp.modules.report.entity.ReportStatisticsEntity">
        <result column="totalCount" property="totalCount" />
        <result column="totalAmount" property="totalAmount" />
        <result column="totalTax" property="totalTax" />
    </resultMap>

    <resultMap id="optionMap" type="com.xforceplus.wapp.modules.report.entity.OptionEntity">
        <result column="taxno" property="value" />
        <result column="taxname" property="label" />
    </resultMap>

    <select id="queryList" resultType="com.xforceplus.wapp.modules.report.entity.ComprehensiveInvoiceQueryEntity">
        /**mycat:schema=${schemaLabel}*/
        <if test="map.offset != null and map.limit != null">
            SELECT
            TOP (#{map.limit}) A.*
            FROM
            (
            SELECT
            row_number () OVER (ORDER BY invoiceDate desc, id desc) AS rownumber, o.*
            FROM
            (
        </if>
        select
        id,
        invoice_type invoiceType,
        invoice_code invoiceCode,
        invoice_no invoiceNo,
        invoice_date invoiceDate,
        gf_tax_no gfTaxNo,
        gf_name gfName,
        xf_tax_no xfTaxNo,
        xf_name xfName,
        invoice_amount invoiceAmount,
        tax_amount taxAmount,
        total_amount totalAmount,
        remark,
        invoice_status invoiceStatus,
        rzh_date rzhDate,
        qs_date qsDate,
        rzh_belong_date rzhBelongDate,
        rzh_yesorno rzhYesorno,
        qs_type qsType,
        qs_status qsStatus
        from t_dx_record_invoice WITH(NOLOCK)
        where valid='1'
        <if test="map.gfName != null and map.gfName != '-1'">
            and gf_tax_no = #{map.gfName}
        </if>
        <if test="map.xfName != null and map.xfName != ''">
            and xf_name like concat('%',concat(#{map.xfName},'%'))
        </if>
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
        </if>
        <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23) >= #{map.invoiceDate1} ]]>
        </if>
        <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23)  <= #{map.invoiceDate2} ]]>
        </if>
        and invoice_type in ('01','03','14')
        and invoice_status = '0'
        and rzh_yesorno = '0'
        <![CDATA[ and TIMESTAMPDIFF(DAY,default(invoice_date),default(getdate()))> case when convert(varchar(100),invoice_date,23) < '2017-07-01' then 180 else 360 end ]]>
        and gf_tax_no in (select taxno from t_ac_org WITH(NOLOCK) where orgid in (select orgid from t_ac_user_taxno where userid=#{map.userID}))
        and invoice_amount > 0 and tax_amount >= 0
        <if test="map.offset == null and map.limit == null">
            ORDER BY invoice_date desc, id desc
        </if>
        <if test="map.offset != null and map.limit != null">
            )
            AS o
            )A
            WHERE
            rownumber >#{map.offset}
        </if>
        <!--limit #{map.offset}, #{map.limit}-->
    </select>

    <select id="queryTotalResult" resultMap="reportStatisticsMap">
        /**mycat:schema=${schemaLabel}*/select count(1) totalCount, ISNULL(0,sum(invoice_amount)) totalAmount, ISNULL(0,sum(tax_amount)) totalTax
        from t_dx_record_invoice WITH(NOLOCK)
        where valid='1'
        <if test="map.gfName != null and map.gfName != '-1'">
            and gf_tax_no = #{map.gfName}
        </if>
        <if test="map.xfName != null and map.xfName != ''">
            and xf_name like concat('%',concat(#{map.xfName},'%'))
        </if>
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
        </if>
        <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23) >= #{map.invoiceDate1} ]]>
        </if>
        <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23)  <= #{map.invoiceDate2} ]]>
        </if>
        and invoice_type in ('01','03','14')
        and invoice_status = '0'
        and rzh_yesorno = '0'
        <![CDATA[ and TIMESTAMPDIFF(DAY,default(invoice_date),default(getdate()))> case when convert(varchar(100),invoice_date,23) < '2017-07-01' then 180 else 360 end ]]>
        and gf_tax_no in (select taxno from t_ac_org WITH(NOLOCK) where orgid in (select orgid from t_ac_user_taxno where userid=#{map.userID}))
        and invoice_amount > 0 and tax_amount >= 0
        <!--order by invoice_date desc, id desc-->
    </select>



    <select id="queryListAll" resultType="com.xforceplus.wapp.modules.report.entity.ComprehensiveInvoiceQueryEntity">
        /**mycat:schema=${schemaLabel}*/select
        id,
        invoice_type invoiceType,
        invoice_code invoiceCode,
        invoice_no invoiceNo,
        invoice_date invoiceDate,
        gf_tax_no gfTaxNo,
        gf_name gfName,
        xf_tax_no xfTaxNo,
        xf_name xfName,
        invoice_amount invoiceAmount,
        tax_amount taxAmount,
        total_amount totalAmount,
        remark,
        invoice_status invoiceStatus,
        rzh_date rzhDate,
        qs_date qsDate,
        rzh_belong_date rzhBelongDate,
        rzh_yesorno rzhYesorno,
        qs_type qsType,
        qs_status qsStatus
        from t_dx_record_invoice WITH(NOLOCK)
        where valid='1'
        <if test="map.gfName != null and map.gfName != '-1'">
            and gf_tax_no = #{map.gfName}
        </if>
        <if test="map.xfName != null and map.xfName != ''">
            and xf_name like concat('%',concat(#{map.xfName},'%'))
        </if>
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
        </if>
        <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23) >= #{map.invoiceDate1} ]]>
        </if>
        <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23)  <= #{map.invoiceDate2} ]]>
        </if>
        and invoice_type in ('01','03','14')
        and invoice_status = '0'
        and rzh_yesorno = '0'
        <![CDATA[ and TIMESTAMPDIFF(DAY,default(invoice_date),default(getdate()))> case when convert(varchar(100),invoice_date,23) < '2017-07-01' then 180 else 360 end ]]>
        and gf_tax_no in (select taxno from t_ac_org WITH(NOLOCK) where orgid in (select orgid from t_ac_user_taxno where userid=#{map.userID}))
        and invoice_amount > 0 and tax_amount >= 0
        order by invoice_date desc, id desc
    </select>

</mapper>