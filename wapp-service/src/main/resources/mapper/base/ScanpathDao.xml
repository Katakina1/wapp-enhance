<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.base.dao.ScanPathDao">


	<select id="queryObject" resultType="com.xforceplus.wapp.modules.base.entity.ScanPathEntity">
		/**mycat:schema=${schemaLabel}*/ select * from t_dx_scan_path where id = #{id}
	</select>

	<select id="queryList" resultType="com.xforceplus.wapp.modules.base.entity.ScanPathEntity">
		/**mycat:schema=${schemaLabel}*/
		<if test="entity.offset != null and entity.limit != null">
			SELECT
			TOP (#{entity.limit}) A.*
			FROM
			(
			SELECT
			row_number () OVER (ORDER BY   id desc) AS rownumber, o.*
			FROM
			(
		</if>


		select r.* from t_dx_scan_path r
		<where>
			<if test="entity.scanPath != null and entity.scanPath.trim()!= ''">
				and r.scan_path like concat('%',#{entity.scanPath},'%')
			</if>
			<if test="entity.profit != null and entity.profit != ''">
				and r.profit=#{entity.profit}
			</if>
			<if test="entity.invoiceRemark != null and entity.invoiceRemark.trim() != ''">
				and r.invoice_remark like concat('%',#{entity.invoiceRemark},'%')
			</if>
			and   valid = 1 
		</where>
		<if test="entity.offset != null and entity.limit != null">
			)
			AS o
			)A
			WHERE
			rownumber >#{entity.offset}

		</if>
	</select>
	
	
	
	
	<select id="queryScanPathBYOrg" resultType="com.xforceplus.wapp.modules.base.entity.ScanPathEntity">
		/**mycat:schema=${schemaLabel}*/ select t2.*  from (select scan_path from t_ac_org WITH(NOLOCK)
		<where>
			    orgtype = 5
			AND scan_path is not null
			<if test="entity.orgid != null and entity.orgid != ''">
				and  orgid=#{entity.orgid}
			</if>

			<if test="entity.orgname != null and entity.orgname != ''">
				and  orgname=#{entity.orgname}
			</if>

			<if test="entity.taxno != null and entity.taxno != ''">
				and  taxno=#{entity.taxno}
			</if>

			<if test="entity.taxname != null and entity.taxname != ''">
				and taxtname=#{entity.taxname}
			</if>
			 
			
		</where>
		) t1 left join t_dx_scan_path t2  on t1.scan_path = t2.id

	</select>

    <select id="queryByProfit" resultType="com.xforceplus.wapp.modules.base.entity.ScanPathEntity">
        /**mycat:schema=${schemaLabel}*/ select t2.*  from  t_dx_scan_path t2
        WHERE 1=1
        <if test="profit!=null and profit!='' and profit!='01'">
            t2.profit=#{profit}
        </if>
    </select>
	
	
	<select id="queryScanPathBYUser" resultType="com.xforceplus.wapp.modules.base.entity.ScanPathEntity">
		/**mycat:schema=${schemaLabel}*/ SELECT
				dsp.*
			FROM
				t_ac_user_scanpath tas
			LEFT JOIN t_dx_scan_path dsp ON (tas.scanid = dsp.id)
			<where>
				valid = 1
			AND userid = #{entity.userid} 
			
			<if test="entity.profit != null and entity.profit != ''">
				and profit=#{entity.profit}
			</if>
			</where>
			UNION
				SELECT
					*
				FROM
					t_dx_scan_path t
				WHERE
					t.id IN (
						SELECT
							scan_path
						FROM
							t_ac_org t2 WITH(NOLOCK)
						WHERE
							EXISTS (
								SELECT
									orgid
								FROM
									t_ac_user_taxno t3
								WHERE
									userid = #{entity.userid}
								AND t2.orgid = t3.orgid
							)
		)
	</select>
	
	
	
	

	<select id="queryTotal" resultType="int">
		/**mycat:schema=${schemaLabel}*/ select count(*) from t_dx_scan_path r 
		<where>
			<if test="entity.scanPath != null and entity.scanPath.trim()!= ''">
				and r.scan_path like concat('%',#{entity.scanPath},'%')
			</if>
			<if test="entity.profit != null and entity.profit != ''">
				and r.profit=#{entity.profit}
			</if>
			<if test="entity.invoiceRemark != null and entity.invoiceRemark.trim() != ''">
				and r.invoice_remark like concat('%',#{entity.invoiceRemark},'%')
			</if>
			
			and  valid = 1 
		</where>
	</select>

	
	<select id="queryListU" resultType="com.xforceplus.wapp.modules.base.entity.UserScanPathEntity">
		/**mycat:schema=${schemaLabel}*/ select dsp.scan_path ,dsp.invoice_remark,profit,tas.uuid   from t_ac_user_scanpath  tas  left join t_dx_scan_path dsp on ( tas.scanid = dsp.id )
		<where>
			
			<if test="entity.userId != null and entity.userId.trim() != ''">
				and userid=#{entity.userId}
			</if>
			
			<if test="entity.profit != null and entity.profit != ''">
				and  profit=#{entity.profit}
			</if>

			<if test="entity.scanPath != null and entity.scanPath.trim()!= ''">
				and  scan_path like concat('%',#{entity.scanPath},'%')
			</if>
			and   valid = 1 
		</where>
		order by dsp.id  asc
		<if test="entity.offset != null and entity.limit != null">
			limit #{entity.offset}, #{entity.limit}
		</if>
	</select>
	
	
	<select id="queryListUNot" resultType="com.xforceplus.wapp.modules.base.entity.UserScanPathEntity">
		/**mycat:schema=${schemaLabel}*/ SELECT id,scan_path,invoice_remark,profit FROM  t_dx_scan_path dsp
		<where>
			
			<if test="entity.profit != null and entity.profit != ''">
				and  profit=#{entity.profit}
			</if>

			<if test="entity.scanPath != null and entity.scanPath.trim()!= ''">
				and  scan_path like concat('%',#{entity.scanPath},'%')
			</if>
			
			and   valid = 1 
			
			 <if test="entity.userId != null and entity.userId.trim() != ''">

				and id not in (select scanid from t_ac_user_scanpath where userid = #{entity.userId})
			</if>

		</where>

		order by dsp.id  asc
		<if test="entity.offset != null and entity.limit != null">
			limit #{entity.offset}, #{entity.limit}
		</if>
	</select>
	
	
	
	<select id="queryTotalU" resultType="int">
		/**mycat:schema=${schemaLabel}*/ select count(1)   from t_ac_user_scanpath  tas  left join t_dx_scan_path dsp on ( tas.scanid = dsp.id )
		<where>
			
			<if test="entity.userId != null and entity.userId.trim() != ''">
				and userid=#{entity.userId}
			</if>
			
			<if test="entity.profit != null and entity.profit != ''">
				and  profit=#{entity.profit}
			</if>

			<if test="entity.scanPath != null and entity.scanPath.trim()!= ''">
				and  scan_path like concat('%',#{entity.scanPath},'%')
			</if>
			
			and   valid = 1 
		</where>
	</select>
	
	
	<select id="queryTotalUNot" resultType="int">
		/**mycat:schema=${schemaLabel}*/ SELECT count(1) FROM  t_dx_scan_path dsp
		<where>
			
			<if test="entity.profit != null and entity.profit != ''">
				and  profit=#{entity.profit}
			</if>

			<if test="entity.scanPath != null and entity.scanPath.trim()!= ''">
				and  scan_path like concat('%',#{entity.scanPath},'%')
			</if>
			
			and   valid = 1 
			
			 <if test="entity.userId != null and entity.userId.trim() != ''">

				and id not in (select scanid from t_ac_user_scanpath where userid = #{entity.userId})
			</if>

		</where>
	</select>
	
	
	
	<select id="queryListS" resultType="com.xforceplus.wapp.modules.base.entity.ScanPathEntity">
		/**mycat:schema=${schemaLabel}*/

	  select r.scan_path,r.id from t_dx_scan_path r where  valid = 1
		

	</select>


	<insert id="save" parameterType="com.xforceplus.wapp.modules.base.entity.ScanPathEntity" useGeneratedKeys="true" keyProperty="entity.id">
		/**mycat:schema=${schemaLabel}*/ insert into t_dx_scan_path
		(
  			  scan_path,
  			  create_date,
  			  update_date,
  			  invoice_remark,
  			  profit,
  			  push_erp,
  			   valid
		)
		values
		(
			  #{entity.scanPath},
			  getdate(),
			  getdate(),
			  #{entity.invoiceRemark},
			  #{entity.profit},
			  #{entity.pushErp},
			  1
		)
	</insert>
	
	<insert id="saveUserScanPath" parameterType="com.xforceplus.wapp.modules.base.entity.UserScanPathEntity" useGeneratedKeys="true" keyProperty="entity.id">
		/**mycat:schema=${schemaLabel}*/ insert into t_ac_user_scanpath
		(
			  uuid,
  			  userid,
  			  scanid
		)
		values
		(
			  #{entity.uuid},
			  #{entity.userId},
			  #{entity.scanId}
			 
		)
	</insert>
	

	<update id="update" parameterType="com.xforceplus.wapp.modules.base.entity.ScanPathEntity">
		/**mycat:schema=${schemaLabel}*/ update t_dx_scan_path
		<set>
			<if test="entity.scanPath != null">scan_path = #{entity.scanPath},</if>
			<if test="entity.invoiceRemark != null">invoice_remark = #{entity.invoiceRemark},</if>
			<if test="entity.profit != null">profit = #{entity.profit}, </if>
			<if test="entity.pushErp != null">push_erp = #{entity.pushErp}, </if>
			update_date = getdate()
		</set>
		where id = #{entity.id}
	</update>


	<delete id="deleteBatch" parameterType="int">
		/**mycat:schema=${schemaLabel}*/ update  t_dx_scan_path set valid = 0 where id in
		<foreach item="id" collection="ids" open="(" separator="," close=")">
			#{id}
		</foreach>
	</delete>
	
	<delete id="deleteUserScanpath" parameterType="int">
		/**mycat:schema=${schemaLabel}*/ delete from  t_ac_user_scanpath  where uuid in
		<foreach item="uuid" collection="uuids" open="(" separator="," close=")">
			#{uuid}
		</foreach>
	</delete>
	
	

</mapper>