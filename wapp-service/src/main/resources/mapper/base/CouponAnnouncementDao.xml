<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xforceplus.wapp.modules.base.dao.CouponAnnouncementDao">

    <select id="getCouponAnnouncementCount" resultType="Integer">

        SELECT COUNT(*)
        FROM t_dx_annoucement_coupon t WITH(NOLOCK)
        WHERE t.is_release=0
        <if test="venderId != null and venderId != ''">
            and vender_id like  '%'+#{venderId}+'%'
        </if>
        <if test="createStartDate != null and createStartDate != ''">
            <![CDATA[ AND convert(varchar(100),upload_date,23) >= #{createStartDate} ]]>
        </if>
        <if test="createEndDate != null and createEndDate != ''">
            <![CDATA[ AND convert(varchar(100),upload_date,23)  <= #{createEndDate} ]]>
        </if>
    </select>

    <select id="couponAnnouncementList" resultType="com.xforceplus.wapp.modules.base.entity.CouponEntity">
        <if test="offset != null and limit != null">
            select top (#{limit}) a.*
            from
            (select row_number() over(order by o.upload_date desc) as rownumber,o.*
            from(
        </if>
        SELECT
         *
        from t_dx_annoucement_coupon t WITH(NOLOCK)
        WHERE t.is_release=0
        <if test="venderId != null and venderId != ''">
            and vender_id like  '%'+#{venderId}+'%'
        </if>
        <if test="createStartDate != null and createStartDate != ''">
            <![CDATA[ AND convert(varchar(100),upload_date,23) >= #{createStartDate} ]]>
        </if>
        <if test="createEndDate != null and createEndDate != ''">
            <![CDATA[ AND convert(varchar(100),upload_date,23)  <= #{createEndDate} ]]>
        </if>

        <if test="offset != null and limit != null">
            )as o
            )a
            where rownumber>#{offset};
        </if>

    </select>


    <select id="debtList" resultType="com.xforceplus.wapp.modules.base.entity.CouponEntity">
        <if test="offset != null and limit != null">
            select top (#{limit}) a.*
            from
            (select row_number() over(order by o.upload_date desc) as rownumber,o.*
            from(
        </if>
        SELECT
        *
        from t_dx_annoucement_debt t WITH(NOLOCK)
        WHERE 1=1
        <if test="all != '1'.toString()">
          and t.is_release=1  and vender_id =#{venderId}
        </if>
        <if test="supplierAnnoucement != '1'.toString()">
            and have_read=0
        </if>
        <if test="announcementType != '4'.toString()">
            and debt_type=#{announcementType}
        </if>
        <if test="offset != null and limit != null">
            )as o
            )a
            where rownumber>#{offset};
        </if>

    </select>

    <select id="levelList" resultType="com.xforceplus.wapp.modules.base.entity.UserEntity">
        select org_level orgLevel
        from t_ac_user t WITH(NOLOCK)
        where t.org_level is not null
        GROUP BY org_level
    </select>

    <select id="userlist" resultType="com.xforceplus.wapp.modules.base.entity.UserEntity">
        select
        userid,
        usercode,
        username,
        phone,
        email,
        address,
        depname,
        org_level orgLevel
        from t_ac_user WITH(NOLOCK)
        <where>
            <if test="entity.usercode != null and entity.usercode != ''">
                and usercode = right(cast('000000'+rtrim(#{entity.usercode}) as varchar(20)),6)
            </if>
            <if test="entity.orgLevel != null and entity.orgLevel != ''">
                and org_level = #{entity.orgLevel}
            </if>
            <if test="entity.userList != null">
                and usercode in
                <foreach item="user" collection="entity.userList" open="(" separator="," close=")">
                    #{user.usercode}
                </foreach>
            </if>
            <if test="entity.venderId != null">
                AND usercode in
                <foreach item="item" collection="entity.venderId" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>

        </where>
    </select>

    <insert id="addAnnouncement" parameterType="com.xforceplus.wapp.modules.base.entity.AnnouncementEntity" useGeneratedKeys="true" keyProperty="entity.id">
    insert into t_dx_announcement
    (
        announcement_title,
        announcement_type,
        announcement_info,
        header,
        footer,
        releasetime,
        announcement_status
        <if test="entity.supplierUnreadNum != null and entity.supplierUnreadNum != ''">
            ,supplier_unreadnum
        </if>
        <if test="entity.announcementAnnex != null and entity.announcementAnnex != ''">
            ,announcement_annex
        </if>
        <if test="entity.trainDate != null">
            ,train_end_date
        </if>
    ) values(
        #{entity.announcementTitle},
        #{entity.announcementType},
        #{entity.announcementInfo},
        #{entity.header},
        #{entity.footer},
        #{entity.releasetime},
        0
        <if test="entity.supplierUnreadNum != null and entity.supplierUnreadNum != ''">
            ,#{entity.supplierUnreadNum}
        </if>
        <if test="entity.announcementAnnex != null and entity.announcementAnnex != ''">
            ,#{entity.announcementAnnex}
        </if>
        <if test="entity.trainDate != null">
            ,#{entity.trainDate}
        </if>
    )
    </insert>

    <insert id="addAnnouncementUserMiddle" >
        insert into t_dx_announcement_user_middle
        (
        announcementid,
        userid,
        have_read
        ) values
        <foreach collection="list" item="item" separator=",">
            (
            #{item.announcementid},
            #{item.userid},
            0
            )
        </foreach>
    </insert>

    <select id="getUserid" resultType="Integer">
        select userid
        from t_ac_user WITH(NOLOCK)
        <where>
            <if test="user.usercode != null and user.usercode != ''">
                and usercode = #{user.usercode}
            </if>
            <if test="user.username != null and user.username != ''">
                and username = #{user.username}
            </if>
        </where>
    </select>

    <select id="queryTemplateExist" resultType="Integer">
        select count(*)
        from t_dx_announcement WITH(NOLOCK)
        where announcement_type=#{entity.announcementType}
    </select>

    <select id="queryTemplate" resultType="com.xforceplus.wapp.modules.base.entity.AnnouncementEntity">
        select id,announcement_info,announcement_type,announcement_title
        from t_dx_announcement WITH(NOLOCK)
        where announcement_type=#{entity.announcementType}
    </select>

    <update id="updateTemplate">
        update t_dx_announcement
        set announcement_info=#{entity.announcementInfo}
        where announcement_type=#{entity.announcementType}
    </update>

    <select id="templateIsExist" resultType="Integer">
        select count(*)
        from t_dx_announcement WITH(NOLOCK)
        where announcement_type='2' or announcement_type='3' or announcement_type='4'
        or announcement_type='5'
        or announcement_type='6'
    </select>

    <update id="releaseCustom">
        update t_dx_annoucement_coupon
        set is_release='1',
        releasetime=getdate()
        where is_release='0'
    </update>

    <select id="queryDebtIsExist" resultType="int" >
        select count(*) from t_dx_annoucement_coupon WITH(NOLOCK)
        where
        six_d=#{entity.sixD}
        <![CDATA[ and convert(varchar(100),case_date,23) = #{entity.caseDate} ]]>
        and coupon_no=#{entity.couponNo}
        and receivable_amount=#{entity.receivableAmount}
    </select>

    <insert id="saveDebt" parameterType="com.xforceplus.wapp.modules.base.entity.CouponEntity">
        insert into t_dx_annoucement_coupon
        (
        six_d,
        eight_d,
        vender_name,
        case_date,
        store,
        coupon_no,
        nine_d,
        ticket_desc,
        start_date,
        end_date,
        coupon_count,
        case_amount,
        assume_scale,
        receivable_amount,
        upload_date,
        create_by,
        have_read,
        is_release
        )
        values
        (
            #{entity.sixD},
            #{entity.eightD},
            #{entity.venderName},
            CONVERT(datetime,#{entity.caseDate}),
            #{entity.store},
            #{entity.couponNo},
            #{entity.nineD},
            #{entity.ticketDesc},
            CONVERT(datetime,#{entity.startDate}),
           CONVERT(datetime, #{entity.endDate}),
            #{entity.couponCount},
            #{entity.caseAmount},
            #{entity.assumeScale},
            #{entity.receivableAmount},
            getdate(),
            #{entity.createBy},
            '0',
            '0'
        )
    </insert>

    <insert id="saveFailureDebt" parameterType="com.xforceplus.wapp.modules.base.entity.CouponEntity">
        insert into t_dx_annoucement_coupon_failure
        (
        six_d,
        eight_d,
        vender_name,
        case_date,
        store,
        coupon_no,
        nine_d,
        ticket_desc,
        start_date,
        end_date,
        coupon_count,
        case_amount,
        assume_scale,
        receivable_amount,
        create_by,
        failure_reason,
        upload_date
        )
        values
        <foreach collection="list" item="entity" separator=",">
        (
            #{entity.sixD},
            #{entity.eightD},
            #{entity.venderName},
            CONVERT(datetime,#{entity.caseDate}),
            #{entity.store},
            #{entity.couponNo},
            #{entity.nineD},
            #{entity.ticketDesc},
            CONVERT(datetime,#{entity.startDate}),
            CONVERT(datetime, #{entity.endDate}),
            #{entity.couponCount},
            #{entity.caseAmount},
            #{entity.assumeScale},
            #{entity.receivableAmount},
            #{userCode},
            #{entity.failureReason},
            getdate()
        )
        </foreach>
    </insert>

    <delete id="deleteDebt">
        delete from  t_dx_annoucement_coupon where is_release = '0'
    </delete>

    <delete id="deleteDebtByCreateBy">
        delete from t_dx_annoucement_coupon_failure where create_by = #{userCode}
    </delete>

    <select id="queryDebtFailureList" resultType="com.xforceplus.wapp.modules.base.entity.CouponEntity">
        select *
        from t_dx_annoucement_coupon_failure WITH(NOLOCK)
        where 1=1
        <if test="userCode != null and userCode != ''">
           and  create_by =#{userCode}
        </if>
    </select>

    <select id="getVenderDebtList" resultType="com.xforceplus.wapp.modules.base.entity.CouponEntity">
        select *
        from t_dx_annoucement_debt WITH(NOLOCK)
        where is_release='1' and have_read='0'
        <if test="userCode != null and userCode != ''">
            and  vender_id =#{userCode}
        </if>
    </select>
</mapper>