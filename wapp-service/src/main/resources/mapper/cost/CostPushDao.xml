<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xforceplus.wapp.modules.cost.dao.CostPushDao">
    <select id="getMainData" resultType="com.xforceplus.wapp.modules.cost.entity.SettlementEntity">
        select id, vender_id, vender_name, bank_name, bank_account,
        approver_email staffNo,
        staff_email approverEmail,
        win_id winId,
        settlement_amount, walmart_status, cost_no, create_date, remark,
        belongs_to, service_type, payment_mode, pay_day, contract, has_invoice, urgency, pay_model,
        eps_no, instance_id, eps_id, old_bind_id, old_total_amount, surplus_amount,loginname loginName
        from t_dx_settlement WITH(NOLOCK)  where valid='1'
        <if test="costNo != null and costNo != ''">
            and cost_no like '%'+#{costNo}+'%'
        </if>
        <if test="costNo == null or costNo == ''">
            and walmart_status='0' and pay_model='0' and instance_id is null
        </if>
    </select>

    <select id="getMainInstanceId" resultType="com.xforceplus.wapp.modules.cost.entity.SettlementEntity">
        select id, cost_no, instance_id
        from t_dx_settlement WITH(NOLOCK)  where valid='1'
        and walmart_status in ('0','3','4') and pay_model in ('0','2')
    </select>

    <select id="getInvoiceRate" resultType="com.xforceplus.wapp.modules.cost.entity.InvoiceRateEntity">
        select a.id, a.invoice_amount, a.tax_rate, a.tax_amount, a.invoice_code,  a.invoice_no,
        b.invoice_type, b.invoice_date, b.check_code,b.gf_tax_no as jvcode
	from t_dx_settlement_rate a WITH(NOLOCK) left join t_dx_settlement_invoice b WITH(NOLOCK)
    on a.cost_no = b.cost_no  and ((LEFT(a.invoice_no,8)  = b.invoice_no and (b.invoice_type = '01' or b.invoice_type = '04'))or(a.invoice_no = b.invoice_no and (b.invoice_type ='' or b.invoice_type is null)))
        where a.cost_no=#{costNo} and b.valid = '1'
    </select>

    <update id="saveInstanceId">
        update t_dx_settlement WITH(ROWLOCK) set instance_id=#{instanceId} where cost_no=#{costNo}
    </update>

    <update id="saveCostId">
        update t_dx_settlement_cost set instance_id=#{instanceId}, bpms_id=#{bpmsId}
        where id=#{id}
    </update>

    <update id="updateStatus">
        update t_dx_settlement WITH(ROWLOCK) set
        walmart_status=#{status} ,
        <if test="status != 0 and status != 1 and status != 2 and status != 3">
            scan_status ='1',
        </if>
        scan_fail_reason ='',
        <if test="status != 0 and status != 1 and status != 2 and status != 3">
            push_status = '1',
        </if>
        <if test="status == 4">
            scan_date=getdate(),
        </if>
        walmart_date=getdate()
        where cost_no=#{costNo}
    </update>

    <select id="getCostId" resultType="com.xforceplus.wapp.modules.cost.entity.CostEntity">
        select id, bpms_id, cost_amount
        from t_dx_settlement_cost WITH(NOLOCK)  where instance_id=#{instanceId}
    </select>

    <update id="updateMain" parameterType="com.xforceplus.wapp.modules.cost.entity.SettlementEntity">
        update t_dx_settlement WITH(ROWLOCK) set
        belongs_to = #{belongsTo},
        service_type = #{serviceType},
        pay_model = #{payModel},
        pay_day = #{payDay},
        contract = #{contract},
        has_invoice = #{hasInvoice},
        urgency = #{urgency},
        eps_no = #{epsNo},
        remark = #{remark}
        where cost_no = #{costNo}
    </update>

    <update id="updateCost" parameterType="com.xforceplus.wapp.modules.cost.entity.CostEntity">
        update t_dx_settlement_cost set
        cost_type = #{costType},
        cost_type_name = #{costTypeName},
        cost_dept = #{costDept},
        cost_dept_id = #{costDeptId},
        cost_time = #{costTime},
        cost_use = #{costUse},
        project_code = #{projectCode}
        where id = #{id}
    </update>

    <update id="cancelMatch">
        update t_dx_record_invoice WITH(ROWLOCK) set
        cost_no=null,
        flow_type=null
        where cost_no=#{costNo}
    </update>

    <select id="getParamByDictCode" resultType="String">
        SELECT dictname
        FROM t_ac_dictdeta WITH(NOLOCK)
        WHERE dictcode = #{dictCode}
    </select>

    <select id="queryInvoicesByCostNo" resultType="java.lang.String">
    select concat(invoice_code,invoice_no) from t_dx_settlement_invoice  WITH(NOLOCK) where cost_no =#{costNo} and invoice_type='01'
 </select>

    <update id="updateRecord2Confirm" >
        update t_dx_record_invoice WITH(ROWLOCK) set bpms_pay_status='1'  where 1=1 and  uuid in
        <foreach collection="list" separator="," item="item" open="(" close=")">
            #{item}
        </foreach>
    </update>

    <update id="updateReback">
         update t_dx_settlement WITH(ROWLOCK) set walmart_status='2',reject_reason=#{msg} where cost_no=#{costNo}
    </update>

    <update id="updateRebacks">
        update t_dx_record_invoice WITH(ROWLOCK) set cost_no = '' where cost_no=#{costNo}
    </update>

    <delete id="deleteSettlementInvice">
        /**修改推送状态*/
        UPDATE t_dx_settlement_invoice SET valid = '0' where cost_no=#{costNo}
    </delete>

    <select id="getWinid" resultType="java.lang.String">
        select win_id from t_dx_settlement WITH(NOLOCK) where cost_no =#{costNo}
    </select>
</mapper>