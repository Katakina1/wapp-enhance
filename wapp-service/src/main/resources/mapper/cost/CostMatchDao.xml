<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xforceplus.wapp.modules.cost.dao.CostMatchDao">
    <select id="queryList" resultType="com.xforceplus.wapp.modules.cost.entity.SettlementMatchEntity">
        select * from (
        select id, vender_id, cost_no, gf_tax_no, gf_name,
        cost_amount, covered_amount, cost_amount-covered_amount uncoveredAmount, remark,
        belongs_to, service_type, payment_mode, pay_day, contract, has_invoice, urgency,
        eps_no, instance_id , eps_id, staff_no,
        ROW_NUMBER() OVER(Order by id) AS rownum
        from t_dx_settlement_match where vender_id=#{venderId} and cost_amount-covered_amount>0
        <if test="epsNo != null and epsNo != ''">
            and eps_no like '%'+#{epsNo}+'%'
        </if>
        ) a where <![CDATA[rownum>#{offset} and rownum<=#{offset}+#{limit}]]>
    </select>

    <select id="queryCount" resultType="int">
        select count(1)
        from t_dx_settlement_match where vender_id=#{venderId} and cost_amount-covered_amount>0
        <if test="epsNo != null and epsNo != ''">
            and eps_no like '%'+#{epsNo}+'%'
        </if>
    </select>

    <select id="costDeptIds" resultType="String">
        select TOP 1 cost_dept_id
        from t_dx_settlement_match_detail
        where cost_no=#{costNo} and cost_amount-covered_amount>0
    </select>


    <select id="queryDetail" resultType="com.xforceplus.wapp.modules.cost.entity.CostEntity">
        select id,
        cost_type, cost_type_name,
        cost_time, cost_amount, cost_use, cost_dept, cost_dept_id,
        covered_amount, cost_amount-covered_amount uncoveredAmount
        from t_dx_settlement_match_detail
        where cost_no=#{costNo} and cost_amount-covered_amount>0
    </select>

    <select id="querySelectDetail" resultType="com.xforceplus.wapp.modules.cost.entity.CostEntity">
        select id,
        cost_type, cost_type_name,
        cost_time, cost_amount, cost_use, cost_dept, cost_dept_id,
        covered_amount, cost_amount-covered_amount uncoveredAmount,
        instance_id, bpms_id, project_code
        from t_dx_settlement_match_detail
        where cost_no in
        <foreach collection="array" index="index" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        and cost_amount-covered_amount>0
    </select>

    <update id="updateCostAmount">
        update t_dx_settlement_match_detail set covered_amount=covered_amount+${costAmount}
        where id=#{id}
    </update>

    <update id="updateSettlementAmount">
        update t_dx_settlement_match set covered_amount=${costAmount}+covered_amount
        where cost_no=(select cost_no from t_dx_settlement_match_detail where id=#{id})
    </update>

    <select id="selectInvoice" parameterType="com.xforceplus.wapp.modules.cost.entity.RecordInvoiceEntity" resultType="int">
        select count(1) from t_dx_settlement_invoice WITH(NOLOCK)  where invoice_no=#{invoiceNo}
        and invoice_date=#{invoiceDate} and total_amount=#{totalAmount} and venderid=#{venderid} and valid = '1'
    </select>

    <select id="getCostInfo" resultType="com.xforceplus.wapp.modules.cost.entity.CostEntity">
        select id, cost_time, cost_use, cost_amount-covered_amount costAmount, cost_type_name,
        cost_type, cost_dept_id, cost_dept, instance_id, bpms_id,
        project_code
        from t_dx_settlement_match_detail where id=#{id}
    </select>
</mapper>