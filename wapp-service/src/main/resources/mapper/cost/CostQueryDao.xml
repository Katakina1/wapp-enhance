<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xforceplus.wapp.modules.cost.dao.CostQueryDao">
    <select id="queryList" resultType="com.xforceplus.wapp.modules.cost.entity.SettlementEntity">
        select * from (
        SELECT
        t.id,
        t.vender_id,
        t.vender_name,
        t.bank_name,
        t.bank_account,
        t.staff_email approverEmail,
        t.reject_reason,
        t.settlement_amount,
        t.walmart_status,
        t.cost_no,
        t.pay_model,
        t.eps_no,
        t.create_date,
        t.remark,
        t.scan_date,
        t1.invoice_no,
        t1.total_amount,
        t1.tax_amount,
        t.walmart_date,
        ROW_NUMBER () OVER (ORDER BY t.create_date) AS rownum
        FROM
        t_dx_settlement t  WITH(NOLOCK) left join t_dx_settlement_invoice t1 WITH(NOLOCK)  on t.cost_no=t1.cost_no
        WHERE 1=1

        <if test="loginname != null and loginname != ''">
            and  t.loginname=#{loginname}
        </if>
        <if test="invoiceNo != null and invoiceNo != ''">
            and t1.invoice_no like '%'+#{invoiceNo}+'%'
        </if>
        <if test="venderId != null and venderId != ''">
            and t.vender_id=#{venderId}
        </if>
        <if test="costNo != null and costNo != ''">
            and t.cost_no like '%'+#{costNo}+'%'
        </if>
        <if test="epsNo != null and epsNo != ''">
            and t.eps_no like '%'+#{epsNo}+'%'
        </if>
        <if test="payModel != null and payModel != '' and payModel != '-1'">
            and t.pay_model  = #{payModel}
        </if>
        <if test="walmartStatus != null and walmartStatus != ''">
            and t.walmart_status=#{walmartStatus}
        </if>
        <if test="createDate1 != null and createDate1 != ''">
            <![CDATA[ AND convert(varchar(100),t.create_date,23) >= #{createDate1} ]]>
        </if>
        <if test="createDate2 != null and createDate2 != ''">
            <![CDATA[ AND convert(varchar(100),t.create_date,23)  <= #{createDate2} ]]>
        </if>
        <if test="scanDate1 != null and scanDate1 != ''">
            <![CDATA[ AND convert(varchar(100),t.scan_date,23) >= #{scanDate1} ]]>
        </if>
        <if test="scanDate2 != null and scanDate2 != ''">
            <![CDATA[ AND convert(varchar(100),t.scan_date,23)  <= #{scanDate2} ]]>
        </if>

        ) a where <![CDATA[rownum>#{offset} and rownum<=#{offset}+#{limit}]]>
    </select>


    <select id="queryAllList" resultType="com.xforceplus.wapp.modules.cost.entity.SettlementEntity">
        SELECT
        t.id,
        t.vender_id,
        t.vender_name,
        t.bank_name,
        t.bank_account,
        t.staff_email approverEmail,
        t.reject_reason,
        t.settlement_amount,
        t.walmart_status,
        t.cost_no,
        t.eps_no,
        t.create_date,
        t.remark,
        t.scan_date,
        t1.invoice_no,
        t1.total_amount,
        t1.tax_amount,
        t.walmart_date,
        t.pay_model,
        ROW_NUMBER () OVER (ORDER BY t.create_date) AS rownum
        FROM
        t_dx_settlement t  WITH(NOLOCK) left join t_dx_settlement_invoice t1 WITH(NOLOCK)  on t.cost_no=t1.cost_no
        WHERE
        1=1
        <if test="loginname != null and loginname != ''">
            and  t.loginname=#{loginname}
        </if>
        <if test="invoiceNo != null and invoiceNo != ''">
            and t1.invoice_no like '%'+#{invoiceNo}+'%'
        </if>
        <if test="venderId != null and venderId != ''">
            and t.vender_id=#{venderId}
        </if>
        <if test="costNo != null and costNo != ''">
            and t.cost_no like '%'+#{costNo}+'%'
        </if>
        <if test="epsNo != null and epsNo != ''">
            and t.eps_no like '%'+#{epsNo}+'%'
        </if>
        <if test="walmartStatus != null and walmartStatus != ''">
            and t.walmart_status=#{walmartStatus}
        </if>
        <if test="payModel != null and payModel != '' and payModel != '-1'">
            and t.pay_model  = #{payModel}
        </if>
        <if test="createDate1 != null and createDate1 != ''">
            <![CDATA[ AND convert(varchar(100),t.create_date,23) >= #{createDate1} ]]>
        </if>
        <if test="createDate2 != null and createDate2 != ''">
            <![CDATA[ AND convert(varchar(100),t.create_date,23)  <= #{createDate2} ]]>
        </if>
        <if test="scanDate1 != null and scanDate1 != ''">
            <![CDATA[ AND convert(varchar(100),t.scan_date,23) >= #{scanDate1} ]]>
        </if>
        <if test="scanDate2 != null and scanDate2 != ''">
            <![CDATA[ AND convert(varchar(100),t.scan_date,23)  <= #{scanDate2} ]]>
        </if>

    </select>

    <select id="queryCount" resultType="int">
        select count(1)
        from t_dx_settlement t WITH(NOLOCK) left join t_dx_settlement_invoice t1 WITH(NOLOCK)  on t.cost_no=t1.cost_no
        where 1=1
        <if test="loginname != null and loginname != ''">
            and  t.loginname=#{loginname}
        </if>
        <if test="invoiceNo != null and invoiceNo != ''">
            and t1.invoice_no like '%'+#{invoiceNo}+'%'
        </if>
        <if test="venderId != null and venderId != ''">
            and t.vender_id=#{venderId}
        </if>
        <if test="costNo != null and costNo != ''">
            and t.cost_no like '%'+#{costNo}+'%'
        </if>
        <if test="payModel != null and payModel != '' and payModel != '-1'">
            and t.pay_model  = #{payModel}
        </if>
        <if test="epsNo != null and epsNo != ''">
            and t.eps_no like '%'+#{epsNo}+'%'
        </if>
        <if test="walmartStatus != null and walmartStatus != ''">
            and t.walmart_status=#{walmartStatus}
        </if>
        <if test="createDate1 != null and createDate1 != ''">
            <![CDATA[ AND convert(varchar(100),t.create_date,23) >= #{createDate1} ]]>
        </if>
        <if test="createDate2 != null and createDate2 != ''">
            <![CDATA[ AND convert(varchar(100),t.create_date,23)  <= #{createDate2} ]]>
        </if>
        <if test="scanDate1 != null and scanDate1 != ''">
            <![CDATA[ AND convert(varchar(100),t.scan_date,23) >= #{scanDate1} ]]>
        </if>
        <if test="scanDate2 != null and scanDate2 != ''">
            <![CDATA[ AND convert(varchar(100),t.scan_date,23)  <= #{scanDate2} ]]>
        </if>


    </select>

    <select id="getInvoice" resultType="com.xforceplus.wapp.modules.cost.entity.RecordInvoiceEntity">
        select b.invoice_code, b.invoice_no, b.invoice_type, b.invoice_date, b.invoice_amount, b.tax_amount,
        b.total_amount, b.gf_tax_no, b.gf_name, b.check_code, a.invoice_status
        from  t_dx_settlement_invoice b left join t_dx_record_invoice a WITH(NOLOCK)
        on a.invoice_code=b.invoice_code and a.invoice_no=b.invoice_no
        where b.cost_no=#{costNo}
    </select>

    <select id="getRate" resultType="com.xforceplus.wapp.modules.cost.entity.RateEntity">
        select id, invoice_amount, tax_rate, tax_amount from t_dx_settlement_rate WITH(NOLOCK)
        where cost_no=#{costNo} and invoice_code=#{invoiceCode} and invoice_no like #{invoiceNo}+'%'
    </select>

    <select id="getCost" resultType="com.xforceplus.wapp.modules.cost.entity.CostEntity">
        select id,
        cost_type, cost_type_name,
        cost_time, cost_amount, cost_use,
        cost_dept, cost_dept_id, project_code,
        instance_id oldBindId, bpms_id,
        (select (cost_amount-covered_amount) from t_dx_settlement_match_detail  WITH(NOLOCK) where t_dx_settlement_cost.bpms_id=t_dx_settlement_match_detail.bpms_id) surplusAmount
        from t_dx_settlement_cost WITH(NOLOCK)
        where rate_id=#{rateId}
    </select>

    <select id="getFile" resultType="com.xforceplus.wapp.modules.cost.entity.SettlementFileEntity">
        select id, file_name, file_type, file_path
        from t_dx_settlement_file WITH(NOLOCK)  where cost_no=#{costNo}
    </select>

    <select id="getStatusOptions" resultType="com.xforceplus.wapp.modules.cost.entity.SelectionOptionEntity">
        select dictcode optionKey,
        dictname optionName
        from t_ac_dictdeta  WITH(NOLOCK) where dicttype=(select dicttypeid from t_ac_dicttype where dicttypecode='COST_STATUS')
    </select>
    <update id="updateUser">
     update t_dx_settlement WITH(ROWLOCK) set loginname=#{rzuserId} where loginname=#{lzuserId}
    </update>
</mapper>