<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xforceplus.wapp.modules.cost.dao.CostReturnDataMaintenanceDao">
    <!--查询例外报告信息-->
    <select id="questionnairelist" resultType="com.xforceplus.wapp.modules.cost.entity.ApplicantEntity">
        SELECT
        <if test=" map.limit != null">
            TOP (#{map.limit})
        </if>
        A.*
        FROM
        (
        SELECT
        row_number () OVER (ORDER BY applicantId asc) AS rownumber ,o.*
        FROM
        (
        SELECT
        a.applicant_id  applicantId ,
        a.eps_no  epsNo,
        a.shop_no shopNo,
        a.applicant_department applicantDepartment,
        a.applicant_no applicantNo,
        a.applicant_name applicantName,
        a.applicant_call applicantCall,
        a.applicant_subarea applicantSubarea,
        a.import_date importDate
        FROM
        t_dx_applicant a
        <where>
            1=1
            <if test="map.epsNo != null and map.epsNo != '' and map.epsNo != '-1'">
                and a.eps_no like concat('%',concat(#{map.epsNo},'%'))
            </if>
            <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
                <![CDATA[ AND convert(varchar(100),a.import_date,23) >= #{map.invoiceDate1} ]]>
            </if>
            <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
                <![CDATA[ AND convert(varchar(100),a.import_date,23)  <= #{map.invoiceDate2} ]]>
            </if>
        </where>
        ) AS o
        ) A
        WHERE 1=1
        <if test="map.offset != null ">
            and   rownumber > #{map.offset}
        </if>
    </select>

    <!--查询订单信息条数-->
    <select id="questionnairelistCount" resultType="Integer">
        select count(1)
        FROM
        t_dx_applicant a
        where
        1=1
        <if test="map.epsNo != null and map.epsNo != '' and map.epsNo != '-1'">
            and a.eps_no like concat('%',concat(#{map.epsNo},'%'))
        </if>
        <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
            <![CDATA[ AND convert(varchar(100),a.import_date,23) >= #{map.invoiceDate1} ]]>
        </if>
        <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
            <![CDATA[ AND convert(varchar(100),a.import_date,23)  <= #{map.invoiceDate2} ]]>
        </if>
    </select>
    <insert id="saveInvoice">
        INSERT INTO t_dx_applicant (
        eps_no,
        shop_no,
        applicant_department,
        applicant_no,
        applicant_name,
        applicant_call,
        applicant_subarea,
        import_date

        ) VALUES (
        #{map.epsNo},
        #{map.shopNo},
        #{map.applicantDepartment},
        #{map.applicantNo},
        #{map.applicantName},
        #{map.applicantCall},
        #{map.applicantSubarea},
        GETDATE()
        )
    </insert>

    <select id="questionnairelistAll" resultType="com.xforceplus.wapp.modules.InformationInquiry.entity.QuestionnaireEntity">
        SELECT
        a.id,
        a.datet                            dateT,
        a.input_user                       inputUser,
        a.jv                               jV,
        a.vendor_no                        vendorNo,
        a.inv_no                           invNo,
        a.invoice_cost                     InvoiceCost,
        a.wm_cost                          wMCost,
        a.batch_id                         batchID,
        a.po_no                            pONo,
        a.trans                            trans,
        a.rece                             rece,
        a.errcode                          errCode,
        a.errdesc                          errDesc,
        a.invoice_date                     invoiceDate,
        a.errstatus                        errStatus,
        a.isdel                            isDel,
        a.tax_amount                       taxAmount,
        a.tax_rate                         taxRate,
        a.tax_type                          taxType

        FROM
        t_dx_submit_qutstanding_report a LEFT  JOIN t_dx_invoice s WITH(NOLOCK) on
        a.inv_no= s.invoice_no
        AND  a.vendor_no= s.venderid
        AND  a.invoice_date= s.invoice_date
        <where>
            <if test="map.jV != null and map.jV != '' and map.jV != '-1'">
                and a.jv = #{map.jV}
            </if>
            <if test="map.batchId != null and map.batchId != ''">
                and a.batch_id = #{map.batchId}
            </if>
            <if test="map.vendorNo != null and map.vendorNo != ''">
                and a.vendor_no like concat('%',concat(#{map.vendorNo},'%'))
            </if>
            <if test="map.invNo != null and map.invNo != ''">
                and a.inv_no like concat('%',concat(#{map.invNo},'%'))
            </if>
            <if test="map.isDel != null and map.isDel != '-1'">
                and a.isdel = #{map.isDel}
            </if>
            <!--<if test="map.isDel == 1">-->
                <!--and s.isdel = #{map.isDel}-->
            <!--</if>-->
            <!--<if test="map.isDel == 2 or map.isDel == 0">-->
                <!--and a.isdel = #{map.isDel}-->
            <!--</if>-->
            <if test="map.errDesc != null and map.errDesc != ''">
                and a.errcode like concat('%',concat(#{map.errDesc},'%'))
            </if>
            <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
                <![CDATA[ AND convert(varchar(100),a.datet,23) >= #{map.invoiceDate1} ]]>
            </if>
            <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
                <![CDATA[ AND convert(varchar(100),a.datet,23)  <= #{map.invoiceDate2} ]]>
            </if>
        </where>
        ORDER BY a.id asc
    </select>


    <update id="questionnaireUpdate">
        update t_dx_submit_qutstanding_report
        set
        isdel  =     #{map.isDel},
        input_user = #{map.inputUser},
        errcode  =  #{map.errCode},
        errdesc  =  #{map.errDesc},
        errstatus  =  #{map.errStatus}
        where id = #{map.ids}
    </update>


    <update id="inputrefundyesno">

        update t_dx_invoice WITH(ROWLOCK)
        set
        isdel = '1',
        del_date = GETDATE(),
        refund_reason = #{errStatus}
        where
        invoice_no =#{invNo}  and
        venderid =#{vendorNo}
        AND invoice_date = #{invoiceDate}

    </update>
    <!--撤销退票-->
    <update id="cancelTheRefund">

        update t_dx_invoice WITH(ROWLOCK)
        set
        isdel = '0',
        del_date = GETDATE(),
        refund_reason = ''
        where
        invoice_no =#{invNo}  and
        venderid =#{vendorNo}
        AND invoice_date = #{invoiceDate}

    </update>

    <select id="queryuuid">
        DELETE FROM t_dx_applicant where applicant_id = #{id}

    </select>
    <!--&lt;!&ndash;查询uuid&ndash;&gt;-->
    <!--<select id="queryuuids" resultType="com.xforceplus.wapp.modules.InformationInquiry.entity.QuestionnaireEntity">-->
        <!--select-->
        <!--uuid-->
        <!--from t_dx_invoice WITH(NOLOCK)-->
        <!--where id in (-->
        <!--select  code  from t_dx_match_po_claim_invoice-->
        <!--where code_type = '0' and matchid in(-->
        <!--select id from  t_dx_match WITH(NOLOCK)-->
        <!--where id =  #{id}-->
        <!--)-->
        <!--)-->
    <!--</select>-->
    <update id="queryuuids">

        update t_dx_submit_qutstanding_report
        set
        isdel = '1',
        del_date= GETDATE()
        where
        inv_no =#{invNo}  and
        vendor_no =#{vendorNo} and
        invoice_date = #{invoiceDate}

    </update>
    <!--撤销退票状态-->
    <update id="cancelQueryuuids">

        update t_dx_submit_qutstanding_report
        set
        isdel = '0',
        del_date= GETDATE()
        where
        inv_no =#{invNo}  and
        vendor_no =#{vendorNo} and
        invoice_date = #{invoiceDate}

    </update>

    <update id="xqueryuuids">

        update t_dx_submit_qutstanding_report
        set
        isdel = '2',
        del_date = GETDATE()
        where
        id = #{id}

    </update>
    <!--撤销处理-->
    <update id="cancelTheProcess">

        update t_dx_submit_qutstanding_report
        set
        isdel = '0',
        del_date = GETDATE()
        where
        id = #{id}

    </update>

    <select id="queryMatchno" resultType="java.lang.String">
        select matchno from t_dx_record_invoice WITH(NOLOCK)  where uuid = #{uuid}
    </select>

    <update id="updateIsDel">
        update t_dx_match
        set
        isdel = #{isdel},
        where
        matchno = #{matchno}
    </update>

    <select id="getUuId" resultType="java.lang.String">
        select uuid from t_dx_invoice WITH(NOLOCK)
        where
        invoice_no =#{invNo}  and
        venderid =#{vendorNo}
        and invoice_date = #{invoiceDate}
    </select>
</mapper>