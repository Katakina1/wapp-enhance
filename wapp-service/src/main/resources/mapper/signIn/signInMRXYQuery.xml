<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.signin.dao.SignInqueryMRXYDao">
    <select id="queryTotal" resultType="Integer">
        /**mycat:schema=${schemaLabel}*/
        SELECT
        count(1)
        from t_dx_invoice t WITH(NOLOCK)
        where  valid = 1
        AND t.gf_tax_no in (SELECT taxno FROM t_ac_org WITH(NOLOCK) where orgid in(SELECT orgid FROM t_ac_user_taxno where userid=#{query.userId}))
        <if test="query.invoiceType!=null and query.invoiceType!='' and query.invoiceType!='-1'">
            and t.invoice_type= #{query.invoiceType}
        </if>
        <if test="query.shName!=null and query.shName!='' and query.shName!='-1'">
            and t.gf_tax_no = #{query.shName}
        </if>
        <if test="query.invoiceNo!= null and query.invoiceNo!= '' and query.invoiceNo!='-1'">
            and t.invoice_no like concat('%',concat(#{query.invoiceNo},'%'))
        </if>
        <if test="query.invoiceCode!= null and query.invoiceCode!= '' and query.invoiceCode!='-1'">
            and t.invoice_code like concat('%',concat(#{query.invoiceCode},'%'))
        </if>
        <if test="query.userAccount!= null and query.userAccount!= '' and query.userAccount!='-1'">
            and t.user_account like concat('%',concat(#{query.userAccount},'%'))
        </if>
        <if test="query.qsStatus!= null and query.qsStatus!= '' and query.qsStatus!='-1'">
            and t.qs_status like concat('%',concat(#{query.qsStatus},'%'))
        </if>
        <if test="query.invoiceDate1!= null and query.invoiceDate1!= ''">
            <![CDATA[ AND date_format(t.qs_date,'%Y-%m-%d') >= #{query.invoiceDate1} ]]>
        </if>
        <if test="query.invoiceDate2!= null and query.invoiceDate2!= ''">
            <![CDATA[ AND date_format(t.qs_date,'%Y-%m-%d')  <= #{query.invoiceDate2} ]]>
        </if>

        <if test="query.kpDate1!= null and query.kpDate1!= ''">
            <![CDATA[ AND date_format(t.invoice_date,'%Y-%m-%d') >= #{query.kpDate1} ]]>
        </if>
        <if test="query.kpDate2!= null and query.kpDate2!= ''">
            <![CDATA[ AND date_format(t.invoice_date,'%Y-%m-%d')  <= #{query.kpDate2} ]]>
        </if>

        <if test="query.createDate1!= null and query.createDate1!= ''">
            <![CDATA[ AND date_format(t.create_date,'%Y-%m-%d') >= #{query.createDate1} ]]>
        </if>
        <if test="query.createDate2!= null and query.createDate2!= ''">
            <![CDATA[ AND date_format(t.create_date,'%Y-%m-%d')  <= #{query.createDate2} ]]>
        </if>
    </select>

    <select id="getRecordIncoiceList" resultType="com.xforceplus.wapp.modules.signin.entity.RecordInvoiceEntity">
        /**mycat:schema=${schemaLabel}*/
        SELECT
        t.id,
        t.invoice_code invoiceCode,
        t.invoice_no invoiceNo,
        t.invoice_date invoiceDate,
        t.invoice_type invoiceType,
        t.qs_type qsType,
        t.gf_name gfName,
        t.xf_name xfName,
        t.gf_tax_no,
        t.xf_tax_no,
        t.user_account,
        t.invoice_amount invoiceAmount,
        t.tax_amount taxAmount,
        t.total_amount totalAmount,
        t.qs_date signInDate,
        t.create_date createDate,
        t.qs_status qsStatus,
        t.notes notes,
        t.scan_id scanId,
        t.check_code checkCode
        from t_dx_invoice t WITH(NOLOCK)
        where  valid = 1
        AND t.gf_tax_no in (SELECT taxno FROM t_ac_org WITH(NOLOCK) where orgid in(SELECT orgid FROM t_ac_user_taxno where userid=#{query.userId}))
        <if test="query.invoiceType!=null and query.invoiceType!='' and query.invoiceType!='-1'">
            and t.invoice_type= #{query.invoiceType}
        </if>
        <if test="query.shName!=null and query.shName!='' and query.shName!='-1'">
            and t.gf_tax_no = #{query.shName}
        </if>
        <if test="query.invoiceNo!= null and query.invoiceNo!= '' and query.invoiceNo!='-1'">
            and t.invoice_no like concat('%',concat(#{query.invoiceNo},'%'))
        </if>
        <if test="query.invoiceCode!= null and query.invoiceCode!= '' and query.invoiceCode!='-1'">
            and t.invoice_code like concat('%',concat(#{query.invoiceCode},'%'))
        </if>
        <if test="query.userAccount!= null and query.userAccount!= '' and query.userAccount!='-1'">
            and t.user_account like concat('%',concat(#{query.userAccount},'%'))
        </if>
        <if test="query.qsStatus!= null and query.qsStatus!= '' and query.qsStatus!='-1'">
            and t.qs_status like concat('%',concat(#{query.qsStatus},'%'))
        </if>
        <if test="query.invoiceDate1!= null and query.invoiceDate1!= ''">
            <![CDATA[ AND date_format(t.qs_date,'%Y-%m-%d') >= #{query.invoiceDate1} ]]>
        </if>
        <if test="query.invoiceDate2!= null and query.invoiceDate2!= ''">
            <![CDATA[ AND date_format(t.qs_date,'%Y-%m-%d')  <= #{query.invoiceDate2} ]]>
        </if>

        <if test="query.kpDate1!= null and query.kpDate1!= ''">
            <![CDATA[ AND date_format(t.invoice_date,'%Y-%m-%d') >= #{query.kpDate1} ]]>
        </if>
        <if test="query.kpDate2!= null and query.kpDate2!= ''">
            <![CDATA[ AND date_format(t.invoice_date,'%Y-%m-%d')  <= #{query.kpDate2} ]]>
        </if>

        <if test="query.createDate1!= null and query.createDate1!= ''">
            <![CDATA[ AND date_format(t.create_date,'%Y-%m-%d') >= #{query.createDate1} ]]>
        </if>
        <if test="query.createDate2!= null and query.createDate2!= ''">
            <![CDATA[ AND date_format(t.create_date,'%Y-%m-%d')  <= #{query.createDate2} ]]>
        </if>


        order by t.invoice_date desc
        <if test="query.offset != null and query.limit != null">
            limit #{query.offset}, #{query.limit}
        </if>
    </select>

    <!-- 获取金额合计和税额合计 -->
    <select id="getSumAmount" resultType="map">
        /**mycat:schema=${schemaLabel}*/
        SELECT
        truncate(SUM(invoice_amount),2) sumTotalAmount,
        truncate(SUM(tax_amount),2) sumTaxAmount
        from t_dx_invoice t WITH(NOLOCK)
        where valid = 1
        AND t.gf_tax_no in (SELECT taxno FROM t_ac_org WITH(NOLOCK) where orgid in(SELECT orgid FROM t_ac_user_taxno where userid=#{query.userId}))
        <if test="query.invoiceType!=null and query.invoiceType!='' and query.invoiceType!='-1'">
            and t.invoice_type= #{query.invoiceType}
        </if>
        <if test="query.shName!=null and query.shName!='' and query.shName!='-1'">
            and t.gf_tax_no = #{query.shName}
        </if>
        <if test="query.invoiceNo!= null and query.invoiceNo!= '' and query.invoiceNo!='-1'">
            and t.invoice_no like concat('%',concat(#{query.invoiceNo},'%'))
        </if>
        <if test="query.invoiceCode!= null and query.invoiceCode!= '' and query.invoiceCode!='-1'">
            and t.invoice_code like concat('%',concat(#{query.invoiceCode},'%'))
        </if>
        <if test="query.userAccount!= null and query.userAccount!= '' and query.userAccount!='-1'">
            and t.user_account like concat('%',concat(#{query.userAccount},'%'))
        </if>
        <if test="query.qsStatus!= null and query.qsStatus!= '' and query.qsStatus!='-1'">
            and t.qs_status like concat('%',concat(#{query.qsStatus},'%'))
        </if>
        <if test="query.invoiceDate1!= null and query.invoiceDate1!= ''">
            <![CDATA[ AND date_format(t.qs_date,'%Y-%m-%d') >= #{query.invoiceDate1} ]]>
        </if>
        <if test="query.invoiceDate2!= null and query.invoiceDate2!= ''">
            <![CDATA[ AND date_format(t.qs_date,'%Y-%m-%d')  <= #{query.invoiceDate2} ]]>
        </if>

        <if test="query.kpDate1!= null and query.kpDate1!= ''">
            <![CDATA[ AND date_format(t.invoice_date,'%Y-%m-%d') >= #{query.kpDate1} ]]>
        </if>
        <if test="query.kpDate2!= null and query.kpDate2!= ''">
            <![CDATA[ AND date_format(t.invoice_date,'%Y-%m-%d')  <= #{query.kpDate2} ]]>
        </if>

        <if test="query.createDate1!= null and query.createDate1!= ''">
            <![CDATA[ AND date_format(t.create_date,'%Y-%m-%d') >= #{query.createDate1} ]]>
        </if>
        <if test="query.createDate2!= null and query.createDate2!= ''">
            <![CDATA[ AND date_format(t.create_date,'%Y-%m-%d')  <= #{query.createDate2} ]]>
        </if>
    </select>

    <select id="queryAllList" resultType="com.xforceplus.wapp.modules.signin.entity.RecordInvoiceEntity">
        /**mycat:schema=${schemaLabel}*/
        SELECT
        t.id,
        t.invoice_code invoiceCode,
        t.invoice_no invoiceNo,
        t.invoice_date invoiceDate,
        t.gf_name gfName,
        t.xf_name xfName,
        t.qs_type qsType,
        t.invoice_amount invoiceAmount,
        t.tax_amount taxAmount,
        t.qs_date signInDate,
        t.qs_status qsStatus,
        t.notes notes,
        t.user_account
        from t_dx_invoice t WITH(NOLOCK)
        where valid = 1
        AND t.gf_tax_no in (SELECT taxno FROM t_ac_org WITH(NOLOCK) where orgid in(SELECT orgid FROM t_ac_user_taxno where userid=#{query.userId}))
        <if test="query.invoiceType!=null and query.invoiceType!='' and query.invoiceType!='-1'">
            and t.invoice_type= #{query.invoiceType}
        </if>
        <if test="query.shName!=null and query.shName!='' and query.shName!='-1'">
            and t.gf_tax_no = #{query.shName}
        </if>
        <if test="query.invoiceNo!= null and query.invoiceNo!= '' and query.invoiceNo!='-1'">
            and t.invoice_no like concat('%',concat(#{query.invoiceNo},'%'))
        </if>
        <if test="query.invoiceCode!= null and query.invoiceCode!= '' and query.invoiceCode!='-1'">
            and t.invoice_code like concat('%',concat(#{query.invoiceCode},'%'))
        </if>
        <if test="query.userAccount!= null and query.userAccount!= '' and query.userAccount!='-1'">
            and t.user_account like concat('%',concat(#{query.userAccount},'%'))
        </if>
        <if test="query.qsStatus!= null and query.qsStatus!= '' and query.qsStatus!='-1'">
            and t.qs_status like concat('%',concat(#{query.qsStatus},'%'))
        </if>
        <if test="query.invoiceDate1!= null and query.invoiceDate1!= ''">
            <![CDATA[ AND date_format(t.qs_date,'%Y-%m-%d') >= #{query.invoiceDate1} ]]>
        </if>
        <if test="query.invoiceDate2!= null and query.invoiceDate2!= ''">
            <![CDATA[ AND date_format(t.qs_date,'%Y-%m-%d')  <= #{query.invoiceDate2} ]]>
        </if>

        <if test="query.kpDate1!= null and query.kpDate1!= ''">
            <![CDATA[ AND date_format(t.invoice_date,'%Y-%m-%d') >= #{query.kpDate1} ]]>
        </if>
        <if test="query.kpDate2!= null and query.kpDate2!= ''">
            <![CDATA[ AND date_format(t.invoice_date,'%Y-%m-%d')  <= #{query.kpDate2} ]]>
        </if>

        <if test="query.createDate1!= null and query.createDate1!= ''">
            <![CDATA[ AND date_format(t.create_date,'%Y-%m-%d') >= #{query.createDate1} ]]>
        </if>
        <if test="query.createDate2!= null and query.createDate2!= ''">
            <![CDATA[ AND date_format(t.create_date,'%Y-%m-%d')  <= #{query.createDate2} ]]>
        </if>
        order by t.invoice_date desc
    </select>

    <resultMap id="optionMap" type="com.xforceplus.wapp.modules.report.entity.OptionEntity">
        <result column="taxno" property="value" />
        <result column="orgname" property="label" />
    </resultMap>
    <select id="searchGf" resultMap="optionMap">
        /**mycat:schema=${schemaLabel}*/
        select taxno, orgname from t_ac_org WITH(NOLOCK) where orgid in (select orgid from t_ac_user_taxno where userid=#{userId})
    </select>



</mapper>