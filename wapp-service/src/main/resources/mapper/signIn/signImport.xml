<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xforceplus.wapp.modules.signin.dao.SignImportDao">

    <!-- 根据发票代码 发票号码查询抵账信息 -->
    <select id="getRecordData" resultType="com.xforceplus.wapp.modules.signin.entity.RecordInvoiceDataEntity">
        /**mycat:schema=${schemaLabel}*/
        SELECT
        id,
        invoice_date invoiceDate,
        invoice_amount invoiceAmount,
        tax_amount taxAmount,
        invoice_type invoiceType,
        gf_tax_no gfTaxNo,
        gf_name gfName,
        xf_tax_no xfTaxNo,
        xf_name xfName,
        qs_status qsStatus,
        total_amount totalAmount,
        check_code checkCode
        FROM t_dx_record_invoice WITH(NOLOCK)
        WHERE invoice_code = #{invoiceCode} AND invoice_no =#{invoiceNo}
    </select>

    <insert id="insertScanInvoice">
        /**mycat:schema=${schemaLabel}*/
        INSERT INTO t_dx_invoice WITH(ROWLOCK)
        (
        invoice_type ,
        invoice_code ,
        invoice_no ,
        invoice_date ,
        gf_tax_no ,
        gf_name ,
        xf_name ,
        invoice_amount ,
        tax_amount ,
        total_amount ,
        xf_tax_no ,
        check_code ,
        uuid,
        qs_status,
        qs_type,
        valid,
        create_date,
        qs_date,
        user_account,
        user_name,
        notes,
        scan_id
        )
        VALUES
        <foreach collection="list" item="item" separator=",">
            (
            #{item.invoiceType},
            #{item.invoiceCode},
            #{item.invoiceNo},
            #{item.invoiceDate},
            #{item.gfTaxNo},
            #{item.gfName},
            #{item.xfName},
            #{item.invoiceAmount},
            #{item.taxAmount},
            #{item.totalAmount},
            #{item.xfTaxNo},
            #{item.checkCode},
            #{item.uuId},
            #{item.invoiceStatus},
            #{item.qsType},
            #{item.valid},
            now(),
            now(),
            #{item.userAccount},
            #{item.userName},
            #{item.notes},
            #{item.scanId}
            )
        </foreach>
        ON DUPLICATE KEY UPDATE
        invoice_type = VALUES(invoice_type),
        invoice_code = VALUES(invoice_code),
        invoice_no=VALUES(invoice_no),
        invoice_date=VALUES(invoice_date) ,
        gf_tax_no=VALUES(gf_tax_no),
        gf_name=VALUES(gf_name),
        xf_name=VALUES(xf_name),
        invoice_amount=VALUES(invoice_amount),
        tax_amount=VALUES(tax_amount),
        total_amount=VALUES(total_amount),
        xf_tax_no=VALUES(xf_tax_no),
        check_code=VALUES(check_code),
        uuid=VALUES(uuid),
        qs_status=VALUES(qs_status),
        valid=VALUES(valid),
        scan_id = VALUES(scan_id),
        qs_date= now()
    </insert>

    <!-- 更新抵账表中的签收状态 导入签收 -->
    <update id="updateRecordQsStatus">
        /**mycat:schema=${schemaLabel}*/
        UPDATE t_dx_record_invoice WITH(ROWLOCK)
        SET qs_date = now(),
        qs_type = '3',
        qs_status = '1'
        WHERE uuid IN (
        <foreach collection="list" item="item" separator=",">
            #{item.uuId}
        </foreach>
        )
    </update>

    <!-- 保存图片到图片路径表 -->
    <insert id="insertInvoiceImg">
        /**mycat:schema=${schemaLabel}*/
        insert into t_dx_invoice_img WITH(ROWLOCK) (
        image_path,
        uuid,
        valid,
        scan_id,
        create_date,
        update_date
        )values
        <foreach collection="list" item="item" separator=",">
            (
            #{item.imagePath},
            #{item.uuid},
            '1',
            #{item.scanId},
            now(),
            now()
            )
        </foreach>
        ON DUPLICATE KEY UPDATE
        image_path = VALUES(image_path),
        uuid = VALUES(uuid),
        valid = VALUES(valid),
        scan_id = VALUES(scan_id),
        update_date=now()
    </insert>

    <select id="getImgPath" resultType="String">
        /**mycat:schema=${schemaLabel}*/
        SELECT image_path FROM t_dx_invoice_img WITH(NOLOCK) WHERE uuid = #{uuid} limit 1
    </select>

    <!-- 获取当前登录人下绑定的税号 -->
    <select id="getTaxNoList" resultType="String">
      /**mycat:schema=${schemaLabel}*/
        SELECT tao.taxno FROM t_ac_org tao WITH(NOLOCK)
         LEFT JOIN t_ac_user_taxno taut ON taut.orgid = tao.orgid
        WHERE taut.userid = #{userId}
    </select>

    <!-- 根据uuid查询数据是否在扫描表存在 -->
    <select id="queryCountScan" resultType="Integer">
        /**mycat:schema=${schemaLabel}*/
        SELECT
        count(1)
        from t_dx_invoice WITH(NOLOCK)
        where uuid = #{uuid}
    </select>
</mapper>
