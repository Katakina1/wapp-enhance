<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.signin.dao.SignInqueryCostDao">
    <select id="queryTotal" resultType="Integer">
        /**mycat:schema=${schemaLabel}*/
        SELECT
        count(1)
        from t_dx_invoice t WITH(NOLOCK)
        where
        t.valid = 1 and
        t.rebateyesorno = 0 AND
        t.qs_type=1
		AND t.flow_type = '2'


        <if test="query.invoiceNo!= null and query.invoiceNo!= '' and query.invoiceNo!='-1'">
            and (t.dy_invoice_no like concat('%',concat(#{query.invoiceNo},'%')) or t.invoice_no like concat('%',concat(#{query.invoiceNo},'%')))
        </if>
        <if test="query.invoiceDate1!= null and query.invoiceDate1!= ''">
            <![CDATA[ AND FORMAT(t.create_date ,'yyyy-MM-dd', 'zh-cn') >= #{query.invoiceDate1} ]]>
        </if>
        <if test="query.invoiceDate2!= null and query.invoiceDate2!= ''">
            <![CDATA[ AND FORMAT(t.create_date ,'yyyy-MM-dd', 'zh-cn')  <= #{query.invoiceDate2} ]]>
        </if>

        <if test="query.scanId!= null and query.invoiceDerialNo!= '' and query.scanId!='-1'">
            and t.scan_id like concat('%',concat(#{query.scanId},'%'))
        </if>
        <if test="query.venderid!= null and query.venderid!= '' and query.venderid!='-1'">
            and t.venderid = #{query.venderid}
        </if>
        <if test="query.companyCode!= null and query.companyCode!= '' and query.companyCode!='-1'">
            and t.company_code = #{query.companyCode}
        </if>
        <if test="query.shName!=null and query.shName!='' and query.shName!='-1'">
            and t.jv_code = #{query.shName}
        </if>
        <if test="query.qsStatus!=null and query.qsStatus!='' and query.qsStatus!='-1'">
            and t.qs_status= #{query.qsStatus}
        </if>
    </select>

    <select id="getRecordIncoiceList" resultType="com.xforceplus.wapp.modules.signin.entity.RecordInvoiceEntity">
        /**mycat:schema=${schemaLabel}*/
        <if test="query.offset != null and query.limit != null">
            SELECT
            TOP (#{query.limit}) A.*
            FROM
            (
            SELECT
            row_number () OVER (ORDER BY   localTrmSeqNum ASC ) AS rownumber, o.*
            FROM
            (
        </if>
        SELECT


		RIGHT(t.scan_id,17) scanRightId,
		SUBSTRING(t.scan_id,0,CHARINDEX('_', t.scan_id)) scanSubId,
        t.id,
        t.invoice_code invoiceCode,
        t.invoice_no invoiceNo,
        t.dy_invoice_code dyInvoiceCode,
        t.dy_invoice_no dyInvoiceNo,
        t.invoice_date invoiceDate,
        t.invoice_type invoiceType,
        t.qs_type qsType,
        t.gf_name gfName,
        t.xf_name xfName,
        t.gf_tax_no gfTaxNo,
        t.xf_tax_no xfTaxNo,
        t.user_account,
        t.invoice_amount invoiceAmount,
        t.tax_amount taxAmount,
        t.qs_date signInDate,
        t.qs_status qsStatus,
        t.notes notes,t.scan_id scanId,
        t.invoice_serial_no localTrmSeqNum,
        t.vendername,t.rebateyesorno, t.check_code,t.total_amount,t.create_date, t.venderid,t.jv_code,t.company_code,
        t.file_type,tdri.rzh_date,tdri.rzh_yesorno,t.flow_type,t.isdel,
        tdri.scan_match_status scanMatchStatus,
        tdri.scan_fail_reason scanFailReason,
        t.venderid_edit venderidEdit,t.is_exist_stamper isExistStamper,t.no_exist_stamper_notes noExistStamperNotes,t.cost_no costNo
        from t_dx_invoice t WITH(NOLOCK)
        left join t_dx_record_invoice tdri WITH(NOLOCK) on tdri.uuid=t.uuid
        where
        t.valid = 1 and
        t.rebateyesorno = 0 and
        t.qs_type=1 and
        t.flow_type = '2'
        <if test="query.invoiceNo!= null and query.invoiceNo!= '' and query.invoiceNo!='-1'">
            and (t.dy_invoice_no like concat('%',concat(#{query.invoiceNo},'%')) or t.invoice_no like concat('%',concat(#{query.invoiceNo},'%')))
        </if>
        <if test="query.invoiceDate1!= null and query.invoiceDate1!= ''">
            <![CDATA[ AND FORMAT(t.create_date ,'yyyy-MM-dd', 'zh-cn') >= #{query.invoiceDate1} ]]>
        </if>
        <if test="query.invoiceDate2!= null and query.invoiceDate2!= ''">
            <![CDATA[ AND FORMAT(t.create_date ,'yyyy-MM-dd', 'zh-cn')  <= #{query.invoiceDate2} ]]>
        </if>



        <if test="query.scanId!= null and query.invoiceDerialNo!= '' and query.scanId!='-1'">
            and t.scan_id like concat('%',concat(#{query.scanId},'%'))
        </if>
        <if test="query.venderid!= null and query.venderid!= '' and query.venderid!='-1'">
            and t.venderid = #{query.venderid}
        </if>
        <if test="query.companyCode!= null and query.companyCode!= '' and query.companyCode!='-1'">
            and t.company_code = #{query.companyCode}
        </if>
        <if test="query.shName!=null and query.shName!='' and query.shName!='-1'">
            and t.jv_code = #{query.shName}
        </if>
        <if test="query.qsStatus!=null and query.qsStatus!='' and query.qsStatus!='-1'">
            and t.qs_status= #{query.qsStatus}
        </if>
        
        <if test="query.offset != null and query.limit != null">
            )
            AS o
            )A
            WHERE
            rownumber >#{query.offset}
        </if>
            order by scanSubId,scanRightId asc
    </select>

    <!-- 获取金额合计和税额合计 -->
    <select id="getSumAmount" resultType="map">
        /**mycat:schema=${schemaLabel}*/
        SELECT
        SUM(invoice_amount) sumTotalAmount,
        SUM(tax_amount) sumTaxAmount
        from t_dx_invoice t WITH(NOLOCK)
        where t.qs_status=1
        and valid = 1


        <if test="query.invoiceNo != null and query.invoiceNo != '' and query.invoiceNo!='-1'">
            and t.invoice_no like concat('%',concat(#{query.invoiceNo},'%'))
        </if>
        <if test="query.invoiceDate1 != null and query.invoiceDate1 != ''">
            <![CDATA[ AND FORMAT(t.create_date ,'yyyy-MM-dd', 'zh-cn') >= #{query.invoiceDate1} ]]>
        </if>
        <if test="query.invoiceDate2 != null and query.invoiceDate2 != ''">
            <![CDATA[ AND FORMAT(t.create_date ,'yyyy-MM-dd', 'zh-cn')  <= #{query.invoiceDate2} ]]>
        </if>
    </select>

    <select id="queryAllList" resultType="com.xforceplus.wapp.modules.signin.entity.RecordInvoiceEntity">
        /**mycat:schema=${schemaLabel}*/
        SELECT
        RIGHT(t.scan_id,17) scanRightId,
		SUBSTRING(t.scan_id,0,CHARINDEX('_', t.scan_id)) scanSubId,
        t.id,
        t.invoice_code invoiceCode,
        t.invoice_no invoiceNo,
        t.dy_invoice_code dyInvoiceCode,
        t.dy_invoice_no dyInvoiceNo,
        t.invoice_date invoiceDate,
        t.invoice_type invoiceType,
        t.qs_type qsType,
        t.gf_name gfName,
        t.xf_name xfName,
        t.gf_tax_no gfTaxNo,
        t.xf_tax_no xfTaxNo,
        t.user_account,
        t.invoice_amount invoiceAmount,
        t.tax_amount taxAmount,
        t.qs_date signInDate,
        t.qs_status qsStatus,
        t.notes notes,t.scan_id scanId,
        t.invoice_serial_no localTrmSeqNum,
        t.vendername,t.rebateyesorno, 
        t.check_code,
        t.total_amount,
        t.create_date, 
        t.venderid,
        t.jv_code,
        t.company_code,
        t.file_type,
        tdri.rzh_date,
        tdri.rzh_yesorno,
        t.flow_type,
        t.isdel,
        tdri.scan_match_status scanMatchStatus,
        tdri.scan_fail_reason scanFailReason,
        t.cost_no costNo
        from t_dx_invoice t WITH(NOLOCK)
        left join t_dx_record_invoice tdri WITH(NOLOCK) on tdri.uuid=t.uuid
        where
        t.valid = 1 and
        t.rebateyesorno = 0 AND
        t.qs_type=1
        and t.flow_type = '2'
        <if test="query.invoiceNo!= null and query.invoiceNo!= '' and query.invoiceNo!='-1'">
            and (t.dy_invoice_no like concat('%',concat(#{query.invoiceNo},'%')) or t.invoice_no like concat('%',concat(#{query.invoiceNo},'%')))
        </if>
        <if test="query.invoiceDate1!= null and query.invoiceDate1!= ''">
            <![CDATA[ AND FORMAT(t.create_date ,'yyyy-MM-dd', 'zh-cn') >= #{query.invoiceDate1} ]]>
        </if>
        <if test="query.invoiceDate2!= null and query.invoiceDate2!= ''">
            <![CDATA[ AND FORMAT(t.create_date ,'yyyy-MM-dd', 'zh-cn')  <= #{query.invoiceDate2} ]]>
        </if>



        <if test="query.scanId!= null and query.invoiceDerialNo!= '' and query.scanId!='-1'">
            and t.scan_id like concat('%',concat(#{query.scanId},'%'))
        </if>
        <if test="query.venderid!= null and query.venderid!= '' and query.venderid!='-1'">
            and t.venderid = #{query.venderid}
        </if>
        <if test="query.companyCode!= null and query.companyCode!= '' and query.companyCode!='-1'">
            and t.company_code = #{query.companyCode}
        </if>
        <if test="query.shName!=null and query.shName!='' and query.shName!='-1'">
            and t.jv_code = #{query.shName}
        </if>
        <if test="query.qsStatus!=null and query.qsStatus!='' and query.qsStatus!='-1'">
            and t.qs_status= #{query.qsStatus}
        </if>
        <if test="query.flowType!=null and query.flowType!='' and query.flowType!='-1'">
            and t.flow_type= #{query.flowType}
        </if>
       order by scanSubId,scanRightId asc
    </select>

    <resultMap id="optionMap" type="com.xforceplus.wapp.modules.report.entity.OptionEntity">
        <result column="taxno" property="value" />
        <result column="orgname" property="label" />
    </resultMap>
    <select id="searchGf" resultMap="optionMap">
        /**mycat:schema=${schemaLabel}*/
        select taxno, orgname from t_ac_org WITH(NOLOCK) where orgid in (select orgid from t_ac_user_taxno where userid=#{userId})
    </select>

    <select id="getMatchid" resultType="Integer">
    /**mycat:schema=${schemaLabel}*/
    select t.matchid
    from t_dx_match_po_claim_invoice t
    LEFT JOIN t_dx_record_invoice d WITH(NOLOCK) ON t.code = d.id
    where d.uuid=#{uuid}
    AND t.code_type = '0';
</select>

    <select id="getcostNo" resultType="com.xforceplus.wapp.modules.job.entity.SettlementEntity">
        /**mycat:schema=${schemaLabel}*/
        SELECT
            *
        FROM
            t_dx_settlement_invoice WITH(NOLOCK)
        WHERE
            invoice_code = #{invoiceCode}
            and invoice_no=#{invoiceNo}
    </select>
    <select id="selectOuterRedInvoice" parameterType="com.xforceplus.wapp.modules.redTicket.entity.RedTicketMatch">
        /**mycat:schema=${schemaLabel}*/
        SELECT
            t.*
        FROM
            t_dx_red_ticket_matching t
            LEFT JOIN t_dx_record_invoice d WITH(NOLOCK) ON t.red_notice_number = d.red_notice_number
        WHERE
            d.invoice_code = #{invoiceCode}
            and d.invoice_no=#{invoiceNo}
    </select>

    <select id="getSerialNumber" resultType="String">
        /**mycat:schema=${schemaLabel}*/
        SELECT
            serial_number
        FROM
            t_dx_redInvoice_detail WITH(NOLOCK)
        WHERE
        invoice_code = #{invoiceCode}
        and invoice_no=#{invoiceNo}
    </select>
    <select id="getRedInvoiceData"  resultType="com.xforceplus.wapp.modules.redInvoiceManager.entity.RedInvoiceData">
	    SELECT
	        *
	    FROM
	        t_dx_makeout_redInvoice WITH(NOLOCK)
	      where  serial_number=#{serialNumber}
	</select>

    <select id="selectInvoiceCount" resultType="Integer">
        /**mycat:schema=${schemaLabel}*/
        select count(*) from t_dx_invoice WITH(NOLOCK) where uuid =#{uuid} AND id !=#{id} and invoice_amount=#{invoiceAmount} and invoice_date=#{invoiceDate}  and rebateyesorno = 0
    </select>

	<delete id="deleteInvoiceDate">
		delete from t_dx_invoice WITH(ROWLOCK) where cost_no = #{costNo}
	</delete>

    <delete id="deleteScanInvoice">
        delete from t_dx_invoice WITH(ROWLOCK) where id = #{scanId}
    </delete>
	
	<update id="updateRecordScanMatchStatus">
		update t_dx_record_invoice WITH(ROWLOCK) set scan_match_status = #{scanMatchStatus} , scan_fail_reason = '' where uuid = #{uuid}
	</update>
	
	<update id="updateSettlementScanMatchStatus">
		update t_dx_settlement WITH(ROWLOCK) set scan_fail_reason = '' , scan_status = #{scanMatchStatus} where  cost_no = #{costNo}
	</update>

    <update id="updateInvoice">
        update t_dx_record_invoice WITH(ROWLOCK) set no_deduction = '1' where cost_no = #{costNo}
    </update>

    <select id="updateRecord" resultType="com.xforceplus.wapp.modules.cost.entity.InvoiceRateEntity">
        select
         invoice_code,
         invoice_no
         from t_dx_invoice WITH(ROWLOCK) where cost_no=#{costNo} and (invoice_type = '01' or invoice_type ='04')
    </select>
    <update id="underWay">
        update t_dx_settlement WITH(ROWLOCK) set push_status = '2',scan_status = '1' where cost_no=#{costNo}
    </update>
    <select id="checkInvoiceZP" resultType="Integer">
        select count(*) from t_dx_record_invoice with(nolock) where qs_status!='1' and invoice_type='01' and cost_no=#{costNo}
    </select>
</mapper>