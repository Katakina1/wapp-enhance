<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.pack.dao.InputPackNumberDao">

    <resultMap id="reportStatisticsMap" type="com.xforceplus.wapp.modules.report.entity.ReportStatisticsEntity">
        <result column="totalCount" property="totalCount" />
        <result column="totalAmount" property="totalAmount" />
        <result column="totalTax" property="totalTax" />
    </resultMap>

    <resultMap id="optionMap" type="com.xforceplus.wapp.modules.report.entity.OptionEntity">
        <result column="taxno" property="value" />
        <result column="taxname" property="label" />
    </resultMap>

    <select id="queryList" resultType="com.xforceplus.wapp.modules.pack.entity.InputPackNumberEntity">
        /**mycat:schema=${schemaLabel}*/
        <if test="map.offset != null and map.limit != null">
        SELECT
        TOP (#{map.limit}) A.*
        FROM
        (
        SELECT
        row_number () OVER (ORDER BY bbindingNo desc) AS rownumber, o.*
        FROM
        (
        </if>
        select
        bbindingno bbindingNo,
        convert(varchar(100),bbinding_date,23) bbindingDate,
        eps_no epsNo,
        max(scanning_seriano) invoiceSerialNo
        from t_dx_record_invoice WITH(NOLOCK)
        where
         bindyesorno='1'
        and (packyesorno != '1' or packyesorno is null)
        <if test="map.epsNo != null and map.epsNo != ''">
            and eps_no like concat('%',concat(#{map.epsNo},'%'))

        </if>
        <if test="map.invoiceSerialNo != null and map.invoiceSerialNo != ''">
            and scanning_seriano like concat('%',concat(#{map.invoiceSerialNo},'%'))

        </if>
        <if test="map.bbindingNo != null and map.bbindingNo != ''">
            and bbindingno like concat('%',concat(#{map.bbindingNo},'%'))

        </if>
        <if test="map.bbindingDate1 != null and map.bbindingDate1 != ''">
            <![CDATA[ AND convert(varchar(100),bbinding_date,23) >= #{map.bbindingDate1} ]]>
        </if>
        <if test="map.bbindingDate2 != null and map.bbindingDate2 != ''">
            <![CDATA[ AND convert(varchar(100),bbinding_date,23)  <= #{map.bbindingDate2} ]]>
        </if>
        <!--GROUP BY bbindingno,convert(varchar(100),bbinding_date,23)-->
        <if test="map.offset == null and map.limit == null">
            ORDER BY bbindingno desc
        </if>
        <if test="map.offset != null and map.limit != null">
            group by bbindingno ,CONVERT (
            VARCHAR (100),
            bbinding_date,
            23
            ),
            eps_no
            )
            AS o
            )A
            WHERE
            rownumber >#{map.offset}

        </if>
        <!--limit #{map.offset}, #{map.limit}-->
    </select>
    <select id="queryTotalResult" resultType="java.lang.Integer">
        /**mycat:schema=${schemaLabel}*/

            SELECT
            count(1)
            FROM
            (

        select
        bbindingno bbindingNo,
        convert(varchar(100),bbinding_date,23) bbindingDate
        from t_dx_record_invoice WITH(NOLOCK)
        where
        bindyesorno='1'
        and (packyesorno != '1' or packyesorno is null)
        <if test="map.epsNo != null and map.epsNo != ''">
            and eps_no like concat('%',concat(#{map.epsNo},'%'))

        </if>
        <if test="map.invoiceSerialNo != null and map.invoiceSerialNo != ''">
            and scanning_seriano like concat('%',concat(#{map.invoiceSerialNo},'%'))

        </if>
        <if test="map.bbindingNo != null and map.bbindingNo != ''">
            and bbindingno like concat('%',concat(#{map.bbindingNo},'%'))

        </if>
        <if test="map.bbindingDate1 != null and map.bbindingDate1 != ''">
            <![CDATA[ AND convert(varchar(100),bbinding_date,23) >= #{map.bbindingDate1} ]]>
        </if>
        <if test="map.bbindingDate2 != null and map.bbindingDate2 != ''">
            <![CDATA[ AND convert(varchar(100),bbinding_date,23)  <= #{map.bbindingDate2} ]]>
        </if>


            group by bbindingno ,CONVERT (
            VARCHAR (100),
            bbinding_date,
            23
            ),
            eps_no
            )
            AS o



    </select>

    <update id="inputpackingno">
        update t_dx_record_invoice WITH(ROWLOCK)
        <set>
            packingno = #{packingNo},
            packyesorno = '1',
            packing_date = getdate(),
            packing_address=#{packingAddress},
        </set>
        where bindyesorno ='1' and
        bbindingno = #{bbindingNo}


    </update>

    <select id="querypackingno" resultType="java.lang.Integer">
        select count(1)
        from t_dx_record_invoice WITH(NOLOCK)
        where packingno =#{packingNo}
    </select>

    <!--查询抵账表信息-->
    <select id="getBindingnoList" resultType="com.xforceplus.wapp.modules.pack.entity.InputPackNumberEntity">
        SELECT
        <if test=" map.limit != null">
            TOP (#{map.limit})
        </if>
        A.*
        FROM
        (
        SELECT
        row_number () OVER (ORDER BY createDate ) AS rownumber ,o.*
        FROM
        (
        select
        DISTINCT(a.id),
        RIGHT ( a.scanning_seriano, 17 ) scanRightId,
        SUBSTRING (
        a.scanning_seriano,
        0,
        CHARINDEX( '_', a.scanning_seriano )) scanSubId,
        a.scanning_seriano invoiceSerialNo,
        a.venderid venderId,
        a.vendername venderName,
        convert(varchar(100),a.create_date,23) createDate,
        a.gf_name gfName,
        a.uuid,
        a.invoice_type invoiceType,
        a.invoice_code invoiceCode,
        a.invoice_no invoiceNo,
        a.invoice_date invoiceDate,
        a.gf_tax_no gfTaxNo,
        a.xf_tax_no xfTaxNo,
        a.xf_name xfName,
        a.invoice_amount invoiceAmount,
        a.tax_amount taxAmount,
        a.total_amount totalAmount,
        a.remark,
        a.invoice_status invoiceStatus,
        a.rzh_date rzhDate,
        a.qs_date qsDate,
        a.rzh_belong_date rzhBelongDate,
        a.rzh_yesorno rzhYesorno,
        a.auth_status authStatus,
        a.qs_type  qsType,
        a.qs_status qsStatus,
        a.jvcode jvCode,
        a.company_code companyCode,
        a.tax_rate taxRate,
        a.eps_no
        from
        t_dx_record_invoice a WITH(NOLOCK)
       <!-- LEFT JOIN t_ac_org b WITH(NOLOCK) on b.orgcode = a.jvcode-->
        where
        a.bindyesorno ='1'
        and a.bbindingno = #{map.bbindingNo}
        ) AS o
        ) A
        WHERE 1=1
        <if test="map.offset != null ">
            and   rownumber > #{map.offset}
        </if>
        ORDER BY
        scanSubId,
        scanRightId ASC
    </select>


    <select id="getListAll" resultType="com.xforceplus.wapp.modules.pack.entity.InputPackNumberEntity">
        select
        DISTINCT(a.id),
        RIGHT ( a.scanning_seriano, 17 ) scanRightId,
        SUBSTRING (
        a.scanning_seriano,
        0,
        CHARINDEX( '_', a.scanning_seriano )) scanSubId,
        a.scanning_seriano invoiceSerialNo,
        a.venderid venderId,
        a.vendername venderName,
        convert(varchar(100),a.create_date,23) createDate,
        a.gf_name gfName,
        a.uuid,
        a.invoice_type invoiceType,
        a.invoice_code invoiceCode,
        a.invoice_no invoiceNo,
        a.invoice_date invoiceDate,
        a.gf_tax_no gfTaxNo,
        a.xf_tax_no xfTaxNo,
        a.xf_name xfName,
        a.invoice_amount invoiceAmount,
        a.tax_amount taxAmount,
        a.total_amount totalAmount,
        a.remark,
        a.invoice_status invoiceStatus,
        a.rzh_date rzhDate,
        a.qs_date qsDate,
        a.rzh_belong_date rzhBelongDate,
        a.rzh_yesorno rzhYesorno,
        a.auth_status authStatus,
        a.qs_type  qsType,
        a.qs_status qsStatus,
        a.jvcode jvCode,
        a.company_code companyCode,
        a.tax_rate taxRate,
        a.eps_no,
        bbindingno bbindingNo,
        convert(varchar(100),bbinding_date,23) bbindingDate
        from
        t_dx_record_invoice a WITH(NOLOCK)
        <!-- LEFT JOIN t_ac_org b WITH(NOLOCK) on b.orgcode = a.jvcode-->
        where
        a.bindyesorno ='1'
        and a.bbindingno in (
        select
        bbindingno bbindingNo
        from t_dx_record_invoice WITH(NOLOCK)
        where
        bindyesorno='1'
        and (packyesorno != '1' or packyesorno is null)
        <if test="map.epsNo != null and map.epsNo != ''">
            and eps_no like concat('%',concat(#{map.epsNo},'%'))

        </if>
        <if test="map.invoiceSerialNo != null and map.invoiceSerialNo != ''">
            and scanning_seriano like concat('%',concat(#{map.invoiceSerialNo},'%'))

        </if>
        <if test="map.bbindingNo != null and map.bbindingNo != ''">
            and bbindingno like concat('%',concat(#{map.bbindingNo},'%'))

        </if>
        <if test="map.bbindingDate1 != null and map.bbindingDate1 != ''">
            <![CDATA[ AND convert(varchar(100),bbinding_date,23) >= #{map.bbindingDate1} ]]>
        </if>
        <if test="map.bbindingDate2 != null and map.bbindingDate2 != ''">
            <![CDATA[ AND convert(varchar(100),bbinding_date,23)  <= #{map.bbindingDate2} ]]>
        </if>
            group by bbindingno ,CONVERT (
            VARCHAR (100),
            bbinding_date,
            23
            )
        )
        ORDER BY
        scanSubId,
        scanRightId ASC

    </select>


    <!--查询装订册条数-->
    <select id="getBindingnoListCount" resultType="java.lang.Integer">
        select
        count(1)
        from
        t_dx_record_invoice a WITH(NOLOCK)
       <!-- LEFT JOIN t_ac_org b WITH(NOLOCK) on b.orgcode = a.jvcode-->
        where  a.bbindingno = #{map.bbindingNo}
        and a.bindyesorno ='1'
    </select>
    <select id="querydetailList" resultType="com.xforceplus.wapp.modules.pack.entity.GenerateBindNumberEntity">
        /**mycat:schema=${schemaLabel}*/
        SELECT
        id,
        uuid,
        invoice_type invoiceType,
        invoice_code invoiceCode,
        invoice_no invoiceNo,
        invoice_date invoiceDate,
        gf_tax_no gfTaxNo,
        gf_name gfName,
        xf_tax_no xfTaxNo,
        xf_name xfName,
        invoice_amount invoiceAmount,
        tax_amount taxAmount,
        total_amount totalAmount,
        remark,
        invoice_status invoiceStatus,
        rzh_date rzhDate,
        qs_date qsDate,
        rzh_belong_date rzhBelongDate,
        rzh_yesorno rzhYesorno,
        auth_status authStatus,
        qs_type  qsType,
        venderid venderId,
        vendername venderName,
        qs_status qsStatus
        from t_dx_record_invoice a WITH(NOLOCK), t_dx_invoice b WITH(NOLOCK)
        where valid='1'
            and a.uuid = concat(b.invoice_code,b.invoice_no)
            ORDER BY create_date desc, id desc
    </select>

</mapper>