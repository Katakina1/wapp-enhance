<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.enterprise.dao.EnterpriseDao">
    <resultMap id="resultEnterprise" type="com.xforceplus.wapp.modules.enterprise.entity.EnterpriseEntity">
        <id column="orgid" property="id" />
        <result column="orgcode" property="orgCode" />
        <result column="orgname" property="orgName" />
        <result column="taxno" property="taxNo" />
        <result column="taxname" property="taxName" />
        <result column="orgtype" property="orgType" />
        <result column="create_time" property="createTime" />
        <result column="is_black" property="isBlack" />
        <result column="com_type" property="comType" />
        <result column="company" property="company" />
        <result column="email" property="email" />
        <result column="postcode" property="postcode" />
        <result column="address" property="address" />
        <result column="phone" property="phone" />
        <result column="remark" property="remark" />
        <result column="linkman" property="linkman" />
        <result column="bank" property="bank" />
        <result column="account" property="account" />
        <result column="bankAccount" property="bankAccount" />
        <result column="addressPhone" property="addressPhone" />
    </resultMap>

    <select id="queryList" resultMap="resultEnterprise">
        /**mycat:schema=${schemaLabel}*/
        SELECT
        orgid, orgcode, orgname, taxno,
        taxname, orgtype, create_time,
        is_black, com_type,
        CONCAT(address,' ',phone) addressPhone,
        CONCAT(bank,account) bankAccount,
        company,email,postcode,address,phone,
        remark,linkman,bank,account
        FROM t_ac_org WITH(NOLOCK)
        WHERE orgtype = #{orgType}
        AND company = (SELECT tao.company FROM t_ac_org tao WITH(NOLOCK)
        WHERE orgid = (SELECT orgId FROM t_ac_user WITH(NOLOCK)
        WHERE userid = #{userId} ))
        <if test="orgName != null and orgName !=''" >
            AND orgname LIKE  "%"#{orgName}"%"
        </if>
        <if test="taxNo != null and taxNo !=''" >
            AND taxno LIKE "%"#{taxNo}"%"
        </if>
        <if test="isBlack != null and isBlack !=''">
            AND is_black = #{isBlack}
        </if>
        <if test="comType != null and comType !=''">
            AND com_type = #{comType}
        </if>
        ORDER BY create_time DESC
        <if test="offset != null and limit != null">
            limit #{offset}, #{limit}
        </if>
    </select>

    <select id="queryTotal" resultType="Integer">
        /**mycat:schema=${schemaLabel}*/
        SELECT COUNT(1)
        FROM t_ac_org WITH(NOLOCK)
        WHERE orgtype = #{orgType}
        AND company = (SELECT tao.company FROM t_ac_org tao WITH(NOLOCK)
        WHERE tao.orgid = (SELECT tau.orgid FROM t_ac_user tau WITH(NOLOCK)
        WHERE tau.userid = #{userId} ))
        <if test="orgName != null and orgName !=''" >
            AND orgname LIKE  "%"#{orgName}"%"
        </if>
        <if test="taxNo != null and taxNo !=''" >
            AND taxno LIKE "%"#{taxNo}"%"
        </if>
        <if test="isBlack != null and isBlack !=''">
            AND is_black = #{isBlack}
        </if>
        <if test="comType != null and comType !=''">
            AND com_type = #{comType}
        </if>
    </select>

    <select id="queryBlackEnterpriseList"  resultMap="resultEnterprise">
        /**mycat:schema=${schemaLabel}*/
        SELECT
        orgid, orgname,
        taxno, create_time, com_type
        FROM t_ac_org_black
        WHERE is_black = '1'
        AND company = (SELECT tao.company FROM t_ac_org tao WITH(NOLOCK)
        WHERE tao.orgid = (SELECT tau.orgid FROM t_ac_user tau WITH(NOLOCK)
        WHERE tau.userid = #{userId} ))
        <if test="orgName != null and orgName !=''" >
            AND orgname LIKE  "%"#{orgName}"%"
        </if>
        <if test="taxNo != null and taxNo !=''" >
            AND taxno LIKE "%"#{taxNo}"%"
        </if>
        <if test="comType != null and comType !=''">
            AND com_type = #{comType}
        </if>
        <if test="company != null and company !=''">
            AND company = #{company}
        </if>
        ORDER BY create_time DESC
        <if test="offset != null and limit != null">
            limit #{offset}, #{limit}
        </if>
    </select>

    <select id="queryBlackEnterpriseTotal" resultType="Integer">
        /**mycat:schema=${schemaLabel}*/
        SELECT COUNT(1)
        FROM t_ac_org_black
        WHERE is_black = '1'
        AND company = (SELECT tao.company FROM t_ac_org tao WITH(NOLOCK)
        WHERE tao.orgid = (SELECT tau.orgid FROM t_ac_user tau WITH(NOLOCK)
        WHERE tau.userid = #{userId} ))
        <if test="orgName != null and orgName !=''" >
            AND orgname LIKE  "%"#{orgName}"%"
        </if>
        <if test="taxNo != null and taxNo !=''" >
            AND taxno LIKE "%"#{taxNo}"%"
        </if>
        <if test="comType != null and comType !=''">
            AND com_type = #{comType}
        </if>
        <if test="company != null and company !=''">
            AND company = #{company}
        </if>
    </select>

    <select id="queryEnterpriseById" resultMap="resultEnterprise">
        /**mycat:schema=${schemaLabel}*/
        SELECT
        orgid, orgcode, orgname, taxno,
        taxname, orgtype, create_time,
        is_black, com_type, company,
        email, postcode, address, phone,
        remark, linkman, bank, account
        FROM t_ac_org WITH(NOLOCK)
        WHERE orgid = #{enterpriseId}
    </select>

    <select id="queryBlackEnterpriseById" resultMap="resultEnterprise">
        /**mycat:schema=${schemaLabel}*/
        SELECT
        orgid, orgname,
        taxno, com_type
        FROM t_ac_org_black
        WHERE orgid = #{blackEnterpriseId}
    </select>

    <select id="queryEnterpriseByTaxNo" resultType="Integer">
        /**mycat:schema=${schemaLabel}*/
        SELECT COUNT(1)
        FROM t_ac_org_black
        WHERE taxno = #{enterprise.taxNo}
        AND company = (SELECT tao.company FROM t_ac_org tao WITH(NOLOCK)
        WHERE tao.orgid = (SELECT tau.orgid FROM t_ac_user tau WITH(NOLOCK)
        WHERE tau.userid = #{enterprise.userId} ))
    </select>

    <select id="queryEnterpriseByOrgName" resultType="Integer">
        /**mycat:schema=${schemaLabel}*/
        SELECT COUNT(1)
        FROM t_ac_org_black
        WHERE orgname = #{enterprise.orgName}
        AND company = (SELECT tao.company FROM t_ac_org tao WITH(NOLOCK)
        WHERE tao.orgid = (SELECT tau.orgid FROM t_ac_user tau WITH(NOLOCK)
        WHERE tau.userid = #{enterprise.userId} ))
    </select>

    <update id="deleteBlackEnterprise">
        /**mycat:schema=${schemaLabel}*/
        UPDATE t_ac_org_black
        SET is_black = '0',
        last_modify_time = sysdate(),
        last_modify_by = #{lastModifyBy}
        WHERE orgid = #{orgId}
    </update>

    <insert id="saveBlackEnterprise">
        /**mycat:schema=${schemaLabel}*/
        INSERT INTO t_ac_org_black
        (
        `orgname`,
        `taxno`,
        `com_type`,
        `create_time`,
        `create_by`,
        `is_black`,
        `company`
        )
        VALUES
        (
        #{enterprise.orgName},
        #{enterprise.taxNo},
        #{enterprise.comType},
        sysdate(),
        #{enterprise.createBy},
        '1',
        (
        #{enterprise.company}
        )
        )
    </insert>

    <select id="queryCompanyByUser" resultMap="resultEnterprise">
        /**mycat:schema=${schemaLabel}*/
        SELECT tao.company FROM t_ac_org tao WITH(NOLOCK)
        WHERE tao.orgid = (SELECT tau.orgid FROM t_ac_user tau WITH(NOLOCK)
        WHERE tau.userid = #{enterprise.userId} )
    </select>

    <update id="updateBlackEnterprise">
        /**mycat:schema=${schemaLabel}*/
        UPDATE t_ac_org_black
        <set>
            <if test="enterprise.orgName != null">`orgName` = #{enterprise.orgName}, </if>
            <if test="enterprise.taxNo != null">`taxno` = #{enterprise.taxNo},</if>
            <if test="enterprise.comType != null">`com_type` = #{enterprise.comType}, </if>
            <if test="enterprise.lastModifyBy != null">`last_modify_by` = #{enterprise.lastModifyBy}, </if>
            `last_modify_time` = sysdate(),
        </set>
        WHERE orgid = #{enterprise.id}
    </update>

    <update id="updateEnterpriseAsBlack">
        /**mycat:schema=${schemaLabel}*/
        UPDATE t_ac_org_black
        <set>
            `is_black` = '1',
            <if test="enterprise.lastModifyBy != null">`last_modify_by` = #{enterprise.lastModifyBy}, </if>
            `last_modify_time` = sysdate(),
        </set>
        WHERE taxno = #{enterprise.taxNo}
    </update>
</mapper>