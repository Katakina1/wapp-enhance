<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.analysis.dao.DataInvoiceSubmitDao">

    <select id="queryList" resultType="com.xforceplus.wapp.modules.report.entity.ComprehensiveInvoiceQueryEntity">
        /**mycat:schema=${schemaLabel}*/
        <if test="map.offset != null and map.limit != null">
        SELECT
        TOP (#{map.limit}) A.*
        FROM
        (
        SELECT
        row_number () OVER (ORDER BY invoiceDate desc, id desc) AS rownumber, o.*
        FROM
        (
        </if>
        select
        id,
        invoice_type invoiceType,
        invoice_code invoiceCode,
        invoice_no invoiceNo,
        invoice_date invoiceDate,
        gf_tax_no gfTaxNo,
        gf_name gfName,
        xf_tax_no xfTaxNo,
        xf_name xfName,
        invoice_amount invoiceAmount,
        tax_amount taxAmount,
        total_amount totalAmount,
        remark,
        invoice_status invoiceStatus,
        rzh_date rzhDate,
        qs_date qsDate,
        rzh_belong_date rzhBelongDate,
        rzh_yesorno rzhYesorno,
        auth_status authStatus,
        qs_type qsType,
        qs_status qsStatus,
        certificate_no certificateNo,
        dxhy_match_status dxhyMatchStatus,
        match_date matchDate,
        host_status hoststatus,
        scanning_seriano scanningSeriano,
        bbindingno,
        packingno,
        tax_rate taxRate
        from t_dx_record_invoice WITH(NOLOCK)
        where 1=1
        <if test="map.gfName != null and map.gfName != '-1'">
            and gf_tax_no = #{map.gfName}
        </if>
        <if test="map.xfName != null and map.xfName != ''">
            and xf_name like concat('%',concat(#{map.xfName},'%'))
        </if>
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
        </if>
        <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23) >= #{map.invoiceDate1} ]]>
        </if>
        <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23)  <= #{map.invoiceDate2} ]]>
        </if>
        <if test="map.invoiceStatus !=null and map.invoiceStatus != '-1'">
            and invoice_status = #{map.invoiceStatus}
        </if>
        <if test="map.invoiceType !=null and map.invoiceType != '-1'">
            and invoice_type = #{map.invoiceType}
        </if>
        <if test="map.dxhyMatchStatus !=null and map.dxhyMatchStatus != '-1'">
            and dxhy_match_status = #{map.dxhyMatchStatus}
        </if>
        <if test="map.qsStatus !=null and map.qsStatus != '-1'">
            and qs_status = #{map.qsStatus}
        </if>
        <if test="map.rzhYesorno !=null and map.rzhYesorno != '-1'">
            and rzh_yesorno = #{map.rzhYesorno}
        </if>
        <if test="map.qsType !=null and map.qsType != '-1'">
            and qs_type = #{map.qsType}
        </if>
        <if test="map.qsDate1 != null and map.qsDate1 != ''">
            <![CDATA[ AND convert(varchar(100),qs_date,23) >= #{map.qsDate1} ]]>
        </if>
        <if test="map.qsDate2 != null and map.qsDate2 != ''">
            <![CDATA[ AND convert(varchar(100),qs_date,23)  <= #{map.qsDate2}) ]]>
        </if>
        <if test="map.rzhBelongDate !=null and map.rzhBelongDate != ''">
            and rzh_belong_date = #{map.rzhBelongDate}
        </if>
        <if test="map.rzhDate1 != null and map.rzhDate1 != ''">
            <![CDATA[ AND convert(varchar(100),rzh_date,23) >= #{map.rzhDate1} ]]>
        </if>
        <if test="map.rzhDate2 != null and map.rzhDate2 != ''">
            <![CDATA[ AND convert(varchar(100),rzh_date,23)  <= #{map.rzhDate2} ]]>
        </if>
        <if test="map.matchDateStart != null and map.matchDateStart != ''">
            <![CDATA[ AND convert(varchar(100),match_date,23) >= #{map.matchDateStart} ]]>
        </if>
        <if test="map.matchDateEnd != null and map.matchDateEnd != ''">
            <![CDATA[ AND convert(varchar(100),match_date,23)  <= #{map.matchDateEnd} ]]>
        </if>
         <if test="map.venderid ==null and map.venderid ==''">
             and gf_tax_no in (select taxno from t_ac_org WITH(NOLOCK) where orgid in (select orgid from t_ac_user_taxno where userid=#{map.userID}))
         </if>
        <if test="map.venderid !=null or map.venderid !=''">
            and xf_tax_no in (select taxno from t_ac_org WITH(NOLOCK) where orgid in (select orgid from t_ac_user WITH(NOLOCK) where userid=#{map.userID}))
        </if>
        <if test="map.offset == null and map.limit == null">
            ORDER BY invoice_date desc, id desc
        </if>
        <if test="map.offset != null and map.limit != null">
            )
            AS o
            )A
            WHERE
            rownumber >#{map.offset}

        </if>
        <!--limit #{map.offset}, #{map.limit}-->
    </select>

	<resultMap id="resultCollectionMap" type="com.xforceplus.wapp.modules.report.entity.ComprehensiveInvoiceQueryEntity">
        <id column="id" property="id" />
        <result column="venderid" property="venderId" />
        <result column="vendername" property="venderName" />
        <result column="countNum" property="countNum" />
    </resultMap>
    
    <sql id="queryInvoiceSubmitSql">
        SELECT
        v.venderid,
        u.username vendername,
        count(v.venderid) countNum
        FROM t_dx_record_invoice v WITH(NOLOCK)
        left join t_ac_user u WITH(NOLOCK) on v.venderid=u.usercode
        WHERE v.venderid !=''
        <if test="venderId != null and venderId != ''">
            AND v.venderid = #{venderId}
        </if>
        <choose><!-- type=1 数据发票提交统计，查找匹配时间字段，2是实物发票处理统计，查找扫描匹配时间字段 -->
        	<when test="type == 1">
        		<if test="createStartDate != null and createStartDate != ''">
            	<![CDATA[ AND convert(varchar(100),v.match_date,23) >= #{createStartDate} ]]>
        		</if>
        		<if test="createEndDate != null and createEndDate != ''">
            	<![CDATA[ AND convert(varchar(100),v.match_date,23)  <= #{createEndDate} ]]>
        		</if>
        	
        	</when>
            <when test="type == 1">
                <if test="createStartDate != null and createStartDate != ''">
                    <![CDATA[ AND convert(varchar(100),v.match_date,23) >= #{createStartDate} ]]>
                </if>
                <if test="createEndDate != null and createEndDate != ''">
                    <![CDATA[ AND convert(varchar(100),v.match_date,23)  <= #{createEndDate} ]]>
                </if>

            </when>
        </choose>
        GROUP BY v.venderid,u.username
    </sql>
    
     <select id="queryCount" resultType="Integer">
        SELECT COUNT(1) FROM (
        <include refid="queryInvoiceSubmitSql"/>
        ) t
    </select>

    <!-- 供应商提交发票统计 -->
    <select id="queryInvoiceSubmit" resultMap="resultCollectionMap">
        <if test="offset != null and limit != null">
        select top (#{limit}) a.*
        from(
        select row_number() over(order by venderid) as rownumber,o.*
        from(
        </if>
        <include refid="queryInvoiceSubmitSql"/>
        <if test="offset != null and limit != null">
        ) as o
        ) a
        where rownumber>#{offset};
        </if>

    </select>

    <sql id="queryRealInvoiceSubmitSql">
        SELECT
        v.venderid,
        u.username vendername,
        count(v.venderid) countNum
        FROM t_dx_invoice v WITH(NOLOCK)
        left join t_ac_user u WITH(NOLOCK) on v.venderid=u.usercode
        WHERE v.venderid !=''
        and v.rebateyesorno ='0'
        <if test="venderId != null and venderId != ''">
            AND v.venderid = #{venderId}
        </if>
        <choose><!-- 2是实物发票处理统计，查找扫描创建时间字段 -->
            <when test="type == 2">
                <if test="createStartDate != null and createStartDate != ''">
                    <![CDATA[ AND convert(varchar(100),v.create_date,20) >= #{createStartDate} ]]>
                </if>
                <if test="createEndDate != null and createEndDate != ''">
                    <![CDATA[ AND convert(varchar(100),v.create_date,20)  <= #{createEndDate} ]]>
                </if>
            </when>
        </choose>

        GROUP BY v.venderid,u.username
    </sql>

    <select id="queryRealCount" resultType="Integer">
        SELECT COUNT(1) FROM (
        <include refid="queryRealInvoiceSubmitSql"/>
        ) t
    </select>

    <!-- 实物发票提交统计 -->
    <select id="queryRealInvoiceSubmit" resultMap="resultCollectionMap">
        <if test="offset != null and limit != null">
            select top (#{limit}) a.*
            from(
            select row_number() over(order by venderid) as rownumber,o.*
            from(
        </if>
        <include refid="queryRealInvoiceSubmitSql"/>
        <if test="offset != null and limit != null">
            ) as o
            ) a
            where rownumber>#{offset};
        </if>
    </select>
</mapper>