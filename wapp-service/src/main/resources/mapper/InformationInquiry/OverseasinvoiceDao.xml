<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xforceplus.wapp.modules.InformationInquiry.dao.OverseasinvoiceDao">
    <!--查询海外发票信息-->
    <select id="list" resultType="com.xforceplus.wapp.modules.InformationInquiry.entity.OverseasInvoiceEntity">
        SELECT
        <if test=" map.limit != null">
            TOP (#{map.limit})
        </if>
        A.*
        FROM
        (
        SELECT
        row_number () OVER (ORDER BY o.id ) AS rownumber ,o.*
        FROM
        (
        select
        id,
        invoice_no      invoiceNo,
        invoice_code    invoiceCode,
        invoice_date    invoiceDate,
        venderid,
        jvcode,
        company_code     companyCode,
        gfname,
        store,
        tax_amount       taxAmount,
        tax_rate         taxRate,
        tax_code         taxCode,
        cost_amount      costAmount,
        certificate_no   certificateNo,
        total_amount     totalAmount,
        remarks,
        flow_type        flowType
        from t_dx_overseas_invoice WITH(NOLOCK)
        <where>
            <if test="map.venderid != null and map.venderid != ''">
                and venderid like concat('%',concat(#{map.venderid},'%'))
            </if>
            <if test="map.jvcode != null and map.jvcode != '-1'">
                and jvcode like concat('%',concat(#{map.jvcode},'%'))
            </if>
            <if test="map.invoiceNo != null and map.invoiceNo != ''">
                and invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
            </if>
            <if test="map.invoiceCode != null and map.invoiceCode != ''">
                and invoice_code like concat('%',concat(#{map.invoiceCode},'%'))
            </if>
            <if test="map.flowType != null and map.flowType != '-1'">
                and flow_type like concat('%',concat(#{map.flowType},'%'))
            </if>
            <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
                <![CDATA[ AND convert(varchar(10),invoice_date,23) >= #{map.invoiceDate1} ]]>
            </if>
            <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
                <![CDATA[ AND convert(varchar(10),invoice_date,23)  <= #{map.invoiceDate2} ]]>
            </if>
        </where>
        ) AS o
        ) A
        WHERE 1=1
        <if test="map.offset != null ">
            and   rownumber > #{map.offset}
        </if>
    </select>

    <!--查询海外发票信息条数-->
    <select id="listCount" resultType="Integer">
        select count(1)
        from t_dx_overseas_invoice WITH(NOLOCK)
        <where>
            <if test="map.venderid != null and map.venderid != ''">
                and venderid like concat('%',concat(#{map.venderid},'%'))
            </if>
            <if test="map.jvcode != null and map.jvcode != '-1'">
                and jvcode like concat('%',concat(#{map.jvcode},'%'))
            </if>
            <if test="map.invoiceNo != null and map.invoiceNo != ''">
                and invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
            </if>
            <if test="map.invoiceCode != null and map.invoiceCode != ''">
                and invoice_code like concat('%',concat(#{map.invoiceCode},'%'))
            </if>
            <if test="map.flowType != null and map.flowType != '-1'">
                and flow_type like concat('%',concat(#{map.flowType},'%'))
            </if>
            <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
                <![CDATA[ AND convert(varchar(10),invoice_date,23) >= #{map.invoiceDate1} ]]>
            </if>
            <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
                <![CDATA[ AND convert(varchar(10),invoice_date,23)  <= #{map.invoiceDate2} ]]>
            </if>
        </where>
    </select>

    <!--海外发票导入-->
    <insert id="saveInvoice" parameterType="com.xforceplus.wapp.modules.InformationInquiry.entity.OverseasInvoiceEntity">
        INSERT INTO t_dx_overseas_invoice (
        invoice_no,
        invoice_code,
        invoice_date,
        venderid,
        jvcode,
        company_code,
        gfname,
        store,
        tax_amount,
        tax_rate,
        tax_code,
        cost_amount,
        certificate_no,
        total_amount,
        remarks,
        flow_type,
        create_by,
        create_time
        )
        VALUES
        <foreach collection="list" item="item" separator=",">
            (
            #{item.invoiceNo},
            #{item.invoiceCode},
            #{item.invoiceDate},
            #{item.venderid},
            #{item.jvcode},
            #{item.companyCode},
            #{item.gfname},
            #{item.store},
            #{item.taxAmount},
            #{item.taxRate},
            #{item.taxCode},
            #{item.costAmount},
            #{item.certificateNo},
            #{item.totalAmount},
            #{item.remarks},
            #{item.flowType},
            #{item.createBy},
            #{item.createTime}
            )
        </foreach>
    </insert>

    <!--查询海外问题发票信息-->
    <select id="failedlist" resultType="com.xforceplus.wapp.modules.InformationInquiry.entity.OverseasInvoiceEntity">
        select
        id,
        invoice_no      invoiceNo,
        invoice_code    invoiceCode,
        invoice_date    invoiceDate,
        venderid,
        jvcode,
        company_code     companyCode,
        gfname,
        store,
        tax_amount       taxAmount,
        tax_rate         taxRate,
        tax_code         taxCode,
        cost_amount      costAmount,
        certificate_no   certificateNo,
        total_amount     totalAmount,
        remarks,
        flow_type        flowType,
        error_description  errorDescription
        from t_dx_overseas_invoice_failed WITH(NOLOCK)
        <where>
            <if test="createBy != null and createBy != ''">
                and create_by = #{createBy}
            </if>
        </where>
        ORDER BY id
    </select>

    <!--海外发票导入-->
    <insert id="saveErrorInvoice" parameterType="com.xforceplus.wapp.modules.InformationInquiry.entity.OverseasInvoiceEntity">
        INSERT INTO t_dx_overseas_invoice_failed (
        invoice_no,
        invoice_code,
        invoice_date,
        venderid,
        jvcode,
        company_code,
        gfname,
        store,
        tax_amount,
        tax_rate,
        tax_code,
        cost_amount,
        certificate_no,
        total_amount,
        remarks,
        flow_type,
        create_by,
        create_time,
        error_description
        )
        VALUES
            (
            #{map.invoiceNo},
            #{map.invoiceCode},
            #{map.invoiceDate},
            #{map.venderid},
            #{map.jvcode},
            #{map.companyCode},
            #{map.gfname},
            #{map.store},
            #{map.taxAmount},
            #{map.taxRate},
            #{map.taxCode},
            #{map.costAmount},
            #{map.certificateNo},
            #{map.totalAmount},
            #{map.remarks},
            #{map.flowType},
            #{createBy},
            #{createTime},
            #{errorDescription}
            )
    </insert>

    <delete id="delete">
        delete from t_dx_overseas_invoice_failed
        where
        create_by = #{loginname}
    </delete>

    <!--查询购方信息条数-->
    <select id="getGfCount" resultType="Integer">
        select count(1)
        from t_ac_org o WITH(NOLOCK)
        join t_ac_org g on o.parentid=g.orgid
        <where>
            and o.orgtype ='7'
            and g.orgtype='5'
            <if test="map.jvcode != null and map.jvcode != ''">
                and g.orgcode = #{map.jvcode}
            </if>
            <if test="map.companyCode != null and map.companyCode != ''">
                and g.company_code = #{map.companyCode}
            </if>
            <if test="map.store != null and map.store != ''">
                and o.orgcode = #{map.store}
            </if>
            <if test="map.gfname != null and map.gfname != ''">
                and g.orgname = #{map.gfname}
            </if>
        </where>
    </select>

    <update id="updateInvoice">
        update t_dx_overseas_invoice set
        invoice_date=#{map.invoiceDate},
        venderid=#{map.venderid},
        jvcode=#{map.jvcode},
        company_code=#{map.companyCode},
        gfname=#{map.gfname},
        store=#{map.store},
        tax_amount=#{map.taxAmount},
        tax_rate=#{map.taxRate},
        tax_code=#{map.taxCode},
        cost_amount=#{map.costAmount},
        certificate_no=#{map.certificateNo},
        total_amount=#{map.totalAmount},
        remarks=#{map.remarks},
        flow_type=#{map.flowType},
        last_modify_by=#{map.lastModifyBy},
        last_modify_time=#{map.lastModifyTime}
        where invoice_no=#{map.invoiceNo}
        and invoice_code=#{map.invoiceCode}
    </update>

    <!--查询销方信息条数-->
    <select id="getXfCount" resultType="Integer">
        select count(1)
        from t_ac_user WITH(NOLOCK)
        where usercode = #{map.venderid}
    </select>
</mapper>