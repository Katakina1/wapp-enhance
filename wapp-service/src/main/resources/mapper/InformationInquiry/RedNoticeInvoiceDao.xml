<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.InformationInquiry.dao.RedNoticeInvoiceDao">
    

    
     <select id="selectRedNoticeNumbers" resultType="com.xforceplus.wapp.modules.redTicket.entity.RedTicketMatch">
        SELECT red_notice_number , redticket_data_serial_number,audit_results as examineResult FROM
        t_dx_red_ticket_matching
        where redticket_data_serial_number=#{redTicketDataSerialNumber}
    </select>
    <select id="selectRedNotice" resultType="java.lang.Integer">
        SELECT count(1) FROM
        t_dx_redInvoice_detail
        where red_letter_notice=#{redNoticeNumber}
    </select>
    <insert id="saveRedNoticeInvoiceData" parameterType="com.xforceplus.wapp.modules.InformationInquiry.entity.RedNoticeBathEntity">
          INSERT INTO t_dx_batch_red_notice (
        xf_name,
        xf_taxno,
        gf_name,
        gf_taxno,
        red_ticket_data_serial_number,
        amount,
        tax_rate,
        tax_amount,
        tk_date,
        red_notice_number,
        create_date,
        red_ricket_type,
        update_persion
        ) VALUES (
        #{xfName},
        #{xfTaxno},
        #{gfName},
        #{gfTaxno},
        #{redTicketDataSerialNumber},
        #{amount},
        #{taxRate},
        #{taxAmount},
        #{tkDate},
        #{redNoticeNumber},
        getdate(),
        #{redTicketType},
         #{updatePersion}
        )
    </insert>

    <select id="queryList" resultType="com.xforceplus.wapp.modules.InformationInquiry.entity.RedNoticeBathEntity">
        SELECT
        <if test=" map.limit != null">
            TOP (#{map.limit})
        </if>
        A.*
        FROM
        (
        SELECT
        row_number () OVER (ORDER BY o.id ) AS rownumber ,o.*
        FROM
        (
        select
        id,
        xf_name xfName,
        xf_taxno xfTaxno,
        gf_name  gfName,
        gf_taxno  gfTaxno,
        red_ticket_data_serial_number redTicketDataSerialNumber,
        amount ,
        tax_rate  taxRate,
        tax_amount taxAmount ,
        tk_date tkDate,
        red_notice_number redNoticeNumber,
        create_date createDate,
        update_date  updateDate,
        update_persion  updatePersion,
        red_ricket_type redRicketType
        from
        t_dx_batch_red_notice
        where red_ricket_type = #{map.redTicketType}
        ) AS o
        ) A
        WHERE 1=1
        <if test="map.offset != null ">
            and   rownumber > #{map.offset}
        </if>


    </select>
    <select id="queryTotalResult" resultType="int" >
        select
        ISNULL( count(1),0)
        from
        t_dx_batch_red_notice
        where red_ricket_type = #{map.redTicketType}
    </select>


<select id="gfNames" resultType="String">
    SELECT y.gf_name FROM  t_dx_red_ticket_matching a
    LEFT  JOIN t_dx_record_invoice y WITH(NOLOCK)
      on  a.uuid = y.uuid
    where redticket_data_serial_number  = #{redTicketDataSerialNumber}
</select>

    <select id="gfTaxnos" resultType="String">
        SELECT y.gf_tax_no FROM  t_dx_red_ticket_matching a
        LEFT  JOIN t_dx_record_invoice y WITH(NOLOCK)
          on  a.uuid = y.uuid
        where redticket_data_serial_number  = #{redTicketDataSerialNumber}
    </select>

    <select id="getGfuuid" resultType="com.xforceplus.wapp.modules.InformationInquiry.entity.RedNoticeBathEntity">
    SELECT y.invoice_code+y.invoice_no as uuid FROM  t_dx_red_ticket_matching a WITH(NOLOCK)
    LEFT  JOIN t_dx_red_ticket_matching_middle y WITH(NOLOCK)
      on  a.id = y.red_ticket_matching_association
    where a.redticket_data_serial_number  = #{redTicketDataSerialNumber}
    </select>

    <select id="gfDxName" resultType="String">
    SELECT gf_name FROM t_dx_record_invoice WITH(NOLOCK)
    where uuid  = #{uuid}
    </select>

    <select id="gfDxTaxno" resultType="String">
    SELECT gf_tax_no FROM t_dx_record_invoice WITH(NOLOCK)
    where uuid  = #{uuid}
    </select>

</mapper>