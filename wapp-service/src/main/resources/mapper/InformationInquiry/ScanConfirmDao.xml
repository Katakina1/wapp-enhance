<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.InformationInquiry.dao.ScanConfirmDao">
    <select id="queryList" resultType="com.xforceplus.wapp.modules.report.entity.ComprehensiveInvoiceQueryEntity">
        <if test="map.offset != null and map.limit != null">
            SELECT
            TOP (#{map.limit}) P.*
            FROM
            (
            SELECT
            row_number () OVER (ORDER BY invoiceDate desc, id desc) AS rownumber, o.*
            FROM
            (
        </if>
        select
        a.id id,
        a.invoice_type invoiceType,
        a.invoice_code invoiceCode,
        a.invoice_no invoiceNo,
        a.invoice_date invoiceDate,
        a.gf_tax_no gfTaxNo,
        a.gf_name gfName,
        a.xf_tax_no xfTaxNo,
        a.xf_name xfName,
        a.invoice_amount invoiceAmount,
        a.tax_amount taxAmount,
        a.total_amount totalAmount,
        a.tax_rate taxRate,
        a.confirm_reason confirmReason,
        a.jvcode  jvCode,
        a.venderid  venderId,
        a.deductible_tax_rate  deductibleTaxRate,
        a.deductible_tax      deductibleTax
        from t_dx_record_invoice a WITH(NOLOCK)
        <if test="map.isReturnTicket != 1">
        join t_dx_invoice b WITH(NOLOCK)
        on a.uuid=b.uuid and a.invoice_amount=b.invoice_amount
        and convert(varchar(10),a.invoice_date,23)=convert(varchar(10),b.invoice_date,23)
        where isnull(a.auth_status,'0')='0' and b.qs_status='1'
        and isnull(b.rebateyesorno,'0')='0' and isnull(b.isdel,'0')='0'
        and isnull(a.source_system,'')!='2'
        and((b.flow_type='1' and a.scan_match_status !='1') or (b.flow_type='8' and a.scan_match_status ='1'))
        </if>
        <if test="map.isReturnTicket == 1">
            where is_return_ticket='1'
        </if>
        <if test="map.jvcode != null and map.jvcode != '-1'">and a.gf_tax_no in (select taxno from t_ac_org WITH(NOLOCK) where
            orgcode =#{map.jvcode})
        </if>
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and a.
            invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
        </if>
        <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
            <![CDATA[ AND convert(varchar(100),a.invoice_date,23) >= #{map.invoiceDate1} ]]>
        </if>
        <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
            <![CDATA[ AND convert(varchar(100),a.invoice_date,23) <= #{map.invoiceDate2} ]]>
        </if>
        <if test="map.flowType != null and map.flowType != '' and map.flowType != '-1'">
           and a.flow_type =#{map.flowType}
        </if>
        <if test="map.offset != null and map.limit != null">
            )
            AS o
            ) P
            WHERE
            rownumber >#{map.offset}
        </if>
    </select>

    <select id="queryCount" resultType="int">
        select
        count(1)
        from t_dx_record_invoice a WITH(NOLOCK)
        <if test="map.isReturnTicket != 1">
        join t_dx_invoice b WITH(NOLOCK)
        on a.uuid=b.uuid and a.invoice_amount=b.invoice_amount
        and convert(varchar(10),a.invoice_date,23)=convert(varchar(10),b.invoice_date,23)
        where isnull(a.auth_status,'0')='0' and b.qs_status='1'
        and isnull(b.rebateyesorno,'0')='0' and isnull(b.isdel,'0')='0'
        and isnull(a.source_system,'')!='2'
            and((b.flow_type='1' and a.scan_match_status !='1') or (b.flow_type='8' and a.scan_match_status ='1'))
        </if>
        <if test="map.isReturnTicket == 1">
            where is_return_ticket='1'
        </if>
        <if test="map.jvcode != null and map.jvcode != '-1'">
            and a.gf_tax_no in (select taxno from t_ac_org WITH(NOLOCK) where orgcode =#{map.jvcode})
        </if>
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and a.invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
        </if>
        <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
            <![CDATA[ AND convert(varchar(100),a.invoice_date,23) >= #{map.invoiceDate1} ]]>
        </if>
        <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
            <![CDATA[ AND convert(varchar(100),a.invoice_date,23) <= #{map.invoiceDate2} ]]>
        </if>
        <if test="map.flowType != null and map.flowType != '' and map.flowType != '-1'">
           and a.flow_type =#{map.flowType}
        </if>
    </select>

    <select id="getJV" resultType="com.xforceplus.wapp.modules.cost.entity.SelectionOptionEntity">
        select orgcode optionKey,
        orgcode+'('+orgname+')' optionName
        from t_ac_org WITH(NOLOCK) where orgtype='5' and taxno=#{taxNo}
    </select>

    <select id="getVender" resultType="com.xforceplus.wapp.modules.cost.entity.SelectionOptionEntity">
        select usercode optionKey,
        usercode+'('+username+')' optionName
        from t_ac_user a WITH(NOLOCK) join t_ac_org b WITH(NOLOCK) on a.orgid=b.orgid
        where b.orgtype='8' and a.status='1'
    </select>

    <update id="updateRecordInvoice" parameterType="com.xforceplus.wapp.modules.InformationInquiry.entity.ConfirmInvoiceEntity">
        update t_dx_record_invoice WITH(ROWLOCK) set
        scan_match_status='1',
        qs_status='1',
        qs_date=GETDATE(),
        jvcode=#{jvcode},
        company_code=#{companyCode},
        venderid=#{venderid},
        confirm_status='1',
        confirm_reason=#{confirmReason},
        confirm_time=GETDATE(),
        confirm_user_id=#{confirmUserId},
        is_return_ticket='1',
        flow_type=b.flow_type
        <if test="deductibleTaxRate!=null and deductibleTaxRate!=''">
            ,deductible_tax_rate=#{deductibleTaxRate}
        </if>
        <if test="deductibleTax!=null and deductibleTax!=''">
            ,deductible_tax=#{deductibleTax}
        </if>
        from t_dx_record_invoice a join t_dx_invoice b
        on a.invoice_code=b.invoice_code and a.invoice_no=b.invoice_no
        where a.invoice_code=#{invoiceCode} and a.invoice_no=#{invoiceNo}
    </update>

    <update id="updateInvoice" parameterType="com.xforceplus.wapp.modules.InformationInquiry.entity.ConfirmInvoiceEntity">
        update t_dx_invoice WITH(ROWLOCK)  set
        qs_status='1',
        qs_date=GETDATE(),
        notes=N'签收成功',
        venderid=#{venderid},
        gf_tax_no=b.gf_tax_no,
        gf_name=b.gf_name,
        xf_tax_no=b.xf_tax_no,
        xf_name=b.xf_name,
        invoice_amount=b.invoice_amount,
        tax_amount=b.tax_amount,
        total_amount=b.total_amount,
        invoice_date=b.invoice_date
         from t_dx_invoice a join t_dx_record_invoice b
        on a.invoice_code=b.invoice_code and a.invoice_no=b.invoice_no
        where a.invoice_code=#{invoiceCode} and a.invoice_no=#{invoiceNo}
    </update>

    <select id="getCompanyCode" resultType="java.lang.String">
        select company_code from t_ac_org WITH(NOLOCK) where orgcode=#{jvcode}
    </select>

    <select id="jvOk" resultType="int">
        select count(1) from t_ac_org WITH(NOLOCK) where orgcode=#{jvcode} and taxno=#{gfTaxNo}
    </select>

    <select id="venderOk" resultType="int">
        select count(1) from t_ac_user a WITH(NOLOCK) join t_ac_org b WITH(NOLOCK) on a.orgid=b.orgid
        where b.orgtype='8' and a.status='1' and a.usercode=#{venderid}
    </select>
</mapper>