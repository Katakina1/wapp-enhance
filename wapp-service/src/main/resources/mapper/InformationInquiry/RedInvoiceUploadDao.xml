<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.InformationInquiry.dao.RedInvoiceUploadDao">



    <resultMap id="reportStatisticsMap" type="com.xforceplus.wapp.modules.report.entity.ReportStatisticsEntity">
        <result column="totalCount" property="totalCount" />
    </resultMap>

    <select id="queryList" resultType="com.xforceplus.wapp.modules.InformationInquiry.entity.RedInvoiceUploadEntity">
        <if test="map.offset != null and map.limit != null">
            SELECT
            TOP (#{map.limit}) A.*
            FROM
            (
            SELECT
            row_number () OVER (ORDER BY id) AS rownumber, o.*
            FROM
            (
        </if>
        select * from t_dx_red_invoice_list
        where 1=1
        <if test="map.venderid != null and map.venderid != ''">
            and venderid LIKE '%'+ #{map.venderid}+ '%'
        </if>
        <if test="map.returnGoodsDate1 != null and map.returnGoodsDate1 != ''">
            <![CDATA[ AND convert(varchar(100),redInvoiceDate,23) >= #{map.returnGoodsDate1} ]]>
        </if>
        <if test="map.returnGoodsDate2 != null and map.returnGoodsDate2 != ''">
            <![CDATA[ AND convert(varchar(100),redInvoiceDate,23)  <= #{map.returnGoodsDate2} ]]>
        </if>
        <if test="map.invoiceOrAgreementNo != null and map.invoiceOrAgreementNo != ''">
            and invoiceOrAgreementNo LIKE '%'+ #{map.invoiceOrAgreementNo} + '%'
        </if>
        <if test="map.redInvoiceNo != null and map.redInvoiceNo != ''">
            and redInvoiceNo LIKE '%'+ #{map.redInvoiceNo} + '%'
        </if>
        <if test="map.redType != null and map.redType != '' and map.redType !='-1'">
            and redType = #{map.redType}
        </if>
        <if test="map.offset == null and map.limit == null">
            ORDER BY uploadDate desc
        </if>
        <if test="map.offset != null and map.limit != null">
            )
            AS o
            )A
            WHERE
            rownumber >#{map.offset}
        </if>
    </select>

    <select id="queryTotalResult" resultMap="reportStatisticsMap">

        select count(1) totalCount
        from t_dx_red_invoice_list
        where 1=1
        <if test="map.venderid != null and map.venderid != ''">
            and venderid LIKE '%'+ #{map.venderid}+ '%'
        </if>
        <if test="map.returnGoodsDate1 != null and map.returnGoodsDate1 != ''">
            <![CDATA[ AND convert(varchar(100),redInvoiceDate,23) >= #{map.returnGoodsDate1} ]]>
        </if>
        <if test="map.returnGoodsDate2 != null and map.returnGoodsDate2 != ''">
            <![CDATA[ AND convert(varchar(100),redInvoiceDate,23)  <= #{map.returnGoodsDate2} ]]>
        </if>
        <if test="map.invoiceOrAgreementNo != null and map.invoiceOrAgreementNo != ''">
            and invoiceOrAgreementNo LIKE '%'+ #{map.invoiceOrAgreementNo} + '%'
        </if>
        <if test="map.redInvoiceNo != null and map.redInvoiceNo != ''">
            and redInvoiceNo LIKE '%'+ #{map.redInvoiceNo} + '%'
        </if>
        <if test="map.redType != null and map.redType != '' and map.redType !='-1'">
            and redType = #{map.redType}
        </if>
    </select>

    <select id="queryListAll" resultType="com.xforceplus.wapp.modules.InformationInquiry.entity.RedInvoiceUploadEntity">
        select * from t_dx_red_invoice_list
        where 1=1
        <if test="map.venderid != null and map.venderid != ''">
            and venderid LIKE '%'+ #{map.venderid}+ '%'
        </if>
        <if test="map.returnGoodsDate1 != null and map.returnGoodsDate1 != ''">
            <![CDATA[ AND convert(varchar(100),redInvoiceDate,23) >= #{map.returnGoodsDate1} ]]>
        </if>
        <if test="map.returnGoodsDate2 != null and map.returnGoodsDate2 != ''">
            <![CDATA[ AND convert(varchar(100),redInvoiceDate,23)  <= #{map.returnGoodsDate2} ]]>
        </if>
        <if test="map.invoiceOrAgreementNo != null and map.invoiceOrAgreementNo != ''">
            and invoiceOrAgreementNo LIKE '%'+ #{map.invoiceOrAgreementNo} + '%'
        </if>
        <if test="map.redInvoiceNo != null and map.redInvoiceNo != ''">
            and redInvoiceNo LIKE '%'+ #{map.redInvoiceNo} + '%'
        </if>
        <if test="map.redType != null and map.redType != '' and map.redType !='-1'">
            and redType = #{map.redType}
        </if>
        <if test="map.offset == null and map.limit == null">
            ORDER BY id
        </if>
    </select>
    <insert id="saveInvoice" parameterType="com.xforceplus.wapp.modules.InformationInquiry.entity.RedInvoiceUploadEntity">
        INSERT INTO t_dx_red_invoice_list (
        venderid,
        redAmount,
        invoiceOrAgreementNo,
        redInvoiceNo,
        redInvoiceDate,
        uploadDate,
        venderName,
        redType
        )
        VALUES
        <foreach collection="list" item="item" separator=",">
            (
            #{item.venderid},
            #{item.redAmount},
            #{item.invoiceOrAgreementNo},
            #{item.redInvoiceNo},
            #{item.redInvoiceDate},
            getdate(),
            #{item.venderName},
            #{item.redType}
            )
        </foreach>
    </insert>
    <select id="selectCount" resultType="java.lang.Integer">
        select count(*) from t_dx_red_invoice_list with(nolock)
        where convert(varchar(100),redInvoiceDate,23)=#{entity.redInvoiceDate}
        and redAmount=#{entity.redAmount}
        and redInvoiceNo=#{entity.redInvoiceNo}
        and invoiceOrAgreementNo=#{entity.invoiceOrAgreementNo}
    </select>
    <update id="updateRedEntity">
        update t_dx_red_invoice_list with(rowlock) set venderid=#{entity.venderid},
        venderName=#{entity.venderName},
        redType=#{entity.redType}
        where convert(varchar(100),redInvoiceDate,23)=#{entity.redInvoiceDate}
        and redAmount=#{entity.redAmount}
        and redInvoiceNo=#{entity.redInvoiceNo}
        and invoiceOrAgreementNo=#{entity.invoiceOrAgreementNo}
    </update>
</mapper>