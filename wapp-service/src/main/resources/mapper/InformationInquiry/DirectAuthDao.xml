<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.InformationInquiry.dao.DirectAuthDao">
    <select id="queryList" resultType="com.xforceplus.wapp.modules.report.entity.ComprehensiveInvoiceQueryEntity">
        <if test="map.offset != null and map.limit != null">
            SELECT
            TOP (#{map.limit}) P.*
            FROM
            (
            SELECT
            row_number () OVER (ORDER BY id desc) AS rownumber, o.*
            FROM
            (
        </if>
        select
        a.id id,
        a.invoice_type invoiceType,
        a.invoice_code invoiceCode,
        a.invoice_no invoiceNo,
        a.invoice_date invoiceDate,
        a.gf_tax_no gfTaxNo,
        a.gf_name gfName,
        a.xf_tax_no xfTaxNo,
        a.xf_name xfName,
        a.invoice_amount invoiceAmount,
        a.tax_amount taxAmount,
        a.total_amount totalAmount,
        a.tax_rate taxRate,
        a.venderid venderId,
        a.company_code companyCode,
        a.qs_date,
        a.jvcode jvCode
        from t_dx_record_invoice a WITH(NOLOCK) join t_dx_invoice b WITH(NOLOCK)
        on a.uuid=b.uuid and a.invoice_amount=b.invoice_amount
        and convert(varchar(10),a.invoice_date,23)=convert(varchar(10),b.invoice_date,23)
        where b.qs_status='1' and b.flow_type='7' and isnull(confirm_status,'0')!='1'
        and a.invoice_type = '01' and (b.isdel='0' or b.isdel is null)
        <if test="map.jvcode != null and map.jvcode != '-1'">and a.gf_tax_no in (select taxno from t_ac_org WITH(NOLOCK) where
            orgcode =#{map.jvcode})
        </if>
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and a.
            invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
        </if>
        <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
            <![CDATA[ AND convert(varchar(100),a.invoice_date,23) >= #{map.invoiceDate1} ]]>
        </if>
        <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
            <![CDATA[ AND convert(varchar(100),a.invoice_date,23) <= #{map.invoiceDate2} ]]>
        </if>
        <if test="map.qsDate1 != null and map.qsDate1 != ''">
            <![CDATA[ AND convert(varchar(100),a.qs_date,23) >= #{map.qsDate1} ]]>
        </if>
        <if test="map.qsDate2 != null and map.qsDate2 != ''">
            <![CDATA[ AND convert(varchar(100),a.qs_date,23) <= #{map.qsDate2} ]]>
        </if>
        <if test="map.offset != null and map.limit != null">
            )
            AS o
            ) P
            WHERE
            rownumber >#{map.offset}
        </if>
    </select>

    <select id="queryCount" resultType="int">
        select
        count(1)
        from t_dx_record_invoice a WITH(NOLOCK) join t_dx_invoice b WITH(NOLOCK)
        on a.uuid=b.uuid and a.invoice_amount=b.invoice_amount
        and convert(varchar(10),a.invoice_date,23)=convert(varchar(10),b.invoice_date,23)
        where b.qs_status='1' and b.flow_type='7' and isnull(confirm_status,'0')!='1'
        and a.invoice_type = '01' and (b.isdel='0' or b.isdel is null)
        <if test="map.jvcode != null and map.jvcode != '-1'">
            and a.gf_tax_no in (select taxno from t_ac_org WITH(NOLOCK) where orgcode =#{map.jvcode})
        </if>
        <if test="map.invoiceNo != null and map.invoiceNo != ''">
            and a.invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
        </if>
        <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
            <![CDATA[ AND convert(varchar(100),a.invoice_date,23) >= #{map.invoiceDate1} ]]>
        </if>
        <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
            <![CDATA[ AND convert(varchar(100),a.invoice_date,23) <= #{map.invoiceDate2} ]]>
        </if>
        <if test="map.qsDate1 != null and map.qsDate1 != ''">
            <![CDATA[ AND convert(varchar(100),a.qs_date,23) >= #{map.qsDate1} ]]>
        </if>
        <if test="map.qsDate2 != null and map.qsDate2 != ''">
            <![CDATA[ AND convert(varchar(100),a.qs_date,23) <= #{map.qsDate2} ]]>
        </if>
    </select>

    <update id="updateRecordInvoice" parameterType="com.xforceplus.wapp.modules.InformationInquiry.entity.ConfirmInvoiceEntity">
        update t_dx_record_invoice WITH(ROWLOCK) set
        scan_match_status='1',
        qs_status='1',
        qs_date=GETDATE(),
        confirm_status='1',
        confirm_user_id=#{confirmUserId},
        flow_type=b.flow_type
        from t_dx_record_invoice a WITH(ROWLOCK) join t_dx_invoice b WITH(ROWLOCK)
        on a.invoice_code=b.invoice_code and a.invoice_no=b.invoice_no
        where a.invoice_code=#{invoiceCode} and a.invoice_no=#{invoiceNo}
    </update>

    <update id="updateInvoice" parameterType="com.xforceplus.wapp.modules.InformationInquiry.entity.ConfirmInvoiceEntity">
        update t_dx_invoice WITH(ROWLOCK) set
        qs_status='1',
        qs_date=GETDATE(),
        notes=N'签收成功',
        gf_tax_no=b.gf_tax_no,
        gf_name=b.gf_name,
        xf_tax_no=b.xf_tax_no,
        xf_name=b.xf_name,
        invoice_amount=b.invoice_amount,
        tax_amount=b.tax_amount,
        total_amount=b.total_amount,
        invoice_date=b.invoice_date
         from t_dx_invoice a WITH(ROWLOCK) join t_dx_record_invoice b WITH(ROWLOCK)
        on a.invoice_code=b.invoice_code and a.invoice_no=b.invoice_no
        where a.invoice_code=#{invoiceCode} and a.invoice_no=#{invoiceNo}
    </update>

</mapper>