<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xforceplus.wapp.modules.InformationInquiry.dao.QuestionnaireDao">
    <!--查询例外报告信息-->
    <select id="questionnairelist" resultType="com.xforceplus.wapp.modules.InformationInquiry.entity.QuestionnaireEntity">
        SELECT
        <if test=" map.limit != null">
            TOP (#{map.limit})
        </if>
        A.*
        FROM
        (
        SELECT
        row_number () OVER (ORDER BY id asc) AS rownumber ,o.*
        FROM
        (
        SELECT
        a.id,
        a.datet                            dateT,
        a.input_user                       inputUser,
        a.jv                               jV,
        a.vendor_no                        vendorNo,
        a.inv_no                           invNo,
        a.invoice_cost                     InvoiceCost,
        a.wm_cost                          wMCost,
        a.batch_id                         batchID,
        a.po_no                            pONo,
        a.trans                            trans,
        a.rece                             rece,
        a.errcode                          errCode,
        a.errdesc                          errDesc,
        a.errstatus                        errStatus,
        a.isdel                            isDel,
        a.isdel                            isDelB,
        a.tax_amount                       taxAmount,
        a.tax_rate                         taxRate,
        a.tax_type                          taxType,
        invoice_date                        invoiceDate,
        del_date                             delDate
        FROM
        t_dx_submit_qutstanding_report a WITH(NOLOCK)
        <where>
            1=1
            <if test="map.jV != null and map.jV != '' and map.jV != '-1'">
                and a.jv = #{map.jV}
            </if>
            <if test="map.batchId != null and map.batchId != ''">
                and a.batch_id = #{map.batchId}
            </if>
            <if test="map.vendorNo != null and map.vendorNo != ''">
                and a.vendor_no like concat('%',concat(#{map.vendorNo},'%'))
            </if>
            <if test="map.invNo != null and map.invNo != ''">
                and a.inv_no like concat('%',concat(#{map.invNo},'%'))
            </if>
            <if test="map.isDel != null and map.isDel != '-1'">
                and a.isdel = #{map.isDel}
            </if>
            <if test="map.billtype == 'cp'">
                and a.inv_no is not null and a.inv_no !=''
            </if>
         <!--   <if test="map.isDel == 1">
                and s.isdel = #{map.isDel}
            </if>
            <if test="map.isDel == 2 or map.isDel == 0">
                and a.isdel = #{map.isDel}
            </if>-->
            <if test="map.errDesc != null and map.errDesc != ''">
                and a.errcode like concat('%',concat(#{map.errDesc},'%'))
            </if>
            <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
                <![CDATA[ AND convert(varchar(100),a.datet,23) >= #{map.invoiceDate1} ]]>
            </if>
            <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
                <![CDATA[ AND convert(varchar(100),a.datet,23)  <= #{map.invoiceDate2} ]]>
            </if>
        </where>
        ) AS o
        ) A
        WHERE 1=1
        <if test="map.offset != null ">
            and   rownumber > #{map.offset}
        </if>
    </select>

    <!--查询订单信息条数-->
    <select id="questionnairelistCount" resultType="Integer">
        select count(1)
        FROM
        t_dx_submit_qutstanding_report a WITH(NOLOCK)
        where
        1=1
        <if test="map.jV != null and map.jV != '' and map.jV != '-1'">
            and a.jv = #{map.jV}
        </if>
        <if test="map.batchId != null and map.batchId != ''">
            and a.batch_id = #{map.batchId}
        </if>
        <if test="map.vendorNo != null and map.vendorNo != ''">
            and a.vendor_no like concat('%',concat(#{map.vendorNo},'%'))
        </if>
        <if test="map.invNo != null and map.invNo != ''">
            and a.inv_no like concat('%',concat(#{map.invNo},'%'))
        </if>
        <if test="map.isDel != null and map.isDel != '-1'">
            and a.isdel = #{map.isDel}
        </if>
        <if test="map.billtype == 'cp'">
            and a.inv_no is not null and a.inv_no !=''
        </if>
        <!--<if test="map.isDel == 1">
            and s.isdel = #{map.isDel}
        </if>
        <if test="map.isDel == 2 or map.isDel == 0">
            and a.isdel = #{map.isDel}
        </if>-->
        <if test="map.errDesc != null and map.errDesc != ''">
            and a.errcode like concat('%',concat(#{map.errDesc},'%'))
        </if>
        <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
            <![CDATA[ AND convert(varchar(100),a.datet,23) >= #{map.invoiceDate1} ]]>
        </if>
        <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
            <![CDATA[ AND convert(varchar(100),a.datet,23)  <= #{map.invoiceDate2} ]]>
        </if>
    </select>
    <insert id="saveInvoice">
        INSERT INTO t_dx_submit_qutstanding_report WITH(ROWLOCK) (
        isdel                            ,
        datet                            ,
        input_user                       ,
        jv                               ,
        vendor_no                        ,
        inv_no                           ,
        invoice_cost                     ,
        wm_cost                          ,
        batch_id                         ,
        po_no                            ,
        trans                            ,
        rece                             ,
        errcode                          ,
        errdesc                          ,
        errstatus

        ) VALUES (
        #{map.isDel},
        #{map.dateT},
        #{map.inputUser},
        #{map.jV},
        #{map.vendorNo},
        #{map.invNo},
        #{map.invoiceCost},
        #{map.wMCost},
        #{map.batchID},
        #{map.pONo},
        #{map.trans},
        #{map.rece},
        #{map.errCode},
        #{map.errDesc},
        #{map.errStatus}
        )
    </insert>

    <select id="questionnairelistAll" resultType="com.xforceplus.wapp.modules.InformationInquiry.entity.QuestionnaireEntity">
        SELECT
        a.id,
        a.datet                            dateT,
        a.input_user                       inputUser,
        a.jv                               jV,
        a.vendor_no                        vendorNo,
        a.inv_no                           invNo,
        a.invoice_cost                     InvoiceCost,
        a.wm_cost                          wMCost,
        a.batch_id                         batchID,
        a.po_no                            pONo,
        a.trans                            trans,
        a.rece                             rece,
        a.errcode                          errCode,
        a.errdesc                          errDesc,
        a.invoice_date                     invoiceDate,
        a.errstatus                        errStatus,
        a.isdel                            isDel,
        a.tax_amount                       taxAmount,
        a.tax_rate                         taxRate,
        a.tax_type                          taxType

        FROM
        t_dx_submit_qutstanding_report a WITH(NOLOCK) LEFT  JOIN t_dx_invoice s WITH(NOLOCK) on
        a.inv_no= s.invoice_no
        AND  a.vendor_no= s.venderid
        AND  a.invoice_date= s.invoice_date
        <where>
            <if test="map.jV != null and map.jV != '' and map.jV != '-1'">
                and a.jv = #{map.jV}
            </if>
            <if test="map.batchId != null and map.batchId != ''">
                and a.batch_id = #{map.batchId}
            </if>
            <if test="map.vendorNo != null and map.vendorNo != ''">
                and a.vendor_no like concat('%',concat(#{map.vendorNo},'%'))
            </if>
            <if test="map.invNo != null and map.invNo != ''">
                and a.inv_no like concat('%',concat(#{map.invNo},'%'))
            </if>
            <if test="map.isDel != null and map.isDel != '-1'">
                and a.isdel = #{map.isDel}
            </if>
            <!--<if test="map.isDel == 1">-->
                <!--and s.isdel = #{map.isDel}-->
            <!--</if>-->
            <!--<if test="map.isDel == 2 or map.isDel == 0">-->
                <!--and a.isdel = #{map.isDel}-->
            <!--</if>-->
            <if test="map.errDesc != null and map.errDesc != ''">
                and a.errcode like concat('%',concat(#{map.errDesc},'%'))
            </if>
            <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
                <![CDATA[ AND convert(varchar(100),a.datet,23) >= #{map.invoiceDate1} ]]>
            </if>
            <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
                <![CDATA[ AND convert(varchar(100),a.datet,23)  <= #{map.invoiceDate2} ]]>
            </if>
        </where>
        ORDER BY a.id asc
    </select>


    <update id="questionnaireUpdate">
        update t_dx_submit_qutstanding_report WITH(ROWLOCK)
        set
        isdel  =     #{map.isDel},
        del_date = GETDATE(),
        input_user = #{map.inputUser},
        errcode  =  #{map.errCode},
        errdesc  =  #{map.errDesc},
        errstatus  =  #{map.errStatus}
        where id = #{map.ids}
    </update>


    <update id="inputrefundyesno">

        update t_dx_invoice WITH(ROWLOCK)
        set
        isdel = '1',
        del_date = GETDATE(),
        refund_reason = #{errStatus}
        where
        invoice_no =#{invNo}
        and venderid =#{vendorNo}
        <if test="invoiceDate != null and invoiceDate != ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23) >= #{invoiceDate} ]]>
        </if>
        <if test="invoiceCost != null and invoiceCost != ''">
           and total_amount=#{invoiceCost}
        </if>

    </update>
    <!--撤销退票-->
    <update id="cancelTheRefund">

        update t_dx_invoice WITH(ROWLOCK)
        set
        isdel = '0',
        del_date = GETDATE(),
        refund_reason = ''
        where
        invoice_no =#{invNo}  and
        venderid =#{vendorNo}
        <if test="invoiceDate != null and invoiceDate != ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23) >= #{invoiceDate} ]]>
        </if>
        <if test="invoiceCost != null and invoiceCost != ''">
            and total_amount=#{invoiceCost}
        </if>
    </update>

    <select id="queryuuid" resultType="com.xforceplus.wapp.modules.InformationInquiry.entity.QuestionnaireEntity">
        select
        inv_no  invNo,
        vendor_no   vendorNo,
        invoice_date  invoiceDate,
        errdesc   errStatus,
        errdesc   errDesc,
        invoice_cost invoiceCost
        from t_dx_submit_qutstanding_report WITH(NOLOCK)  where id = #{id}


    </select>
    <!--&lt;!&ndash;查询uuid&ndash;&gt;-->
    <!--<select id="queryuuids" resultType="com.xforceplus.wapp.modules.InformationInquiry.entity.QuestionnaireEntity">-->
        <!--select-->
        <!--uuid-->
        <!--from t_dx_invoice WITH(NOLOCK)-->
        <!--where id in (-->
        <!--select  code  from t_dx_match_po_claim_invoice-->
        <!--where code_type = '0' and matchid in(-->
        <!--select id from  t_dx_match WITH(NOLOCK)-->
        <!--where id =  #{id}-->
        <!--)-->
        <!--)-->
    <!--</select>-->
    <update id="queryuuids">

        update t_dx_submit_qutstanding_report WITH(ROWLOCK)
        set
        isdel = '1',
        del_date= GETDATE()
        where
        inv_no =#{invNo}  and
        vendor_no =#{vendorNo}
        <if test="invoiceDate != null and invoiceDate != ''">
            and invoice_date = #{invoiceDate}
        </if>
    </update>
    <!--撤销退票状态-->
    <update id="cancelQueryuuids">

        update t_dx_submit_qutstanding_report WITH(ROWLOCK)
        set
        isdel = '0',
        del_date= GETDATE()
        where
        inv_no =#{invNo}  and
        vendor_no =#{vendorNo}
        <if test="invoiceDate != null and invoiceDate != ''">
            and invoice_date = #{invoiceDate}
        </if>
    </update>

    <update id="xqueryuuids">

        update t_dx_submit_qutstanding_report WITH(ROWLOCK)
        set
        isdel = '2',
        del_date = GETDATE()
        where
        id = #{id}

    </update>
    <!--撤销处理-->
    <update id="cancelTheProcess">

        update t_dx_submit_qutstanding_report WITH(ROWLOCK)
        set
        isdel = '0',
        del_date = GETDATE()
        where
        id = #{id}

    </update>
    <!--需重匹-->
    <update id="xqueryuuidss">

        update t_dx_submit_qutstanding_report WITH(ROWLOCK)
        set
        isdel = '3',
        del_date = GETDATE()
        where
        id = #{id}

    </update>
    <!--撤销需重匹-->
    <update id="cancelTheProcesss">

        update t_dx_submit_qutstanding_report WITH(ROWLOCK)
        set
        isdel = '0',
        del_date = GETDATE()
        where
        id = #{id}

    </update>
    <select id="queryMatchno" resultType="java.lang.String">
        select matchno from t_dx_record_invoice WITH(NOLOCK)  where uuid = #{uuid}
    </select>

    <update id="updateIsDel">
        update t_dx_match WITH(ROWLOCK)
        set
        isdel = #{isdel}
        where
        matchno = #{matchno}
    </update>

    <select id="getUuId" resultType="java.lang.String">
        select top 1 uuid from t_dx_invoice WITH(NOLOCK)
        where
        invoice_no =#{invNo}  and
        venderid =#{vendorNo}
        <if test="invoiceDate != null and invoiceDate != ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23) >= #{invoiceDate} ]]>
        </if>
        <if test="invoiceCost != null and invoiceCost != ''">
            and total_amount=#{invoiceCost}
        </if>
    </select>
    <update id="invoiceCl">
        update t_dx_invoice WITH(ROWLOCK)
        set
        isdel = '0'
        where
        invoice_no =#{invNo}
        and venderid =#{vendorNo}
        <if test="invoiceDate != null and invoiceDate != ''">
            <![CDATA[ AND convert(varchar(100),invoice_date,23) >= #{invoiceDate} ]]>
        </if>
        <if test="invoiceCost != null and invoiceCost != ''">
            and total_amount=#{invoiceCost}
        </if>

    </update>


    <select id="getBatchId" resultType="java.lang.String">
        select batch_id from t_dx_submit_qutstanding_report with(nolock)
        where
        id = #{id}
    </select>
</mapper>