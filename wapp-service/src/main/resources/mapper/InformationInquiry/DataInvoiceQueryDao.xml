<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xforceplus.wapp.modules.InformationInquiry.dao.DataInvoiceQueryDao">

    <resultMap id="gfoptionMap" type="com.xforceplus.wapp.modules.report.entity.GfOptionEntity">
        <result column="taxno" property="value" />
        <result column="taxname" property="label"/>
    </resultMap>

    <!--查询发票匹配处理状态报告信息-->
    <select id="matchlist" resultType="com.xforceplus.wapp.modules.InformationInquiry.entity.MatchEntity">
        SELECT
        <if test=" map.limit != null">
            TOP (#{map.limit})
        </if>
        A.*
        FROM
        (
        SELECT
        row_number () OVER (ORDER BY o.createDate DESC ) AS rownumber ,o.*
        FROM
        (
        select
        m.id,
        m.venderid         venderId,
        m.matchno          matchNo,
        u.invoice_no       invoiceNo,--发票号码
        u.tax_amount       taxAmount,--税额
        u.total_amount     totalAmount,--价税合计
        u.create_date      createDate,--录入时间
        u.gf_name          gfName,--购方名称
        m.settlementamount settlemenTamount
        from t_dx_match m WITH(NOLOCK)
        left join t_dx_record_invoice u WITH(NOLOCK) on m.matchno=u.matchno
        <where>
            <if test="map.venderId != null and map.venderId != ''">
                and m.venderid like concat('%',concat(#{map.venderId},'%'))
            </if>
            <if test="map.xfName != null and map.xfName != ''">
                and m.xf_name like concat('%',concat(#{map.xfName},'%'))
            </if>
            <if test="map.invoiceNo != null and map.invoiceNo != ''">
                and u.invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
            </if>
            <if test="map.matchNo != null and map.matchNo != ''">
                and m.matchno like concat('%',concat(#{map.matchNo},'%'))
            </if>
            <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
                <![CDATA[ AND convert(varchar(100),m.match_date,23) >= #{map.invoiceDate1} ]]>
            </if>
            <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
                <![CDATA[ AND convert(varchar(10),m.match_date,23)  <= #{map.invoiceDate2} ]]>
            </if>
        </where>
        ) AS o
        ) A
        WHERE 1=1
        <if test="map.offset != null ">
            and   rownumber > #{map.offset}
        </if>
    </select>

    <!--查询发票匹配处理状态报告信息条数-->
    <select id="matchlistCount" resultType="Integer">
        select count(1)
        from t_dx_match m WITH(NOLOCK)
        left join t_dx_record_invoice u WITH(NOLOCK) on m.matchno=u.matchno
        <where>
            <if test="map.invoiceNo != null and map.invoiceNo != ''">
                and u.invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
            </if>
            <if test="map.matchNo != null and map.matchNo != ''">
                and m.matchno like concat('%',concat(#{map.matchNo},'%'))
            </if>
            <if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
                <![CDATA[ AND convert(varchar(100),m.match_date,23) >= #{map.invoiceDate1} ]]>
            </if>
            <if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
                <![CDATA[ AND convert(varchar(10),m.match_date,23)  <= #{map.invoiceDate2} ]]>
            </if>
        </where>
    </select>

    <select id="searchGf" resultMap="gfoptionMap">
        select taxno, orgname taxname,orgcode orgCode from t_ac_org WITH(NOLOCK) where orgtype=5
    </select>

</mapper>