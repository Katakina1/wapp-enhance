<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.monitearly.dao.DefinitiveStrideYearCopDao">
    <resultMap id="reportStatisticsMap" type="com.xforceplus.wapp.modules.report.entity.ReportStatisticsEntity">
        <result column="totalCount" property="totalCount" />
        <result column="totalAmount" property="totalAmount" />
        <result column="totalTax" property="totalTax" />
    </resultMap>
    <!-- 自定义底账表结果集映射-->
    <resultMap id="RecordInvoiceMap" type="com.xforceplus.wapp.modules.monitearly.entity.RecordInvoiceEntity" >
        <id property="uuid" column="uuid"></id>
        <result property="qsDate" column="qs_date"/>
        <result property="invoiceType" column="invoice_type"/>
        <result property="invoiceCode" column="invoice_code"/>
        <result property="invoiceNo" column="invoice_no"/>
        <result property="invoiceDate" column="invoice_date"/>
        <result property="invoiceStatus" column="invoice_status"/>
        <result property="gfName" column="gf_name"/>
        <result property="xfName" column="xf_name"/>
        <result property="taxAmount" column="amount"/>
        <result property="invoiceAmount" column="invoiceamount"/>
    </resultMap>
    <!--多条件查询普票跨年度预警-->
    <select id="queryDefinitiveList"  resultMap="RecordInvoiceMap">
        /**mycat:schema=${schemaLabel}*/SELECT id,uuid,invoice_type,qs_date,invoice_code,invoice_no,invoice_date,gf_name,xf_name,
      FORMAT(invoice_amount,2) AS invoiceamount,FORMAT(tax_amount,2) AS amount from t_dx_record_invoice AS t WITH(NOLOCK)
      WHERE t.qs_status=1 and invoice_type IN('04','10','11','14')
      <if test="invoiceNo !=null and invoiceNo !='' ">
          AND invoice_no LIKE CONCAT('%',#{invoiceNo},'%')
      </if>
      <if test="gfTaxNo !='' and gfTaxNo!=null ">
            AND t.gf_tax_no = #{gfTaxNo}
      </if>
      <if test="gfTaxNo =='' or gfTaxNo ==null">
            AND t.gf_tax_no IN (SELECT taxno from t_ac_user_taxno as t,t_ac_org as o WITH(NOLOCK) WHERE t.userid=#{userId}
            and o.orgid = t.orgid)
      </if>
        <!--开票日期的限定 -->
      <if test="billingDate1 != null and billingDate1 != ''">
            <![CDATA[ AND date_format(invoice_date,'%Y-%m-%d') >= #{billingDate1} ]]>
      </if>
      <if test="billingDate2 != null and billingDate2 != ''">
            <![CDATA[ AND date_format(invoice_date,'%Y-%m-%d')  <= #{billingDate2} ]]>
      </if>
        <!--签收日期的限定 -->
        <if test="signForDate1 != null and signForDate1 != ''">
            <![CDATA[ AND date_format(qs_date,'%Y-%m-%d') >= #{signForDate1} ]]>
        </if>
        <if test="signForDate2 != null and signForDate2 != ''">
            <![CDATA[ AND date_format(qs_date,'%Y-%m-%d')  <= #{signForDate2} ]]>
        </if>
        order by qs_date desc
      <if test="offset != null and limit != null ">
            limit #{offset}, #{limit}
      </if>
    </select>
    <!--多条件查询普票跨年度预警数量 -->
    <select id="queryDefinitiveNumber" resultMap="reportStatisticsMap">
        /**mycat:schema=${schemaLabel}*/SELECT count(1) totalCount, ifnull(sum(invoice_amount), 0) totalAmount, ifnull(sum(tax_amount), 0) totalTax from t_dx_record_invoice AS t WITH(NOLOCK)
        WHERE t.qs_status=1 and invoice_type IN('04','10','11','14')
        <if test="invoiceNo !=null and invoiceNo !='' ">
            AND invoice_no LIKE CONCAT('%',#{invoiceNo},'%')
        </if>
        <if test="gfTaxNo !='' and gfTaxNo!=null ">
            AND t.gf_tax_no = #{gfTaxNo}
        </if>
        <if test="gfTaxNo =='' or gfTaxNo ==null">
            AND t.gf_tax_no IN (SELECT taxno from t_ac_user_taxno as t,t_ac_org as o WITH(NOLOCK) WHERE t.userid=#{userId}
            and o.orgid = t.orgid)
        </if>
        <!--开票日期的限定 -->
        <if test="billingDate1 != null and billingDate1 != ''">
            <![CDATA[ AND date_format(invoice_date,'%Y-%m-%d') >= #{billingDate1} ]]>
        </if>
        <if test="billingDate2 != null and billingDate2 != ''">
            <![CDATA[ AND date_format(invoice_date,'%Y-%m-%d')  <= #{billingDate2} ]]>
        </if>
        <!--签收日期的限定 -->
        <if test="signForDate1 != null and signForDate1 != ''">
            <![CDATA[ AND date_format(qs_date,'%Y-%m-%d') >= #{signForDate1} ]]>
        </if>
        <if test="signForDate2 != null and signForDate2 != ''">
            <![CDATA[ AND date_format(qs_date,'%Y-%m-%d')  <= #{signForDate2} ]]>
        </if>
    </select>

    <!--用于导出-->
    <select id="queryDefinitiveInfoList" resultMap="RecordInvoiceMap" >
        /**mycat:schema=${schemaLabel}*/SELECT invoice_type,qs_date,invoice_code,invoice_no,invoice_date,gf_name,xf_name,
        FORMAT(invoice_amount,2) AS invoiceamount,FORMAT(tax_amount,2) AS amount from t_dx_record_invoice AS t WITH(NOLOCK)
        WHERE t.qs_status=1 and invoice_type IN('04','10','11','14')
        <if test="invoiceNo !=null and invoiceNo !='' ">
            AND invoice_no LIKE CONCAT('%',#{invoiceNo},'%')
        </if>
        <if test="gfTaxNo !='' and gfTaxNo!=null ">
            AND t.gf_tax_no = #{gfTaxNo}
        </if>
        <if test="gfTaxNo =='' or gfTaxNo ==null">
            AND t.gf_tax_no IN (SELECT taxno from t_ac_user_taxno as t,t_ac_org as o WITH(NOLOCK) WHERE t.userid=#{userId}
            and o.orgid = t.orgid)
        </if>
        <!--开票日期的限定 -->
        <if test="billingDate1 != null and billingDate1 != ''">
            <![CDATA[ AND date_format(invoice_date,'%Y-%m-%d') >= #{billingDate1} ]]>
        </if>
        <if test="billingDate2 != null and billingDate2 != ''">
            <![CDATA[ AND date_format(invoice_date,'%Y-%m-%d')  <= #{billingDate2} ]]>
        </if>
        <!--签收日期的限定 -->
        <if test="signForDate1 != null and signForDate1 != ''">
            <![CDATA[ AND date_format(qs_date,'%Y-%m-%d') >= #{signForDate1} ]]>
        </if>
        <if test="signForDate2 != null and signForDate2 != ''">
            <![CDATA[ AND date_format(qs_date,'%Y-%m-%d')  <= #{signForDate2} ]]>
        </if>
        order by qs_date desc
    </select>
</mapper>

