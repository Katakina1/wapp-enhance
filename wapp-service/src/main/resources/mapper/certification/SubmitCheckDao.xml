<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.certification.dao.SubmitCheckDao">

	<resultMap id="reportStatisticsMap" type="com.xforceplus.wapp.modules.report.entity.ReportStatisticsEntity">
		<result column="totalCount" property="totalCount" />
		<result column="totalAmount" property="totalAmount" />
		<result column="totalTax" property="totalTax" />
	</resultMap>

	<select id="queryTotal" resultMap="reportStatisticsMap" >
		/**mycat:schema=${schemaLabel}*/
		select
		count(1) totalCount, isnull(sum(invoice_amount), 0) totalAmount, isnull(sum(tax_amount),0 ) totalTax
 		from t_dx_record_invoice t WITH(NOLOCK)
 		where 1=1
		<!--AND gf_tax_no in (SELECT taxno FROM t_ac_org WITH(NOLOCK) where orgid in(SELECT orgid FROM t_ac_user_taxno where userid=#{map.userId})-->
		<if test="map.companyCode != null and map.companyCode != ''">
			and company_code =#{map.companyCode}
		</if>
		<if test="map.invoiceNo != null and map.invoiceNo != ''">
			and invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
		</if>
		<if test="map.invoiceType !=null and map.invoiceType != '-1'">
			and invoice_type = #{map.invoiceType}
		</if>
		<if test="map.gfName != null and map.gfName != '-1'and  map.gfName != ''">
			and jvcode = #{map.gfName}
		</if>
		<if test="map.xfName != null and map.xfName != ''">
			and xf_name like concat('%',concat(#{map.xfName},'%'))
		</if>
		<if test="map.gxDate1 != null and map.gxDate1 != ''">
			<![CDATA[ AND CONVERT(varchar(100),gx_date, 23) >= #{map.gxDate1} ]]>
		</if>
		<if test="map.gxDate2 != null and map.gxDate2 != ''">
			<![CDATA[ AND CONVERT(varchar(100),gx_date, 23) <= #{map.gxDate2} ]]>
		</if>
		<if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
			<![CDATA[ AND CONVERT(varchar(100),invoice_date, 23) >= #{map.invoiceDate1} ]]>
		</if>
		<if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
			<![CDATA[ AND CONVERT(varchar(100),invoice_date, 23)  <= #{map.invoiceDate2} ]]>
		</if>
		and invoice_type IN ('01', '04')
		AND (SELECT c.current_tax_period FROM t_dx_tax_current c WHERE c.taxno=t.gf_tax_no)>= SUBSTRING(CONVERT(varchar(12) , getdate(), 112 ),0,7)
		and rzh_yesorno=0
		and invoice_status=0
		and invoice_amount>0
		and invoice_date >= '2017-01-01 00:00:00'
		and tax_amount>=0
		and auth_status=1
	</select>

	<select id="queryList" resultType="com.xforceplus.wapp.modules.certification.entity.InvoiceCertificationEntity" >
		/**mycat:schema=${schemaLabel}*/
		SELECT
		<if test=" map.limit != null">
			TOP (#{map.limit})
		</if>
		A.*
		FROM
		(
		SELECT
		row_number () OVER (ORDER BY o.gxDate DESC) AS rownumber ,o.*
		FROM
		(select
		id 				 ,
		gx_date 		 gxDate,
		invoice_code 	 invoiceCode,
		invoice_type     invoiceType,
		invoice_no 		 invoiceNo,
		invoice_date	 invoiceDate,
		gf_name 		 gfName,
		xf_name 		 xfName,
		invoice_amount   invoiceAmount,
		tax_amount 		 taxAmount,
		qs_status 		 qsStatus,
		qs_date 		 qsDate,
		qs_type 		 qsType
		from t_dx_record_invoice t WITH(NOLOCK)
		where 1=1
		AND (SELECT c.current_tax_period FROM t_dx_tax_current c WHERE c.taxno=t.gf_tax_no)>= SUBSTRING(CONVERT(varchar(12) , getdate(), 112 ),0,7)
		<!--AND gf_tax_no in (SELECT taxno FROM t_ac_org WITH(NOLOCK) where orgid in(SELECT orgid FROM t_ac_user_taxno where userid=#{map.userId})-->
		<if test="map.companyCode != null and map.companyCode != ''">
			and company_code =#{map.companyCode}
		</if>
		<if test="map.invoiceNo != null and map.invoiceNo != ''">
			and invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
		</if>
		<if test="map.invoiceType !=null and map.invoiceType != '-1'">
			and invoice_type = #{map.invoiceType}
		</if>
		<if test="map.gfName != null and map.gfName != '-1'and  map.gfName != ''">
			and jvcode = #{map.gfName}
		</if>
		<if test="map.xfName != null and map.xfName != ''">
			and xf_name like concat('%',concat(#{map.xfName},'%'))
		</if>
		<if test="map.gxDate1 != null and map.gxDate1 != ''">
			<![CDATA[ AND  CONVERT(varchar(100),gx_date, 23) >= #{map.gxDate1} ]]>
		</if>
		<if test="map.gxDate2 != null and map.gxDate2 != ''">
			<![CDATA[ AND CONVERT(varchar(100),gx_date, 23) <= #{map.gxDate2} ]]>
		</if>
		<if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
			<![CDATA[ AND CONVERT(varchar(100),invoice_date, 23) >= #{map.invoiceDate1} ]]>
		</if>
		<if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
			<![CDATA[ AND CONVERT(varchar(100),invoice_date, 23)  <= #{map.invoiceDate2} ]]>
		</if>
		and rzh_yesorno=0
		and invoice_status=0
		and invoice_amount>0
		and invoice_type in ('01','04')
		and invoice_date >= '2017-01-01 00:00:00'
		and  tax_amount>=0
		and auth_status=1) AS o
		) A
		WHERE
		1=1
		<if test="map.offset != null ">
			and   rownumber > #{map.offset}
		</if>


		<!--select
		id 				 ,
		gx_date 		 gxDate,
    	invoice_code 	 invoiceCode,
		invoice_type     invoiceType,
    	invoice_no 		 invoiceNo,
    	invoice_date	 invoiceDate,
    	gf_name 		 gfName,
    	xf_name 		 xfName,
		invoice_amount   invoiceAmount,
    	tax_amount 		 taxAmount,
		qs_status 		 qsStatus,
		qs_date 		 qsDate,
		qs_type 		 qsType
 		from t_dx_record_invoice t WITH(NOLOCK)
 		where 1=1
		AND (SELECT c.current_tax_period FROM t_dx_tax_current c WHERE c.taxno=t.gf_tax_no)>= SUBSTRING(CONVERT(varchar(12) , getdate(), 112 ),0,7)
		AND gf_tax_no in (SELECT taxno FROM t_ac_org WITH(NOLOCK) where orgid in(SELECT orgid FROM t_ac_user_taxno where userid=#{map.userId}))
		<if test="map.invoiceNo != null and map.invoiceNo != ''">
			and invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
		</if>
		<if test="map.invoiceType !=null and map.invoiceType != '-1'">
			and invoice_type = #{map.invoiceType}
		</if>
		<if test="map.gfName != null and map.gfName != '-1'and  map.gfName != ''">
			and gf_tax_no = #{map.gfName}
		</if>
		<if test="map.xfName != null and map.xfName != ''">
			and xf_name like concat('%',concat(#{map.xfName},'%'))
		</if>
		<if test="map.gxDate1 != null and map.gxDate1 != ''">
			<![CDATA[ AND  CONVERT(varchar(100),gx_date, 23) >= #{map.gxDate1} ]]>
		</if>
		<if test="map.gxDate2 != null and map.gxDate2 != ''">
			<![CDATA[ AND CONVERT(varchar(100),gx_date, 23) <= #{map.gxDate2} ]]>
		</if>
		<if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
			<![CDATA[ AND CONVERT(varchar(100),invoice_date, 23) >= #{map.invoiceDate1} ]]>
		</if>
		<if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
			<![CDATA[ AND CONVERT(varchar(100),invoice_date, 23)  <= #{map.invoiceDate2} ]]>
		</if>
 		and rzh_yesorno=0
		and invoice_status=0
		and invoice_amount>0
		and invoice_type in (01,14,03)
		and IF (
		invoice_date >= '2017-07-01 00:00:00',

		dateadd(day,359,invoice_date)  >= getdate(),

		dateadd(day,179,invoice_date)  >= getdate()
		)
		and  tax_amount>=0
		and auth_status=1
		ORDER BY gx_date DESC
		<if test="map.offset != null and map.limit != null">
			limit #{map.offset}, #{map.limit}
		</if>-->
	</select>


	<update id="submitCheck">
        /**mycat:schema=${schemaLabel}*/
		update t_dx_record_invoice WITH(ROWLOCK) set
		confirm_date=getdate(),
		rzh_belong_date=#{rzhBelongDate},
		confirm_user=#{loginName},
		auth_status=2
		where id = #{id}
	</update>


	<update id="cancelCheck">
		/**mycat:schema=${schemaLabel}*/
		update t_dx_record_invoice WITH(ROWLOCK) set
		gx_date = (null),
		auth_status = 0,
		gx_type = (null),
		gx_user_account='',
		gx_user_name=''
		where id = #{id}
	</update>

</mapper>