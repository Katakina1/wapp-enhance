<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.certification.dao.IntelligentizeCheckDao">
	<select id="queryTotal" resultType="Integer" >
		/**mycat:schema=${schemaLabel}*/
		select
		count(1)
		from t_dx_record_invoice t WITH(NOLOCK)
		where 1=1
		<if test="map.companyCode != null and map.companyCode != ''">
			and company_code =#{map.companyCode}
		</if>
		<if test="map.venderid !=null and map.venderid != ''">
			and venderid = #{map.venderid}
		</if>
		<if test="map.invoiceNo != null and map.invoiceNo != ''">
			and invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
		</if>
		<if test="map.qsStatus !=null and map.qsStatus != '-1'">
			and qs_status = #{map.qsStatus}
		</if>
		<if test="map.qsType !=null and map.qsType != '-1'">
			and qs_type = #{map.qsType}
		</if>
		<if test="map.qsDate1 != null and map.qsDate1 != ''">
			<![CDATA[ AND  CONVERT(varchar(100),qs_date, 23) >= #{map.qsDate1} ]]>
		</if>
		<if test="map.qsDate2 != null and map.qsDate2 != ''">
			<![CDATA[ AND  CONVERT(varchar(100),qs_date, 23)  <= #{map.qsDate2} ]]>
		</if>
		<if test="map.gfName != null and map.gfName != '-1'and  map.gfName != ''">
			and jvcode = #{map.gfName}
		</if>
		<if test="map.xfName != null and map.xfName != ''">
			and xf_name like concat('%',concat(#{map.xfName},'%'))
		</if>
        and ((rzh_yesorno = 0) or(rzh_yesorno is null ))
		and invoice_status=0
		and invoice_amount>0
		AND (SELECT c.current_tax_period FROM t_dx_tax_current c WHERE c.taxno=gf_tax_no)>= SUBSTRING(CONVERT(varchar(12) , invoice_date, 112 ),0,7)
		and invoice_date >= '2017-01-01 00:00:00'
		and scan_match_status ='1'
        and (auth_status in (0,5) or (auth_status is null))
		and invoice_type in('01','08')
		AND scan_match_status = '1'
		AND (
		(
		flow_type = '1'
		AND (
		host_status IN ('11','12','9','14','15','99','999','19')
		OR confirm_status = '1'
		)
		)
		OR (flow_type = '2' and bpms_pay_status = '1')
		OR (flow_type = '6' and fixed_matching ='1')
		OR (flow_type = '7' and confirm_status = '1')
		OR (flow_type = '8' and confirm_status = '1')
		)
	</select>

	<select id="queryList" resultType="com.xforceplus.wapp.modules.certification.entity.InvoiceCertificationEntity" >
		/**mycat:schema=${schemaLabel}*/
		select
		id               ,
    	invoice_code 	 invoiceCode,
    	invoice_no 		 invoiceNo,
    	invoice_date	 invoiceDate,
    	invoice_type	 ,
    	gf_name 		 gfName,
		jvcode           ,
    	xf_name 		 xfName,
		invoice_amount   invoiceAmount,
    	tax_amount 		 taxAmount,
        total_amount 		 ,
		venderid venderid ,
		certificate_no 		 ,
		host_status      ,
		flow_type 		 ,
		company_code
 		from t_dx_record_invoice WITH(NOLOCK)
 		where invoice_type in('01','08')
		<if test="map.companyCode != null and map.companyCode != ''">
			and company_code =#{map.companyCode}
		</if>

        <if test="map.venderid !=null and map.venderid != ''">
				AND venderid =#{map.venderid}
        </if>
		<if test="map.qsStatus !=null and map.qsStatus != '-1'">
			and qs_status = #{map.qsStatus}
		</if>
		<if test="map.qsType !=null and map.qsType != '-1'">
			and qs_type = #{map.qsType}
		</if>
		<if test="map.qsDate1 != null and map.qsDate1 != ''">
			<![CDATA[ AND CONVERT(varchar(100),qs_date, 23)  >= #{map.qsDate1} ]]>
		</if>
		<if test="map.qsDate2 != null and map.qsDate2 != ''">
			<![CDATA[ AND CONVERT(varchar(100),qs_date, 23)  <= #{map.qsDate2} ]]>
		</if>
		<if test="map.gfName != null and map.gfName != '-1' and map.gfName != ''">
			and jvcode = #{map.gfName}
		</if>
		<if test="map.xfName != null and map.xfName != ''">
			and xf_name like concat('%',concat(#{map.xfName},'%'))
		</if>
		<if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
			<![CDATA[ AND CONVERT(varchar(100),invoice_date, 23) >= #{map.invoiceDate1} ]]>
		</if>
		<if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
			<![CDATA[ AND CONVERT(varchar(100),invoice_date, 23)  <= #{map.invoiceDate2} ]]>
		</if>
		AND scan_match_status = '1'
		AND (
		(
		flow_type = '1'
		AND (
		host_status IN ('11','12','9','14','15','99','999','19')
		OR confirm_status = '1'
		)
		)
		OR (flow_type = '2' and bpms_pay_status = '1')
		OR (flow_type = '6' and fixed_matching ='1')
		OR (flow_type = '7' and confirm_status = '1')
		OR (flow_type = '8' and confirm_status = '1')
		)
        and ((rzh_yesorno = 0) or(rzh_yesorno is null ))
		and invoice_status=0
		and invoice_amount>0
		AND (SELECT c.current_tax_period FROM t_dx_tax_current c WHERE c.taxno=gf_tax_no)>= SUBSTRING(CONVERT(varchar(12) , invoice_date, 112 ),0,7)
		and invoice_date >= '2017-01-01 00:00:00'
        and (auth_status in (0,5) or (auth_status is null))
		<if test="map.priorityFiltrate == '-1' ">
			order by invoice_date desc,id,tax_amount
		</if>
		<if test="map.priorityFiltrate == '1' ">
			order by invoice_date asc,id, tax_amount
		</if>
	</select>

	<update id="intelligentizeCheck">
        /**mycat:schema=${schemaLabel}*/
		update t_dx_record_invoice WITH(ROWLOCK) set
		gx_date = getdate(),
		auth_status = 2,
		gx_type = 3,
		confirm_date=getdate(),
        rzh_belong_date=#{rzhBelongDate},
        confirm_user=#{loginName},
		gx_user_account=#{loginName},
		gx_user_name=#{userName}
        where id = #{id}
	</update>

	
	<select id="selectCheck" resultType="com.xforceplus.wapp.modules.certification.entity.InvoiceCertificationEntity" >
		/**mycat:schema=${schemaLabel}*/
		select
		id               ,
		invoice_code 	 invoiceCode,
		invoice_no 		 invoiceNo,
		invoice_type     invoiceType,
		invoice_date	 invoiceDate,
		gf_name 		 gfName,
		xf_name 		 xfName,
		invoice_amount   invoiceAmount,
		tax_amount 		 taxAmount,
		qs_status 		 qsStatus,
		qs_date 		 qsDate,
		host_status,
		jvcode           ,
		flow_type 		 ,
		venderid venderid ,
		certificate_no 		 ,
		company_code 		 ,
		qs_type 		 qsType
		from t_dx_record_invoice WITH(NOLOCK)
		where id=#{id}
	</select>
	<!--获取开关状态-->
	<select id="selectSwitchStatus" resultType="java.lang.String" >
		select
		on_off
		from t_ac_dictdeta_amend
		where dictdeta_no='INVOICE_TAX_STATUS'
	</select>



</mapper>