<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.certification.dao.DkCountDao">
	<resultMap id="reportStatisticsMap" type="com.xforceplus.wapp.modules.report.entity.ReportStatisticsEntity">
		<result column="totalCount" property="totalCount" />
		<result column="totalAmount" property="totalAmount" />
		<result column="totalTax" property="totalTax" />
	</resultMap>

	<select id="queryTotal" resultMap="reportStatisticsMap" >
		select
		count(1) totalCount
		from t_dx_dk_count t left join t_dx_dk_count_detail d
		on t.taxno=d.taxno and t.skssq=d.tj_month left join t_ac_org g on t.taxno=g.taxno
		where (d.invoice_type='99' or d.invoice_type is null) and
		t.taxno in
		(SELECT taxno FROM t_ac_org where orgtype='5')
		<if test="map.skssq != null and map.skssq != '' and map.skssq != 'null' ">
			and t.skssq = #{map.skssq}
		</if>
		<if test="map.gfName != null and map.gfName != '' and map.gfName != 'null' and map.gfName != '-1' ">
			and t.taxno = #{map.gfName}
		</if>
		<if test="map.tjStatus != null and map.tjStatus != '' and map.tjStatus != 'null' and map.tjStatus != '-1' ">
			and t.tj_status = #{map.tjStatus}
		</if>
		<if test="map.qsStatus != null and map.qsStatus != '' and  map.qsStatus != 'null' and map.qsStatus != '-1' ">
			and t.qs_status = #{map.qsStatus}
		</if>
		<if test="map.dkWhetherPassword != null and map.dkWhetherPassword != '' and  map.dkWhetherPassword != 'null' and map.dkWhetherPassword != '-1' ">
			and g.is_mm = #{map.dkWhetherPassword}
		</if>
	</select>
	<select id="queryList" resultType="com.xforceplus.wapp.modules.certification.entity.TDxDkCountEntity" >
        SELECT
        <if test="map.limit != null ">
            TOP (#{map.limit})
        </if>
        A.*
        FROM
        (
        SELECT
        row_number () OVER (ORDER BY o.create_date DESC) AS rownumber ,o.*
        FROM
        (
        select distinct t.id,t.taxno,t.taxname,t.skssq,t.create_date,t.tj_status tjStatus,t.qs_status qsStatus,t.sfdqskssq,
		d.dk_tax_amount_count dksehj,t.cxtj_status cxtjStatus,t.tj_date tjDate ,t.cxqs_status cxqsStatus,t.ywmm dkPassword,g.is_mm dkWhetherPassword
		from t_dx_dk_count t left join t_dx_dk_count_detail d
		on t.taxno=d.taxno and t.skssq=d.tj_month left join t_ac_org g on t.taxno=g.taxno
		where (d.invoice_type='99' or d.invoice_type is null) and
		t.taxno in
		(SELECT taxno FROM t_ac_org where orgtype='5')
		<if test="map.skssq != null and map.skssq != ''.toString() and map.skssq != 'null' ">
			and t.skssq = #{map.skssq}
		</if>
		<if test="map.gfName != null and map.gfName != '' and map.gfName != 'null' and map.gfName != '-1' ">
			and t.taxno = #{map.gfName}
		</if>
		<if test="map.tjStatus != null and map.tjStatus != '' and map.tjStatus != 'null' and map.tjStatus != '-1' ">
			and t.tj_status = #{map.tjStatus}
		</if>
		<if test="map.qsStatus != null and map.qsStatus != '' and  map.qsStatus != 'null' and map.qsStatus != '-1' ">
			and t.qs_status = #{map.qsStatus}
		</if>
		<if test="map.dkWhetherPassword != null and map.dkWhetherPassword != '' and  map.dkWhetherPassword != 'null' and map.dkWhetherPassword != '-1' ">
			and g.is_mm = #{map.dkWhetherPassword}
		</if>
        ) as o
        ) A
        WHERE
        1=1
        <if test="map.offset != null ">
            and   rownumber > #{map.offset}
        </if>
	</select>
	<select id="selectBeforeTj" resultType="java.lang.Integer" >
		select count(1) sl
		from t_dx_record_invoice t WITH(NOLOCK) left join t_dx_tax_current c
		on t.gf_tax_no=c.taxno
		WHERE  t.auth_status in ('2','3')
		and convert(varchar(8),t.invoice_date,112) between c.select_start_date and c.select_end_date
		<if test="map.gfsh != null and map.gfsh != '' and map.gfsh != 'null' ">
			and t.gf_tax_no = #{map.gfsh}
		</if>
	</select>
	<update id="insertDk">
		update t_dx_dk_count set
		apply_status = '0',
		apply_type = '0',
		tj_status = '1',
		cxtj_status='0'
        where taxno = #{gfsh} and skssq=#{skssq}
		
	</update>
	<select id="selectDksh" resultType="com.xforceplus.wapp.modules.certification.entity.TDxDkCountEntity">
		select t.current_tax_period skssq,t.taxno taxno,d.tj_status tjStatus,tj_date tjDate from t_dx_tax_current t,t_dx_dk_count d
		where t.taxno=d.taxno
		and t.current_tax_period=d.skssq
		and t.taxno in
		<foreach collection="gfsh" index="index" item="item" open="(" separator="," close=")">
			#{item}
		</foreach>
	</select>
	<update id="insertConfirm">
		update t_dx_dk_count set
		apply_type='0',
		apply_status = '0',
		qs_status = '1',
		ywmm=#{ywmm}
		where taxno = #{gfsh} and skssq = #{skssq}
	</update>
	<update id="insertCxtj">
		update t_dx_dk_count set
		apply_type='1',
		apply_status='0',
		cxtj_status='1'
		where taxno = #{gfsh} and skssq = #{skssq}

	</update>
	<insert id="insertDkLog">
		insert into t_dx_dk_count_log (taxno,skssq,opera_type,opera_name,create_date)
		values
		<foreach collection="list" item="log" separator="," >
			(
			#{log.taxno},
			#{log.skssq},
			#{log.operaType},
			#{log.operaName},
			#{log.createDate}
			)
		</foreach>
	</insert>
	<select id="checkDksh" resultType="com.xforceplus.wapp.modules.certification.entity.TDxDkCountEntity">
		select t.current_tax_period skssq,t.taxno taxno,d.tj_status tjStatus,tj_date tjDate from t_dx_tax_current t,t_dx_dk_count d
		where t.taxno=d.taxno
		and t.current_tax_period=d.skssq
		and t.taxno in
		(SELECT taxno FROM t_ac_org where orgtype='5')
		<if test="map.gfName!=null and map.gfName!='' and map.gfName!='null' and map.gfName!='-1'">
			and t.taxno=#{map.gfName}
		</if>
	</select>
<select id="selectDkDetail" resultType="com.xforceplus.wapp.modules.certification.entity.TDxDkCountDetail">
	select * from t_dx_dk_count_detail where taxno=#{gfsh} and tj_month=#{skssq} order by invoice_type
</select>
	<select id="selectUpgrad" resultType="com.xforceplus.wapp.modules.job.entity.TAcOrg">
		select * from t_ac_org where taxno = #{gfsh} and orgtype='5'
	</select>

    <update id="insertCxqs">
		update t_dx_dk_count set
		apply_type='1',
		apply_status='0',
		cxqs_status='1'
		where taxno = #{gfsh} and skssq = #{skssq}
	</update>

</mapper>