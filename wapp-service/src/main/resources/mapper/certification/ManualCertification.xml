<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xforceplus.wapp.modules.certification.dao.ManualCertificationDao">

	<resultMap id="reportStatisticsMap" type="com.xforceplus.wapp.modules.report.entity.ReportStatisticsEntity">
		<result column="totalCount" property="totalCount" />
		<result column="totalAmount" property="totalAmount" />
		<result column="totalTax" property="totalTax" />
	</resultMap>

	<select id="queryTotal" resultMap="reportStatisticsMap" >
		/**mycat:schema=${schemaLabel}*/
		select
		count(1) totalCount, isnull(sum(invoiceAmount), 0) totalAmount, isnull(sum(taxAmount), 0) totalTax
		from (
		select
		id,
		invoice_amount   invoiceAmount,
		tax_amount 		 taxAmount,
		total_amount
		from t_dx_record_invoice WITH(NOLOCK)
		where  invoice_type in('01','08')  AND (no_deduction is null or no_deduction ='')
		AND (SELECT c.current_tax_period FROM t_dx_tax_current c WHERE c.taxno=gf_tax_no)>= SUBSTRING(CONVERT(varchar(12) , invoice_date, 112 ),0,7)
		and scan_match_status ='1'
		and source_system !='2'
		AND (
		(
		flow_type = '1'
		AND (
		host_status IN ('11','12','9','14','15','99','999','19')
		OR confirm_status = '1'
		)
		)
		OR (flow_type = '2' and bpms_pay_status = '1')
		OR (flow_type = '6' and fixed_matching ='1')
		OR (flow_type = '7' and confirm_status = '1')
		OR (flow_type = '8' and confirm_status = '1')
		) 
		<if test="map.companyCode != null and map.companyCode != ''">
			and company_code =#{map.companyCode}
		</if>
		<if test="map.venderid != null and map.venderid != ''">
			AND  venderid =  #{map.venderid}
		</if>
		<if test="map.flowType !=null and map.flowType != '-1'">
			and flow_type=#{map.flowType}
		</if>
		<if test="map.invoiceNo != null and map.invoiceNo != ''">
			and invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
		</if>
		<if test="map.qsStatus !=null and map.qsStatus != '-1'">
			and qs_status = #{map.qsStatus}
		</if>
		<if test="map.qsType !=null and map.qsType != '-1'">
			and qs_type = #{map.qsType}
		</if>
		<if test="map.qsDate1 != null and map.qsDate1 != ''">
			<![CDATA[ AND CONVERT(varchar(100),qs_date, 23) >= #{map.qsDate1} ]]>
		</if>
		<if test="map.qsDate2 != null and map.qsDate2 != ''">
			<![CDATA[ AND CONVERT(varchar(100),qs_date, 23) <= #{map.qsDate2} ]]>
		</if>
		<if test="map.gfName != null and map.gfName != '-1'and  map.gfName != ''">
			and jvcode = #{map.gfName}
		</if>
		<if test="map.xfName != null and map.xfName != ''">
			and xf_name like concat('%',concat(#{map.xfName},'%'))
		</if>
		<if test="map.certificateNo != null and map.certificateNo != '-1'and  map.certificateNo != ''">
			and certificate_no = #{map.certificateNo}
		</if>
		<if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
			<![CDATA[ AND CONVERT(varchar(100),invoice_date, 23) >= #{map.invoiceDate1} ]]>
		</if>
		<if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
			<![CDATA[ AND CONVERT(varchar(100),invoice_date, 23)  <= #{map.invoiceDate2} ]]>
		</if>
        and ((rzh_yesorno =0) or(rzh_yesorno is null ))
		and invoice_status=0
		and invoice_amount>0
		and invoice_date >= '2017-01-01 00:00:00'
        and (auth_status in (0,5) or (auth_status is null))
		) as aa
	</select>

	<select id="queryList" resultType="com.xforceplus.wapp.modules.certification.entity.InvoiceCertificationEntity" >
		/**mycat:schema=${schemaLabel}*/
		SELECT
		<if test=" map.limit != null">
			TOP (#{map.limit})
		</if>
		 A.*
		FROM
		(
		SELECT
		row_number () OVER (ORDER BY o.invoiceDate DESC, o.id DESC) AS rownumber ,o.*
		FROM
		(
		select
		id 				 ,
		invoice_type      invoiceType,
		invoice_code 	 invoiceCode,
		invoice_no 		 invoiceNo,
		invoice_date	 invoiceDate,
		gf_name 		 gfName,
		jvcode           ,
		xf_name 		 xfName,
		invoice_amount   invoiceAmount,
		tax_amount 		 taxAmount,
		total_amount 		 ,
		venderid venderid ,
		certificate_no 		 ,
		company_code  companyCode,
		host_status ,
		flow_type 	,
		qs_date 		 qsDate
		from t_dx_record_invoice WITH(NOLOCK)

		where invoice_type in('01','08')  AND (no_deduction is null or no_deduction ='')
		AND (SELECT c.current_tax_period FROM t_dx_tax_current c WHERE c.taxno=gf_tax_no)>= SUBSTRING(CONVERT(varchar(12) , invoice_date, 112 ),0,7)
		and scan_match_status ='1'
		and source_system !='2'
		AND (
		(
		flow_type = '1'
		AND (
		host_status IN ('11','12','9','14','15','99','999','19')
		OR confirm_status = '1'
		)
		)
		OR (flow_type = '2' and bpms_pay_status = '1')
		OR (flow_type = '6' and fixed_matching ='1')
		OR (flow_type = '7' and confirm_status = '1')
		OR (flow_type = '8' and confirm_status = '1')
		)
		<if test="map.companyCode != null and map.companyCode != ''">
		and company_code =#{map.companyCode}
		</if>
		<if test="map.venderid != null and map.venderid != ''">
			AND   venderid = #{map.venderid}
		</if>
		<if test="map.invoiceNo != null and map.invoiceNo != ''">
			and invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
		</if>
		<if test="map.qsStatus !=null and map.qsStatus != '-1'">
			and qs_status = #{map.qsStatus}
		</if>
		<if test="map.flowType !=null and map.flowType != '-1'">
			and flow_type=#{map.flowType}
		</if>
		<if test="map.qsType !=null and map.qsType != '-1'">
			and qs_type = #{map.qsType}
		</if>
		<if test="map.qsDate1 != null and map.qsDate1 != ''">
			<![CDATA[ AND CONVERT(varchar(100),qs_date, 23) >= #{map.qsDate1} ]]>
		</if>
		<if test="map.qsDate2 != null and map.qsDate2 != ''">
			<![CDATA[ AND CONVERT(varchar(100),qs_date, 23) <= #{map.qsDate2} ]]>
		</if>
		<if test="map.gfName != null and map.gfName != '-1'and  map.gfName != ''">
			and jvcode = #{map.gfName}
		</if>
		<if test="map.certificateNo != null and map.certificateNo != '-1'and  map.certificateNo != ''">
			and certificate_no = #{map.certificateNo}
		</if>
		<if test="map.xfName != null and map.xfName != ''">
			and xf_name like concat('%',concat(#{map.xfName},'%'))
		</if>
		<if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
			<![CDATA[ AND CONVERT(varchar(100),invoice_date, 23) >= #{map.invoiceDate1} ]]>
		</if>
		<if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
			<![CDATA[ AND CONVERT(varchar(100),invoice_date, 23)  <= #{map.invoiceDate2} ]]>
		</if>
		and ((rzh_yesorno =0) or(rzh_yesorno is null ))
		and invoice_status=0
		and invoice_amount>0
		and invoice_date >= '2017-01-01 00:00:00'
		and (auth_status in (0,5) or (auth_status is null))
         ) AS o
         ) A
         WHERE 1=1
         <if test="map.offset != null ">
             and   rownumber > #{map.offset}
         </if>
     </select>
     <update id="manualCertification">
         /**mycat:schema=${schemaLabel}*/
         update t_dx_record_invoice WITH(ROWLOCK) set
         gx_type=4,
         auth_status=2,
         confirm_date=getdate(),
         gx_user_account=#{loginName},
         rzh_belong_date=#{rzhBelongDate},
         confirm_user=#{loginName},
         yxse=#{taxAmount}
         where id = #{id}
     </update>
     <select id="getRzhBelongDate" resultType="String">
         /**mycat:schema=${schemaLabel}*/
         select
         (SELECT c.current_tax_period FROM t_dx_tax_current c WHERE c.taxno=t.gf_tax_no) rzhBelongDate
         from t_dx_record_invoice t WITH(NOLOCK)
         where t.id= #{id}
     </select>

     <select id="getCurrentTaxPeriod" resultType="String">
         /**mycat:schema=${schemaLabel}*/
                 select
         (select top 1 current_tax_period FROM t_dx_tax_current where taxno=t.gf_tax_no or old_tax_no=t.gf_tax_no ORDER BY taxno DESC ) rzhBelongDate
         from t_dx_record_invoice t WITH(NOLOCK)
         where t.id= #{id}
     </select>

	<select id="queryExportList" resultType="com.xforceplus.wapp.modules.certification.entity.InvoiceCertificationEntity" >
		/**mycat:schema=${schemaLabel}*/
		SELECT
		<if test=" map.limit != null">
			TOP (#{map.limit})
		</if>
		A.*
		FROM
		(
		SELECT
		row_number () OVER (ORDER BY  o.id DESC) AS rownumber ,o.*
		FROM
		(
		select
		id 				 ,
		invoice_type      invoiceType,
		invoice_code 	 invoiceCode,
		invoice_no 		 invoiceNo,
		invoice_date	 invoiceDate,
		gf_name 		 gfName,
		jvcode           ,
		xf_name 		 xfName,
		invoice_amount   invoiceAmount,
		tax_amount 		 taxAmount,
		total_amount 		 ,
		venderid venderid ,
		certificate_no 		 ,
		company_code  companyCode,
		host_status ,
		flow_type 	,
		qs_date 		 qsDate
		from t_dx_record_invoice WITH(NOLOCK)

		where invoice_type in('01','08')  AND (no_deduction is null or no_deduction ='')
		AND (SELECT c.current_tax_period FROM t_dx_tax_current c WHERE c.taxno=gf_tax_no)>= SUBSTRING(CONVERT(varchar(12) , invoice_date, 112 ),0,7)
		and scan_match_status ='1'
		and source_system !='2'
		AND (
		(
		flow_type = '1'
		AND (
		host_status IN ('11','12','9','14','15','99','999','19')
		OR confirm_status = '1'
		)
		)
		OR (flow_type = '2' and bpms_pay_status = '1')
		OR (flow_type = '6' and fixed_matching ='1')
		OR (flow_type = '7' and confirm_status = '1')
		OR (flow_type = '8' and confirm_status = '1')
		)
		<if test="map.companyCode != null and map.companyCode != ''">
		and company_code =#{map.companyCode}
		</if>
		<if test="map.venderid != null and map.venderid != ''">
			AND   venderid = #{map.venderid}
		</if>
		<if test="map.invoiceNo != null and map.invoiceNo != ''">
			and invoice_no like concat('%',concat(#{map.invoiceNo},'%'))
		</if>
		<if test="map.qsStatus !=null and map.qsStatus != '-1'">
			and qs_status = #{map.qsStatus}
		</if>
		<if test="map.qsType !=null and map.qsType != '-1'">
			and qs_type = #{map.qsType}
		</if>
		<if test="map.qsDate1 != null and map.qsDate1 != ''">
			<![CDATA[ AND CONVERT(varchar(100),qs_date, 23) >= #{map.qsDate1} ]]>
		</if>
		<if test="map.qsDate2 != null and map.qsDate2 != ''">
			<![CDATA[ AND CONVERT(varchar(100),qs_date, 23) <= #{map.qsDate2} ]]>
		</if>
		<if test="map.gfName != null and map.gfName != '-1'and  map.gfName != ''">
			and jvcode = #{map.gfName}
		</if>
		<if test="map.flowType !=null and map.flowType != '-1'">
			and flow_type=#{map.flowType}
		</if>
		<if test="map.xfName != null and map.xfName != ''">
			and xf_name like concat('%',concat(#{map.xfName},'%'))
		</if>
		<if test="map.invoiceDate1 != null and map.invoiceDate1 != ''">
			<![CDATA[ AND CONVERT(varchar(100),invoice_date, 23) >= #{map.invoiceDate1} ]]>
		</if>
		<if test="map.invoiceDate2 != null and map.invoiceDate2 != ''">
			<![CDATA[ AND CONVERT(varchar(100),invoice_date, 23)  <= #{map.invoiceDate2} ]]>
		</if>
		and ((rzh_yesorno =0) or(rzh_yesorno is null ))
		and invoice_status=0
		and invoice_amount>0
		and invoice_date >= '2017-01-01 00:00:00'
		and (auth_status in (0,5) or (auth_status is null))
		) AS o
		) A
		WHERE 1=1
		<if test="map.offset != null ">
			and   rownumber > #{map.offset} ORDER BY id desc
		</if>
     </select>

 </mapper>