<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xforceplus.wapp.modules.invoiceBorrow.dao.InvoiceBorrowDao">


    <select id="getInvoiceBorrowCount" resultType="Integer">

        SELECT COUNT(*)
        FROM t_dx_record_invoice tdri WITH(NOLOCK)
        WHERE 1=1
        <if test="jvCode != null and jvCode != ''">
            AND tdri.jvcode = #{jvCode}
        </if>
        <if test="epsNo != null and epsNo != ''">
            AND tdri.eps_no = #{epsNo}
        </if>
        <if test="companyCode != null and companyCode != ''">
            and tdri.gf_tax_no in (select taxno from t_ac_org WITH(NOLOCK) where company_code = #{companyCode})
        </if>
        <if test="borrowYesOrNo != null and borrowYesOrNo !='' ">
            AND tdri.borrowyesorno = #{borrowYesOrNo}
        </if>
        <if test="gfName != null and gfName != '-1'and  gfName != ''">
            and jvcode = #{gfName}
        </if>
        <if test="venderId != null and venderId != ''">
            AND tdri.venderid = #{venderId}
        </if>
        <if test="createStartDate != null and createStartDate != ''">
            <![CDATA[ AND convert(varchar(100),tdri.packing_date,23) >= #{createStartDate} ]]>
        </if>
        <if test="createEndDate != null and createEndDate != ''">
            <![CDATA[ AND convert(varchar(100),tdri.packing_date,23)  <= #{createEndDate} ]]>
        </if>
        <if test="borrowStartDate != null and borrowStartDate != ''">
            <![CDATA[ AND convert(varchar(100),tdri.borrow_date,23) >= #{borrowStartDate} ]]>
        </if>
        <if test="borrowEndDate != null and borrowEndDate != ''">
            <![CDATA[ AND convert(varchar(100),tdri.borrow_date,23)  <= #{borrowEndDate} ]]>
        </if>
        <if test="invoiceNo != null and invoiceNo != ''">
            AND tdri.invoice_no = #{invoiceNo}
        </if>
        <if test="bindingNo != null and bindingNo != ''">
            AND tdri.bbindingno = #{bindingNo}
        </if>
        <if test="packingNo != null and packingNo != ''">
            AND tdri.packingno = #{packingNo}
        </if>
        <if test="certificateNo != null and certificateNo != ''">
            AND tdri.certificate_no = #{certificateNo}
        </if>
    </select>

    <select id="queryInvoiceBorrowList" resultType="com.xforceplus.wapp.modules.report.entity.ComprehensiveInvoiceQueryEntity">

        <if test="offset != null and limit != null">
        select top (#{limit}) a.*
        from
        (select row_number() over(order by o.invoiceDate desc) as rownumber,o.*
        from(
        </if>
        SELECT
        tdri.id,
        tdri.uuid,
        tdri.invoice_code invoiceCode,
        tdri.invoice_no invoiceNo,
        tdri.invoice_date invoiceDate,
        tdri.gf_tax_no gfTaxNo,
        tdri.gf_name gfName,
        tdri.xf_tax_no xfTaxNo,
        tdri.xf_name xfName,
        tdri.venderid venderId,
        tdri.invoice_amount invoiceAmount,
        tdri.tax_amount taxAmount,
        tdri.total_amount totalAmount,
        tdri. certificate_no certificateNo,
        tdri.scanning_seriano scanningSeriano,
        tdri.bbindingno,
        tdri.packingno,
        tdri.tax_rate taxRate,
        tdri.jvcode jvCode,
        tdri.eps_no epsNo,
        o.company_code companyCode
        from t_dx_record_invoice tdri WITH(NOLOCK)
        left join t_ac_org o WITH(NOLOCK) on o.taxno=tdri.gf_tax_no and tdri.jvcode = o.orgcode
        WHERE 1=1
        <if test="borrowYesOrNo != null and borrowYesOrNo !='' ">
            AND tdri.borrowyesorno = #{borrowYesOrNo}
        </if>
            <if test="gfName != null and gfName != '-1'and  gfName != ''">
                and jvcode = #{gfName}
            </if>
        <if test="jvCode != null and jvCode != ''">
            AND tdri.jvcode = #{jvCode}
        </if>
        <if test="epsNo != null and epsNo != ''">
            AND tdri.eps_no = #{epsNo}
        </if>
        <if test="companyCode != null and companyCode != ''">
            and tdri.gf_tax_no in (select taxno from t_ac_org WITH(NOLOCK) where company_code = #{companyCode})
        </if>
        <if test="venderId != null and venderId != ''">
            AND tdri.venderid = #{venderId}
        </if>
        <if test="createStartDate != null and createStartDate != ''">
            <![CDATA[ AND convert(varchar(100),tdri.packing_date,23) >= #{createStartDate} ]]>
        </if>
        <if test="createEndDate != null and createEndDate != ''">
            <![CDATA[ AND convert(varchar(100),tdri.packing_date,23)  <= #{createEndDate} ]]>
        </if>
        <if test="borrowStartDate != null and borrowStartDate != ''">
            <![CDATA[ AND convert(varchar(100),tdri.borrow_date,23) >= #{borrowStartDate} ]]>
        </if>
        <if test="borrowEndDate != null and borrowEndDate != ''">
            <![CDATA[ AND convert(varchar(100),tdri.borrow_date,23)  <= #{borrowEndDate} ]]>
        </if>
        <if test="invoiceNo != null and invoiceNo != ''">
            AND tdri.invoice_no = #{invoiceNo}
        </if>
        <if test="bindingNo != null and bindingNo != ''">
            AND tdri.bbindingno = #{bindingNo}
        </if>
        <if test="packingNo != null and packingNo != ''">
            AND tdri.packingno = #{packingNo}
        </if>
        <if test="certificateNo != null and certificateNo != ''">
            AND tdri.certificate_no = #{certificateNo}
        </if>
        <if test="offset != null and limit != null">
        )as o
        )a
        where rownumber>#{offset};
        </if>

    </select>

    <!-- 获取金额合计和税额合计 -->
    <select id="getInvoiceBorrowSumAmount" resultType="map">

        SELECT
        CONVERT (decimal(38,2),sum(invoice_amount)) summationTotalAmount,
        CONVERT (decimal(38,2),sum(tax_amount)) summationTaxAmount
        FROM (
        SELECT
        tdri.invoice_amount,
        tdri.tax_amount
        FROM t_dx_record_invoice tdri WITH(NOLOCK)
        WHERE 1=1
        <if test="jvCode != null and jvCode != ''">
            AND tdri.jvcode = #{jvCode}
        </if>
        <if test="epsNo != null and epsNo != ''">
            AND tdri.eps_no = #{epsNo}
        </if>
        <if test="companyCode != null and companyCode != ''">
            and tdri.gf_tax_no in (select taxno from t_ac_org WITH(NOLOCK) where company_code = #{companyCode})
        </if>
        <if test="borrowYesOrNo != null and borrowYesOrNo !='' ">
            AND tdri.borrowyesorno = #{borrowYesOrNo}
        </if>
        <if test="gfName != null and gfName != '-1'and  gfName != ''">
            and jvcode = #{gfName}
        </if>
        <if test="venderId != null and venderId != ''">
            AND tdri.venderid = #{venderId}
        </if>
        <if test="createStartDate != null and createStartDate != ''">
            <![CDATA[ AND convert(varchar(100),tdri.packing_date,23) >= #{createStartDate} ]]>
        </if>
        <if test="createEndDate != null and createEndDate != ''">
            <![CDATA[ AND convert(varchar(100),tdri.packing_date,23)  <= #{createEndDate} ]]>
        </if>
        <if test="borrowStartDate != null and borrowStartDate != ''">
            <![CDATA[ AND convert(varchar(100),tdri.borrow_date,23) >= #{borrowStartDate} ]]>
        </if>
        <if test="borrowEndDate != null and borrowEndDate != ''">
            <![CDATA[ AND convert(varchar(100),tdri.borrow_date,23)  <= #{borrowEndDate} ]]>
        </if>
        <if test="invoiceNo != null and invoiceNo != ''">
            AND tdri.invoice_no = #{invoiceNo}
        </if>
        <if test="bindingNo != null and bindingNo != ''">
            AND tdri.bbindingno = #{bindingNo}
        </if>
        <if test="packingNo != null and packingNo != ''">
            AND tdri.packingno = #{packingNo}
        </if>
        <if test="certificateNo != null and certificateNo != ''">
            AND tdri.certificate_no = #{certificateNo}
        </if>
        ) a
    </select>

    <select id="getBorrowRecordCount" resultType="Integer">

        SELECT COUNT(*)
        from t_dx_borrow_record r
        left join t_dx_record_invoice tdri WITH(NOLOCK) on r.invoice_code=tdri.invoice_code and r.invoice_no=tdri.invoice_no
        WHERE 1=1
        <if test="gfName != null and gfName != '-1'and  gfName != ''">
            and tdri.jvcode = #{gfName}
        </if>
        <if test="epsNo != null and epsNo != ''">
            AND tdri.eps_no = #{epsNo}
        </if>
        <if test="companyCode != null and companyCode != ''">
            and tdri.gf_tax_no in (select taxno from t_ac_org WITH(NOLOCK) where company_code = #{companyCode})
        </if>
        <if test="venderId != null and venderId != ''">
            AND tdri.venderid = #{venderId}
        </if>
        <if test="createStartDate != null and createStartDate != '' and operateType=='0'.toString()">
            <![CDATA[ AND convert(varchar(100),r.borrow_return_date,23) >= #{createStartDate} ]]>
        </if>
        <if test="createEndDate != null and createEndDate != '' and operateType=='0'.toString()">
            <![CDATA[ AND convert(varchar(100),r.borrow_return_date,23)  <= #{createEndDate} ]]>
        </if>
        <if test="returnStartDate != null and returnStartDate != '' and operateType=='1'.toString()">
            <![CDATA[ AND convert(varchar(100),r.borrow_return_date,23) >= #{returnStartDate} ]]>
        </if>
        <if test="returnEndDate != null and returnEndDate != '' and operateType=='1'.toString()">
            <![CDATA[ AND convert(varchar(100),r.borrow_return_date,23)  <= #{returnEndDate} ]]>
        </if>
        <if test="invoiceNo != null and invoiceNo != ''">
            AND r.invoice_no = #{invoiceNo}
        </if>
        <if test="bindingNo != null and bindingNo != ''">
            AND tdri.bbindingno = #{bindingNo}
        </if>
        <if test="packingNo != null and packingNo != ''">
            AND tdri.packingno = #{packingNo}
        </if>
        <if test="borrowDept != null and borrowDept != ''">
            AND r.borrow_dept = #{borrowDept}
        </if>
        <if test="certificateNo != null and certificateNo != ''">
            AND tdri.certificate_no = #{certificateNo}
        </if>
        <if test="operateType != null and operateType != ''">
            AND r.operate_type = #{operateType}
        </if>
    </select>

    <select id="queryBorrowRecordList" resultType="com.xforceplus.wapp.modules.invoiceBorrow.entity.BorrowEntity">

        <if test="offset != null and limit != null">
            select top (#{limit}) a.*
            from
            (select row_number() over(order by o.borrowDate desc) as rownumber,o.*
            from(
        </if>
        SELECT
        r.invoice_no invoiceNo,
        tdri.venderid venderId,
        tdri.bbindingno,
        tdri.packingno,
        tdri.certificate_no certificateNo,
        tdri.jvcode jvCode,
        tdri.eps_no,
        o.company_code companyCode,
        r.borrow_return_date borrowDate,
        r.borrow_return_user borrowUser,
        r.borrow_reason borrowReason,
        r.operate_type operateType,
        r.borrow_dept borrowDept
        from t_dx_borrow_record r
        left join t_dx_record_invoice tdri WITH(NOLOCK) on r.invoice_code=tdri.invoice_code and r.invoice_no=tdri.invoice_no
        left join t_ac_org o WITH(NOLOCK) on o.taxno=tdri.gf_tax_no and tdri.jvcode = o.orgcode
        WHERE 1=1
        <if test="gfName != null and gfName != '-1'and  gfName != ''">
            and tdri.jvcode = #{gfName}
        </if>
        <if test="epsNo != null and epsNo != ''">
            AND tdri.eps_no = #{epsNo}
        </if>
        <if test="companyCode != null and companyCode != ''">
            and tdri.gf_tax_no in (select taxno from t_ac_org WITH(NOLOCK) where company_code = #{companyCode})
        </if>
        <if test="venderId != null and venderId != ''">
            AND tdri.venderid = #{venderId}
        </if>
        <if test="borrowDept != null and borrowDept != ''">
            AND r.borrow_dept = #{borrowDept}
        </if>
        <if test="operateType != null and operateType != ''">
            AND r.operate_type = #{operateType}
        </if>
        <if test="createStartDate != null and createStartDate != '' and operateType=='0'.toString()">
            <![CDATA[ AND convert(varchar(100),r.borrow_return_date,23) >= #{createStartDate} ]]>
        </if>
        <if test="createEndDate != null and createEndDate != '' and operateType=='0'.toString()">
            <![CDATA[ AND convert(varchar(100),r.borrow_return_date,23)  <= #{createEndDate} ]]>
        </if>
        <if test="returnStartDate != null and returnStartDate != '' and operateType=='1'.toString()">
            <![CDATA[ AND convert(varchar(100),r.borrow_return_date,23) >= #{returnStartDate} ]]>
        </if>
        <if test="returnEndDate != null and returnEndDate != '' and operateType=='1'.toString()">
            <![CDATA[ AND convert(varchar(100),r.borrow_return_date,23)  <= #{returnEndDate} ]]>
        </if>
        <if test="invoiceNo != null and invoiceNo != ''">
            AND r.invoice_no = #{invoiceNo}
        </if>
        <if test="bindingNo != null and bindingNo != ''">
            AND tdri.bbindingno = #{bindingNo}
        </if>
        <if test="packingNo != null and packingNo != ''">
            AND tdri.packingno = #{packingNo}
        </if>
        <if test="certificateNo != null and certificateNo != ''">
            AND tdri.certificate_no = #{certificateNo}
        </if>
        <if test="offset != null and limit != null">
            )as o
            )a
            where rownumber>#{offset};
        </if>

    </select>


    <insert id="save"  >
     insert into t_dx_borrow_record
        (
        <if test="entity.borrowReason !=null and entity.borrowReason!=''">
            borrow_reason,
        </if>
        <if test="entity.borrowDept !=null and entity.borrowDept!=''">
            borrow_dept,
        </if>
        borrow_return_user,
        borrow_return_date,
        operate_type,
        invoice_code,
        invoice_no,
        create_date
        )
        values
        (
        <if test="entity.borrowReason !=null and entity.borrowReason!=''">
            #{entity.borrowReason},
        </if>
        <if test="entity.borrowDept !=null and entity.borrowDept!=''">
            #{entity.borrowDept},
        </if>
        #{entity.borrowUser},
        CONVERT(datetime,#{entity.borrowDate}),
        #{entity.operateType},
        #{entity.invoiceCode},
        #{entity.invoiceNo},
        getdate()
        )
    </insert>

    <select id="getDataByuuid" resultType="com.xforceplus.wapp.modules.report.entity.ComprehensiveInvoiceQueryEntity">
        SELECT
        invoice_code invoiceCode,
        invoice_no invoiceNo
        from t_dx_record_invoice WITH(NOLOCK)
        where uuid=#{uuid}
    </select>

    <update id="updateBorrowStatus">
        update t_dx_record_invoice WITH(ROWLOCK) set
        borrowyesorno=#{status},
        borrow_date=#{borrowDate}
        where uuid = #{uuid}
    </update>
    <update id="updateBorrowjy">
        update t_dx_record_invoice WITH(ROWLOCK) set
        borrowyesorno=#{status},
        borrow_date=#{borrowDate},
        borrow_user=#{borrowUser},
        borrow_reason=#{borrowReason},
        borrow_dept=#{borrowDept}
        where uuid = #{uuid}
    </update>
    <update id="updateBorrowgh">
        update t_dx_record_invoice WITH(ROWLOCK) set
        borrowyesorno=#{status},
        borrow_return_date=#{borrowReturnDate},
        borrow_return_user=#{borrowReturnUser}
        where uuid = #{uuid}
    </update>
</mapper>